<?xml version="1.0" encoding="utf-8"?>
<DataSchemaModel FileFormatVersion="1.2" SchemaVersion="2.4" DspName="Microsoft.Data.Tools.Schema.Sql.Sql110DatabaseSchemaProvider" CollationLcid="1033" CollationCaseSensitive="False" xmlns="http://schemas.microsoft.com/sqlserver/dac/Serialization/2012/02">
	<Header>
		<CustomData Category="AnsiNulls">
			<Metadata Name="AnsiNulls" Value="True" />
		</CustomData>
		<CustomData Category="QuotedIdentifier">
			<Metadata Name="QuotedIdentifier" Value="True" />
		</CustomData>
		<CustomData Category="CompatibilityMode">
			<Metadata Name="CompatibilityMode" Value="110" />
		</CustomData>
		<CustomData Category="Reference" Type="SqlSchema">
			<Metadata Name="FileName" Value="C:\PROGRAM FILES (X86)\MICROSOFT VISUAL STUDIO\2017\ENTERPRISE\COMMON7\IDE\EXTENSIONS\MICROSOFT\SQLDB\EXTENSIONS\SQLSERVER\110\SQLSCHEMAS\MASTER.DACPAC" />
			<Metadata Name="LogicalName" Value="master.dacpac" />
			<Metadata Name="ExternalParts" Value="[master]" />
			<Metadata Name="SuppressMissingDependenciesErrors" Value="False" />
		</CustomData>
		<CustomData Category="Reference" Type="Assembly">
			<Metadata Name="LogicalName" Value="ETL_Staging.dll" />
			<Metadata Name="FileName" Value="C:\GITHUB\ETL-ACCELERATOR\ETL_FRAMEWORK\DATABASE\ETL_STAGING\OBJ\RELEASE\ETL_STAGING.DLL" />
			<Metadata Name="AssemblyName" Value="ETL_Staging" />
			<Metadata Name="PermissionSet" Value="SAFE" />
			<Metadata Name="Owner" Value="" />
			<Metadata Name="GenerateSqlClrDdl" Value="True" />
			<Metadata Name="IsVisible" Value="True" />
			<Metadata Name="IsModelAware" Value="True" />
			<Metadata Name="SkipCreationIfEmpty" Value="True" />
			<Metadata Name="AssemblySymbolsName" />
		</CustomData>
		<CustomData Category="SqlCmdVariables" Type="SqlCmdVariable" />
	</Header>
	<Model>
		<Element Type="SqlDatabaseOptions">
			<Property Name="Collation" Value="SQL_Latin1_General_CP1_CI_AS" />
			<Property Name="IsAnsiNullDefaultOn" Value="True" />
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Property Name="IsAnsiWarningsOn" Value="True" />
			<Property Name="IsArithAbortOn" Value="True" />
			<Property Name="IsConcatNullYieldsNullOn" Value="True" />
			<Property Name="IsTornPageProtectionOn" Value="False" />
			<Property Name="RecoveryMode" Value="1" />
			<Property Name="IsFullTextEnabled" Value="True" />
			<Property Name="PageVerifyMode" Value="3" />
			<Property Name="DefaultLanguage" Value="" />
			<Property Name="DefaultFullTextLanguage" Value="" />
			<Relationship Name="DefaultFilegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[0]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[Priority]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="5" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[getdate()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[CreateDt]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="6" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[getdate()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ChangeDt]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="7" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[suser_sname()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ChangeBy]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="8" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[getdate()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ProgressStatus]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[ProgressStatus].[CreateDt]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="9" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[getdate()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ProgressStatus]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[ProgressStatus].[ChangeDt]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="10" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[suser_sname()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ProgressStatus]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[ProgressStatus].[ChangeBy]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="11" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FileProcessProgress].[FileId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="12" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ProgressStatus].[ProgressStatusId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ProgressStatus]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="13" />
		</Element>
		<Element Type="SqlUniqueConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FileProcessProgress].[SourceName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FileProcessProgress].[FileName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="14" />
		</Element>
		<Element Type="SqlUniqueConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ProgressStatus].[ProgressStatusName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ProgressStatus]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="15" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Audit]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[AuditId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[AuditObject]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[SourceObject]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[StartDT]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[EndDT]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[Op]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[Err]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[RowCnt]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Audit].[RunId]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[AuditPK]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Audit].[AuditId]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Audit]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTableType" Name="[dbo].[FileList]">
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlTableTypeSimpleColumn" Name="[dbo].[FileList].[Name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlTableTypeSimpleColumn" Name="[dbo].[FileList].[Path]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlTableTypeSimpleColumn" Name="[dbo].[FileList].[Source]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[FileProcessProgress]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[FileId]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="12" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[FileName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[FullName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[SourceName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[ProgressStatusId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[ProcessId]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[Priority]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="5" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[CreateDt]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="6" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[ChangeDt]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="7" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FileProcessProgress].[ChangeBy]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="30" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="8" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="14" />
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_Audit]">
			<Property Name="BodyScript">
				<Value><![CDATA[
/******************************************************************************
** File: prc_Audit.proc.sql
** Name: dbo.prc_Audit
**
** Desc: Set process run record; generates unique audit key.
**          
** Params: 
**    AudutMode: {0=Update audit; 1=Start audit; 2=Close audit}
**
** Returns:
**    Return code: {0=Success; Error code otherwise}.
*******************************************************************************
**       CHANGE HISTORY
*******************************************************************************
** Date        Author    Description
** ----------  --------  ------------------------------------------------------
** 04/20/2009  andrey@biasintelligence.com  Created procedure.
******************************************************************************/

-- Reduce processing overhead.
SET NOCOUNT ON;

-- Standard variable declarations.
DECLARE
      @InitialTransactionCount INT
    , @RowCount INT
    , @IsDebug BIT
    , @ReturnCode INT
    , @Message NVARCHAR(1000)
    , @ProcedureName SYSNAME
    ;
    
-- Set variable defaults.
SELECT
      @ProcedureName = OBJECT_NAME(@@PROCID)
    , @InitialTransactionCount = @@TRANCOUNT
    , @IsDebug = CASE WHEN CHARINDEX('debug',@Options) > 0 THEN 1 ELSE 0 END
    , @ReturnCode = 0 -- Default return code.
    ;

BEGIN TRY

-- STEP 1: Check for begin audit mode.
IF @AuditMode = 1  -- Begin mode.

   BEGIN -- NEW AUDIT
   
        -- STEP 2: Validate mode.
        IF @AuditId IS NOT NULL
            RAISERROR('Warning: AuditId cant be reused in BEGIN Audit mode . Key=%d', 1, 0, @AuditId) WITH NOWAIT;
   
        -- STEP 3: Insert beginning of audit.
        INSERT dbo.Audit (
                AuditObject
              , SourceObject
              , StartDT
              , Op
              , Err
              , RowCnt
              , RunId
              )
            VALUES (
                  @AuditObject
                , @SourceObject
                , GETDATE() -- Start date time.
                , @Op
                , ISNULL(@Err,0) -- Error code.
                , @RowCnt
                , @RunId
                )
                ;
                
        -- STEP 3: Retrieve auto-generated audit key value.
        SELECT @AuditId = SCOPE_IDENTITY();
      
        -- STEP 4: For debug mode, report audit is created.
        IF @IsDebug = 1
            RAISERROR('Audit record %d created.', 0, 1, @AuditId) WITH NOWAIT;
         
   END; -- NEW AUDIT
   
ELSE

    BEGIN -- EXISTING AUDIT
    
        -- STEP 5: Validate audit exists.
        IF NOT EXISTS (SELECT 1 FROM dbo.Audit WHERE AuditId = @AuditId)
            RAISERROR('Specified audit record %d does not exist.', 11, 11, @AuditId) WITH NOWAIT;
            
        -- STEP 6: Check for update audit mode.
        IF @AuditMode = 0 -- Update mode.

            BEGIN -- UPDATE AUDIT MODE
         
                -- STEP 7: Validate audit is not already closed.
                IF EXISTS (SELECT 1 FROM dbo.Audit WHERE AuditId = @AuditId AND EndDT IS NOT NULL)
                    RAISERROR('Cannot change audit record %d because it is already closed.', 11, 11, @AuditId) WITH NOWAIT;
            
                -- STEP 8: Update audit.
                UPDATE A SET
                      A.AuditObject = ISNULL(@AuditObject, A.AuditObject)
                    , A.SourceObject = ISNULL(@SourceObject, A.SourceObject)
                    , A.Op = ISNULL(@Op, A.Op)
                    , A.Err = ISNULL(@Err, A.Err)
                    , A.RowCnt = ISNULL(@RowCnt, A.RowCnt)
                    , A.RunId = ISNULL(@RunId, A.RunId)
                    FROM dbo.Audit A
                    WHERE A.AuditId = @AuditId
                ;

                -- STEP 9: For debug mode, report audit is updated.
                IF @IsDebug = 1
                    RAISERROR('Audit record %d is updated.', 0, 1, @AuditId) WITH NOWAIT;

            END; -- UPDATE AUDIT MODE

        -- STEP 10: Check for close audit mode.    
        ELSE IF @AuditMode = 2

           BEGIN -- CLOSE AUDIT MODE
           
                -- STEP 11: Update audit mode to closed state.
                UPDATE A SET
                      A.EndDT = GETDATE()
                    , A.Err = ISNULL(@Err, Err)
                    FROM dbo.Audit A
                    WHERE A.AuditId = @AuditId
                ;

                -- STEP 12: For debug mode, report audit is closed.
                IF @IsDebug = 1 
                    RAISERROR('Audit record %d closed.', 0, 1, @AuditId) WITH NOWAIT;
                 
           END; -- CLOSE AUDIT MODE
           
        -- STEP 13: Handle unknown audit mode conditions.
        ELSE

            BEGIN -- UNKNOWN MODE CONDITION
                
                -- STEP 14: Handle unknown mode condition.
                RAISERROR('Invalid audit mode specified for an existing audit record. Mode=%d', 11, 11, @AuditMode) WITH NOWAIT;
              
            END; -- UNKNOWN MODE CONDITION
            
    END; -- EXISTING AUDIT
    
END TRY
BEGIN CATCH

    -- Rollback uncommitted changes.
    IF @@TRANCOUNT > @InitialTransactionCount ROLLBACK TRAN;

    SELECT @ReturnCode = ERROR_NUMBER();
        
    -- Record an error condition.  
    UPDATE A SET 
          A.Err = ERROR_NUMBER()
        , A.EndDT = GETDATE()  -- Error implicitly closes an audit cycle.
        FROM dbo.Audit A
        WHERE A.AuditId = @AuditId
    ;
    
    SELECT @Message = 'Audit %d: failed with the message:' + ERROR_MESSAGE();
    RAISERROR(@Message, 11, 11, @AuditId) WITH NOWAIT;
    
END CATCH

RETURN @ReturnCode]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@Options]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@AuditMode]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@AuditId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[AuditObject]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[SourceObject]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[StartDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[Op]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[RowCnt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[RunId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@AuditObject]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@SourceObject]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@Op]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@RowCnt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Audit].[@RunId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[AuditId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[EndDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[AuditObject]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[SourceObject]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[Op]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[RowCnt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[RunId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[AuditId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Audit].[EndDT]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@AuditId]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@AuditMode]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@AuditObject]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@SourceObject]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@Op]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@Err]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@RowCnt]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@RunId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Audit].[@Options]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="368" />
				<Property Name="Length" Value="6462" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;/*&#xD;&#xA;declare @Audit_Key int&#xD;&#xA;exec dbo.[prc_Audit] @AuditMode = 1,@AuditId = @Audit_Key out,@AuditObject='Test',@Options='debug'&#xD;&#xA;--select @Audit_Key&#xD;&#xA;exec dbo.[prc_Audit] @AuditMode = 0,@AuditId = @Audit_Key,@Op='1',@RowCnt=100,@Options='debug'&#xD;&#xA;exec dbo.[prc_Audit] @AuditMode = 2,@AuditId = @Audit_Key,@Op='1',@RowCnt=100,@Options='debug'&#xD;&#xA;select * from Audit&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE dbo.prc_Audit&#xD;&#xA;      @AuditId INT = NULL OUT&#xD;&#xA;    , @AuditMode TINYINT = 0&#xD;&#xA;    , @AuditObject SYSNAME = NULL&#xD;&#xA;    , @SourceObject NVARCHAR(1000) = NULL&#xD;&#xA;    , @Op NVARCHAR(10) = NULL&#xD;&#xA;    , @Err INT = NULL&#xD;&#xA;    , @RowCnt INT = NULL&#xD;&#xA;    , @RunId INT = NULL&#xD;&#xA;    , @Options NVARCHAR(100) = NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_FileProcessGetNext]">
			<Property Name="BodyScript">
				<Value><![CDATA[
/*
exec dbo.prc_FileProcessGetNext 'testSource',5,0
*/
	SET NOCOUNT ON;
	--SET XACT_ABORT ON;
	DECLARE	 @msg nvarchar(max)
			,@debug bit
			,@tran int
			,@err int
			,@proc sysname = object_name(@@procid)
			,@rows int;

	SET @err = 0;
	SET @tran = @@TRANCOUNT;
			 
	BEGIN TRY

	SET @debug = CASE WHEN charindex('debug', @options) > 0 THEN 1 ELSE 0 END;


	UPDATE dst
	 SET ProgressStatusId = 1 --started
		,dst.processId = isnull(@processId,dst.processId)
		,dst.changeDt = getDate()
		,dst.changeBy = suser_sname()
		OUTPUT deleted.fileId,deleted.[fileName],deleted.[fullName],deleted.sourceName,inserted.processId
	FROM dbo.FileProcessProgress dst
	JOIN (SELECT TOP (@count) fp.fileId FROM dbo.FileProcessProgress fp WITH (TABLOCK)
	WHERE fp.ProgressStatusId = 0 AND fp.SourceName = ISNULL(@sourceName,fp.sourceName)
	ORDER BY fp.[Priority] desc, fp.CreateDt asc) lst
	ON dst.fileId = lst.fileId;


	RETURN 0;

	END TRY
	BEGIN CATCH
	   IF @@TRANCOUNT > @tran
	      ROLLBACK TRAN;
	      
	   SET @msg = ERROR_MESSAGE();
	   SET @Err = ERROR_NUMBER();

	   THROW @Err, @msg, 1;
	END CATCH

RETURN @err;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessGetNext].[@options]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessGetNext].[@Count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ProgressStatusId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessGetNext].[@SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[Priority]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[CreateDt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ProgressStatusId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ProcessId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessGetNext].[@processId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ChangeDt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ChangeBy]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FullName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ProcessId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessGetNext].[@SourceName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessGetNext].[@Count]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessGetNext].[@processId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessGetNext].[@options]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1313" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE dbo.prc_FileProcessGetNext&#xD;&#xA;&#x9; @SourceName nvarchar(100) = null&#xD;&#xA;&#x9;,@Count int = 1&#xD;&#xA;&#x9;,@processId int = 0&#xD;&#xA;&#x9;,@options nvarchar(100) = null&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_FileProcessProgressUpdate]">
			<Property Name="BodyScript">
				<Value><![CDATA[
/*
exec dbo.prc_FileProcessProgressUpdate @fileId = 3, @progressStatusId = 0,@priority = 2
*/
	SET NOCOUNT ON;
	--SET XACT_ABORT ON;
	DECLARE	 @msg nvarchar(max)
			,@debug bit
			,@tran int
			,@err int
			,@proc sysname = object_name(@@procid)
			,@rows int;

	SET @err = 0;
	SET @tran = @@TRANCOUNT;
			 
	BEGIN TRY

	SET @debug = CASE WHEN charindex('debug', @options) > 0 THEN 1 ELSE 0 END;

	IF (@fileId IS NULL AND (@FileName IS NULL OR @SourceName IS NULL))
	BEGIN
		SET @msg = 'Invalid parameters. @fileId or @fileName and @sourceName are required';   
		THROW 50001, @msg, 1;
	END

	DECLARE @fId int = (SELECT fileId FROM dbo.FileProcessProgress
	 WHERE fileId = ISNULL(@fileId,fileId)
	 AND [fileName] = ISNULL(@fileName,[fileName])
	 AND [sourceName] = ISNULL(@sourceName,[sourceName]));

	IF (@fId IS NULL)
	BEGIN
		SET @msg = 'Invalid parameters. @fileId = ' + ISNULL(CAST(@fileId AS nvarchar(30)),'null')
		+ ' or @fileName = ' + ISNULL(@fileName,'null')
		+ ' or @sourceName = ' + ISNULL(@sourceName,'null') ;

		THROW 50002, @msg, 1;
	END


	IF (@ProgressStatusId IS NULL AND @ProgressStatusName IS NULL)
	BEGIN
		SET @msg = 'Invalid parameters. @ProgressStatusName or ProgressStatusName are required';   
		THROW 50001, @msg, 1;
	END

	DECLARE @statusId tinyint = (SELECT progressStatusId FROM dbo.ProgressStatus
	WHERE progressStatusId = ISNULL(@progressStatusId,progressStatusId)
	AND progressStatusName = ISNULL(@progressStatusName,progressStatusName));

	IF (@statusId IS NULL)
	BEGIN
		SET @msg = 'Invalid parameters. @progressStatusId = ' + ISNULL(CAST(@progressStatusId AS nvarchar(30)),'null')
		+ ' or @progressStatusName = ' + ISNULL(@progressStatusName,'null');

		THROW 50002, @msg, 1;
	END

	UPDATE dbo.FileProcessProgress
	 SET ProgressStatusId = isnull(@statusId,ProgressStatusId)
		,processId = isnull(@processId,processId)
		,[priority] = isnull(@priority,[priority])
		,changeDt = getDate()
		,changeBy = suser_sname()
	WHERE fileId = @fId;

	RETURN 0;

	END TRY
	BEGIN CATCH
	   IF @@TRANCOUNT > @tran
	      ROLLBACK TRAN;
	      
	   SET @msg = ERROR_MESSAGE();
	   SET @Err = ERROR_NUMBER();

	   THROW @Err, @msg, 1;
	END CATCH

RETURN @err;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessProgressUpdate].[@fileId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessProgressUpdate].[@FileName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessProgressUpdate].[@SourceName]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProgressStatus]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProgressStatus].[ProgressStatusId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessProgressUpdate].[@ProgressStatusId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProgressStatus].[ProgressStatusName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessProgressUpdate].[@ProgressStatusName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessProgressUpdate].[@options]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ProgressStatusId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ProcessId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessProgressUpdate].[@processId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[Priority]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessProgressUpdate].[@priority]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ChangeDt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ChangeBy]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessProgressUpdate].[@fileId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessProgressUpdate].[@FileName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessProgressUpdate].[@SourceName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessProgressUpdate].[@ProgressStatusId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessProgressUpdate].[@ProgressStatusName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessProgressUpdate].[@processId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessProgressUpdate].[@priority]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessProgressUpdate].[@options]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2571" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE dbo.prc_FileProcessProgressUpdate&#xD;&#xA;&#x9; @fileId int = null&#xD;&#xA;&#x9;,@FileName nvarchar(100) = null&#xD;&#xA;&#x9;,@SourceName nvarchar(100) = null&#xD;&#xA;&#x9;,@ProgressStatusId tinyint = null&#xD;&#xA;&#x9;,@ProgressStatusName nvarchar(100) = null&#xD;&#xA;&#x9;,@processId int = null&#xD;&#xA;&#x9;,@priority int = null&#xD;&#xA;&#x9;,@options nvarchar(100) = null&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_FileProcessRegisterNew]">
			<Property Name="BodyScript">
				<Value><![CDATA[
/*
declare @list [dbo].[FileList]
insert @list
values ('testFile1.json','c:\files\testFile1.json','testSource')
,('testFile2.json','c:\files\testFile1.json','testSource')
exec dbo.prc_FileProcessRegisterNew @list,1,1

*/

	SET NOCOUNT ON;
	--SET XACT_ABORT ON;
	DECLARE	 @msg nvarchar(max)
			,@debug bit
			,@tran int
			,@err int
			,@proc sysname = object_name(@@procid)
			,@rows int;

	SET @err = 0;
	SET @tran = @@TRANCOUNT;
			 
	BEGIN TRY

	SET @debug = CASE WHEN charindex('debug', @options) > 0 THEN 1 ELSE 0 END;
	IF NOT EXISTS (SELECT 1 FROM @list)
		RETURN 0;


	DECLARE @StatusId tinyint = 0; -- new records

	MERGE dbo.FileProcessProgress dst
	USING (SELECT [Name], [Path], [Source] FROM @list) src ([FileName], [FullName], [SourceName])
	ON src.[FileName] = dst.[FileName] AND src.[SourceName] = dst.[SourceName]
	WHEN NOT MATCHED BY TARGET THEN
	INSERT ([FileName], [FullName], [SourceName],[ProgressStatusId],[ProcessId],[Priority])
	VALUES ([FileName], [FullName], [SourceName],@statusId,@processId,@priority)
	;

	END TRY
	BEGIN CATCH
	   IF @@TRANCOUNT > @tran
	      ROLLBACK TRAN;
	      
	   SET @msg = ERROR_MESSAGE();
	   SET @Err = ERROR_NUMBER();

	   THROW @Err, @msg, 1;
	END CATCH

RETURN @err;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessRegisterNew].[@options]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessRegisterNew].[@list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessRegisterNew].[@list].[Name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessRegisterNew].[@list].[Path]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessRegisterNew].[@list].[Source]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FileName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[FullName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ProgressStatusId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[ProcessId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FileProcessProgress].[Priority]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessRegisterNew].[@processId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_FileProcessRegisterNew].[@priority]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_FileProcessRegisterNew].[@list]" Disambiguator="4">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_FileProcessRegisterNew].[@list].[Name]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_FileProcessRegisterNew].[@list].[Path]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="1000" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_FileProcessRegisterNew].[@list].[Source]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessRegisterNew].[@list]">
						<Property Name="IsReadOnly" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References Name="[dbo].[FileList]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessRegisterNew].[@processId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessRegisterNew].[@priority]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_FileProcessRegisterNew].[@options]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1438" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE dbo.prc_FileProcessRegisterNew&#xD;&#xA;&#x9; @list [dbo].[FileList] readonly&#xD;&#xA;&#x9;,@processId int = 0&#xD;&#xA;&#x9;,@priority int = 0&#xD;&#xA;&#x9;,@options nvarchar(100) = null&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_StagingTablePrepare]">
			<Property Name="BodyScript">
				<Value><![CDATA[
begin
/******************************************************************************
** File:	[prc_StagingTablePrepare].sql
** Name:	[dbo].[prc_StagingTablePrepare]

** Desc:	prepare staging table. Create one or tructate if present. Proc uses @src table as template
**          
**
** Params:
** @src       -- table or view name to use as template
** @dst       -- returns delta table name
** @options   -- supported: debug,rebuild,index,uniqueindex
** Returns:
**
** Author:	andreys
** Date:	12/5/2008
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------
   2012-03-08       andreys                             add extended property metadata
														table: hasMetadata = 1
														column: isSPK = ordinal(1,2,3) --source PK ordinal
															    isType2 = 1 -- type2 column
																isAudit = 1 -- audit column
																isType2StartPeriod -- Type2 start period column
																isType2EndPeriod -- Type2 end period column
																isAction = 1 -- action column

  2017-03-13		andrey								add ident column back
  2017-03-30		andrey								remove src/dst db if the same to support azure dbs 
*/
--exec [prc_StagingTablePrepare] 'dbo.TestProperty','dbo.staging_TestProperty',0,'debug,rebuild,index'

   set nocount on

   declare @err                int
   declare @tran               int
   declare @proc               sysname
   declare @msg                nvarchar(1000)
   declare @query              nvarchar(max)
   declare @sql1               nvarchar(max)
   declare @debug              tinyint
   declare @rebuild            tinyint
   declare @needindex          tinyint
   declare @quotename          tinyint
   declare @srcDB              sysname
   declare @srcSchema          sysname

   declare @AuditCol           sysname
   declare @ActionCol          sysname
   declare @RecordStartCol     sysname
   declare @RecordEndCol       sysname

   set @err = 0
   set @tran = @@trancount
   set @debug = case when @options like '%debug%' then 1 else 0 end
   set @rebuild = case when @options like '%rebuild%' then 1 else 0 end
   set @needindex = case 
                      when @options like '%uniqueindex%' then 1
                      when @options like '%index%' then 2
                      else 0
                    end
   set @quotename = case when @options like '%quotename%' then 1 else 0 end

-----------------------------------------------------------------------------------------------------
--metadata defaults
-----------------------------------------------------------------------------------------------------
   set @AuditCol = 'AuditId'
   set @ActionCol = 'ActionId'
   set @RecordStartCol = 'RecordStartDate'
   set @RecordEndCol = 'RecordEndDate'

-----------------------------------------------------------------------------------------------------
--table name normalization
-----------------------------------------------------------------------------------------------------
   set @srcDB = isnull(parsename(@src,3),DB_NAME())
   set @srcdb = case when @srcdb = db_name() then '' else quotename(@srcdb) + '.' end;

   set @srcSchema = quotename(isnull(parsename(@src,2),'dbo'))
   set @src = case when len(@srcDB) > 0 then @srcDB + '.' else '' end + @srcSchema+ '.' + quotename(parsename(@src,1))
   if (@quotename = 0)
   	   set @dst = isnull(parsename(isnull(@dst,@src),2),'dbo')
				+ '.' + isnull(parsename(@dst,1),'staging_' + parsename(@src,1))
	else
      set @dst = quotename(isnull(parsename(isnull(@dst,@src),2),'dbo'))
            + '.' + quotename(isnull(parsename(@dst,1),'staging_' + parsename(@src,1)))

  create table #srccol
  ([name] sysname primary key
  ,[type] smallint
  ,[len]  smallint
  ,[prec] tinyint
  ,[scale] tinyint
  ,[is_ident] bit
  ,[is_null] bit
  ,[is_guid] bit
  ,[colid] smallint
  ,[pk] tinyint
  ,[spk] tinyint
  ,[is_type2] bit
  )

  create table #srcprop
  ([colname] sysname
  ,[propname]  sysname
  ,[propvalue] nvarchar(30)
  )

begin try

   if (object_id(@src) is null)
   begin
      raiserror('ERROR: unknown object in %s',11,10,@src)
   end


-----------------------------------------------------------------------------------------------------
--build column def set
-----------------------------------------------------------------------------------------------------
   set @query = '
declare @tbl sysname,@sch sysname;
set @tbl = parsename(@src,1);
set @sch = parsename(@src,2);
if exists(select 1 from <db>.sys.fn_listextendedproperty (NULL, ''schema'', @sch, ''table'', @tbl, default, default) where name = ''hasMetadata'' and value = 1)
begin
--use Extended Properties
   insert #srcprop
   select objname, name, cast(value as nvarchar(30)) from <db>.sys.fn_listextendedproperty (NULL, ''schema'', @sch, ''table'', @tbl, ''column'', default);

   insert #srccol
   select d.[name],d.system_type_id,d.max_length,d.[precision],d.[scale]
       ,d.[is_identity],d.[is_nullable],d.[is_rowguidcol],d.[column_id]
       ,isnull(ipkc.[key_ordinal],0),isnull(spk.[propvalue],0),isnull(t2.[propvalue],0)
    from <db>.sys.columns d
    left join <db>.sys.indexes ipk on ipk.[object_id] = d.[object_id] and  ipk.[is_primary_key] = 1
    left join <db>.sys.index_columns ipkc
           on ipk.[object_id] = ipkc.[object_id]
          and ipk.[index_id] = ipkc.[index_id]
          and d.[column_id] = ipkc.[column_id]
    left join #srcprop spk on d.[name] = spk.[colname] and spk.[propname] = ''isSPK''
    left join #srcprop t2 on d.[name] = t2.[colname] and t2.[propname] = ''isType2''
    where d.[object_id] = object_id(@src)
end
else
begin
--use defaults
   insert #srccol
   select d.[name],d.system_type_id,d.max_length,d.[precision],d.[scale]
       ,d.[is_identity],d.[is_nullable],d.[is_rowguidcol],d.[column_id]
       ,isnull(ipkc.[key_ordinal],0),isnull(ispkc.[key_ordinal],0),isnull(ispkc.[is_included_column],0)
    from <db>.sys.columns d
    left join <db>.sys.indexes ipk on ipk.[object_id] = d.[object_id] and  ipk.[is_primary_key] = 1
    left join <db>.sys.index_columns ipkc
           on ipk.[object_id] = ipkc.[object_id]
          and ipk.[index_id] = ipkc.[index_id]
          and d.[column_id] = ipkc.[column_id]
    left join <db>.sys.indexes ispk on ispk.[object_id] = d.[object_id] and  ispk.name like ''UQ_SPK_%''
    left join <db>.sys.index_columns ispkc
           on ispk.[object_id] = ispkc.[object_id]
          and ispk.[index_id] = ispkc.[index_id]
          and d.[column_id] = ispkc.[column_id]
    where d.[object_id] = object_id(@src)
end
'
    
   set @query = replace(@query,'<db>.',@srcDB)
   --print @query
   exec sp_executesql @query,N'@src sysname',@src = @src

   --if (@debug = 1)
   --begin
   --   select * from #srccol
   --end

  set @AuditCol = isnull((select top 1 [colname] from #srcprop where [propname] = 'isAudit' and [propvalue] = 1)
                            ,(select top 1 [name] from #srccol where [name] = @AuditCol));
   set @ActionCol = isnull((select top 1 [colname] from #srcprop where [propname] = 'isAction' and [propvalue] = 1)
                            ,(select top 1 [name] from #srccol where [name] = @ActionCol));
   set @RecordStartCol = isnull((select top 1 [colname] from #srcprop where [propname] = 'isType2StartPeriod' and [propvalue] = 1)
                            ,(select top 1 [name] from #srccol where [name] = @RecordStartCol));
   set @RecordEndCol = isnull((select top 1 [colname] from #srcprop where [propname] = 'isType2EndPeriod' and [propvalue] = 1)
                            ,(select top 1 [name] from #srccol where [name] = @RecordEndCol));

   --remove dw specific columns
   delete #srccol where [name] in (@AuditCol,@ActionCol,@RecordStartCol,@RecordEndCol)
   --remove identity column
   --need it for sync processing
   --delete #srccol where [is_ident] = 1

   --use spk as pk if provided
   if (exists(select 1 from #srccol where [spk] > 0))
   begin
      delete #srccol where [pk] > 0 and  [spk] = 0
      update #srccol set [pk] = [spk]
   end
   
   --remove pk requirement for staging
   if not exists(select 1 from #srccol where pk > 0)
   begin
      if (@needindex <> 0)
	  begin
         raiserror('WARNING: index can not be created. spk is required on %s',0,1,@src);
         set @needindex = 0;
	  end
      --raiserror('ERROR: pk is required in %s',11,10,@src)
   end
   if not exists(select 1 from #srccol)
   begin
      raiserror('ERROR: no source columns are found in %s',11,10,@src)
   end

-----------------------------------------------------------------------------------------------------
--check delta
-----------------------------------------------------------------------------------------------------
   if (@rebuild = 0)
   begin
      if object_id(@dst) is null
      begin
         set @rebuild = 1
      end
      else
      begin
         if exists(
            select 1 from (select d.[name] from sys.columns d where d.[object_id] = object_id(@dst)) d
              full join (select s.[name] from #srccol s) s
                on s.[name] = d.[name]
             where (s.[name] is null or d.name is null))
         begin
            exec ('drop table ' + @dst)
            set @rebuild = 1
         end
      end
   end
   else if object_id(@dst) is not null
   begin
      exec ('drop table ' + @dst)
   end


-----------------------------------------------------------------------------------------------------
--truncate or table create DDL
-----------------------------------------------------------------------------------------------------
   if (@rebuild = 0)
   begin
      set @query = 'truncate table ' + @dst + ';'
      if (@needIndex = 0 and exists(select 1 from sys.indexes where object_id = object_id(@dst) and name like 'uq_spk_%'))
         set @query = @query + 'drop index [uq_spk_' + parsename(@dst,1) + '] on ' + @dst + ';'
   end
   else
   begin
      set @query = 'create table ' + @dst + '(<columnlist>)'

      --<columnlist>
      set @sql1 = ''
      select @sql1 = @sql1 + ',' + quotename([name]) + ' ' + type_name([type])
                + case when [type] in (62) then '(' + cast(prec as nvarchar(10)) + ')'    
                       when [type] in (106,108) then '(' + cast(prec as nvarchar(10)) + ',' + cast(scale as nvarchar(10)) + ')'
                       when [type] in (165,167,173,175) then case when [len] = -1 then '(max)' else '(' + cast([len] as nvarchar(10)) + ')' end
                       when [type] in (231,239) then case when [len] = -1 then '(max)' else '(' + cast([len]/2 as nvarchar(10)) + ')' end
                       else '' 
                  end
                --+ case when ([pk] = 0) then ' null' else ' not null' end --+ char(13) + char(10)
                + case when ([is_null] = 0) then ' not null' else ' null' end --+ char(13) + char(10)
        from  #srccol
        order by [colid]

      set @sql1 = right(@sql1,len(@sql1) -1)
      set @query = replace(@query,'<columnlist>',@sql1)

   end

   if (@debug = 1)
   begin
      print @query
   end
   exec(@query)

 --create index for pre sorted input
   if (@rebuild = 1 and @needIndex > 0)
   begin
      set @query = 'create ' + case @needIndex when 1 then 'unique' else '' end + ' clustered index uq_spk_<tblname> on '
                 + @dst + '(<keycolumnlist>)'

      --<keycolumnlist>
      set @sql1 = ''
      select @sql1 = @sql1 + ',' + quotename([name])
        from  #srccol where [pk] > 0 and [is_type2] = 0
        order by [pk]

      set @sql1 = right(@sql1,len(@sql1) -1)
      set @query = replace(@query,'<keycolumnlist>',@sql1)
      set @query = replace(@query,'<tblname>',parsename(@dst,1))

      if (@debug = 1)
      begin
         print @query
      end
      exec(@query)
   end


end try
begin catch
   if @@trancount > @tran
      rollback tran

   set @dst = null
   set @Proc = ERROR_PROCEDURE()
   set @Msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   raiserror ('ERROR: PROC %s, MSG: %s',11,17,@Proc,@Msg) 
end catch

   return @err
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[@options]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[@src]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[@dst]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srcprop]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srcprop].[colname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srcprop].[propname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srcprop].[propvalue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[spk]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[pk]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[spk]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[pk]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[columns]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[columns].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[columns].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[columns].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[indexes]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[indexes].[object_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[indexes].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[type]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[prec]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[scale]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[len]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[is_null]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[colid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTablePrepare].[#srccol].[is_type2]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_StagingTablePrepare].[#srccol]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[name]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[type]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[len]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[prec]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[scale]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[is_ident]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[is_null]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[is_guid]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[colid]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[pk]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[spk]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srccol].[is_type2]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_StagingTablePrepare].[#srcprop]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srcprop].[colname]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srcprop].[propname]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTablePrepare].[#srcprop].[propvalue]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="30" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StagingTablePrepare].[@src]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StagingTablePrepare].[@dst]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StagingTablePrepare].[@runid]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StagingTablePrepare].[@options]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="12776" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="create procedure [dbo].[prc_StagingTablePrepare] (&#xD;&#xA;    @src           sysname&#xD;&#xA;   ,@dst           sysname = null output&#xD;&#xA;   ,@runid         int = null&#xD;&#xA;   ,@options       varchar(255) = null&#xD;&#xA;) as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_StagingTableUpload]">
			<Property Name="BodyScript">
				<Value><![CDATA[  
begin  
/******************************************************************************  
** File: [prc_StagingTableUpload].sql  
** Name: [dbo].[prc_StagingTableUpload]  
  
** Desc: Delete and Insert data from src into dst table. dst must have primary key.   
**            
**  
** Params:  
** @src  -- fully qualified source table name. if database is not specified the db  
**               defaults to current database, if schema is not specified schema defaults to dbo  
** @dst  -- domain destination. must exists in current database. if schema is not specified schema defaults to dbo  
** @options   -- debug
                ,fullmerge --insert+update+softdelete
				,reload --truncate+insert
				,append --insert without check
				,checksum --update only changed records
				,appendnew --insert new only
** Returns:  
**  
** Author: andreys  
** Date: 11/05/2008  
** ****************************************************************************  
** CHANGE HISTORY  
** ****************************************************************************  
** Date        Author   version  #bug   Description
** ----------------------------------------------------------------------------------------------------------  
** 20011-12-29 andrey                  added type2 logic. Type2 columns are included columns in the UQ_SPK index
                                                         also RecordStartDate, RecordEndDate columns are required  
   2012-03-08       andreys            add extended property metadata
														table: hasMetadata = 1
														column: isSPK = ordinal(1,2,3) --source PK ordinal
															    isType2 = 1 -- type2 column
																isAudit = 1 -- audit column
																isAction = 1 -- action column
																isType2StartPeriod -- Type2 start period column
																isType2EndPeriod -- Type2 end period column
  2012-05-30		andrey				fix Soft Delete. After Soft Delete set ActionId to 1 - insert
  2013-05-13		andrey				check for type2 columns
  2013-05-21		andrey				move type2 filter from join to match clause
  2017-01-21		andrey				fix merge when table has only PK or SPK columns
  2017-03-13		andrey				comment audit calls + allow identity on pk
  2017-03-30		andrey				remove src/dst db if the same to support azure dbs
  2018-01-10		andrey				replace binary_checksum logic with intersect
*/
--exec [prc_StagingTablePrepare] 'dbo.TestProperty','dbo.staging_TestProperty',0,'debug,rebuild,index'
  
   set nocount on  
  
   declare @err                int
   declare @tran               int
   declare @proc               sysname  
   declare @msg                nvarchar(1000)  
   declare @query              nvarchar(max)  
   declare @sql1               nvarchar(max)  
   declare @sql2               nvarchar(max)  
   declare @srcdb              sysname  
   declare @dstdb              sysname  
   declare @debug              bit
   declare @delete             bit
   declare @reload             bit
   declare @append             bit
   declare @appendnew      bit
   declare @check              bit
   declare @rows               int
   declare @is_tbl             tinyint
   declare @is_type2           bit

   declare @AuditCol           sysname
   declare @ActionCol          sysname
   declare @RecordStartCol     sysname
   declare @RecordEndCol       sysname

   set @proc = object_name(@@procid)  
   set @err = 0  
   set @tran = @@trancount
   set @debug = case when @options like '%debug%' then 1 else 0 end  
   set @delete = case when @options like '%fullmerge%' then 1 else 0 end
   set @reload = case when @options like '%reload%' then 1 else 0 end
   set @append = case when @options like '%append%' and @options not like '%appendnew%' then 1 else 0 end
   set @check = case when @options like '%checksum%' then 1 else 0 end
   set @appendnew = case when @options like '%appendnew%' then 1 else 0 end
                                                   
   set @RunId = ISNULL(@RunId,0)
   
-----------------------------------------------------------------------------------------------------
--metadata defaults
-----------------------------------------------------------------------------------------------------
   set @AuditCol = 'AuditId'
   set @ActionCol = 'ActionId'
   set @RecordStartCol = 'RecordStartDate'
   set @RecordEndCol = 'RecordEndDate'
-----------------------------------------------------------------------------------------------------  
--table name normalization  
-----------------------------------------------------------------------------------------------------  
   if (charindex('#',parsename(@src,1)) > 0)  
   begin  
      set @srcdb = quotename('tempdb') + '.';  
      set @src = quotename(parsename(@src,1))  
   end  
   else  
   begin  
      set @srcdb = isnull(parsename(@src,3),db_name())
      set @srcdb = case when @srcdb = db_name() then '' else quotename(@srcdb) + '.' end;

      set @src = @srcdb  
               + quotename(isnull(parsename(@src,2),'dbo')) + '.'
			   + quotename(parsename(@src,1));
   end  
  
   set @dstdb = isnull(parsename(@dst,3),db_name());
   set @dstdb = case when @dstdb = db_name() then '' else quotename(@dstdb) + '.' end;
   set @dst = @dstdb  
            + quotename(isnull(parsename(@dst,2),'dbo')) + '.'
			+ quotename(parsename(@dst,1))  
  
  
  create table #srccol  
  ([src_name] sysname  
  ,[type] smallint  
  ,[len]  smallint  
  ,[prec] tinyint  
  ,[scale] tinyint
  ,[spk] tinyint)  
  
  
  create table #dstcol  
  ([name] sysname  
  ,[src_name] sysname null  
  ,[type] smallint  
  ,[len]  smallint  
  ,[prec] tinyint  
  ,[scale] tinyint  
  ,[is_ident] bit  
  ,[is_null] bit  
  ,[is_guid] bit  
  ,[has_src] bit
  ,[is_add] bit
  ,[pk] tinyint 
  ,[spk] tinyint
  ,[is_type2] bit) 
  
  
  create table #dstprop
  ([colname] sysname
  ,[propname]  sysname
  ,[propvalue] nvarchar(30)
  )

begin try 
  
   set @is_tbl = 0;
   if (object_id(case when @srcdb = quotename('tempdb') + '.' then @srcdb + '.' else '' end + @src,'U') is not null)
      set @is_tbl = 1;
   else if (object_id(case when @srcdb = quotename('tempdb') + '.' then @srcdb + '.' else '' end + @src) is null)  
      raiserror('ERROR: unknown source table in %s',11,10,@src)  
     
   if (object_id(@dst) is null)  
   begin  
      raiserror('ERROR: unknown destination table in %s',11,10,@dst)  
   end  
  
-----------------------------------------------------------------------------------------------------  
--bring srcTable def over  
-----------------------------------------------------------------------------------------------------  
  
   set @query = '  
      insert #srccol  
      select s.[name],s.system_type_id,s.max_length,s.[precision],s.[scale],isnull(ispkc.[key_ordinal],0)  
        from ' + @srcdb + 'sys.columns s
    left join ' + @srcdb + 'sys.indexes ispk on ispk.[object_id] = s.[object_id] and  ispk.name like ''UQ_SPK_%''
    left join ' + @srcdb + 'sys.index_columns ispkc
           on ispk.[object_id] = ispkc.[object_id]
          and ispk.[index_id] = ispkc.[index_id]
          and s.[column_id] = ispkc.[column_id] 
       where s.[object_id] = object_id(''' + case when @srcdb = quotename('tempdb') + '.' then @srcdb + '.' else '' end + @src + ''')  
     '  
  
   --if (@debug = 1)  
   --begin  
   --   print @query  
   --end  
  
   exec(@query)  
  
   --if (@debug = 1)  
   --begin  
   --   select * from #srccol  
   --end  

-----------------------------------------------------------------------------------------------------  
--build column def set  
-----------------------------------------------------------------------------------------------------  
  set @query = '
declare @tbl sysname,@sch sysname;
set @tbl = parsename(@dst,1);
set @sch = parsename(@dst,2);
if exists(select 1 from <db>.sys.fn_listextendedproperty (NULL, ''schema'', @sch, ''table'', @tbl, default, default) where name = ''hasMetadata'' and value = 1)
begin
--use Extended Properties
   insert #dstprop
   select objname, name, cast(value as nvarchar(30)) from <db>.sys.fn_listextendedproperty (NULL, ''schema'', @sch, ''table'', @tbl, ''column'', default);

  insert #dstcol  
  select 
      [name]     = d.[name]
     ,[src_name] = s.[src_name]
     ,[type]     = d.system_type_id
     ,[len]      = d.max_length
     ,[prec]     = d.[precision]
     ,[scale]    = d.[scale]  
     ,[is_ident] = d.[is_identity]
     ,[is_null]  = d.[is_nullable]
     ,[is_guid]  = d.[is_rowguidcol]
     ,[has_src]  = case when s.[src_name] is null then 0 else 1 end
     ,[is_add]   = case when d.system_type_id in (48,52,56,59,60,62,106,108,122,127) then 1 else 0 end  
     ,isnull(ipkc.[key_ordinal],0)
     ,isnull(spk.[propvalue],0)
     ,isnull(t2.[propvalue],0)
    from <db>.sys.columns d  
    left join #srccol s on d.[name] = s.[src_name]  
    left join <db>.sys.indexes ipk on ipk.[object_id] = d.[object_id] and  ipk.[is_primary_key] = 1
    left join <db>.sys.index_columns ipkc
           on ipk.[object_id] = ipkc.[object_id]
          and ipk.[index_id] = ipkc.[index_id]
          and d.[column_id] = ipkc.[column_id]
    left join #dstprop spk on d.[name] = spk.[colname] and spk.[propname] = ''isSPK''
    left join #dstprop t2 on d.[name] = t2.[colname] and t2.[propname] = ''isType2''
    where d.[object_id] = object_id(@dst)

end
else
begin
--use defaults

  insert #dstcol  
  select 
      [name]     = d.[name]
     ,[src_name] = s.[src_name]
     ,[type]     = d.system_type_id
     ,[len]      = d.max_length
     ,[prec]     = d.[precision]
     ,[scale]    = d.[scale]  
     ,[is_ident] = d.[is_identity]
     ,[is_null]  = d.[is_nullable]
     ,[is_guid]  = d.[is_rowguidcol]
     ,[has_src]  = case when s.[src_name] is null then 0 else 1 end
     ,[is_add]   = case when d.system_type_id in (48,52,56,59,60,62,106,108,122,127) then 1 else 0 end  
     ,isnull(ipkc.[key_ordinal],0)
     ,isnull(ispkc.[key_ordinal],0)
     ,isnull(ispkc.[is_included_column],0)
    from <db>.sys.columns d  
    left join #srccol s on d.[name] = s.[src_name]  
    left join <db>.sys.indexes ipk on ipk.[object_id] = d.[object_id] and  ipk.[is_primary_key] = 1
    left join <db>.sys.index_columns ipkc
           on ipk.[object_id] = ipkc.[object_id]
          and ipk.[index_id] = ipkc.[index_id]
          and d.[column_id] = ipkc.[column_id]
    left join <db>.sys.indexes ispk on ispk.[object_id] = d.[object_id] and  ispk.name like ''UQ_SPK_%''
    left join <db>.sys.index_columns ispkc
           on ispk.[object_id] = ispkc.[object_id]
          and ispk.[index_id] = ispkc.[index_id]
          and d.[column_id] = ispkc.[column_id]
    where d.[object_id] = object_id(@dst)
end
'
  
   set @query = replace(@query,'<db>.',@dstdb)
   exec sp_executesql @query,N'@dst sysname',@dst = @dst

   --if (@debug is not null)
   --begin
   --   select * from #dstcol
   --end

   set @AuditCol = isnull((select top 1 [colname] from #dstprop where [propname] = 'isAudit' and [propvalue] = 1)
                            ,(select top 1 [name] from #dstcol where [name] = @AuditCol));
   set @ActionCol = isnull((select top 1 [colname] from #dstprop where [propname] = 'isAction' and [propvalue] = 1)
                            ,(select top 1 [name] from #dstcol where [name] = @ActionCol));
   set @RecordStartCol = isnull((select top 1 [colname] from #dstprop where [propname] = 'isType2StartPeriod' and [propvalue] = 1)
                            ,(select top 1 [name] from #dstcol where [name] = @RecordStartCol));
   set @RecordEndCol = isnull((select top 1 [colname] from #dstprop where [propname] = 'isType2EndPeriod' and [propvalue] = 1)
                            ,(select top 1 [name] from #dstcol where [name] = @RecordEndCol));

   set @is_type2 = 0;
   if (@RecordStartCol is not null and @RecordEndCol is not null)
   begin
      set @is_type2 = 1;
   end

   --remove dw specific columns
   delete #dstcol where [name] in (@AuditCol,@ActionCol,@RecordStartCol,@RecordEndCol)

if (@reload = 1 or @append = 1)
begin
-----------------------------------------------------------------------------------------------------  
--reload/append
-----------------------------------------------------------------------------------------------------  

   set @query =
 'declare @AuditId int,@Err int,@Rows int,@dt date;
set @dt = getdate();
begin try
if exists (select 1 from <src>)
begin
   --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId out,@AuditMode = 1,@AuditObject = ''<dst>'',@Op = ''<op>'',@RunId = @RunID,@Options = @Options
'
+ case when @reload = 1 then ' truncate table <dst> ' else '' end
+ '  
  <IdentityOn>
   insert <dst>
   (<dstlist>)
   select <selectlist>
     from <src>

  set @rows = @@rowcount
  --raiserror(''%d rows reloaded into <dst> table'',0,1,@rows) with nowait 
  <IdentityOff>

   --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 0,@RowCnt = @Rows,@Options = @Options
   --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 2,@Options = @Options

end  
end try  
begin catch
  <IdentityOff>
   declare @msg nvarchar(500)  
   set @msg = error_message()
   set @Err = error_number()
  
   --if (@AuditId is not null) 
   --   exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 2,@Err = @Err,@Options = @Options
   raiserror (@msg,11,17) 
end catch  
     '  
end
else
begin

   --use spk as pk if provided
   if (not exists(select 1 from #dstcol where [spk] > 0))
   begin
      update #dstcol set [spk] = [pk]
   end

  
   if (not exists(select 1 from #dstcol where [spk] > 0))  
   begin  
      raiserror('ERROR: dst table %s must have spk in order to join to src table',11,10,@dst)  
   end  
   if (exists(select 1 from #dstcol where [spk] > 0 and [has_src] = 0))  
   begin  
      raiserror('ERROR: src table must have dst spk columns present',11,10,@dst)  
   end  
   if (exists(select 1 from #dstcol where [pk] = 0 and [is_ident] = 1))  
   begin  
      raiserror('ERROR: identity on non pk column is not supported',11,10,@dst)  
   end  

   if (@is_type2 = 0)
   begin
-----------------------------------------------------------------------------------------------------  
--type1 merge
-----------------------------------------------------------------------------------------------------  
   set @query =
 'declare @AuditId int,@Err int,@Rows int
begin try
if exists (select 1 from <src>)
begin
  --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId out,@AuditMode = 1,@AuditObject = ''<dst>'',@Op = ''<op>'',@RunId = @RunID,@Options = @Options
  <performanceindex>

  <IdentityOn>
   merge <dst> as dst
   using (select <selectlist> from <src>) as src
         (<dstlist>)
      on (<joinlist>)
  --1  when matched <type1checksum> then 
  --1 update Set <updatelist>
       when not matched by target then 
      insert (<dstlist>)
      values (<dstlist>)
  --2  when not matched by source <delete>
  ;
--OUTPUT $action;

  set @rows = @@rowcount
  --raiserror(''%d rows merged into <dst> table'',0,1,@rows) with nowait 
  <IdentityOff>

  --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 0,@RowCnt = @Rows,@Options = @Options
  --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 2,@Options = @Options

end  
end try  
begin catch  
  <IdentityOff>
   declare @msg nvarchar(500)  
   set @msg = error_message()
   set @Err = error_number()
  
   --if (@AuditId is not null) 
   --   exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 2,@Err = @Err,@Options = @Options
   raiserror (@msg,11,17) 
end catch  
     '  
--<appendnew> option
--or dst only has pk/spk columns (no need for update)
   if (@appendnew = 0
   and exists (select 1 from #dstcol where spk = 0 and has_src = 1))
      set @query = replace(@query,'--1','')


--<fullmerge> option
--<delete>
   if (@delete = 1)
   begin
      set @query = replace(@query,'--2','');
	  if (@ActionCol is null)
         set @query = replace(@query,'<delete>','then delete'); --hard delete if action col is not defined
	  else
	  begin
	     set @sql1 = ' and dst.' +  @ActionCol + ' <> 3 then update set dst.' +  @ActionCol + ' = 3' + case when @AuditCol is not null then ',dst.' +  @AuditCol + ' = @AuditId' else '' end;
		 set @query = replace(@query,'<delete>',@sql1);
	  end
   end


   end
   else
   begin
-----------------------------------------------------------------------------------------------------  
--type2 merge
-----------------------------------------------------------------------------------------------------  
--if type2 columns are not defined set all none key columns to type2
   if (not exists(select 1 from #dstcol where [is_type2] = 1))  
   begin  
      update #dstcol set [is_type2] = 1 where [spk] = 0;
      SET @rows = @@ROWCOUNT;
      if (@rows = 0)
		raiserror('ERROR: no type2 columns found',11,10)  
   end

   set @query =
 'declare @AuditId int,@Err int,@Rows int,@tran int,@dt date;
 set @tran = @@TRANCOUNT;
 set @dt = getdate();
begin try
if exists (select 1 from <src>)
begin
  --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId out,@AuditMode = 1,@AuditObject = ''<dst>'',@Op = ''<op>'',@RunId = @RunID,@Options = @Options
  <performanceindex>

   begin tran;
   merge <dst> as dst
   using (select <selectlist> from <src>) as src
         (<dstlist>)
      on (<joinlist>)
    when matched <type2checksum>
	and (dst.' + @RecordEndCol + ' is null and dst.' + @RecordStartCol + ' < @dt) then 
  update Set dst.' + @RecordEndCol + ' = @dt;

  set @rows = @@rowcount
  --raiserror(''%d rows t2 closed recorded merged into <dst> table'',0,1,@rows) with nowait 

   merge <dst> as dst
   using (select <selectlist> from <src>) as src
         (<dstlist>)
      on (<joinlist>)
	 and (dst.' + @RecordEndCol + ' is null)
--1	when matched <type1checksum> then
--1  update Set <updatelist>
       when not matched by target then 
      insert (<dstlist>)
      values (<dstlist>);

  set @rows = @rows + @@rowcount
  --raiserror(''%d rows t1 merged into <dst> table'',0,1,@rows) with nowait 

  commit tran;

  --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 0,@RowCnt = @Rows,@Options = @Options
  --exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 2,@Options = @Options

end  
end try  
begin catch

   if  (@tran < @@TRANCOUNT) 
      rollback tran;

   declare @msg nvarchar(500)  
   set @msg = error_message()
   set @Err = error_number()
  
   --if (@AuditId is not null) 
   --   exec <dstdb>.dbo.prc_Audit @AuditId = @AuditId,@AuditMode = 2,@Err = @Err,@Options = @Options
   raiserror (@msg,11,17) 
end catch  
     '  

--dst only has pk/spk columns (no need for update)
   if exists (select 1 from #dstcol where spk = 0 and has_src = 1)
      set @query = replace(@query,'--1','')


--<type2checksum>
   set @sql1 = ''
   set @sql2 = ''
   select @sql1 = @sql1 + ',src.' + quotename([src_name]) 
       ,@sql2 = @sql2 + ',dst.' + quotename([name])  
    from  #dstcol where [has_src] = 1 and [is_type2] = 1
      
   if (len(@sql1) > 0)
   begin
	   set @sql1 = right(@sql1,len(@sql1) -1)
	   set @sql2 = right(@sql2,len(@sql2) -1)
	   --set @sql1 = ' and binary_checksum(' + @sql1 + ') <> binary_checksum(' + @sql2 + ')'
	   set @sql1 = ' and not exists (select ' + @sql1 + ' intersect select ' + @sql2 + ')'
	   set @query = replace(@query,'<type2checksum>',@sql1)
   end

   end



--<performanceindex>
   set @sql1 = ''
   if (@is_tbl = 1 and not exists(select 1 from #srccol where [spk] > 0))
   begin
      select @sql1 = @sql1 + ',' + quotename([src_name])
        from  #dstcol where [spk] > 0 and [is_type2] = 0
        order by [spk]
      
	  select @sql1 = 'create unique clustered index [uq_spk_' + parsename(@src,1) + '] on <src>(' + right(@sql1,len(@sql1) -1) +')'
   end

   set @query = replace(@query,'<performanceindex>',@sql1)


--<type1checksum> option
   set @sql1 = ''
   set @sql2 = ''
   if (@check = 1)
   begin
      select @sql1 = @sql1 + ',src.' + quotename([src_name]) 
            ,@sql2 = @sql2 + ',dst.' + quotename([name])  
      from  #dstcol where [has_src] = 1 and [spk] = 0 --and [is_type2] = 0
      
      if (len(@sql1) > 0)
	  begin
		  set @sql1 = right(@sql1,len(@sql1) -1)
		  set @sql2 = right(@sql2,len(@sql2) -1)
		  --set @sql1 = ' and (binary_checksum(' + @sql1 + ') <> binary_checksum(' + @sql2 + ')'
		  set @sql1 = ' and (not exists (select ' + @sql1 + ' intersect select ' + @sql2 + ')'
					+ case when @ActionCol is not null then ' or dst.' + @ActionCol + ' = 3' else '' end + ')'
      end          
   end
   set @query = replace(@query,'<type1checksum>',@sql1)

--<joinlist>
   set @sql1 = ''
   select @sql1 = @sql1 + ' and src.' + quotename([name]) + ' = dst.' + quotename([src_name])
     from  #dstcol where [spk] > 0 and [is_type2] = 0

   set @sql1 = right(@sql1,len(@sql1) -4)
   set @query = replace(@query,'<joinlist>',@sql1)


--<updatelist>
   set @sql1 = case when @AuditCol is not null then ',dst.' + @AuditCol + ' = @AuditId' else '' end
             + case when @ActionCol is not null then ',dst.' + @ActionCol + ' = case dst.' + @ActionCol + ' when 3 then 1 else 2 end' else '' end  --insert if deleted else update
   select @sql1 = @sql1 + ',dst.' + quotename([name]) + ' = src.' + quotename([src_name]) 
         ,@sql2 = @sql2 + ',' + quotename([name])  
   from  #dstcol where [has_src] = 1 and [spk] = 0 --and [is_type2] = 0

   
   if (len(@sql1) > 0)
   begin
	   set @sql1 = right(@sql1,len(@sql1) -1)
	   set @query = replace(@query,'<updatelist>',@sql1)
   end
end

--<selectlist>
--<dstlist>
set @sql1 = case when @AuditCol is not null then ',@AuditId' else '' end
          + case when @ActionCol is not null then ',1' else '' end  --insert
          + case when @is_type2 = 1 then ',@dt,null' else '' end 
set @sql2 = case when @AuditCol is not null then ',' + @AuditCol else '' end
          + case when @ActionCol is not null then ',' + @ActionCol else '' end
          + case when @is_type2 = 1 then ',' + @RecordStartCol + ',' + @RecordEndCol else '' end
select @sql1 = @sql1 + ',' + quotename([src_name])  
      ,@sql2 = @sql2 + ',' + quotename([name])  
from  #dstcol where [has_src] = 1 

set @sql1 = right(@sql1, len(@sql1)-1) -- remove leading comma
set @sql2 = right(@sql2, len(@sql2)-1) -- remove leading comma  

set @query = replace(@query, '<selectlist>', @sql1)  
set @query = replace(@query, '<dstlist>', @sql2)  

--<Identity>
if exists(select 1 from  #dstcol where [is_ident] = 1 and [has_src] = 1) -- and [pk] = 0
begin
   set @query = replace(@query, '<IdentityOn>', 'set identity_insert <dst> on;')  
   set @query = replace(@query, '<IdentityOff>', 'set identity_insert <dst> off;')  
end
else
begin
   set @query = replace(@query, '<IdentityOn>', '')  
   set @query = replace(@query, '<IdentityOff>', '')  
end

--<src>  
--<dst>  
--<dstdb>  
set @query = replace(@query, '<dst>', @dst)  
set @query = replace(@query, '<src>', @src)  
set @query = replace(@query, '<dstdb>.', @dstdb)  
  
--<op>
set @sql1 = case when @reload = 1 then 'RELOAD'
               when @append = 1 then 'APPEND'
			   when @is_type2 = 1 then 'MERGE_T2'
               else 'MERGE_T1'
			 end
set @query = replace(@query, '<op>', @sql1)  

if (@debug = 1)  
begin  
  print @query  
end                 

exec sp_executesql @query,N'@RunID int,@Options varchar(255)',@RunID = @RunID,@Options = @Options

end try  
begin catch  
   if @@trancount > @tran  
      rollback tran  
  
   set @Proc = ERROR_PROCEDURE()  
   set @Msg = ERROR_MESSAGE()  
   set @Err = ERROR_NUMBER()  
   raiserror ('ERROR: PROC %s, MSG: %s',11,17,@Proc,@Msg)   
end catch  
  
   return @err  
end
;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[@options]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[@RunId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[@src]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[@dst]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstprop]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstprop].[colname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstprop].[propname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstprop].[propvalue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[spk]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[spk]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[pk]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[has_src]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[pk]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[is_ident]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[is_type2]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[is_type2]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[src_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#dstcol].[has_src]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#srccol]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StagingTableUpload].[#srccol].[spk]" />
				</Entry>
				<Entry />
				<Entry />
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_StagingTableUpload].[#srccol]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#srccol].[src_name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#srccol].[type]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#srccol].[len]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#srccol].[prec]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#srccol].[scale]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#srccol].[spk]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_StagingTableUpload].[#dstcol]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[src_name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[type]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[len]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[prec]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[scale]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[is_ident]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[is_null]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[is_guid]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[has_src]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[is_add]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[pk]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[spk]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstcol].[is_type2]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_StagingTableUpload].[#dstprop]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstprop].[colname]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstprop].[propname]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_StagingTableUpload].[#dstprop].[propvalue]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="30" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StagingTableUpload].[@src]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StagingTableUpload].[@dst]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StagingTableUpload].[@RunId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StagingTableUpload].[@options]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="24452" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="create procedure [dbo].[prc_StagingTableUpload] (  &#xD;&#xA;    @src      sysname  &#xD;&#xA;   ,@dst      sysname&#xD;&#xA;   ,@RunId    int = 0&#xD;&#xA;   ,@options  varchar(255) = null  &#xD;&#xA;) as" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ProgressStatus]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ProgressStatus].[ProgressStatusId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="13" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ProgressStatus].[ProgressStatusName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="30" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="15" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ProgressStatus].[CreateDt]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="9" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ProgressStatus].[ChangeDt]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="10" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ProgressStatus].[ChangeBy]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="30" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="11" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
	</Model>
</DataSchemaModel>