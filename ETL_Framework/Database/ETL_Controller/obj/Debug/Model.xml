<?xml version="1.0" encoding="utf-8"?>
<DataSchemaModel FileFormatVersion="1.2" SchemaVersion="2.4" DspName="Microsoft.Data.Tools.Schema.Sql.Sql120DatabaseSchemaProvider" CollationLcid="1033" CollationCaseSensitive="False" xmlns="http://schemas.microsoft.com/sqlserver/dac/Serialization/2012/02">
	<Header>
		<CustomData Category="AnsiNulls">
			<Metadata Name="AnsiNulls" Value="True" />
		</CustomData>
		<CustomData Category="QuotedIdentifier">
			<Metadata Name="QuotedIdentifier" Value="True" />
		</CustomData>
		<CustomData Category="CompatibilityMode">
			<Metadata Name="CompatibilityMode" Value="120" />
		</CustomData>
		<CustomData Category="Reference" Type="SqlSchema">
			<Metadata Name="FileName" Value="C:\PROGRAM FILES (X86)\MICROSOFT VISUAL STUDIO 14.0\COMMON7\IDE\EXTENSIONS\MICROSOFT\SQLDB\EXTENSIONS\SQLSERVER\120\SQLSCHEMAS\MASTER.DACPAC" />
			<Metadata Name="LogicalName" Value="master.dacpac" />
			<Metadata Name="ExternalParts" Value="[master]" />
			<Metadata Name="SuppressMissingDependenciesErrors" Value="False" />
		</CustomData>
		<CustomData Category="Reference" Type="Assembly">
			<Metadata Name="LogicalName" Value="ControllerClrExtensions.dll" />
			<Metadata Name="FileName" Value="C:\GITHUB\ETL-ACCELERATOR\ETL_FRAMEWORK\TOOLS\CONTROLLERCLREXTENSIONS\BIN\DEBUG\CONTROLLERCLREXTENSIONS.DLL" />
			<Metadata Name="AssemblyName" Value="ControllerClrExtensions" />
			<Metadata Name="PermissionSet" Value="SAFE" />
			<Metadata Name="Owner" Value="" />
			<Metadata Name="GenerateSqlClrDdl" Value="True" />
			<Metadata Name="IsVisible" Value="True" />
			<Metadata Name="IsModelAware" Value="True" />
			<Metadata Name="SkipCreationIfEmpty" Value="False" />
			<Metadata Name="AssemblySymbolsName" />
		</CustomData>
		<CustomData Category="Reference" Type="Assembly">
			<Metadata Name="LogicalName" Value="ETL_Controller.dll" />
			<Metadata Name="FileName" Value="C:\GITHUB\ETL-ACCELERATOR\ETL_FRAMEWORK\DATABASE\ETL_CONTROLLER\OBJ\DEBUG\ETL_CONTROLLER.DLL" />
			<Metadata Name="AssemblyName" Value="ETL_Controller" />
			<Metadata Name="PermissionSet" Value="SAFE" />
			<Metadata Name="Owner" Value="" />
			<Metadata Name="GenerateSqlClrDdl" Value="True" />
			<Metadata Name="IsVisible" Value="True" />
			<Metadata Name="IsModelAware" Value="True" />
			<Metadata Name="SkipCreationIfEmpty" Value="True" />
			<Metadata Name="AssemblySymbolsName" Value="C:\github\etl-accelerator\ETL_Framework\Database\ETL_Controller\obj\Debug\ETL_Controller.pdb" />
		</CustomData>
		<CustomData Category="SqlCmdVariables" Type="SqlCmdVariable" />
	</Header>
	<Model>
		<Element Type="SqlDatabaseOptions">
			<Property Name="Collation" Value="SQL_Latin1_General_CP1_CI_AS" />
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Property Name="IsAnsiWarningsOn" Value="True" />
			<Property Name="IsArithAbortOn" Value="True" />
			<Property Name="IsConcatNullYieldsNullOn" Value="True" />
			<Property Name="IsCursorDefaultScopeGlobal" Value="True" />
			<Property Name="IsTornPageProtectionOn" Value="False" />
			<Property Name="RecoveryMode" Value="1" />
			<Property Name="IsTrustworthyOn" Value="True" />
			<Property Name="ServiceBrokerOption" Value="1" />
			<Property Name="DefaultLanguage" Value="" />
			<Property Name="DefaultFullTextLanguage" Value="" />
			<Relationship Name="DefaultFilegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(getdate())]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CreatedDTim]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="5" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(getdate())]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[ModifiedDTim]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="6" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(suser_sname())]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLBatchRun]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[ModifiedBY]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="7" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value QuotedIdentifiers="True"><![CDATA[(getdate())]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Dsv]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Dsv].[FromDT]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="8" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value QuotedIdentifiers="True"><![CDATA[('9999-12-31')]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Dsv]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Dsv].[ToDT]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="9" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStep].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStep].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="10" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepAttribute].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepAttribute]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="11" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepConstraint].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepConstraint]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="12" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="13" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRun].[RunID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRun].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepRun]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="14" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="15" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunHistory].[RunID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunHistory].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunHistory].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="16" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunHistoryLog].[RunID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunHistoryLog].[LogID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="17" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatch].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="18" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="19" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="20" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="21" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchRun].[RunID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLBatchRun]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="22" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLProcess].[ProcessID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLProcess]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="23" />
		</Element>
		<Element Type="SqlUniqueConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStep].[StepName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStep].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="24" />
		</Element>
		<Element Type="SqlUniqueConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRun].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRun].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepRun]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="25" />
		</Element>
		<Element Type="SqlUniqueConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunHistoryLog].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunHistoryLog].[StepID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLStepRunHistoryLog].[LogID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="26" />
		</Element>
		<Element Type="SqlUniqueConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatch].[BatchName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="27" />
		</Element>
		<Element Type="SqlUniqueConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchRun].[BatchID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[ETLBatchRun].[RunID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[ETLBatchRun]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="28" />
		</Element>
		<Element Type="SqlRoute" Name="[AutoCreatedLocal]">
			<Property Name="Address" Value="LOCAL" />
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlAssembly" Name="[ControllerClrExtensions]">
			<Relationship Name="AssemblySources">
				<Entry>
					<Element Type="SqlAssemblySource">
						<Property Name="Source">
							<Value><![CDATA[0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300E376D5590000000000000000E00022200B013000001A0000000600000000000002380000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000B03700004F00000000400000D403000000000000000000000000000000000000006000000C000000783600001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E746578740000000818000000200000001A000000020000000000000000000000000000200000602E72737263000000D40300000040000000040000001C0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000002000000000000000000000000000004000004200000000000000000000000000000000E4370000000000004800000002000500742600000410000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B300300B9000000010000110002731000000A0A0000066F1100000A0000DE040B00077A720100007006731200000A0C00081A6F1300000A00086F1400000A7225000070038C110000016F1500000A26086F1400000A723B000070048C120000016F1500000A26086F1400000A7255000070056F1500000A26086F1400000A726B0000700E048C110000016F1500000A2608166F1600000A0000086F1700000A2600DE040D00097A00DE0B082C07086F1800000A00DC00DE0B062C07066F1800000A00DC2A00000001340000000009000B1400041500000100008D000B98000415000001020024007B9F000B0000000002000800A5AD000B000000001B300300F0010000010000110002731000000A0A0000066F1100000A0000DE040B00077A727D00007006731200000A0C00081A6F1300000A00086F1400000A729F0000701F0E6F1900000A7E1A00000A8C170000016F1B00000A00086F1400000A729F0000706F1C00000A186F1D00000A00086F1400000A723B0000701A6F1900000A7E1E00000A8C120000016F1B00000A00086F1400000A723B0000706F1C00000A186F1D00000A00086F1400000A72B10000701A6F1900000A7E1E00000A8C120000016F1B00000A00086F1400000A72B10000706F1C00000A186F1D00000A00086F1400000A72550000701F198C250000016F1500000A281F00000A6F1B00000A00086F1400000A72550000706F1C00000A186F1D00000A00086F1400000A72250000700E058C110000016F1500000A26086F1400000A726B0000700E068C110000016F1500000A2608166F1600000A0000086F1700000A2603086F1400000A729F0000706F1C00000A6F2000000AA517000001811700000104086F1400000A723B0000706F1C00000A6F2000000AA512000001811200000105086F1400000A72B10000706F1C00000A6F2000000AA51200000181120000010E04086F1400000A72550000706F1C00000A6F2000000A74130000015100DE040D00097A00DE0B082C07086F1800000A00DC00DE0B062C07066F1800000A00DC2A4164000000000000090000000B000000140000000400000015000001000000004701000088000000CF01000004000000150000010200000024000000B2010000D60100000B000000000000000200000008000000DC010000E40100000B00000000000000133003003900000002000011000516FE010A062C03002B2C0314FE030B072C1A00031604282100000A6F2200000A0002036F2300000A00002B0A0002046F2400000A00002A0000001B3007001A0100000300001100140A282500000A0A0F05FE16110000016F2600000A72CF0000706F2700000A0B72DB0000700F01FE16110000016F2600000A0F00FE16110000016F2600000A282800000A0C17282900000A0D00282A00000A6F2B00000A6F2C00000A1304178D1E000001251672760100701F0C20A00F00006A732D00000AA21305141306282E00000A130711071106727E0100701104066F2F00000A282800000A072803000006000804050E040E052801000006001107110672EC0100701A8D100000012516098C1B000001A225170F00FE16110000016F2600000AA225180F01FE16110000016F2600000AA225190F02FE16110000016F2600000AA2283000000A0728030000060016282900000A0D00DE042600FE1A0913082B0011082A00000110000000004D00C10E0104100000011B3007001E0100000300001100140A282500000A0A0F07FE16110000016F2600000A72CF0000706F2700000A0B72DB0000700F01FE16110000016F2600000A0F00FE16110000016F2600000A282800000A0C17282900000A0D00282A00000A6F2B00000A6F2C00000A1304178D1E000001251672760100701F0C20A00F00006A732D00000AA21305141306282E00000A130711071106723E0200701104066F2F00000A282800000A072803000006000804050E040E050E060E072802000006001107110672AC0200701A8D100000012516098C1B000001A225170F00FE16110000016F2600000AA225180F01FE16110000016F2600000AA225190F06FE16110000016F2600000AA2283000000A0728030000060016282900000A0D00DE042600FE1A0913082B0011082A00000110000000004D00C5120104100000012202283100000A002A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000050040000237E0000BC040000F405000023537472696E677300000000B00A00000403000023555300B40D0000100000002347554944000000C40D00004002000023426C6F620000000000000002000001471502000900000000FA013300160000010000002C00000003000000060000001E00000031000000100000000300000001000000020000000000FC020100000000000600F60147040600630247040600140115040F006704000006003C0149030600D90149030600BA01490306004A02490306001602490306002F02490306006901490306002801280406000601280406009D01490306008401B2020600350531030A00CF0276040A00B40076040A00210376040A007F0348050600AE0331030A006C0048050A005A0076040A00C900E6030A007C00E6030A005301E6030A00010076040600E405E2020600410331030A001F00E6030A007203B8030A006200B8030A00DF0013000A005B0348050A00D903480506008A0031030A00D10013000A00CD03B8030A009B0313000A009205E6030600DB0231030600B80549030600A70049030600D1059504000000000A000000000001000100810110000805B50441000100010001001000DB04B50441000100030050200000000096006B05E90001004C210000000096005E05F6000600AC2300000000910077000B010D00F4230000000096007505150111002C25000000009600A502260117006826000000008618010406001F0000000100070400000200EB00000003004000000004008B04000005001705000001000704020002003400020003004000020004004C00020005008B0400000600EB0000000700170500000100CB0300000200130400000300360300000400880000000100FA0300000200F50000000300EB00000004004000000005008B0400000600170500000100FA0300000200F500020003003400020004004000020005004C00020006008B0400000700EB00000008001705090001040100110001040600190001040A00290001041000310001041000390001041000410001041000490001041000510001041000590001041000610001041500690001041000710001041000790001041000D10001040600A10001041000F90038030600B100010425000101DB002C00B1001F05330011018B02390001017F0501000101C10541002101FE00060011013C004500B9001C034F0031018102530011012803580031018D035F0091001C036600990018036A00190198026F0089003C057800C900CC027E00C1009D058500C100770010004101E0059F008100D902A4004901AC04A80049012E05AD00D9003C05B4005101AC05BA0051019F00C00059013D03C600F1000104CB004101C000D40061019600A40049012E05D9008100010406002E000B003F012E00130048012E001B0067012E00230070012E002B007E012E0033007E012E003B0084012E00430070012E004B0093012E0053007E012E005B007E012E006300B4012E006B00DE012E007300EB0180007B003902A0007B0039021A0073008B00048000000100000000000100000000000000F0040000040000000000000000000000E0002B0000000000040000000000000000000000E00013000000000000000053716C496E743332003C4D6F64756C653E0053797374656D2E446174610053716C4D65746144617461006D73636F726C6962004576656E74496400416464004576656E74506F73746564004576656E7452656365697665640053716C47756964004462436F6D6D616E640053716C436F6D6D616E640053656E640053716C446174615265636F72640049446973706F7361626C65006765745F4E616D65004765744E616D6500417373656D626C794E616D650053716C4461746554696D65006765745F506970650053716C506970650053716C446254797065007365745F436F6D6D616E6454797065004576656E745479706500446174616261736500446973706F736500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C654174747269627574650053716C50726F63656475726541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F56616C7565004164645769746856616C7565006765745F53716C56616C7565004576656E74526563656976650053797374656D2E52756E74696D652E56657273696F6E696E670053657453716C537472696E6700546F537472696E670053797374656D2E53656375726974792E5072696E636970616C00436F6E74726F6C6C6572436C72457874656E73696F6E732E646C6C006765745F4E756C6C0053716C586D6C006765745F4974656D0053797374656D004F70656E006765745F56657273696F6E0053797374656D2E5265666C656374696F6E0053716C506172616D65746572436F6C6C656374696F6E004462436F6E6E656374696F6E0053716C436F6E6E656374696F6E007365745F446972656374696F6E00506172616D65746572446972656374696F6E00457863657074696F6E0053797374656D2E446174612E436F6D6D6F6E0070004462506172616D657465720053716C506172616D65746572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F7200436F6E6E656374696F6E5374720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C5479706573004576656E74417267730053797374656D2E53656375726974792E436C61696D7300436F6E7461696E730045544C5F4672616D65776F726B2E436F6E74726F6C6C6572434C52457874656E73696F6E7300436F6E74726F6C6C6572457874656E73696F6E7300436F6E74726F6C6C6572436C72457874656E73696F6E73004576656E7446756E6374696F6E73004F7074696F6E73006765745F506172616D657465727300466F726D6174004F626A656374006F705F496D706C696369740053797374656D2E446174612E53716C436C69656E7400526563656976654576656E7400506F73744576656E74004576656E74506F7374007365745F436F6D6D616E6454696D656F75740053716C436F6E746578740053656E64526573756C7473526F7700476574457865637574696E67417373656D626C7900457865637574654E6F6E517565727900436C61696D734964656E74697479006765745F57696E646F77734964656E74697479000023640062006F002E007000720063005F004500760065006E00740050006F0073007400001540004500760065006E0074005400790070006500001940004500760065006E00740050006F007300740065006400001540004500760065006E0074004100720067007300001140004F007000740069006F006E0073000021640062006F002E007000720063005F004500760065006E007400470065007400001140004500760065006E00740049004400001D40004500760065006E00740052006500630065006900760065006400000B640065006200750067000080995000650072007300690073007400200053006500630075007200690074007900200049006E0066006F003D00460061006C00730065003B0049006E00740065006700720061007400650064002000530065006300750072006900740079003D0053005300500049003B00640061007400610062006100730065003D007B0030007D003B007300650072007600650072003D007B0031007D0000076D0073006700006D43006F006E00740072006F006C006C0065007200200043006C007200200045007800740065006E00730069006F006E0073002000560065007200730069006F006E0020007B0030007D00200045007800650063007500740069006E00670020006100730020007B0031007D000051530071006C0043006C00720020004500760065006E00740050006F007300740020007B0031007D002E007B0032007D0020002D0020007B0033007D00200063006F006D0070006C006500740065006400016D43006F006E00740072006F006C006C0065007200200043004C005200200045007800740065006E00730069006F006E0073002000560065007200730069006F006E0020007B0030007D00200045007800650063007500740069006E00670020006100730020007B0031007D000057530071006C0043006C00720020004500760065006E007400520065006300650069007600650020007B0031007D002E007B0032007D0020002D0020007B0033007D00200063006F006D0070006C006500740065006400017907E67DD245B946AF06C9224CBFCF6700042001010803200001052001011111042001010E04200101020A07041251125512591255062002010E12510620010111808505200012808907200212808D0E1C0320000809200212808D0E1180950306115D042001011C06200112808D0E0620010111809D03061149040000124D0320001C040702020205000111450E062002010811450520010112651307091271020E116D12751D127912651261116D04000012710320000E042001020E0600030E0E1C1C050001116D080500001280A90520001280AD0420001275082003010E1180950A04000012610600020E0E1D1C08B77A5C561934E0890C0005010E11451149124D1145140007010E10115D10114910114910124D1145114509000401126112650E02100006116D1145114511451149124D1145180008116D1145114510115D10114910114910124D114511450801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000701000000000D010008446553716C536C7200000501000000000E0100094D6963726F736F667400002001001B436F7079726967687420C2A9204D6963726F736F6674203230303900002901002430353635646536622D376663302D343065372D623230612D34613836613638333062393300000C010007312E302E302E3100004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E352E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E352E320401000000000000000000E376D55900000000020000001C010000943600009418000052534453EF29DE33B8A07D41B41E2B13460FBC3F01000000433A5C6769746875625C65746C2D616363656C657261746F725C45544C5F4672616D65776F726B5C546F6F6C735C436F6E74726F6C6C6572436C72457874656E73696F6E735C6F626A5C44656275675C436F6E74726F6C6C6572436C72457874656E73696F6E732E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D83700000000000000000000F2370000002000000000000000000000000000000000000000000000E4370000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000780300000000000000000000780334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000100000000000100010000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004D8020000010053007400720069006E006700460069006C00650049006E0066006F000000B402000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000034000A00010043006F006D00700061006E0079004E0061006D006500000000004D006900630072006F0073006F006600740000003A0009000100460069006C0065004400650073006300720069007000740069006F006E000000000044006500530071006C0053006C00720000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003100000058001C00010049006E007400650072006E0061006C004E0061006D006500000043006F006E00740072006F006C006C006500720043006C00720045007800740065006E00730069006F006E0073002E0064006C006C0000005A001B0001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020004D006900630072006F0073006F006600740020003200300030003900000000002A00010001004C006500670061006C00540072006100640065006D00610072006B007300000000000000000060001C0001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000043006F006E00740072006F006C006C006500720043006C00720045007800740065006E00730069006F006E0073002E0064006C006C000000320009000100500072006F0064007500630074004E0061006D0065000000000044006500530071006C0053006C00720000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003100000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0031000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000043800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000]]></Value>
						</Property>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Dsv]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Dsv].[DsvID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Dsv].[DsvName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="30" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Dsv].[DsvType]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Dsv].[FromDT]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="8" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Dsv].[ToDT]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="9" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Dsv].[Dsv]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLBatch]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[BatchName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="30" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[BatchDesc]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[OnSuccessID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[OnFailureID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[IgnoreErr]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[RestartOnErr]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[StatusDT]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[StatusID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[Err]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatch].[EndTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="18" />
			<AttachedAnnotation Disambiguator="27" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLBatchAttribute]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchAttribute].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchAttribute].[AttributeName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchAttribute].[AttributeValue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="8000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="19" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLBatchConstraint]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraint].[ConstID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraint].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraint].[ProcessID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraint].[ConstOrder]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraint].[WaitPeriod]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="20" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLBatchConstraintAttribute]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="8000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="21" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLBatchRun]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchRun].[RunID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchRun].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchRun].[StatusDT]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchRun].[StatusID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchRun].[Err]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchRun].[StartTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchRun].[EndTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLBatchRun].[ModifiedBY]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="7" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="22" />
			<AttachedAnnotation Disambiguator="28" />
		</Element>
		<Element Type="SqlXmlSchemaCollection" Name="[dbo].[ETLClient_DE]">
			<Property Name="SchemaExpression">
				<Value><![CDATA[N'<?xml version="1.0"?>
<xsd:schema xmlns="DeltaExtractor.XSD" xmlns:xsd="http://www.w3.org/2001/XMLSchema" targetNamespace="DeltaExtractor.XSD"  elementFormDefault="qualified">
	<!-- Guid Pattern definition -->
	<xsd:simpleType name="GUID">
		<xsd:restriction base="xsd:string">
			<xsd:pattern value="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}" />
		</xsd:restriction>
	</xsd:simpleType>
  
	<!-- List of possible actions -->
	<xsd:simpleType name="Actions">
		<xsd:restriction base="xsd:string">
      <xsd:enumeration value="MoveData" />
    </xsd:restriction>
	</xsd:simpleType>


  <!-- Sharepoint Destination Action -->
  <xsd:simpleType name="SPAction">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="Modification" />
      <xsd:enumeration value="Deletion" />
    </xsd:restriction>
  </xsd:simpleType>

  <!-- AccessMode -->
  <xsd:simpleType name="AccessMode">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="OpenRowset" />
      <xsd:enumeration value="OpenRowset From Variable" />
      <xsd:enumeration value="SQL Command" />
      <xsd:enumeration value="SQL Command From Variable" />
      <xsd:enumeration value="Table or view" />
      <xsd:enumeration value="Table Name" />
      <xsd:enumeration value="OpenRowset Using FastLoad" />
      <xsd:enumeration value="OpenRowset Using FastLoad From Variable" />
    </xsd:restriction>
  </xsd:simpleType>

  <!-- BindNumericMode -->
  <xsd:simpleType name="NumericMode">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="Char" />
      <xsd:enumeration value="Numeric" />
    </xsd:restriction>
  </xsd:simpleType>

  <!-- BindCharMode -->
  <xsd:simpleType name="CharMode">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="ANSI" />
      <xsd:enumeration value="Unicode" />
    </xsd:restriction>
  </xsd:simpleType>

  <!-- FetchMode -->
  <xsd:simpleType name="FetchMode">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="Batch" />
      <xsd:enumeration value="Row by row" />
    </xsd:restriction>
  </xsd:simpleType>

  <xsd:simpleType name="CompressionMethod">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="GZIP" />
      <xsd:enumeration value="XPRESS" />
      <xsd:enumeration value="ZIP" />
      <xsd:enumeration value="NONE" />
    </xsd:restriction>
  </xsd:simpleType>
  
	<xsd:simpleType name="ExcelVersion">
		<xsd:restriction base="xsd:string">
      <xsd:enumeration value="Microsoft Excel 97-2003" />
      <xsd:enumeration value="Microsoft Excel 2007" />
      <xsd:enumeration value="Microsoft Excel 2010" />
      <xsd:enumeration value="Microsoft Excel 2013" />
    </xsd:restriction>
	</xsd:simpleType>

  <xsd:simpleType name="FlatFileFormat">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="Delimited" />
      <xsd:enumeration value="FixedWidth" />
      <xsd:enumeration value="RaggedRight" />
    </xsd:restriction>
  </xsd:simpleType>

  <xsd:simpleType name="QueryType">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="SQL" />
      <xsd:enumeration value="MDX" />
      <xsd:enumeration value="XMLA" />
    </xsd:restriction>
  </xsd:simpleType>

  <xsd:simpleType name="PartitionFunction">
    <xsd:restriction base="xsd:string">
      <xsd:enumeration value="UPS" />
      <xsd:enumeration value="SRC" />
      <xsd:enumeration value="NONE" />
    </xsd:restriction>
  </xsd:simpleType>

  <!-- Partition block properties -->
  <xsd:complexType name="PartitionBlock">
    <xsd:sequence>
      <xsd:element name="Input" type="xsd:string" maxOccurs="1" minOccurs="0" />
      <xsd:element name="Output" type="xsd:string" maxOccurs="1" minOccurs="0" />
    </xsd:sequence>
    <xsd:attribute name="Function" type="PartitionFunction" use="required"/>
  </xsd:complexType>


  <!-- Partition range properties -->
  <xsd:complexType name="PartitionRange">
    <xsd:attribute name="Min" type="xsd:int" use="optional"/>
    <xsd:attribute name="Max" type="xsd:int" use="optional"/>
  </xsd:complexType>


  <!-- ODataSource -->
  <xsd:complexType name="ODataSource">
    <xsd:sequence>
      <xsd:element name="ConnectionString" type="xsd:string" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="DefaultStringLength" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="CollectionName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="Query" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="ResourcePath" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="UseResourcePath" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>

  <!-- SharePointSource -->
  <xsd:complexType name="SharePointSource">
    <xsd:sequence>
      <xsd:element name="ConnectionString" type="xsd:string" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="BatchSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="CamlQuery" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="IncludeFolders" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="IsRecursive" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SharePointCulture" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SiteListName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SiteListViewName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SiteUrl" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="DecodeLookupColumns" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="IncludeHiddenColumns" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="UseConnectionManager" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>

  <!-- SharePointDestination -->
  <xsd:complexType name="SharePointDestination">
    <xsd:sequence>
      <xsd:element name="ConnectionString" type="xsd:string" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="BatchSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BatchType" type="SPAction" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SharePointCulture" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SiteListName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SiteListViewName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SiteUrl" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="UseConnectionManager" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>

  <!-- FlatFileSource -->
  <xsd:complexType name="FlatFileSource">
    <xsd:sequence>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="CodePage" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="ConnectionString" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="DataRowsToSkip" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="Format" type="FlatFileFormat" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="ColumnNamesInFirstDataRow" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="HeaderRowDelimiter" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="HeaderRowsToSkip" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="TextQualifier" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="Unicode" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="ColumnDelimiter" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="RecordDelimiter" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="FileNameColumnName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="RetainNulls" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="DataCompression" type="CompressionMethod" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="StagingAreaTableName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>

  <!-- FlatFileDestination -->
  <xsd:complexType name="FlatFileDestination">
    <xsd:sequence>
      <xsd:element name="PartitionRange" type="PartitionRange" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="CodePage" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="ConnectionString" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="DataRowsToSkip" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="Format" type="FlatFileFormat" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="ColumnNamesInFirstDataRow" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="HeaderRowDelimiter" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="HeaderRowsToSkip" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="TextQualifier" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="Unicode" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="ColumnDelimiter" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="RecordDelimiter" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="Header" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="Override" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="DataCompression" type="CompressionMethod" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="StagingAreaTableName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>


  <!-- ExcelSource -->
  <xsd:complexType name="ExcelSource">
    <xsd:sequence>
      <xsd:element name="ConnectionString" type="xsd:string" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="FilePath" type="xsd:string" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="Header" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="ExcelVersion" type="ExcelVersion" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="AccessMode" type="AccessMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="OpenRowset" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SqlCommand" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="CommandTimeout" type="xsd:int" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
      <xsd:element name="DataCompression" type="CompressionMethod" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="StagingAreaTableName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
    </xsd:sequence>
  </xsd:complexType>

  <!-- ExcelDestination -->
  <xsd:complexType name="ExcelDestination">
    <xsd:sequence>
      <xsd:element name="ConnectionString" type="xsd:string" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="FilePath" type="xsd:string" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="Header" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="ExcelVersion" type="ExcelVersion" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="PartitionRange" type="PartitionRange" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="AccessMode" type="AccessMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="OpenRowset" type="xsd:string" minOccurs="1" maxOccurs="1"/>
            <xsd:element name="CommandTimeout" type="xsd:int" minOccurs="1" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
      <xsd:element name="DataCompression" type="CompressionMethod" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="StagingAreaTableName" type="xsd:string" minOccurs="0" maxOccurs="1"/>
    </xsd:sequence>
  </xsd:complexType>


  <!-- Database Connection -->
	<xsd:complexType name="DBConnection">
    <xsd:sequence>
      <xsd:choice>
        <xsd:sequence>
          <xsd:element name="Server" type="xsd:string" maxOccurs="1" minOccurs="0" />
          <xsd:element name="Database" type="xsd:string" maxOccurs="1" minOccurs="0" />
        </xsd:sequence>
        <xsd:sequence>
          <xsd:element name="ConnectionString" type="xsd:string" maxOccurs="1" minOccurs="0" />
          <xsd:element name="Qualifier" type="xsd:string" maxOccurs="1" minOccurs="0" />
        </xsd:sequence>
      </xsd:choice>
      <xsd:element name="QueryTimeout" type="xsd:integer" maxOccurs="1" minOccurs="0" />
    </xsd:sequence>
	</xsd:complexType>

	<!-- OLEDB Source -->
	<xsd:complexType name="OleDbSource">
		<xsd:sequence>
			<xsd:element name="DBConnection" type="DBConnection" minOccurs="1" maxOccurs="1"/>
      <xsd:element name="QueryType" type="QueryType" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
				<xsd:complexType>
					<xsd:sequence>
						<xsd:element name="AccessMode" type="AccessMode" minOccurs="0" maxOccurs="1"/>
						<xsd:element name="SqlCommand" type="xsd:string" minOccurs="1" maxOccurs="1"/>
						<xsd:element name="CommandTimeout" type="xsd:int" minOccurs="0" maxOccurs="1"/>
					</xsd:sequence>
				</xsd:complexType>
			</xsd:element>
		</xsd:sequence>
	</xsd:complexType>

  <!-- ADONET Source -->
  <xsd:complexType name="AdoNetSource">
    <xsd:sequence>
      <xsd:element name="DBConnection" type="DBConnection" minOccurs="1" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="AccessMode" type="AccessMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SqlCommand" type="xsd:string" minOccurs="1" maxOccurs="1"/>
            <xsd:element name="CommandTimeout" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="AllowImplicitStringConversion" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>

  <!-- ODBC Source -->
  <xsd:complexType name="OdbcSource">
    <xsd:sequence>
      <xsd:element name="DBConnection" type="DBConnection" minOccurs="1" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="AccessMode" type="AccessMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="SqlCommand" type="xsd:string" minOccurs="1" maxOccurs="1"/>
            <xsd:element name="StatementTimeout" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BatchSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="LobChunkSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="ExposeCharColumnsAsUnicode" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="FetchMethod" type="FetchMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="DefaultCodePage" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BindNumericAs" type="NumericMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BindCharColumnsAs" type="CharMode" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>


  <!-- Staging block properties -->
  <xsd:complexType name="StagingBlock">
    <xsd:sequence>
      <xsd:element name="StagingTableName" type="xsd:string" maxOccurs="1" minOccurs="0" />
      <xsd:element name="StagingTablePrepare" type="xsd:string" maxOccurs="1" minOccurs="0" />
      <xsd:element name="StagingTableUpload" type="xsd:string" maxOccurs="1" minOccurs="0" />
      <xsd:element name="UserOptions" type="xsd:string" minOccurs="0" maxOccurs="1"/>
    </xsd:sequence>
    <xsd:attribute name="Staging" type="xsd:boolean" use="required"/>
  </xsd:complexType>


  <!-- OLEDB Destination -->
	<xsd:complexType name="OleDbDestination">
		<xsd:sequence>
			<xsd:element name="DBConnection" type="DBConnection" minOccurs="1" maxOccurs="1"/>
			<xsd:element name="StagingBlock" type="StagingBlock" maxOccurs="1" minOccurs="0" />
      <xsd:element name="PartitionRange" type="PartitionRange" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
				<xsd:complexType>
					<xsd:sequence>
						<xsd:element name="AccessMode" type="AccessMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="OpenRowset" type="xsd:string" minOccurs="1" maxOccurs="1"/>
            <xsd:element name="FastLoadOptions" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="FastLoadKeepIdentity" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="FastLoadKeepNulls" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="FastLoadMaxInsertCommitSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="CommandTimeout" type="xsd:int" minOccurs="0" maxOccurs="1"/>
					</xsd:sequence>
				</xsd:complexType>
			</xsd:element>
		</xsd:sequence>
	</xsd:complexType>

  <!-- ADONET Destination -->
  <xsd:complexType name="AdoNetDestination">
    <xsd:sequence>
      <xsd:element name="DBConnection" type="DBConnection" minOccurs="1" maxOccurs="1"/>
      <xsd:element name="StagingBlock" type="StagingBlock" maxOccurs="1" minOccurs="0" />
      <xsd:element name="PartitionRange" type="PartitionRange" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="TableOrViewName" type="xsd:string" minOccurs="1" maxOccurs="1"/>
            <xsd:element name="BatchSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="UseBulkInsertWhenPossible" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="CommandTimeout" type="xsd:int" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>

  <!-- ODBC Destination -->
  <xsd:complexType name="OdbcDestination">
    <xsd:sequence>
      <xsd:element name="DBConnection" type="DBConnection" minOccurs="1" maxOccurs="1"/>
      <xsd:element name="StagingBlock" type="StagingBlock" maxOccurs="1" minOccurs="0" />
      <xsd:element name="PartitionRange" type="PartitionRange" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="InsertMethod" type="FetchMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BindCharColumnsAs" type="CharMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BindNumericAs" type="NumericMode" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="TableName" type="xsd:string" minOccurs="1" maxOccurs="1"/>
            <xsd:element name="BatchSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="TransactionSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="LobChunkSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="StatementTimeout" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="DefaultCodePage" type="xsd:int" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>

  <!-- SQLBULK Destination -->
  <xsd:complexType name="SqlBulkDestination">
    <xsd:sequence>
      <xsd:element name="DBConnection" type="DBConnection" minOccurs="1" maxOccurs="1"/>
      <xsd:element name="StagingBlock" type="StagingBlock" maxOccurs="1" minOccurs="0" />
      <xsd:element name="PartitionRange" type="PartitionRange" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="CustomProperties">
        <xsd:complexType>
          <xsd:sequence>
            <xsd:element name="DefaultCodePage" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="AlwaysUseDefaultCodePage" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertTableName" type="xsd:string" minOccurs="1" maxOccurs="1"/>
            <xsd:element name="BulkInsertCheckConstraints" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertFirstRow" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertFireTriggers" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertKeepIdentity" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertKeepNulls" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertLastRow" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertMaxErrors" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertOrder" type="xsd:string" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="BulkInsertTablock" type="xsd:boolean" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="Timeout" type="xsd:int" minOccurs="0" maxOccurs="1"/>
            <xsd:element name="MaxInsertCommitSize" type="xsd:int" minOccurs="0" maxOccurs="1"/>
          </xsd:sequence>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
  </xsd:complexType>


  <!-- Complex type for destinations -->
	<xsd:complexType name="DataDestination">
    <xsd:sequence>
      <xsd:element name="OleDbDestination" type="OleDbDestination" minOccurs="0" maxOccurs="unbounded"/>
      <xsd:element name="FlatFileDestination" type="FlatFileDestination" minOccurs="0" maxOccurs="unbounded"/>
      <xsd:element name="ExcelDestination" type="ExcelDestination" minOccurs="0" maxOccurs="unbounded"/>
      <xsd:element name="SharePointDestination" type="SharePointDestination" minOccurs="0" maxOccurs="unbounded"/>
      <xsd:element name="AdoNetDestination" type="AdoNetDestination" minOccurs="0" maxOccurs="unbounded"/>
      <xsd:element name="OdbcDestination" type="OdbcDestination" minOccurs="0" maxOccurs="unbounded"/>
      <xsd:element name="SqlBulkDestination" type="SqlBulkDestination" minOccurs="0" maxOccurs="unbounded"/>
    </xsd:sequence>
	</xsd:complexType>


	<!-- Complex type for sources -->
	<xsd:complexType name="DataSource">
	 <xsd:choice>
	  <xsd:sequence>
	    <xsd:element name="OleDbSource" type="OleDbSource" minOccurs="0" maxOccurs="1"/>
	  </xsd:sequence>
	  <xsd:sequence>
        <xsd:element name="FlatFileSource" type="FlatFileSource" minOccurs="0" maxOccurs="1" />
      </xsd:sequence>
      <xsd:sequence>
        <xsd:element name="ExcelSource" type="ExcelSource" minOccurs="0" maxOccurs="1" />
      </xsd:sequence>
      <xsd:sequence>
        <xsd:element name="SharePointSource" type="SharePointSource" minOccurs="0" maxOccurs="1" />
      </xsd:sequence>
      <xsd:sequence>
        <xsd:element name="AdoNetSource" type="AdoNetSource" minOccurs="0" maxOccurs="1"/>
      </xsd:sequence>
      <xsd:sequence>
        <xsd:element name="OdbcSource" type="OdbcSource" minOccurs="0" maxOccurs="1"/>
      </xsd:sequence>
      <xsd:sequence>
        <xsd:element name="ODataSource" type="ODataSource" minOccurs="0" maxOccurs="1"/>
      </xsd:sequence>
    </xsd:choice>
  </xsd:complexType>


	<xsd:complexType name="MoveData">
		<xsd:sequence maxOccurs="1" minOccurs="1">
			<xsd:element name="DataSource" type="DataSource" maxOccurs="1" minOccurs="1" />
			<xsd:element name="DataDestination" type="DataDestination" minOccurs="1" maxOccurs="1" />
			<xsd:element name="StagingAreaRoot" type="xsd:string" minOccurs="0" maxOccurs="1"/>
      <xsd:element name="Partition" type="PartitionBlock" maxOccurs="1" minOccurs="0" />
      <xsd:element name="SavePackage" maxOccurs="1" minOccurs="0">
        <xsd:complexType>
          <xsd:simpleContent>
            <xsd:extension base="xsd:string">
              <xsd:attribute name="Save" type="xsd:boolean"  use="required"/>
              <xsd:attribute name="Load" type="xsd:boolean"  use="optional"/>
            </xsd:extension>
          </xsd:simpleContent>
        </xsd:complexType>
      </xsd:element>
    </xsd:sequence>
	</xsd:complexType>

  <xsd:complexType name="RunPackage">
    <xsd:sequence maxOccurs="1" minOccurs="1">
      <xsd:element name="File" type="xsd:string" maxOccurs="1" minOccurs="1" />
    </xsd:sequence>
  </xsd:complexType>

  <!-- ETL_Controller Header -->
  <xsd:complexType name="ETLHeader">
    <xsd:sequence maxOccurs="1" minOccurs="1">
      <xsd:element name="BatchID" type="xsd:int" maxOccurs="1" minOccurs="1" />
      <xsd:element name="StepID" type="xsd:int" maxOccurs="1" minOccurs="1" />
      <xsd:element name="RunID" type="xsd:int" maxOccurs="1" minOccurs="1" />
      <xsd:element name="Controller" type="DBConnection" maxOccurs="1" minOccurs="1" />
      <xsd:element name="Node" type="DBConnection" maxOccurs="1" minOccurs="0" />
      <xsd:element name="Conversation" type="GUID" maxOccurs="1" minOccurs="0" />
      <xsd:element name="ConversationGrp" type="GUID" maxOccurs="1" minOccurs="0" />
      <xsd:element name="Options" type="xsd:int" maxOccurs="1" minOccurs="0" />
    </xsd:sequence>
  </xsd:complexType>

  <!-- BIAS Workflow header -->
  <xsd:complexType name="BIASHeader">
    <xsd:complexContent>
      <xsd:restriction base="xsd:anyType">
        <xsd:sequence />
        <xsd:attribute name="RunID" type="xsd:int" use="required" />
        <xsd:attribute name="UserOptions" type="xsd:string" />
      </xsd:restriction>
    </xsd:complexContent>
  </xsd:complexType>


  <!-- Parameters to be passed -->
	<xsd:complexType name="Parameters">
		<xsd:sequence minOccurs="1" maxOccurs="1">
      <xsd:choice>
        <xsd:sequence>
          <xsd:element name="ETLHeader" type="ETLHeader" maxOccurs="1" minOccurs="0" />
        </xsd:sequence>
        <xsd:sequence>
          <xsd:element name="BIASHeader" type="BIASHeader" maxOccurs="1" minOccurs="0" />
        </xsd:sequence>
      </xsd:choice>
      <xsd:choice>
				<xsd:sequence>
					<xsd:element name="MoveData" type="MoveData"  maxOccurs="1" minOccurs="0"/>
				</xsd:sequence>
        <xsd:sequence>
          <xsd:element name="RunPackage" type="RunPackage"  maxOccurs="1" minOccurs="0"/>
        </xsd:sequence>
      </xsd:choice>
    </xsd:sequence>
	</xsd:complexType>
	<xsd:element name="Parameters" type="Parameters" />
</xsd:schema>']]></Value>
			</Property>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlXmlSchemaCollection" Name="[dbo].[ETLController]">
			<Property Name="SchemaExpression">
				<Value><![CDATA[N'<xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:t="ETLController.XSD" targetNamespace="ETLController.XSD" elementFormDefault="qualified">
  <xsd:element name="Attributes" type="t:Attributes" />
  <xsd:element name="Context" type="t:Context" />
  <xsd:element name="Counters">
    <xsd:complexType>
      <xsd:complexContent>
        <xsd:restriction base="xsd:anyType">
          <xsd:sequence>
            <xsd:element name="Counter" minOccurs="0" maxOccurs="unbounded">
              <xsd:complexType>
                <xsd:simpleContent>
                  <xsd:extension base="xsd:string">
                    <xsd:attribute name="Name" type="xsd:string" use="required" />
                    <xsd:attribute name="RunID" type="xsd:int" use="required" />
                  </xsd:extension>
                </xsd:simpleContent>
              </xsd:complexType>
            </xsd:element>
          </xsd:sequence>
          <xsd:attribute name="BatchID" type="xsd:int" use="required" />
          <xsd:attribute name="StepID" type="xsd:int" />
          <xsd:attribute name="ConstID" type="xsd:int" />
          <xsd:attribute name="RunID" type="xsd:int" use="required" />
        </xsd:restriction>
      </xsd:complexContent>
    </xsd:complexType>
  </xsd:element>
  <xsd:element name="Header" type="t:Header" />
  <xsd:element name="ProcessInfo">
    <xsd:complexType>
      <xsd:complexContent>
        <xsd:restriction base="xsd:anyType">
          <xsd:sequence>
            <xsd:element name="Header" type="t:Header" />
            <xsd:element name="Message">
              <xsd:complexType>
                <xsd:simpleContent>
                  <xsd:extension base="xsd:string">
                    <xsd:attribute name="Error" type="xsd:int" />
                  </xsd:extension>
                </xsd:simpleContent>
              </xsd:complexType>
            </xsd:element>
          </xsd:sequence>
          <xsd:attribute name="Error" type="xsd:int" />
        </xsd:restriction>
      </xsd:complexContent>
    </xsd:complexType>
  </xsd:element>
  <xsd:element name="ProcessReceipt">
    <xsd:complexType>
      <xsd:complexContent>
        <xsd:restriction base="xsd:anyType">
          <xsd:sequence>
            <xsd:element name="Header" type="t:Header" />
            <xsd:element name="Status">
              <xsd:complexType>
                <xsd:complexContent>
                  <xsd:restriction base="xsd:anyType">
                    <xsd:sequence>
                      <xsd:element name="msg" type="xsd:string" minOccurs="0" />
                    </xsd:sequence>
                    <xsd:attribute name="StatusID" type="xsd:int" use="required" />
                    <xsd:attribute name="Error" type="xsd:int" use="required" />
                  </xsd:restriction>
                </xsd:complexContent>
              </xsd:complexType>
            </xsd:element>
          </xsd:sequence>
        </xsd:restriction>
      </xsd:complexContent>
    </xsd:complexType>
  </xsd:element>
  <xsd:element name="ProcessRequest">
    <xsd:complexType>
      <xsd:complexContent>
        <xsd:restriction base="xsd:anyType">
          <xsd:sequence>
            <xsd:element name="Header" type="t:Header" />
            <xsd:element name="SrcConversation" type="xsd:string" minOccurs="0" />
            <xsd:element name="SrcConversationGrp" type="xsd:string" minOccurs="0" />
            <xsd:element name="DstConversation" type="xsd:string" minOccurs="0" />
            <xsd:element name="DstConversationGrp" type="xsd:string" minOccurs="0" />
            <xsd:element name="Context" type="t:Context" minOccurs="0" />
          </xsd:sequence>
        </xsd:restriction>
      </xsd:complexContent>
    </xsd:complexType>
  </xsd:element>
  <xsd:complexType name="Attributes">
    <xsd:complexContent>
      <xsd:restriction base="xsd:anyType">
        <xsd:sequence>
          <xsd:element name="Attribute" minOccurs="0" maxOccurs="unbounded">
            <xsd:complexType>
              <xsd:simpleContent>
                <xsd:extension base="xsd:string">
                  <xsd:attribute name="Name" type="xsd:string" use="required" />
                </xsd:extension>
              </xsd:simpleContent>
            </xsd:complexType>
          </xsd:element>
        </xsd:sequence>
      </xsd:restriction>
    </xsd:complexContent>
  </xsd:complexType>
  <xsd:complexType name="Constraints">
    <xsd:complexContent>
      <xsd:restriction base="xsd:anyType">
        <xsd:sequence>
          <xsd:element name="Constraint" minOccurs="0" maxOccurs="unbounded">
            <xsd:complexType>
              <xsd:complexContent>
                <xsd:restriction base="xsd:anyType">
                  <xsd:sequence>
                    <xsd:element name="Process" type="t:Process" />
                    <xsd:element name="Attributes" type="t:Attributes" minOccurs="0" maxOccurs="unbounded" />
                  </xsd:sequence>
                  <xsd:attribute name="ConstID" type="xsd:int" use="required" />
                  <xsd:attribute name="ConstOrder" type="xsd:string" />
                  <xsd:attribute name="WaitPeriod" type="xsd:int" />
                  <xsd:attribute name="Disabled" type="xsd:int" />
                  <xsd:attribute name="Ping" type="xsd:int" />
                </xsd:restriction>
              </xsd:complexContent>
            </xsd:complexType>
          </xsd:element>
        </xsd:sequence>
      </xsd:restriction>
    </xsd:complexContent>
  </xsd:complexType>
  <xsd:complexType name="Context">
    <xsd:complexContent>
      <xsd:restriction base="xsd:anyType">
        <xsd:sequence>
          <xsd:element name="OnSuccess" type="t:Process" minOccurs="0" />
          <xsd:element name="OnFailure" type="t:Process" minOccurs="0" />
          <xsd:element name="Attributes" type="t:Attributes" minOccurs="0" maxOccurs="unbounded" />
          <xsd:element name="Constraints" type="t:Constraints" minOccurs="0" maxOccurs="unbounded" />
          <xsd:element name="Steps" minOccurs="0">
            <xsd:complexType>
              <xsd:complexContent>
                <xsd:restriction base="xsd:anyType">
                  <xsd:sequence>
                    <xsd:element name="Step" minOccurs="0" maxOccurs="unbounded">
                      <xsd:complexType>
                        <xsd:complexContent>
                          <xsd:restriction base="xsd:anyType">
                            <xsd:sequence>
                              <xsd:element name="Process" type="t:Process" />
                              <xsd:element name="OnSuccess" type="t:Process" minOccurs="0" />
                              <xsd:element name="OnFailure" type="t:Process" minOccurs="0" />
                              <xsd:element name="Attributes" type="t:Attributes" minOccurs="0" maxOccurs="unbounded" />
                              <xsd:element name="Constraints" type="t:Constraints" minOccurs="0" maxOccurs="unbounded" />
                            </xsd:sequence>
                            <xsd:attribute name="StepID" type="xsd:int" use="required" />
                            <xsd:attribute name="StepName" type="xsd:string" />
                            <xsd:attribute name="StepDesc" type="xsd:string" />
                            <xsd:attribute name="StepOrder" type="xsd:string" />
                            <xsd:attribute name="IgnoreErr" type="xsd:int" />
                            <xsd:attribute name="Restart" type="xsd:int" />
                            <xsd:attribute name="Disabled" type="xsd:int" />
                            <xsd:attribute name="SeqGroup" type="xsd:string" />
                            <xsd:attribute name="PriGroup" type="xsd:string" />
                            <xsd:attribute name="Retry" type="xsd:int" />
                            <xsd:attribute name="Delay" type="xsd:int" />
                            <xsd:attribute name="LoopGroup" type="xsd:string" />
                          </xsd:restriction>
                        </xsd:complexContent>
                      </xsd:complexType>
                    </xsd:element>
                  </xsd:sequence>
                </xsd:restriction>
              </xsd:complexContent>
            </xsd:complexType>
          </xsd:element>
        </xsd:sequence>
        <xsd:attribute name="BatchID" type="xsd:int" use="required" />
        <xsd:attribute name="BatchName" type="xsd:string" />
        <xsd:attribute name="BatchDesc" type="xsd:string" />
        <xsd:attribute name="IgnoreErr" type="xsd:int" />
        <xsd:attribute name="Restart" type="xsd:int" />
        <xsd:attribute name="Disabled" type="xsd:int" />
        <xsd:attribute name="MaxThread" type="xsd:int" />
        <xsd:attribute name="Timeout" type="xsd:int" />
        <xsd:attribute name="Lifetime" type="xsd:int" />
        <xsd:attribute name="Ping" type="xsd:int" />
        <xsd:attribute name="HistRet" type="xsd:int" />
        <xsd:attribute name="Retry" type="xsd:int" />
        <xsd:attribute name="Delay" type="xsd:int" />
      </xsd:restriction>
    </xsd:complexContent>
  </xsd:complexType>
  <xsd:complexType name="Header">
    <xsd:complexContent>
      <xsd:restriction base="xsd:anyType">
        <xsd:sequence />
        <xsd:attribute name="BatchID" type="xsd:int" use="required" />
        <xsd:attribute name="StepID" type="xsd:int" />
        <xsd:attribute name="ConstID" type="xsd:int" />
        <xsd:attribute name="RunID" type="xsd:int" use="required" />
        <xsd:attribute name="Options" type="xsd:int" />
        <xsd:attribute name="Scope" type="xsd:int" />
      </xsd:restriction>
    </xsd:complexContent>
  </xsd:complexType>
  <xsd:complexType name="Process">
    <xsd:complexContent>
      <xsd:restriction base="xsd:anyType">
        <xsd:sequence>
          <xsd:element name="Process" type="xsd:string" minOccurs="0" />
          <xsd:element name="Param" type="xsd:string" minOccurs="0" />
        </xsd:sequence>
        <xsd:attribute name="ProcessID" type="xsd:int" use="required" />
        <xsd:attribute name="ScopeID" type="xsd:int" />
      </xsd:restriction>
    </xsd:complexContent>
  </xsd:complexType>
</xsd:schema>']]></Value>
			</Property>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlQueue" Name="[dbo].[ETLController_Receipt_Queue]">
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[status]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[priority]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[queuing_order]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[conversation_group_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[conversation_handle]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[message_sequence_number]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[service_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="512" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[service_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[service_contract_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[service_contract_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[message_type_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[message_type_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[validation]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="2" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[message_body]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varbinary]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Receipt_Queue].[message_enqueue_time]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlQueue" Name="[dbo].[ETLController_Request_Queue]">
			<Property Name="IsActivationOn" Value="True" />
			<Property Name="MaxQueueReaders" Value="32" />
			<Relationship Name="ActivationProcedure">
				<Entry>
					<References Name="[dbo].[prc_ProcessQueue]" />
				</Entry>
			</Relationship>
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[status]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[priority]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[queuing_order]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[conversation_group_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[conversation_handle]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[message_sequence_number]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[service_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="512" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[service_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[service_contract_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[service_contract_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[message_type_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="256" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[message_type_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[validation]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="2" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[message_body]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varbinary]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLController_Request_Queue].[message_enqueue_time]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="User">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLProcess]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLProcess].[ProcessID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLProcess].[Process]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLProcess].[Param]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="2048" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLProcess].[ScopeID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="23" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLStep]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[StepID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[StepName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[StepDesc]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[StepProcID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[OnSuccessID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[OnFailureID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[IgnoreErr]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[StepOrder]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[StatusDT]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[StatusID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStep].[Err]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="10" />
			<AttachedAnnotation Disambiguator="24" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLStepAttribute]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepAttribute].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepAttribute].[StepID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepAttribute].[AttributeName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepAttribute].[AttributeValue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="8000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="11" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLStepConstraint]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraint].[ConstID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraint].[StepID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraint].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraint].[ProcessID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraint].[ConstOrder]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraint].[WaitPeriod]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="12" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLStepConstraintAttribute]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraintAttribute].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraintAttribute].[StepID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraintAttribute].[ConstID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="8000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="13" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLStepRun]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[RunID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[StepID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[StatusDT]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[StatusID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[spid]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[StepOrder]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[IgnoreErr]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[Err]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[StartTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[EndTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[SeqGroup]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[PriGroup]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRun].[SvcName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="14" />
			<AttachedAnnotation Disambiguator="25" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLStepRunCounter]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunCounter].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunCounter].[StepID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunCounter].[RunID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunCounter].[CounterName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunCounter].[CounterValue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunCounter].[CreatedDTim]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smalldatetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="5" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunCounter].[ModifiedDTim]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smalldatetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="6" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="15" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLStepRunHistory]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[RunID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[StepID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[StatusDT]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[StatusID]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[spid]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[StepOrder]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[IgnoreErr]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[Err]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[StartTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[EndTime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[SeqGroup]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[PriGroup]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistory].[SvcName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="16" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[ETLStepRunHistoryLog]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistoryLog].[LogID]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistoryLog].[RunID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistoryLog].[BatchID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistoryLog].[StepID]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistoryLog].[Err]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistoryLog].[LogDT]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[ETLStepRunHistoryLog].[LogMessage]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="17" />
			<AttachedAnnotation Disambiguator="26" />
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[EventPost]">
			<Property Name="IsAnsiNullsOn" />
			<Property Name="IsQuotedIdentifierOn" />
			<Property Name="MethodName" Value="EventPost" />
			<Property Name="ClassName" Value="ETL_Framework.ControllerCLRExtensions.ControllerExtensions" />
			<Relationship Name="Assembly">
				<Entry>
					<References Name="[ControllerClrExtensions]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventPost].[@Server]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventPost].[@Database]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventPost].[@EventType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventPost].[@EventPosted]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventPost].[@EventArgs]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventPost].[@Options]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[EventReceive]">
			<Property Name="IsAnsiNullsOn" />
			<Property Name="IsQuotedIdentifierOn" />
			<Property Name="MethodName" Value="EventReceive" />
			<Property Name="ClassName" Value="ETL_Framework.ControllerCLRExtensions.ControllerExtensions" />
			<Relationship Name="Assembly">
				<Entry>
					<References Name="[ControllerClrExtensions]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventReceive].[@Server]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventReceive].[@Database]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventReceive].[@EventId]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventReceive].[@EventPosted]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventReceive].[@EventReceived]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventReceive].[@EventArgs]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventReceive].[@EventType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[EventReceive].[@Options]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[fn_AttributeGet]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_AttributeGet].[@ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_AttributeGet].[@StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_AttributeGet].[@AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_AttributeGet].[@BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[RestartOnErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[fn_AttributeGet].sql
** Name:	[dbo].[fn_AttributeGet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Function/[fn_AttributeGet].sql:

** Desc:	return  user defined attribute value for batch/step/const combination
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	08/01/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/
   declare @v nvarchar(4000)

   if (@ConstId is not null and @StepID is null)
      if (@AttributeName = 'ConstOrder')
         select @v = ConstOrder from dbo.[ETLBatchConstraint] where BatchID = @BatchID and ConstId = @ConstID;
      else if (@AttributeName = 'WaitPeriod')
         select @v = WaitPeriod from dbo.[ETLBatchConstraint] where BatchID = @BatchID and ConstId = @ConstID;
      else 
         select @v = AttributeValue
           from dbo.[ETLBatchConstraintAttribute]
          where BatchID = @BatchID and ConstId = @ConstID and AttributeName = @AttributeName;
   else if (@ConstId is not null and @StepID is not null)
      if (@AttributeName = 'ConstOrder')
         select @v = ConstOrder from dbo.[ETLStepConstraint] where BatchID = @BatchID and StepID = @StepID and ConstId = @ConstID;
      else if (@AttributeName = 'WaitPeriod')
         select @v = WaitPeriod from dbo.[ETLStepConstraint] where BatchID = @BatchID and StepID = @StepID and ConstId = @ConstID;
      else 
         select @v = AttributeValue
           from dbo.[ETLStepConstraintAttribute]
          where BatchID = @BatchID and StepID = @StepID and ConstId = @ConstID and AttributeName = @AttributeName
   else if (@StepID is not null)
       if (@AttributeName = 'StepName')
         select @v = StepName from dbo.[ETLStep] where BatchID = @BatchID and StepID = @StepID;
       else if (@AttributeName = 'StepDesc')
         select @v = StepDesc from dbo.[ETLStep] where BatchID = @BatchID and StepID = @StepID;
       else if (@AttributeName = 'IgnoreErr')
         select @v = IgnoreErr from dbo.[ETLStep] where BatchID = @BatchID and StepID = @StepID;
       else if (@AttributeName = 'StepOrder')
         select @v = StepOrder from dbo.[ETLStep] where BatchID = @BatchID and StepID = @StepID;
       else
         select @v = AttributeValue
           from dbo.[ETLStepAttribute]
          where BatchID = @BatchID and StepID = @StepID and AttributeName = @AttributeName
   else 
       if (@AttributeName = 'BatchName')
         select @v = BatchName from dbo.[ETLBatch] where BatchID = @BatchID;
       else if (@AttributeName = 'BatchDesc')
         select @v = BatchDesc from dbo.[ETLBatch] where BatchID = @BatchID;
       else if (@AttributeName = 'IgnoreErr')
         select @v = IgnoreErr from dbo.[ETLBatch] where BatchID = @BatchID;
       else if (@AttributeName = 'RestartOnErr')
         select @v = RestartOnErr from dbo.[ETLBatch] where BatchID = @BatchID;
       else
         select @v = AttributeValue
           from dbo.[ETLBatchAttribute]
          where BatchID = @BatchID and AttributeName = @AttributeName

   return (@v)
end]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="CreateOffset" Value="94" />
							<Property Name="Length" Value="3724" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="/*&#xD;&#xA;select * from ETLStepAttribute&#xD;&#xA;select [dbo].fn_AttributeGet (-10,1,null,'StepName')&#xD;&#xA;*/&#xD;&#xA;create function [dbo].[fn_AttributeGet] (&#xD;&#xA;    @BatchID int&#xD;&#xA;   ,@StepID int&#xD;&#xA;   ,@ConstID int&#xD;&#xA;   ,@AttributeName nvarchar(100)&#xD;&#xA;)&#xD;&#xA;returns nvarchar(4000)&#xD;&#xA; as" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_AttributeGet].[@BatchID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_AttributeGet].[@StepID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_AttributeGet].[@ConstID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_AttributeGet].[@AttributeName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Property Name="Length" Value="4000" />
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[nvarchar]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[fn_CounterGet]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_CounterGet].[@BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_CounterGet].[@StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_CounterGet].[@RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_CounterGet].[@CounterName]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[fn_CounterGet].sql
** Name:	[dbo].[fn_CounterGet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Function/fn_CounterGet.sql:

** Desc:	return  user defined counter value for batch/step/run combination
**          
**
** Params:
** @Request      --xml containing @RunID/StepID/BatchID
** Returns:
**
** Author:	andreys
** Date:	08/01/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/

   return (select top(1) CounterValue
             from dbo.[ETLStepRunCounter]
            where BatchID = @BatchID and StepID = @StepID and RunID = @RunID and CounterName = @CounterName)
end]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="CreateOffset" Value="94" />
							<Property Name="Length" Value="1261" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="/*&#xD;&#xA;select * from ETLStepRunCounter&#xD;&#xA;select [dbo].[fn_CounterGet] (20,0,0,'ExProcessID')&#xD;&#xA;*/&#xD;&#xA;create function [dbo].[fn_CounterGet] (&#xD;&#xA;    @BatchID int&#xD;&#xA;   ,@StepID int&#xD;&#xA;   ,@RunID int&#xD;&#xA;   ,@CounterName nvarchar(100)&#xD;&#xA;)&#xD;&#xA;returns nvarchar(1000)&#xD;&#xA; as" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_CounterGet].[@BatchID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_CounterGet].[@StepID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_CounterGet].[@RunID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_CounterGet].[@CounterName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Property Name="Length" Value="1000" />
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[nvarchar]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[fn_ETLCounterGet]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_ETLCounterGet].[@BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_ETLCounterGet].[@StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_ETLCounterGet].[@RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_ETLCounterGet].[@CounterName]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[fn_ETLCounterGet].sql
** Name:	[dbo].[fn_ETLCounterGet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema40/Function/[fn_ETLCounterGet].sql:

** Desc:	return  user defined counter value for batch/step/run combination
**          
**
** Params:
** @Request      --xml containing @RunID/StepID/BatchID
** Returns:
**
** Author:	andreys
** Date:	08/01/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/

   return (select top(1) CounterValue
             from dbo.[ETLStepRunCounter]
            where BatchID = @BatchID and StepID = @StepID and RunID = @RunID and CounterName = @CounterName)
end]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="CreateOffset" Value="97" />
							<Property Name="Length" Value="1280" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="/*&#xD;&#xA;select * from ETLStepRunCounter&#xD;&#xA;select [dbo].[fn_ETLCounterGet] (20,0,0,'ExProcessID')&#xD;&#xA;*/&#xD;&#xA;create function [dbo].[fn_ETLCounterGet] (&#xD;&#xA;    @BatchID int&#xD;&#xA;   ,@StepID int&#xD;&#xA;   ,@RunID int&#xD;&#xA;   ,@CounterName nvarchar(100)&#xD;&#xA;)&#xD;&#xA;returns nvarchar(1000)&#xD;&#xA; as" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_ETLCounterGet].[@BatchID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_ETLCounterGet].[@StepID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_ETLCounterGet].[@RunID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_ETLCounterGet].[@CounterName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Property Name="Length" Value="1000" />
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[nvarchar]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[fn_GetBase64String]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_GetBase64String].[@StringToEncode]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value QuotedIdentifiers="True"><![CDATA[
BEGIN
/******************************************************************
**	D File:         fn_GetBase64String.SQL
**
**	D Desc:         Encode string as base 64 to pass to DeltaExtractor
**
**	D Auth:         vensri
**	D Date:         12/18/2007
**
**	Param:			@StringToEncode - The string to encode
**  Returns:		nvarchar(max) the base 64 encoded string
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
	DECLARE @xmlDoc xml

	SELECT @xmlDoc = (select cast( @StringToEncode as varbinary(max))
	FOR XML RAW ('row'), elements, BINARY BASE64, type)

	return (select @xmlDoc.value('(/row)[1]','nvarchar(max)'))

END]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="CreateOffset" Value="2" />
							<Property Name="Length" Value="977" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="&#xD;&#xA;CREATE FUNCTION [dbo].[fn_GetBase64String]&#xD;&#xA;(&#xD;&#xA;&#x9;@StringToEncode nvarchar(max)&#xD;&#xA;) RETURNS nvarchar(max)&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_GetBase64String].[@StringToEncode]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Property Name="IsMax" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[nvarchar]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[fn_SystemParameter]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_Current]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_SystemParameter].[@ParameterCategory]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_SystemParameter].[@ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[EnvironmentName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_SystemParameter].[@EnvironmentName]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value QuotedIdentifiers="True"><![CDATA[

    BEGIN

        /*
        ** Declarations.
        */

        DECLARE @ReturnVar varchar(1024)

        /*
        ** Get the current system parameter setting.
        */

        SELECT @ReturnVar = [ParameterValue_Current]
          FROM [dbo].[SystemParameters]
         WHERE [ParameterType] = @ParameterCategory
           AND [ParameterName] = @ParameterName
		   AND EnvironmentName = @EnvironmentName;
        /*
        ** Return the results.
        */

        RETURN (@ReturnVar)

    END]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="CreateOffset" Value="1084" />
							<Property Name="Length" Value="1892" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="&#xD;&#xA;/*&#xD;&#xA;** Name:  [dbo].[fn_SystemParameter]&#xD;&#xA;**&#xD;&#xA;** $Workfile: fn_systemparameter.sql $&#xD;&#xA;** $Archive: /Development/SubjectAreas/UserActivityStats/Database/Schema/Function/fn_systemparameter.sql $&#xD;&#xA;**&#xD;&#xA;** Purpose:&#xD;&#xA;**      This script creates a function to return the current setting for&#xD;&#xA;**  the specified system parameter.&#xD;&#xA;**&#xD;&#xA;** $Author: Karlj $&#xD;&#xA;** $Revision: 6 $&#xD;&#xA;** $BuildVersion: $&#xD;&#xA;**&#xD;&#xA;** Pre-conditions:&#xD;&#xA;**      The system parameters are defined in the [dbo].[SystemParameters]&#xD;&#xA;**  table.&#xD;&#xA;**&#xD;&#xA;** Input Arguments:&#xD;&#xA;**&#xD;&#xA;**      Name:         @ParameterCategory&#xD;&#xA;**      Datatype:     udt_ParameterType&#xD;&#xA;**      Default:      None&#xD;&#xA;**      Description:  The system parameter category.&#xD;&#xA;**&#xD;&#xA;**      Name:         @ParameterName&#xD;&#xA;**      Datatype:     udt_ParameterName&#xD;&#xA;**      Default:      None&#xD;&#xA;**      Description:  The system parameter name.  Names are unique to a&#xD;&#xA;**                    parameter category.&#xD;&#xA;**&#xD;&#xA;** Return Type:&#xD;&#xA;**      [udt_ParameterValue]&#xD;&#xA;**&#xD;&#xA;** Results Set:&#xD;&#xA;**      None&#xD;&#xA;**&#xD;&#xA;** Post-conditions:&#xD;&#xA;**      No changes are made to the database.&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE FUNCTION [dbo].[fn_SystemParameter] (&#xD;&#xA;        @ParameterCategory VARCHAR(32)    -- System parameter category.&#xD;&#xA;      , @ParameterName VARCHAR(57)        -- System parameter name.&#xD;&#xA;&#x9;  , @EnvironmentName VARCHAR(100)&#x9;  -- Environment Name&#xD;&#xA;    ) RETURNS varchar(1024) AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_SystemParameter].[@ParameterCategory]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="32" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_SystemParameter].[@ParameterName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="57" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[fn_SystemParameter].[@EnvironmentName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Property Name="Length" Value="1024" />
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[varchar]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_Dsv]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Dsv].[DsvID]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Dsv]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ApplicationLog]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ApplicationLog.SQL
**
**D Desc:         Log external message
**
**D Auth:         andreys
**D Date:         06/27/2009
**
** Param:
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @Now nvarchar(30)
DECLARE @msg nvarchar(max)
DECLARE @RunID int
DECLARE @BatchID int
DECLARE @StepID int
DECLARE @Options int
DECLARE @debug int
DECLARE @Header xml(ETLController)
DECLARE @ProcessInfo xml(ETLController)

SET @Err = 0
-------------------------------------------------------------------
--Return Statuses
--2 - Success
--3 - Failure
--4 - Error
-------------------------------------------------------------------
BEGIN TRY
    

set @BatchID = ISNULL(@pBatchID,0)
set @StepID = ISNULL(@pStepID,0)
set @RunID = ISNULL(@pRunID,0)
set @debug = CASE WHEN CHARINDEX('debug',@pOptions) > 0 THEN 1 ELSE 0 END;


--use conversation only for Slave; use table insert for master
set @pConversation = NULL;
IF (@pConversation IS NOT NULL)
BEGIN
   exec dbo.[prc_CreateHeader] @Header out,@BatchId,@StepId,null,@RunId,@debug
   exec dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@pMessage,@pErr

   --RAISERROR ('not implemented',0,1) WITH NOWAIT
  ;SEND ON CONVERSATION @pConversation
   MESSAGE TYPE [ETLController_InfoMessage]
      (CAST(@ProcessInfo AS varbinary(max)))

END
ELSE
BEGIN

   if (@debug = 1)
      PRINT @pMessage;
      
   IF (isnull(@RunID,0) <> 0)
     INSERT dbo.[ETLStepRunHistoryLog]
      (RunID,BatchID,StepID,LogDT,Err,LogMessage)
     VALUES(@RunID,isnull(@BatchID,0),isnull(@StepID,0),getdate(),isnull(@pErr,0),@pMessage)
END

END TRY
BEGIN CATCH
    SET @Err = ERROR_NUMBER()
    SET @msg = ERROR_MESSAGE()
    RAISERROR('Error %d %s',10,11,@Err,@msg)
END CATCH

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ApplicationLog].[@pBatchId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ApplicationLog].[@pStepId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ApplicationLog].[@pRunId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ApplicationLog].[@pOptions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ApplicationLog].[@pConversation]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ApplicationLog].[@pMessage]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ApplicationLog].[@pErr]" />
				</Entry>
				<Entry>
					<References Name="[ETLController_InfoMessage]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[LogDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[LogMessage]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ApplicationLog].[@pMessage]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ApplicationLog].[@pErr]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ApplicationLog].[@pBatchId]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ApplicationLog].[@pStepId]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ApplicationLog].[@pRunId]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ApplicationLog].[@pConversation]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ApplicationLog].[@pConversationGrp]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ApplicationLog].[@pOptions]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="62" />
				<Property Name="Length" Value="2508" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;exec dbo.prc_ApplicationLog 'test message',1,1,1,1&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ApplicationLog]&#xD;&#xA;      @pMessage nvarchar(max)&#xD;&#xA;     ,@pErr int = null&#xD;&#xA;     ,@pBatchId int = null&#xD;&#xA;     ,@pStepId int = null&#xD;&#xA;     ,@pRunId int = 0&#xD;&#xA;     ,@pConversation uniqueidentifier = NULL&#xD;&#xA;     ,@pConversationGrp uniqueidentifier = NULL&#xD;&#xA;     ,@pOptions nvarchar(100) = null&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_AttributeGet]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[prc_CounterGet].sql
** Name:	[dbo].[prc_CounterGet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Procedure/[prc_CounterGet].sql:

** Desc:	return Counter value to the client
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	10/30/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/

set nocount on
declare @err                int
declare @proc               sysname
declare @msg                nvarchar(1000)
declare @debug              tinyint
declare @Options            int
declare @query              nvarchar(max)

declare @BatchID int
declare @StepID int
declare @RunID int
declare @ConstID int
declare @ProcErr int
declare @ProcName sysname

set @err = 0
set @proc = object_name(@@procid)
begin try

exec @ProcErr = dbo.[prc_ReadHeader] @pHeader,@BatchID out,@StepID out,@ConstID out,null,null,null
set @pValue = dbo.[fn_AttributeGet] (@BatchID,@StepID,@ConstID,@pName)

end try
begin catch
   set @Proc = ERROR_PROCEDURE()
   set @pValue = null
   set @Msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   raiserror ('ERROR: PROC %s, MSG: %s',11,11,@Proc,@Msg) 
end catch

return @err
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_AttributeGet].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_AttributeGet].[@pValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_AttributeGet]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_AttributeGet].[@pName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_AttributeGet].[@pValue]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_AttributeGet].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_AttributeGet].[@pName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="209" />
				<Property Name="Length" Value="1941" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pValue nvarchar(1000)&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-20,1,null,4,1&#xD;&#xA;--select @pHeader&#xD;&#xA;exec dbo.prc_AttributeGet @pValue out,@pHeader,'test'&#xD;&#xA;select @pValue&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;create procedure [dbo].[prc_AttributeGet] (&#xD;&#xA;    @pValue nvarchar(max) output&#xD;&#xA;   ,@pHeader xml([ETLController])&#xD;&#xA;   ,@pName varchar(100) = null&#xD;&#xA;) as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_AttributeSet]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[prc_AttributeSet].sql
** Name:	[dbo].[prc_AttributeSet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Function/prc_AttributeSet.sql:

** Desc:	set  user defined attribute value for batch/step/const combination
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	08/01/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/
set nocount on
declare @retcode int
declare @msg nvarchar(max)
declare @err int
declare @proc sysname

declare @BatchID int
declare @StepID int
declare @RunID int
declare @ConstID int
declare @ProcErr int
declare @ProcName sysname

set @retcode = 0
set @err = 0
set @proc = object_name(@@procid)
begin try
   exec @ProcErr = dbo.[prc_ReadHeader] @pHeader,@BatchID out,@StepID out,@ConstID out,null,null,null;
   exec @ProcErr = dbo.prc_ETLAttributeSet @BatchID,@StepID,@ConstID,@pName,@pValue;
end try
begin catch
   set @retcode = ERROR_NUMBER()
   set @msg = ERROR_MESSAGE()
   raiserror (@msg,11,11)
end catch
   return (@retcode)
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_AttributeSet].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLAttributeSet]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_AttributeSet].[@pName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_AttributeSet].[@pValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_AttributeSet].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_AttributeSet].[@pName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_AttributeSet].[@pValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="4000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="258" />
				<Property Name="Length" Value="1842" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pValue nvarchar(1000)&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,20,1,null,4,1&#xD;&#xA;--select @pHeader&#xD;&#xA;exec [dbo].[prc_AttributeSet] @pHeader,'TEST',null&#xD;&#xA;exec dbo.prc_AttributeGet @pValue out,@pHeader,'TEST'&#xD;&#xA;select @pValue&#xD;&#xA;*/&#xD;&#xA;create procedure [dbo].[prc_AttributeSet] (&#xD;&#xA;        @pHeader xml([ETLController])&#xD;&#xA;       ,@pName nvarchar(100)&#xD;&#xA;       ,@pValue nvarchar(4000)&#xD;&#xA;)&#xD;&#xA; as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CLREventPost]">
			<Property Name="IsAnsiNullsOn" />
			<Property Name="IsQuotedIdentifierOn" />
			<Property Name="MethodName" Value="EventPost" />
			<Property Name="ClassName" Value="ETL_Framework.ControllerCLRExtensions.ControllerExtensions" />
			<Relationship Name="Assembly">
				<Entry>
					<References Name="[ControllerClrExtensions]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventPost].[@Server]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventPost].[@Database]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventPost].[@EventType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventPost].[@EventPosted]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventPost].[@args]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventPost].[@options]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CLREventReceive]">
			<Property Name="IsAnsiNullsOn" />
			<Property Name="IsQuotedIdentifierOn" />
			<Property Name="MethodName" Value="EventReceive" />
			<Property Name="ClassName" Value="ETL_Framework.ControllerCLRExtensions.ControllerExtensions" />
			<Relationship Name="Assembly">
				<Entry>
					<References Name="[ControllerClrExtensions]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventReceive].[@Server]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventReceive].[@Database]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventReceive].[@EventID]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventReceive].[@EventPosted]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventReceive].[@EventReceived]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventReceive].[@EventArgs]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventReceive].[@EventType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CLREventReceive].[@options]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ConstraintCheck]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ConstraintCheck.SQL
**
**D Desc:         Check Constraints
**
**D Auth:         andreys
**D Date:         10/30/2007
**
** Param: @pRequest  - BatchID info
                  @pReceipt results (StatusID - 2 - SUCCESS, 3 - FAILURE) (OUTPUT only)
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
**  2010/07/12       andrey@biasintelligence.com           stop constraint processing on ExitEvent
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ExitCode INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @StartDT datetime
DECLARE @BatchID INT
DECLARE @StepID INT
DECLARE @ConstID int
DECLARE @StatusID tinyint
DECLARE @BatchStatusID tinyint
DECLARE @debug tinyint
DECLARE @Options int
DECLARE @msg nvarchar(max)
DECLARE @RaiserrMsg nvarchar(max)
DECLARE @handle uniqueidentifier
DECLARE @RunID int
DECLARE @Scope int

DECLARE @Process nvarchar(max)
DECLARE @WaitPeriod int    -- in seconds
DECLARE @Wait varchar(20)
DECLARE @Disabled int

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ExitCode = 0

DECLARE @ATT_PING INT

DECLARE @STAT_SUCCESS TINYINT
DECLARE @STAT_FAILURE TINYINT
DECLARE @STAT_ERROR TINYINT
DECLARE @STAT_FAILURE_IMMEDIATE TINYINT

SET @STAT_SUCCESS = 2
SET @STAT_FAILURE = 3
SET @STAT_ERROR = 4
SET @STAT_FAILURE_IMMEDIATE = 6
-------------------------------------------------------------------
--Return Statuses
--2 - Success
--3 - Failure
--4 - Error
--5 - Failure with abort
-------------------------------------------------------------------
DECLARE @ProcessInfo AS xml (ETLController)
DECLARE @Header AS xml (ETLController)
DECLARE @Context AS xml (ETLController)
DECLARE @cHeader AS xml (ETLController)
DECLARE @cRequest AS xml (ETLController)
DECLARE @cReceipt AS xml (ETLController)

BEGIN TRY

exec @ExitCode = dbo.[prc_ReadProcessRequest] @pRequest,@Header out,@Context out,@handle out
exec @ExitCode = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out,@Scope out

set @debug = isnull(@Options & 1,0)
IF (@debug = 1)
BEGIN
   SET @msg = 'BEGIN Procedure ' + @ProcName
                           + ' with @BatchID=' + CAST(@BatchID AS nvarchar(30))
                           + ISNULL( ', @StepID=' +CAST(@StepID AS nvarchar(30)),'')

   exec @ExitCode = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
END

-------------------------------------------------------------------
--Check for the constraints existance
-------------------------------------------------------------------
SET @ExitCode = 0
IF (@StepID is null)
  SET @ExitCode = @Context.exist('declare namespace etl="ETLController.XSD";(/etl:Context[@BatchID=(sql:variable("@BatchID"))]/etl:Constraints)')
ELSE
  SET @ExitCode = @Context.exist('declare namespace etl="ETLController.XSD";
                                 (/etl:Context[@BatchID=(sql:variable("@BatchID"))]/etl:Steps/etl:Step[@StepID=(sql:variable("@StepID"))]/etl:Constraints)')

IF (@ExitCode = 0)
BEGIN
  SET @StatusID = @STAT_SUCCESS
END
ELSE
BEGIN

declare @const table
(ConstID int
,Process nvarchar(max)
,WaitPeriod int null
,Ping int null
,[Disabled] tinyint null
,ConstOrder nvarchar(10)
)

if (@StepID is null)
begin
   ;with xmlnamespaces ('ETLController.XSD' as etl)
   insert @const
   SELECT
    c.const.value('./@ConstID','int') as ConstID
   ,'exec @ExitCode = ' + c.const.value('(./etl:Process/etl:Process)[1]','nvarchar(max)') + ' @pRequest=@Request, @pReceipt=@Receipt out' 
    + isnull(',' + c.const.value('(./etl:Process/etl:Param)[1]','nvarchar(max)'),'') as Process
   ,c.const.value('./@WaitPeriod','int') as WaitPeriod
   ,isnull(c.const.value('./@Ping','int'),10) as Ping
   ,isnull(c.const.value('./@Disabled','int'),0) as [Disabled]
   ,c.const.value('./@ConstOrder','int') as ConstOrder
   FROM @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]/etl:Constraints/etl:Constraint') c(const)
end
else
begin
   ;with xmlnamespaces ('ETLController.XSD' as etl)
   insert @const
   SELECT
    c.const.value('./@ConstID','int') as ConstID
   ,'exec @ExitCode = ' + c.const.value('(./etl:Process/etl:Process)[1]','nvarchar(max)') + ' @pRequest=@Request,@pReceipt=@Receipt out' 
    + isnull(',' + c.const.value('(./etl:Process/etl:Param)[1]','nvarchar(max)'),'') as Process
   ,c.const.value('./@WaitPeriod','int') as WaitPeriod
   ,isnull(c.const.value('./@Ping','int'),10) as Ping
   ,isnull(c.const.value('./@Disabled','int'),0) as [Disabled]
   ,c.const.value('./@ConstOrder','int') as ConstOrder
   FROM @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]/etl:Steps/etl:Step[@StepID=(sql:variable("@StepID"))]/etl:Constraints/etl:Constraint') c(const)
end

-------------------------------------------------------------------
--Loop through the Step Constraints
-------------------------------------------------------------------
DECLARE StepConstCursor CURSOR LOCAL FAST_FORWARD
FOR SELECT c.ConstID,c.Process,c.WaitPeriod,c.Ping,c.Disabled
FROM @const c
ORDER BY c.ConstOrder

OPEN StepConstCursor
WHILE (1=1)
BEGIN
   SET @StartDT = getdate()
   SET @ConstID = NULL
   FETCH NEXT FROM StepConstCursor INTO @ConstID,@Process,@WaitPeriod,@ATT_PING,@Disabled
   IF (@@FETCH_STATUS <> 0 OR @ConstID IS NULL)
      BREAK

   IF isnull(@Disabled,0) = 1 
   BEGIN
      IF (@debug = 1)
      BEGIN
         SET @msg = '   Constraint=' +  CAST(@ConstID AS nvarchar(30)) + ' is disabled:  ' + @Process
         exec @ExitCode = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
         exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
      END
      CONTINUE
   END

   SET @Wait = right('00' + cast(@ATT_PING/3600 as varchar(10)),3)
             + ':' + right('0' + cast((@ATT_PING/60)%60 as varchar(10)),2)
             + ':' + right('0' + cast(@ATT_PING%60 as varchar(10)),2)

   IF (@debug = 1)
   BEGIN
      SET @msg = '   Constraint=' +  CAST(@ConstID AS nvarchar(30))
               + ' wait=' + CAST(@WaitPeriod AS nvarchar(30)) + '(' + isnull(@Wait,'null') + ')'
               + ':  ' + @Process
      exec @ExitCode = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
   END

   IF (@Process IS NOT NULL)
   BEGIN
       exec @ExitCode = dbo.[prc_CreateHeader] @cHeader out,@BatchID,@StepID,@ConstID,@RunID,@Options,@Scope
       exec @ExitCode = dbo.[prc_CreateProcessRequest] @cRequest out,@cHeader,@Context,@handle
      --Wait Until WaitPeriod is expired
      WHILE (1=1)
      BEGIN
         SET @StatusID = NULL
         SET @cReceipt = NULL
         EXEC sp_ExecuteSQL @Process
                  ,N'@ExitCode int output,@Request xml(ETLController),@Receipt xml(ETLController) output'
                  ,@ExitCode = @ExitCode output
                  ,@Request = @cRequest
                  ,@Receipt = @cReceipt output

         exec @ExitCode = dbo.[prc_ReadProcessReceipt] @cReceipt,null,@StatusID out,@Err out--,@msg out

         SET @StatusID = ISNULL(@StatusID,@STAT_ERROR)
         IF (@debug = 1)
         BEGIN
            SET @msg = '   Constraint=' +  CAST(@ConstID AS nvarchar(30)) + ' returns StatusID=' + CAST(@StatusID AS nvarchar(30))
            exec @ExitCode = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
            exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
         END

-------------------------------------------------------------------
--Exit Batch on Exit Event for batch constraints only
-------------------------------------------------------------------
         if (@StepID is null)
         begin
            set @BatchStatusID = cast(dbo.[fn_ETLCounterGet] (@BatchID,0,@RunID,'ExitEvent') as tinyint)
            IF (@BatchStatusID is not null)
            BEGIN
               SET @StatusID = @BatchStatusID
               IF (@debug = 1)
               BEGIN
                  SET @msg = '   Costraint Check Exit on ExitEvent with StatusID=' + CAST(@StatusID as nvarchar(30))
                  exec @ExitCode = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
                  exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
               END
            END
         end


         IF (@StatusID = @STAT_ERROR)
         BEGIN
            SET @RaiserrMsg = '   ERROR Constraint=' +  CAST(@ConstID AS nvarchar(30)) + ' failed'
            BREAK
         END
         ELSE IF(@StatusID = @STAT_SUCCESS)
         BEGIN
            BREAK
         END
         ELSE
         BEGIN
            IF (@StatusID = @STAT_FAILURE_IMMEDIATE OR DATEDIFF(minute,@StartDT,getdate()) > @WaitPeriod)
            BEGIN
               SET @RaiserrMsg = '   ERROR Constraint=' +  CAST(@ConstID AS nvarchar(30)) + ' was not met'
               SET @StatusID = @STAT_FAILURE
               SET @Err = 50107 -- constraint was not met
               BREAK
            END

            IF (@debug = 1)
            BEGIN
               SET @msg = '   Constraint=' +  CAST(@ConstID AS nvarchar(30)) + ' wait=' + isnull(@Wait,'null')
               exec @ExitCode = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
               exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
            END
            WAITFOR DELAY @Wait

            --check conversation
            IF (@handle IS NOT NULL)
               IF EXISTS (SELECT * FROM sys.conversation_endpoints WHERE [conversation_handle] = @handle AND  state IN ('DI','DO','ER','CD'))
               BEGIN
                  SET @RaiserrMsg = '   ERROR conversation is not active'
                  SET @StatusID = @STAT_ERROR
                  SET @Err = 50110
                  BREAK
               END

         END
      END --WHILE(@Err = 0)
      IF @StatusID IN (@STAT_FAILURE,@STAT_ERROR,@STAT_FAILURE_IMMEDIATE)
         BREAK
    END
END --WHILE (@Err = 0)

DEALLOCATE StepConstCursor
IF (@RaiserrMsg is not null )
BEGIN
   RAISERROR(@RaiserrMsg,11,11)
END

SET @StatusID = @STAT_SUCCESS
END
END TRY
BEGIN CATCH
SET @Err = ISNULL(NULLIF(@Err,0),ERROR_NUMBER())
SET @RaiserrMsg = ISNULL(@RaiserrMsg,ERROR_MESSAGE())
SET @StatusID = isnull(@StatusID,@STAT_ERROR)
IF (@RaiserrMsg IS NOT NULL)
BEGIN
      exec @ExitCode = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@RaiserrMsg,@Err
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
END
END CATCH

if (@pReceipt is null)
   exec @ExitCode = dbo.[prc_CreateProcessReceipt] @pReceipt out,@Header,@StatusID,@Err,@RaiserrMsg

IF (@debug = 1)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ExitCode = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg,@Err
   exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
END
RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@pRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@const].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@const].[Process]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@const].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@const].[Ping]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@const].[Disabled]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@const].[ConstOrder]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessRequest]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ReadProcessReceipt]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_ETLCounterGet]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[conversation_endpoints]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[conversation_endpoints].[conversation_handle]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[conversation_endpoints].[state]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@pReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_ConstraintCheck].[@const]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ConstraintCheck].[@const].[ConstID]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ConstraintCheck].[@const].[Process]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ConstraintCheck].[@const].[WaitPeriod]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ConstraintCheck].[@const].[Ping]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ConstraintCheck].[@const].[Disabled]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ConstraintCheck].[@const].[ConstOrder]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="10" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ConstraintCheck].[@pRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ConstraintCheck].[@pReceipt]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="462" />
				<Property Name="Length" Value="11860" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @BatchID int&#xD;&#xA;set @BatchID = 310&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,@BatchID,1,1,138,1&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;--select @pProcessRequest&#xD;&#xA;exec dbo.prc_ConstraintCheck @pProcessRequest,@pProcessReceipt out&#xD;&#xA;--select @pProcessReceipt&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ConstraintCheck]&#xD;&#xA;    @pRequest xml([ETLController])&#xD;&#xA;   ,@pReceipt  xml([ETLController]) = NULL OUTPUT&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ConversationCleanup]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ConversationCleanup.SQL
**
**D Desc:         clean up broker communication leftovers
**
**D Auth:         andreys
**D Date:         07/05/2007
**
** Param:
** @options:      all - remove all conversation including CO
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @Now nvarchar(30)
DECLARE @msg nvarchar(max)
DECLARE @SPID int
DECLARE @RunID int
DECLARE @handle uniqueidentifier
DECLARE @prevhandle uniqueidentifier
DECLARE @All tinyint

SET @Err = 0
SET @SPID = @@SPID
SET @All = case when @options like '%all%' then 1 else 0 end
-------------------------------------------------------------------
-------------------------------------------------------------------
--just for testing
--waitfor delay '00:00:01'

BEGIN TRY

   SELECT top 1 @handle = conversation_handle FROM sys.conversation_endpoints sc
     JOIN sys.services ss ON ((sc.service_id = ss.service_id AND ss.[name] like ('ETLController[_]%'))
       OR (sc.service_id = 0 AND far_service like ('ETLController[_]%')))
    WHERE (sc.state IN ('ER','DI','DO','CD') or @all = 1)

   WHILE @handle IS NOT NULL
   BEGIN
      SET @msg = 'Ending conversation [' + CAST(@handle AS nvarchar(100)) + ']'
      RAISERROR (@msg,0,1)
      ;END CONVERSATION @handle WITH CLEANUP

      SET @prevhandle = @handle
      SET @handle = NULL
      SELECT top 1 @handle = conversation_handle FROM sys.conversation_endpoints sc
        JOIN sys.services ss ON ((sc.service_id = ss.service_id AND ss.[name] like ('ETLController[_]%'))
          OR (sc.service_id = 0 AND far_service like ('ETLController[_]%')))
       WHERE (sc.state IN ('ER','DI','DO','CD') or @All = 1) 

      IF (@handle IS NULL)
         BREAK

      IF (@handle = @prevhandle)
      BEGIN
         SET @msg = 'Failed to end conversation [' + CAST(@handle AS nvarchar(100)) + ']'
         RAISERROR(@msg,11,11)
         BREAK
      END
   END

END TRY
BEGIN CATCH
    SET @Err = ERROR_NUMBER()
    SET @msg = ERROR_MESSAGE()
    RAISERROR('Error %d %s',11,11,@Err,@msg)
END CATCH

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConversationCleanup].[@options]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[conversation_endpoints]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[services]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[conversation_endpoints].[service_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[services].[service_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[services].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[conversation_endpoints].[far_service]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[conversation_endpoints].[conversation_handle]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[conversation_endpoints].[state]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ConversationCleanup].[@options]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="2" />
				<Property Name="Length" Value="2526" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;CREATE PROCEDURE dbo.prc_ConversationCleanup&#xD;&#xA;@options varchar(100) = null&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CounterGet]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[ETL_CounterGet].sql
** Name:	[dbo].[ETL_CounterGet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Procedure/[ETL_CounterGet].sql:

** Desc:	return Counter value to the client
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	10/30/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/

set nocount on
declare @err                int
declare @proc               sysname
declare @msg                nvarchar(1000)
declare @debug              tinyint
declare @Options            int
declare @query              nvarchar(max)

declare @BatchID int
declare @StepID int
declare @RunID int
declare @LGRunID int
declare @ProcErr int
declare @ProcName sysname
declare @Counters xml(ETLController)

set @err = 0
begin try

exec @ProcErr = dbo.[prc_ReadHeader] @pHeader,null,null,null,@RunID out,null,null
exec @ProcErr = dbo.[prc_CreateCounters] @Counters out, @pHeader, @pName
exec @ProcErr = dbo.[prc_ReadCounter] @Counters,@pName,@pValue out,@RunID

end try
begin catch
   set @Proc = ERROR_PROCEDURE()
   set @pValue = null
   set @Msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   raiserror ('ERROR: PROC %s, MSG: %s',11,11,@Proc,@Msg) 
end catch

return @err
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CounterGet].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateCounters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CounterGet].[@pName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadCounter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CounterGet].[@pValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CounterGet].[@pValue]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CounterGet].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CounterGet].[@pName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="515" />
				<Property Name="Length" Value="2308" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;select * from ETLBatchRun where batchid = 130&#xD;&#xA;&#xD;&#xA;--select * from ETLStepRunCounter&#xD;&#xA;--insert ETLStepRunCounter&#xD;&#xA;--values(-20,1,4,'test','xxx')&#xD;&#xA;--insert ETLStepRunCounter&#xD;&#xA;--values(-20,1,3,'test1','yyy')&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pCounters xml&#xD;&#xA;declare @pValue nvarchar(1000)&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-20,1,null,4,1&#xD;&#xA;--select @pHeader&#xD;&#xA;exec dbo.prc_CreateCounters @pCounters out,@pHeader,'test'&#xD;&#xA;exec dbo.prc_CounterGet @pValue out,@pHeader,'test'&#xD;&#xA;select @pCounters&#xD;&#xA;select @pValue&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;create procedure [dbo].[prc_CounterGet] (&#xD;&#xA;    @pValue nvarchar(max) output&#xD;&#xA;   ,@pHeader xml([ETLController])&#xD;&#xA;   ,@pName varchar(100) = null&#xD;&#xA;) as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CounterSet]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[ETL_CounterSet].sql
** Name:	[dbo].[ETL_CounterSet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Procedure/[ETL_CounterSet].sql:

** Desc:	set client Counter value
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	10/30/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/

set nocount on
declare @err                int
declare @proc               sysname
declare @msg                nvarchar(1000)
declare @debug              tinyint
declare @Options            int
declare @query              nvarchar(max)

declare @BatchID int
declare @StepID int
declare @RunID int
declare @LGRunID int
declare @ProcErr int
declare @ProcName sysname
declare @Counters xml(ETLController)

set @err = 0
begin try

exec @ProcErr = dbo.[prc_ReadHeader] @pHeader,@BatchID out,@StepID out,null,@RunID out,null,null

   if exists(select 1 from dbo.[ETLStepRunCounter]
                      where RunID = @RunID and StepID = @StepID
                        and BatchID = @BatchID and CounterName = @pName)
   begin
      if @pValue is null
      begin
         delete dbo.[ETLStepRunCounter]
          where RunID = @RunID and StepID = @StepID
            and BatchID = @BatchID and CounterName = @pName
         raiserror('record was deleted from dbo.ETLStepRunCounter',0,1)
      end
      else
      begin
         update dbo.[ETLStepRunCounter]
         set CounterValue = @pValue
          where RunID = @RunID and StepID = @StepID
            and BatchID = @BatchID and CounterName = @pName
         raiserror('record was updated in dbo.ETLStepRunCounter',0,1)
      end
   end
   else
   begin
      insert dbo.[ETLStepRunCounter]
      (RunID,StepID,CounterName,BatchID,CounterValue)
      values(@RunID,@StepID,@pName,@BatchID,@pValue)
      raiserror('record was inserted into dbo.ETLStepRunCounter',0,1)
   end


end try
begin catch
   set @Proc = ERROR_PROCEDURE()
   set @pValue = null
   set @Msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   raiserror ('ERROR: PROC %s, MSG: %s',11,11,@Proc,@Msg) 
end catch

return @err
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CounterSet].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CounterSet].[@pName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CounterSet].[@pValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CounterSet].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CounterSet].[@pName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CounterSet].[@pValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="301" />
				<Property Name="Length" Value="2980" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pCounters xml&#xD;&#xA;declare @pValue nvarchar(1000)&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-20,1,null,5,1&#xD;&#xA;--select @pHeader&#xD;&#xA;exec dbo.prc_CounterSet @pHeader,'test2','bbb'&#xD;&#xA;exec dbo.prc_CounterGet @pValue out,@pHeader,'test2'&#xD;&#xA;--select @pCounters&#xD;&#xA;select @pValue&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;create procedure [dbo].[prc_CounterSet] (&#xD;&#xA;    @pHeader xml([ETLController])&#xD;&#xA;   ,@pName varchar(100) = null&#xD;&#xA;   ,@pValue nvarchar(max)&#xD;&#xA;&#xD;&#xA;) as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CreateContext]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_CreateContext.SQL
**
**D Desc:         return Context object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
**  5/20/2008        andreys            remove context resolution
**  10/15/2011       andreys            add controller and node globals
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

declare @BatchID int
declare @StepID int
declare @ConstID int
declare @RunID int
declare @Options int
declare @debug int
declare @Scope int
declare @AttributeScope int

declare @id int
declare @type tinyint
declare @b int
declare @s int
declare @c int
declare @Name nvarchar(100)
declare @Value1 nvarchar(max)
declare @Value2 nvarchar(max)
declare @nValue nvarchar(max)
declare @ProcessInfo xml(ETLController)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

declare @a as table
 (id int identity(1,1)
 ,BatchID int
 ,StepID int null
 ,ConstID int null
 ,AttributeName nvarchar(100)
 ,AttributeValue nvarchar(max)
 ,AttributeScope tinyint
 ,CompleteFlag tinyint null
 ,unique (BatchID,StepID,ConstId,AttributeName,AttributeScope)
)

declare @ab as table
 (aid int
 ,bid int
 ,isexec tinyint
)

begin try
exec @ProcErr = dbo.[prc_ReadHeader] @pHeader,@BatchID out,@StepID out,@ConstID out,@RunID out,@Options out,@Scope out
set @debug = nullif(@Options & 1,0)


if (@debug = 1)
begin
   SET @msg =  'BEGIN Procedure ' + @ProcName + ' with context'
         + ' BatchID=' + isnull(cast(@BatchID as nvarchar(10)),'null')
         + ' StepID=' + isnull(cast(@StepID as nvarchar(10)),'null')
         + ' ConstID=' + isnull(cast(@ConstID as nvarchar(10)),'null')
         + ' RunID=' + isnull(cast(@RunID as nvarchar(10)),'null')
         + ' Scope=' + isnull(cast(@Scope as nvarchar(10)),'null')

   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@pHeader,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo
end
-------------------------------------------------------------------
--Process context attributes
-------------------------------------------------------------------
if (@StepID is null and (@Scope is null or @Scope & 4 = 4))
begin
   insert @a (BatchID,StepID,ConstID,AttributeName,AttributeValue,AttributeScope)
   select BatchID,null,ConstID,AttributeName,AttributeValue,1
     from dbo.[ETLBatchConstraintAttribute]
    where BatchID = @BatchID  and (ConstID = @ConstID or @ConstID is null)
end

if ((@StepID is not null or (@StepID is null and @ConstID is null)) and (@Scope is null or @Scope & 8 = 8))
begin
   insert @a (BatchID,StepID,ConstID,AttributeName,AttributeValue,AttributeScope)
   select  BatchID,StepID,ConstID,AttributeName,AttributeValue,2
     from dbo.[ETLStepConstraintAttribute]
    where BatchID = @BatchID and (StepID = @StepID or @StepID is null) and (ConstID = @ConstID or @ConstID is null)
end

if ((@StepID is not null or @ConstID is null) and (@Scope is null or @Scope & 2 = 2))
begin
   insert @a (BatchID,StepID,ConstID,AttributeName,AttributeValue,AttributeScope)
   select i.BatchID,i.StepID,null,i.AttributeName,i.AttributeValue,3
     from dbo.[ETLStepAttribute] i
    where i.BatchID = @BatchID and (i.StepID = @StepID or @StepID is null)
end

if(@Scope is null or @Scope & 1 = 1)
begin
    insert @a (BatchID,StepID,ConstID,AttributeName,AttributeValue,AttributeScope)
    select i.BatchID,null,null,i.AttributeName,i.AttributeValue,4
      from dbo.[ETLBatchAttribute] i
     where i.BatchID = @BatchID
end

--execution context
insert @a (BatchID,StepID,ConstID,AttributeName,AttributeValue,AttributeScope)
select null,null,null,'@BatchID' as AttributeName,cast(@BatchID as nvarchar(30)) as AttributeValue,0
union all
select null,null,null,'@StepID' as AttributeName,cast(@StepID as nvarchar(30)) as AttributeValue,0
union all
select null,null,null,'@ConstID' as AttributeName,cast(@ConstID as nvarchar(30)) as AttributeValue,0
union all
select null,null,null,'@RunID' as AttributeName,cast(@RunID as nvarchar(30)) as AttributeValue,0
union all
select null,null,null,'@Options' as AttributeName,cast(@Options as nvarchar(30)) as AttributeValue,0

-------------------------------------------------------------------
--add dsvobjectproperty attributes if any
-------------------------------------------------------------------
--declare @DsvID int
--select top (1) @DsvID = AttributeValue from @a where AttributeName = 'DsvVersion'
--if (@DsvID is not null)
--begin
--   insert @a (BatchID,StepID,ConstID,AttributeName,AttributeValue,AttributeScope)
--   select a.BatchID,a.StepID,a.ConstID,b.oName,b.oValue,a.AttributeScope
--     from @a a
--   cross apply dbo.fn_ETLObjectProperty(@DsvID,a.AttributeValue) as b
--    where a.AttributeName = 'DsvObject'
--end

/* dont need to do this here
** move all attribute resolution code to prc_ReadContextAttributes
-------------------------------------------------------------------
--relationship table
-------------------------------------------------------------------
insert @ab
select a.id,b.id,0
from @a a
join @a b on charindex('<' + a.AttributeName + '>',b.AttributeValue) > 0
      and (b.BatchID = a.BatchID or (a.BatchID is null and b.AttributeScope <= a.AttributeScope))
      and ((b.BatchID = a.BatchID and b.StepID = a.StepID) or (a.StepID  is null and b.AttributeScope <= a.AttributeScope))
      and ((b.BatchID = a.BatchID and b.StepID = a.StepID and b.ConstID = a.ConstID)
       or  (b.BatchID = a.BatchID and b.StepID is null and b.ConstID = a.ConstID)
       or (a.ConstID is null and b.AttributeScope <= a.AttributeScope))

union all select a.id,b.id,1
from @a a
join @a b on charindex('<' + a.AttributeName + '*>',b.AttributeValue) > 0
      and (b.BatchID = a.BatchID or (a.BatchID is null and b.AttributeScope <= a.AttributeScope))
      and ((b.BatchID = a.BatchID and b.StepID = a.StepID) or (a.StepID  is null and b.AttributeScope <= a.AttributeScope))
      and ((b.BatchID = a.BatchID and b.StepID = a.StepID and b.ConstID = a.ConstID)
       or  (b.BatchID = a.BatchID and b.StepID is null and b.ConstID = a.ConstID)
       or (a.ConstID is null and b.AttributeScope <= a.AttributeScope))

-------------------------------------------------------------------
--replace dynamic parameters if any
-------------------------------------------------------------------
WHILE (1=1)
BEGIN
    SET @id = null
    SELECT top(1) @id = t.id
                 ,@Name = t.AttributeName
                 ,@b = t.BatchID
                 ,@s = t.StepID
                 ,@c = t.ConstID
                 ,@Value1 = t.AttributeValue
                 ,@AttributeScope = t.AttributeScope
      FROM @a t
      WHERE t.CompleteFlag IS NULL
        AND NOT EXISTS(SELECT 1 FROM @ab t1
                         JOIN @a t2 ON t1.aid = t2.id WHERE  t.id = t1.bid AND t2.CompleteFlag IS NULL) --no parents
        AND EXISTS(SELECT 1 FROM @ab t2 WHERE  t.id = t2.aid) --have children
      order by t.AttributeScope,t.id

    IF (@id is null)
       BREAK

    update a set a.AttributeValue = REPLACE(a.AttributeValue,'<' + @Name + '>',isnull(@Value1,''))
      from @a a
      join @ab ab on a.id = ab.bid and ab.aid = @id and ab.isexec = 0

   --execute value to get the value
   IF (@Value1 is not null
       AND EXISTS(SELECT 1 FROM @ab ab WHERE ab.aid = @id and ab.isexec = 1)
       AND )
   BEGIN
      SET @nValue = 'select top 1 @value = (' + @Value1 + ')'
      SET @Value2 = null
      EXEC sp_executesql @nValue,N'@value varchar(max) output',@value = @value2 out

      update a set a.AttributeValue = REPLACE(a.AttributeValue,'<' + @Name + '*>',isnull(@Value2,''))
        from @a a
        join @ab ab on a.id = ab.bid and ab.aid = @id and ab.isexec = 1
   END


   update @a set CompleteFlag = 1 where id = @id
END
*/
-------------------------------------------------------------------
--build context object
-------------------------------------------------------------------

;WITH XMLNAMESPACES ('ETLController.XSD' as etl)
select @pContext = 
 (select b.BatchID as '@BatchID'
,b.BatchName as '@BatchName'
,b.BatchDesc as '@BatchDesc'
,b.IgnoreErr as '@IgnoreErr'
,b.RestartOnErr as '@Restart'
,ba1.AttributeValue as '@HistRet'
,ba2.AttributeValue as '@MaxThread'
,ba3.AttributeValue as '@Ping'
,ba4.AttributeValue as '@Timeout'
,ba5.AttributeValue as '@Lifetime'
,ba6.AttributeValue as '@Retry'
,ba7.AttributeValue as '@Delay'
--,b.BatchDesc as 'Desc'
,p1.ProcessID as 'etl:OnSuccess/@ProcessID', p1.ScopeID as 'etl:OnSuccess/@ScopeID',p1.Process as 'etl:OnSuccess/etl:Process',p1.Param as 'etl:OnSuccess/etl:Param'
,p2.ProcessID as 'etl:OnFailure/@ProcessID', p2.ScopeID as 'etl:OnFailure/@ScopeID',p2.Process as 'etl:OnFailure/etl:Process',p2.Param as 'etl:OnFailure/etl:Param'
--batch attributes
--,(select ba.AttributeName as '@Name',ba.AttributeValue as '*' from dbo.ETLBatchAttribute ba
--   where b.BatchID = ba.BatchID
--     and ba.AttributeName not in ('HISTRET','MAXTHREAD','PING','TIMEOUT','LIFETIME','RETRY','DELAY')
--     for xml path('etl:Attribute'),type) as 'etl:Attributes'
,(select ba.AttributeName as '@Name',ba.AttributeValue as '*' from @a ba
   where b.BatchID = ba.BatchID and ba.StepID is null and ba.ConstID is null
     and ba.AttributeName not in ('HISTRET','MAXTHREAD','PING','TIMEOUT','LIFETIME','RETRY','DELAY')
     for xml path('etl:Attribute'),type) as 'etl:Attributes'

--
--batch constraints
,(select
 bc.ConstID as '@ConstID'
,bc.ConstOrder as '@ConstOrder'
,bc.WaitPeriod as '@WaitPeriod'
,bca1.AttributeValue as '@Disabled'
,bca2.AttributeValue as '@Ping'
,p0.ProcessID as 'etl:Process/@ProcessID', p0.ScopeID as 'etl:Process/@ScopeID',p0.Process as 'etl:Process/etl:Process',p0.Param as 'etl:Process/etl:Param'
--batch constraint attributes
--,(select bca.AttributeName as '@Name',bca.AttributeValue as '*'
--    from dbo.ETLBatchConstraintAttribute bca
--   where bc.BatchID = bca.BatchID and bc.ConstID = bca.ConstID
--     and bca.AttributeName not in ('DISABLED','PING')
--     for xml path('etl:Attribute'),type) as 'etl:Attributes'
,(select bca.AttributeName as '@Name',bca.AttributeValue as '*'
    from @a bca
   where bc.BatchID = bca.BatchID and bc.ConstID = bca.ConstID and bca.StepID is null
     and bca.AttributeName not in ('DISABLED','PING')
     for xml path('etl:Attribute'),type) as 'etl:Attributes'
--
   from dbo.[ETLBatchConstraint] bc
   left join dbo.[ETLProcess] p0 on bc.ProcessID = p0.ProcessID
   left join dbo.[ETLBatchConstraintAttribute] bca1 on bc.BatchID = bca1.BatchID and bc.ConstID = bca1.ConstID and bca1.AttributeName = 'DISABLED'
   left join dbo.[ETLBatchConstraintAttribute] bca2 on bc.BatchID = bca2.BatchID and bc.ConstID = bca2.ConstID and bca2.AttributeName = 'PING'
  where b.BatchID = bc.BatchID and (@StepID is null and (bc.ConstID = @ConstID or @ConstID is null)) and (@Scope is null or @Scope & 4 = 4) 
  for xml path('etl:Constraint'),type) as 'etl:Constraints'
--
--step
,(select s.StepID as '@StepID'
,s.StepName as '@StepName'
,s.StepDesc as '@StepDesc'
,s.IgnoreErr as '@IgnoreErr'
,s.StepOrder as '@StepOrder'
,sa1.AttributeValue as '@Disabled'
,sa2.AttributeValue as '@SeqGroup'
,sa3.AttributeValue as '@PriGroup'
,sa4.AttributeValue as '@Retry'
,sa6.AttributeValue as '@Delay'
,sa5.AttributeValue as '@Restart'
,sa7.AttributeValue as '@LoopGroup'
--,s.StepDesc as 'Desc'
,p0.ProcessID as 'etl:Process/@ProcessID', p0.ScopeID as 'etl:Process/@ScopeID',p0.Process as 'etl:Process/etl:Process',p0.Param as 'etl:Process/etl:Param'
,p1.ProcessID as 'etl:OnSuccess/@ProcessID', p1.ScopeID as 'etl:OnSuccess/@ScopeID',p1.Process as 'etl:OnSuccess/etl:Process',p1.Param as 'etl:OnSuccess/etl:Param'
,p2.ProcessID as 'etl:OnFailure/@ProcessID', p2.ScopeID as 'etl:OnFailure/@ScopeID',p2.Process as 'etl:OnFailure/etl:Process',p2.Param as 'etl:OnFailure/etl:Param'
--step attributes
--,(select sa.AttributeName as '@Name',sa.AttributeValue as '*' from dbo.ETLStepAttribute sa
--   where s.BatchID = sa.BatchID and s.StepID = sa.StepID
--     and sa.AttributeName not in ('DISABLED','SEQGROUP','PRIGROUP','RETRY','RESTART')
--     for xml path('etl:Attribute'),type) as 'etl:Attributes'
,(select sa.AttributeName as '@Name',sa.AttributeValue as '*' from @a sa
   where s.BatchID = sa.BatchID and s.StepID = sa.StepID and sa.ConstID is null
     and sa.AttributeName not in ('DISABLED','SEQGROUP','PRIGROUP','RETRY','DELAY','RESTART','LOOPGROUP')
     for xml path('etl:Attribute'),type) as 'etl:Attributes'
--
--step constraints
,(select
 sc.ConstID as '@ConstID'
,sc.ConstOrder as '@ConstOrder'
,sc.WaitPeriod as '@WaitPeriod'
,sca1.AttributeValue as '@Disabled'
,sca2.AttributeValue as '@Ping'
,p0.ProcessID as 'etl:Process/@ProcessID', p0.ScopeID as 'etl:Process/@ScopeID',p0.Process as 'etl:Process/etl:Process',p0.Param as 'etl:Process/etl:Param'
--step constraint attributes
--,(select sca.AttributeName as '@Name',sca.AttributeValue as '*'
--    from dbo.ETLStepConstraintAttribute sca where sc.BatchID = sca.BatchID and sc.StepID = sca.StepID and sc.ConstID = sca.ConstID
--     and sca.AttributeName not in ('DISABLED','PING')
--    for xml path('etl:Attribute'),type) as 'etl:Attributes'
,(select sca.AttributeName as '@Name',sca.AttributeValue as '*'
    from @a sca where sc.BatchID = sca.BatchID and sc.StepID = sca.StepID and sc.ConstID = sca.ConstID
     and sca.AttributeName not in ('DISABLED','PING')
    for xml path('etl:Attribute'),type) as 'etl:Attributes'
--
   from dbo.[ETLStepConstraint] sc
   left join dbo.[ETLProcess] p0 on sc.ProcessID = p0.ProcessID
   left join dbo.[ETLStepConstraintAttribute] sca1 on sc.BatchID = sca1.BatchID and sc.StepID = sca1.StepID and sc.ConstID = sca1.ConstID and sca1.AttributeName = 'DISABLED'
   left join dbo.[ETLStepConstraintAttribute] sca2 on sc.BatchID = sca2.BatchID and sc.StepID = sca2.StepID and sc.ConstID = sca2.ConstID and sca2.AttributeName = 'PING'
   where s.BatchID = sc.BatchID and s.StepID = sc.StepID  and (sc.ConstID = @ConstID or @ConstID is null) and (@Scope is null or @Scope & 8 = 8)
   for xml path('etl:Constraint'),type) as 'etl:Constraints'
--
 from dbo.[ETLStep] s
 left join dbo.[ETLProcess] p0 on s.StepProcID = p0.ProcessID
 left join dbo.[ETLProcess] p1 on s.OnSuccessID = p1.ProcessID
 left join dbo.[ETLProcess] p2 on s.OnFailureID = p2.ProcessID
 left join dbo.[ETLStepAttribute] sa1 on s.BatchID = sa1.BatchID and s.StepID = sa1.StepID and sa1.AttributeName = 'DISABLED'
 left join dbo.[ETLStepAttribute] sa2 on s.BatchID = sa2.BatchID and s.StepID = sa2.StepID and sa2.AttributeName = 'SEQGROUP'
 left join dbo.[ETLStepAttribute] sa3 on s.BatchID = sa3.BatchID and s.StepID = sa3.StepID and sa3.AttributeName = 'PRIGROUP'
 left join dbo.[ETLStepAttribute] sa4 on s.BatchID = sa4.BatchID and s.StepID = sa4.StepID and sa4.AttributeName = 'RETRY'
 left join dbo.[ETLStepAttribute] sa5 on s.BatchID = sa5.BatchID and s.StepID = sa5.StepID and sa5.AttributeName = 'RESTART'
 left join dbo.[ETLStepAttribute] sa6 on s.BatchID = sa6.BatchID and s.StepID = sa6.StepID and sa6.AttributeName = 'DELAY'
 left join dbo.[ETLStepAttribute] sa7 on s.BatchID = sa7.BatchID and s.StepID = sa7.StepID and sa7.AttributeName = 'LOOPGROUP'
 where b.BatchID = s.BatchID and (s.StepID = @StepID or @StepID is null) and (@Scope is null or @Scope & 2 = 2)
   for xml path('etl:Step'),type) as 'etl:Steps'
 from dbo.[ETLBatch] b
 left join dbo.[ETLProcess] p1 on b.OnSuccessID = p1.ProcessID
 left join dbo.[ETLProcess] p2 on b.OnFailureID = p2.ProcessID
 left join dbo.[ETLBatchAttribute] ba1 on b.BatchID = ba1.BatchID and ba1.AttributeName = 'HISTRET'
 left join dbo.[ETLBatchAttribute] ba2 on b.BatchID = ba2.BatchID and ba2.AttributeName = 'MAXTHREAD'
 left join dbo.[ETLBatchAttribute] ba3 on b.BatchID = ba3.BatchID and ba3.AttributeName = 'PING'
 left join dbo.[ETLBatchAttribute] ba4 on b.BatchID = ba4.BatchID and ba4.AttributeName = 'TIMEOUT'
 left join dbo.[ETLBatchAttribute] ba5 on b.BatchID = ba5.BatchID and ba5.AttributeName = 'LIFETIME'
 left join dbo.[ETLBatchAttribute] ba6 on b.BatchID = ba6.BatchID and ba6.AttributeName = 'RETRY'
 left join dbo.[ETLBatchAttribute] ba7 on b.BatchID = ba7.BatchID and ba7.AttributeName = 'DELAY'
 where (b.BatchID = @BatchID) and (@Scope is null or @Scope & 1 = 1)
for xml path ('etl:Context'),type)

end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

if (@debug = 1)
begin
   SET @msg =  'END Procedure ' + @ProcName
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@pHeader,@msg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo
end

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@pHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeScope]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@pContext]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[OnFailureID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[RestartOnErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ScopeID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Process]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Param]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ScopeID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Process]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Param]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ScopeID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Process]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Param]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepProcID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[OnFailureID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ScopeID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Process]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Param]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ScopeID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Process]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Param]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ScopeID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Process]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Param]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[ScopeID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Process]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLProcess].[Param]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext].[@a].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_CreateContext].[@a]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@a].[id]">
									<Property Name="IsNullable" Value="False" />
									<Property Name="IsIdentity" Value="True" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@a].[BatchID]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@a].[StepID]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@a].[ConstID]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@a].[AttributeName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@a].[AttributeValue]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@a].[AttributeScope]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@a].[CompleteFlag]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_CreateContext].[@ab]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@ab].[aid]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@ab].[bid]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_CreateContext].[@ab].[isexec]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateContext].[@pContext]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateContext].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="426" />
				<Property Name="Length" Value="17890" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;select * from ETLBatch&#xD;&#xA;select * from ETLStep where batchid = -320&#xD;&#xA;prc_ETLAttributeSet 60,null,null,'DsvVersion','2'&#xD;&#xA;prc_ETLAttributeSet 60,3,null,'DsvObject','LastHourMR'&#xD;&#xA;prc_ETLAttributeSet 60,2,null,'DsvObject','AdType'&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,340,2,null,4,1,15&#xD;&#xA;--select @pHeader&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;select @pContext&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_CreateContext]&#xD;&#xA;    @pContext xml([ETLController]) output&#xD;&#xA;   ,@pHeader xml([ETLController])&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CreateCounters]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[prc_CreateCounters].sql
** Name:	[dbo].[prc_CreateCounters]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Procedure/[prc_ETLStepCounterGet].sql:

** Desc:	return Counters object for a header context
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	10/30/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/

set nocount on

declare @msg                nvarchar(1000)
declare @debug              tinyint
declare @Options            int
declare @query              nvarchar(max)

declare @BatchID int
declare @StepID int
declare @RunID int
declare @ProcName sysname
declare @ProcessInfo xml(ETLController)
declare @Err int

set @ProcName = object_name(@@procid)
begin try

exec dbo.[prc_ReadHeader] @pHeader,@BatchID out,@StepID out,null,@RunID out,@Options out
set @debug = nullif(@Options & 1,0)

if (@debug = 1)
begin
   SET @msg =  'BEGIN Procedure ' + @ProcName + ' with context'
         + ' BatchID=' + isnull(cast(@BatchID as nvarchar(10)),'null')
         + ' StepID=' + isnull(cast(@StepID as nvarchar(10)),'null')
         + ' RunID=' + isnull(cast(@RunID as nvarchar(10)),'null')

   exec dbo.[prc_CreateProcessInfo] @ProcessInfo out,@pHeader=@pHeader,@pMsg=@msg
   exec dbo.[prc_Print] @pProcessInfo=@ProcessInfo
end

set @StepID = isnull(@StepID,0)

--return last known value for all counters
;with xmlnamespaces('ETLController.XSD' as etl)
select @pCounters = 
(select @BatchID as '@BatchID',nullif(@StepID,0) as '@StepID',@RunID as '@RunID'
,(select
        c.CounterName as '@Name'
       ,c.RunID as '@RunID'
       ,c.CounterValue as '*'
    from dbo.[ETLStepRunCounter] c (nolock)
    join (select max(c.RunID) as RunID, c.CounterName
            from dbo.[ETLStepRunCounter] c (nolock)
           where c.RunID <= @RunID and c.StepID = @StepID and c.BatchID = @BatchID
             and (@pName is null or c.CounterName = @pName)
           group by c.CounterName) p
      on c.RunID = p.RunID and c.CounterName = p.CounterName
   where (c.StepID = @StepID and c.BatchID = @BatchID
     and (@pName is null or c.CounterName = @pName))
     for xml path('etl:Counter'),type)
for xml path('etl:Counters'),type
)

if (@debug = 1)
begin
   SET @msg =  'END Procedure ' + @ProcName
   exec dbo.[prc_CreateProcessInfo] @ProcessInfo out,@pHeader=@pHeader,@pMsg=@msg
   exec dbo.[prc_Print] @pProcessInfo=@ProcessInfo
end

end try
begin catch	
	if @@trancount > 0 rollback tran
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pCounters = null
   raiserror (@msg,11,11)
end catch
   return 0
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateCounters].[@pHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo].[@pMsg]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print].[@pProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateCounters].[@pCounters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateCounters].[@pName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateCounters].[@pCounters]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateCounters].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateCounters].[@pName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="409" />
				<Property Name="Length" Value="3618" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;/*&#xD;&#xA;select * from ETLBatchRun where batchid = 130&#xD;&#xA;&#xD;&#xA;--select * from ETLStepRunCounter&#xD;&#xA;--insert ETLStepRunCounter&#xD;&#xA;--values(-20,1,4,'test','xxx')&#xD;&#xA;--insert ETLStepRunCounter&#xD;&#xA;--values(-20,1,3,'test1','yyy')&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pCounters xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-20,1,null,4,1&#xD;&#xA;--select @pHeader&#xD;&#xA;exec dbo.prc_CreateCounters @pCounters out,@pHeader&#xD;&#xA;select @pCounters&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;CREATE procedure [dbo].[prc_CreateCounters] (&#xD;&#xA;    @pCounters xml ([ETLController]) output&#xD;&#xA;   ,@pHeader xml([ETLController])&#xD;&#xA;   ,@pName nvarchar(100) = null&#xD;&#xA;) as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CreateHeader]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_CreateHeader.SQL
**
**D Desc:         return Header object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try
SET @pHeader =
  '<etl:Header xmlns:etl="ETLController.XSD"'
+ ' BatchID="' + CAST(@pBatchID AS nvarchar(30)) + '"'
+ CASE WHEN @pStepID IS NOT NULL THEN ' StepID="' + CAST(@pStepID AS nvarchar(30)) + '"' ELSE '' END
+ CASE WHEN @pConstID IS NOT NULL THEN N' ConstID="' + CAST(@pConstID AS nvarchar(30)) + '"' ELSE '' END
+ ' RunID="' + CAST(@pRunID AS nvarchar(30)) + '"'
+ CASE WHEN @pOptions IS NOT NULL THEN N' Options="' + CAST(@pOptions AS nvarchar(30)) + '"' ELSE '' END
+ CASE WHEN @pScope IS NOT NULL THEN N' Scope="' + CAST(@pScope AS nvarchar(30)) + '"' ELSE '' END
+ ' />'
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader].[@pHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader].[@pBatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader].[@pStepID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader].[@pConstID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader].[@pRunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader].[@pOptions]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader].[@pScope]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateHeader].[@pHeader]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateHeader].[@pBatchID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateHeader].[@pStepID]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateHeader].[@pConstID]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateHeader].[@pRunID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateHeader].[@pOptions]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateHeader].[@pScope]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="104" />
				<Property Name="Length" Value="1800" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,1,null,null,4,10&#xD;&#xA;select @pHeader&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_CreateHeader]&#xD;&#xA;    @pHeader xml([ETLController]) output&#xD;&#xA;   ,@pBatchID int&#xD;&#xA;   ,@pStepID int = null&#xD;&#xA;   ,@pConstID int = null&#xD;&#xA;   ,@pRunID int&#xD;&#xA;   ,@pOptions int = null&#xD;&#xA;   ,@pScope int = null&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CreateProcessInfo]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         etl_CreateProcessInfo.SQL
**
**D Desc:         return ProcessInfo object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)
DECLARE @Options int
DECLARE @debug tinyint
DECLARE @now nvarchar(30)
DECLARE @Prefix nvarchar(100)
DECLARE @BatchID int
DECLARE @StepID int

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0
SET @pErr = ISNULL(@pErr,0)

begin try

exec dbo.[prc_ReadHeader] @pHeader,@BatchID out,@StepID out,null,null,@Options out
set @debug = NULLIF(@Options & 1,0)

IF (@debug IS NOT NULL)
BEGIN
   --SET @Now = CONVERT(NVARCHAR(30),getdate(),121)
   SET @Prefix = CAST(isnull(@BatchID,0) as nvarchar(10)) + '.' + CAST(isnull(@StepID,0) as nvarchar(10))
               + ':' /*+ @@SERVERNAME + '.' + DB_NAME()*/ + 'SP=' + CAST(@@SPID AS nvarchar(10))
               + ':' + 'Er=' + CAST(@pErr AS nvarchar(10))
   --SET @pMsg =  'DEBUG(' + @@SERVERNAME + '.' + DB_NAME() + ' ID=' + CAST(@@SPID AS nvarchar(100)) + ':' + @Now + ') ' + isnull(@pMsg,'null')
   SET @pMsg =  'DEBUG(' + @Prefix + ') ' + isnull(@pMsg,'null')
   SET @pMsg =  isnull(@pMsg,'null')
END



SELECT @pProcessInfo = @pHeader.query('declare namespace etl="ETLController.XSD";
  <etl:ProcessInfo>
   {etl:Header}
   <etl:Message Error="{sql:variable("@pErr")}">{sql:variable("@pMsg")}</etl:Message>
  </etl:ProcessInfo>
')
 
 
 
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo].[@pErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo].[@pHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo].[@pMsg]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo].[@pProcessInfo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessInfo].[@pProcessInfo]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessInfo].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessInfo].[@pMsg]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessInfo].[@pErr]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="217" />
				<Property Name="Length" Value="2438" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pProcessInfo xml&#xD;&#xA;exec dbo.etl_CreateHeader @pHeader out,1,null,null,4,1&#xD;&#xA;select @pHeader&#xD;&#xA;exec dbo.etl_CreateProcessInfo @pProcessInfo out,@pHeader,'xxx'&#xD;&#xA;select @pProcessInfo&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_CreateProcessInfo]&#xD;&#xA;    @pProcessInfo xml([ETLController]) output&#xD;&#xA;   ,@pHeader xml([ETLController])&#xD;&#xA;   ,@pMsg nvarchar(max)&#xD;&#xA;   ,@pErr int = null&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CreateProcessReceipt]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_CreateProcessReceipt.SQL
**
**D Desc:         return ProcessReceipt object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try
SELECT @pProcessReceipt = @pHeader.query('declare namespace etl="ETLController.XSD";
  <etl:ProcessReceipt>
   {etl:Header}
   <etl:Status StatusID="{sql:variable("@pStatusID")}" Error="{sql:variable("@pErr")}">
    <etl:msg>{sql:variable("@pErrMsg")}</etl:msg>
   </etl:Status>
  </etl:ProcessReceipt>
')
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt].[@pProcessReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt].[@pHeader]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessReceipt].[@pProcessReceipt]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessReceipt].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessReceipt].[@pStatusID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessReceipt].[@pErr]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessReceipt].[@pErrMsg]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="236" />
				<Property Name="Length" Value="1652" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,1,null,null,4,10&#xD;&#xA;select @pHeader&#xD;&#xA;exec dbo.prc_CreateProcessReceipt @pProcessReceipt out,@pHeader,2,5000,null&#xD;&#xA;select @pProcessReceipt&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_CreateProcessReceipt]&#xD;&#xA;    @pProcessReceipt xml([ETLController]) output&#xD;&#xA;   ,@pHeader xml([ETLController])&#xD;&#xA;   ,@pStatusID int&#xD;&#xA;   ,@pErr int&#xD;&#xA;   ,@pErrMsg nvarchar(max) = null&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_CreateProcessRequest]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_CreateProcessRequest.SQL
**
**D Desc:         return ProcessRequest object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)
DECLARE @x xml
DECLARE @nHandle nvarchar(36)
DECLARE @nHandleGrp nvarchar(36)
DECLARE @pr nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

set @nHandle= isnull(cast(@pConversation as nvarchar(36)),'')
set @nHandleGrp= isnull(cast(@pConversationGrp as nvarchar(36)),'')

begin try
set @pr = '
  <etl:ProcessRequest xmlns:etl="ETLController.XSD">
   <etl:Header/>
   <etl:SrcConversation>' + @nHandle + '</etl:SrcConversation>
   <etl:SrcConversationGrp>' + @nHandleGrp + '</etl:SrcConversationGrp>
   <etl:DstConversation/>
   <etl:DstConversationGrp/>
   <etl:Context/>
   </etl:ProcessRequest>
'
set @pr = replace(@pr,'<etl:Header/>',cast(@pHeader as nvarchar(max)))

set @pr = replace(@pr,'<etl:Context/>',isnull(cast(@pContext as nvarchar(max)),''))

set @pProcessRequest = @pr

end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessRequest].[@pConversation]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessRequest].[@pConversationGrp]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessRequest].[@pHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessRequest].[@pContext]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessRequest].[@pProcessRequest]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessRequest].[@pProcessRequest]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessRequest].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessRequest].[@pContext]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessRequest].[@pConversation]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_CreateProcessRequest].[@pConversationGrp]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="386" />
				<Property Name="Length" Value="2305" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @uid uniqueidentifier&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;set @uid = newid()&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-10,null,null,4,10&#xD;&#xA;--exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext,@uid&#xD;&#xA;select @pHeader&#xD;&#xA;select @pContext&#xD;&#xA;select @pProcessRequest&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_CreateProcessRequest]&#xD;&#xA;    @pProcessRequest xml([ETLController]) output&#xD;&#xA;   ,@pHeader xml([ETLController])&#xD;&#xA;   ,@pContext xml([ETLController])&#xD;&#xA;   ,@pConversation uniqueidentifier = null&#xD;&#xA;   ,@pConversationGrp uniqueidentifier = null&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_de_CreateParameters]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_de_CreateParameters.SQL
**
**D Desc:         return delta extractor parameters object
**
**D Auth:         andreys
**D Date:         12/11/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
2010-05-16           andrey@biasintelligence.com           add multiple destination support
2017-05-02			 andrey								   add OData source support
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)
DECLARE @pr nvarchar(max)

DECLARE @Header xml (ETLController)
DECLARE @Context xml (ETLController)
DECLARE @Attributes xml (ETLController)
DECLARE @Handle uniqueidentifier
DECLARE @HandleGrp uniqueidentifier
DECLARE @BatchID int
DECLARE @StepID int
DECLARE @RunID int
DECLARE @Options int
DECLARE @Scope int

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try

exec @ProcErr = dbo.[prc_ReadProcessRequest] @pProcessRequest,@Header out,@Context out,@Handle out,@HandleGrp out
exec @ProcErr = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out,@Scope out
exec @ProcErr = dbo.[prc_ReadContextAttributes] @pProcessRequest,@Attributes out
exec @ProcErr = dbo.prc_DE_MapAttributes @Attributes out
--select @Attributes

declare @attr table (AttributeName nvarchar(100),AttributeValue nvarchar(max))
;with xmlnamespaces('ETLController.XSD' as etl)
insert @attr
select b.b.value('./@Name[1]','nvarchar(100)'),b.b.value('(.)[1]','nvarchar(max)')
  from @Attributes.nodes('/etl:Attributes') a(a)
  cross apply a.a.nodes('./etl:Attribute') b(b)


declare @dst table (DestinationName nvarchar(100),DestinationType nvarchar(100))
insert @dst
select replace(AttributeName,'.Component',''),AttributeValue
  from @attr where AttributeName like 'Destination%.Component'


--;with xmlnamespaces ('DeltaExtractor.XSD' as de,'ETLController.XSD' as etl)
;with xmlnamespaces ('DeltaExtractor.XSD' as de)
select @pParameters = 
--header
 (select @BatchID as 'de:ETLHeader/de:BatchID',@StepID as 'de:ETLHeader/de:StepID',@RunID as 'de:ETLHeader/de:RunID'
,isnull((select top 1 AttributeValue from @attr where AttributeName = 'Control.Server'),@@SERVERNAME) as 'de:ETLHeader/de:Controller/de:Server'
,isnull((select top 1 AttributeValue from @attr where AttributeName = 'Control.Database'),DB_NAME()) as 'de:ETLHeader/de:Controller/de:Database'
,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:ETLHeader/de:Controller/de:QueryTimeout'
,@@SERVERNAME as 'de:ETLHeader/de:Node/de:Server'
,DB_NAME() as 'de:ETLHeader/de:Node/de:Database'
,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:ETLHeader/de:Node/de:QueryTimeout'
,@handle as 'de:ETLHeader/de:Conversation',@Options as 'de:ETLHeader/de:Options'
--
,case (select AttributeValue from @attr where AttributeName = 'Action')
 when 'MoveData'
 then
    (select
--define source
--supported OLEDB, FlatFile, Excel, Sharepoint, AdoNet, ODBC
    case when (isnull((select top 1 AttributeValue from @attr where AttributeName = 'Source.Component' and AttributeValue = 'OLEDB'),'') <> '')
      then
--OLEDB source
    (select
   (select top 1 AttributeValue from @attr where AttributeName = 'Source.Server') as 'de:OleDbSource/de:DBConnection/de:Server'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Database') as 'de:OleDbSource/de:DBConnection/de:Database'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ConnectionString') as 'de:OleDbSource/de:DBConnection/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:OleDbSource/de:DBConnection/de:QueryTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.QueryType') as 'de:OleDbSource/de:QueryType'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.OLEDB.AccessMode') as 'de:OleDbSource/de:CustomProperties/de:AccessMode'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Query') as 'de:OleDbSource/de:CustomProperties/de:SqlCommand'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:OleDbSource/de:CustomProperties/de:CommandTimeout'
  for xml path('de:DataSource'),type)
--FlatFile source  
      when (isnull((select top 1 AttributeValue from @attr where AttributeName = 'Source.Component' and AttributeValue = 'FlatFile'),'') <> '')
      then
    (select
   (select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.CodePage') as 'de:FlatFileSource/de:CustomProperties/de:CodePage'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.ConnectionString') as 'de:FlatFileSource/de:CustomProperties/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.DataRowsToSkip') as 'de:FlatFileSource/de:CustomProperties/de:DataRowsToSkip'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.Format') as 'de:FlatFileSource/de:CustomProperties/de:Format'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.ColumnNamesInFirstDataRow') as 'de:FlatFileSource/de:CustomProperties/de:ColumnNamesInFirstDataRow'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.HeaderRowDelimiter') as 'de:FlatFileSource/de:CustomProperties/de:HeaderRowDelimiter'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.HeaderRowsToSkip') as 'de:FlatFileSource/de:CustomProperties/de:HeaderRowsToSkip'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.TextQualifier') as 'de:FlatFileSource/de:CustomProperties/de:TextQualifier'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.Unicode') as 'de:FlatFileSource/de:CustomProperties/de:Unicode'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.ColumnDelimiter') as 'de:FlatFileSource/de:CustomProperties/de:ColumnDelimiter'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.RecordDelimiter') as 'de:FlatFileSource/de:CustomProperties/de:RecordDelimiter'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.FileNameColumnName') as 'de:FlatFileSource/de:CustomProperties/de:FileNameColumnName'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.FlatFile.RetainNulls') as 'de:FlatFileSource/de:CustomProperties/de:RetainNulls'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.CompressionType') as 'de:FlatFileSource/de:CustomProperties/de:DataCompression'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.StagingAreaTableName') as 'de:FlatFileSource/de:CustomProperties/de:StagingAreaTableName'
  for xml path('de:DataSource'),type)
--Sharepoint source  
      when (isnull((select top 1 AttributeValue from @attr where AttributeName = 'Source.Component' and AttributeValue = 'SPList'),'') <> '')
      then
    (select
   (select top 1 AttributeValue from @attr where AttributeName = 'Source.ConnectionString') as 'de:SharePointSource/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.BatchSize') as 'de:SharePointSource/de:CustomProperties/de:BatchSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.CamlQuery') as 'de:SharePointSource/de:CustomProperties/de:CamlQuery'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.IncludeFolders') as 'de:SharePointSource/de:CustomProperties/de:IncludeFolders'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.IsRecursive') as 'de:SharePointSource/de:CustomProperties/de:IsRecursive'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.SharePointCulture') as 'de:SharePointSource/de:CustomProperties/de:SharePointCulture'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.SiteListName') as 'de:SharePointSource/de:CustomProperties/de:SiteListName'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.SiteListViewName') as 'de:SharePointSource/de:CustomProperties/de:SiteListViewName'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.SiteUrl') as 'de:SharePointSource/de:CustomProperties/de:SiteUrl'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.DecodeLookupColumns') as 'de:SharePointSource/de:CustomProperties/de:DecodeLookupColumns'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.IncludeHiddenColumns') as 'de:SharePointSource/de:CustomProperties/de:IncludeHiddenColumns'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.SPList.UseConnectionManager') as 'de:SharePointSource/de:CustomProperties/de:UseConnectionManager'
  for xml path('de:DataSource'),type)
--Excel source
      when (isnull((select top 1 AttributeValue from @attr where AttributeName = 'Source.Component' and AttributeValue = 'Excel'),'') <> '')
      then
    (select
   (select top 1 AttributeValue from @attr where AttributeName = 'Source.Excel.FilePath') as 'de:ExcelSource/de:FilePath'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Excel.Header') as 'de:ExcelSource/de:Header'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Excel.ExcelVersion') as 'de:ExcelSource/de:ExcelVersion'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Excel.AccessMode') as 'de:ExcelSource/de:CustomProperties/de:AccessMode'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Excel.OpenRowset') as 'de:ExcelSource/de:CustomProperties/de:OpenRowset'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Excel.SqlCommand') as 'de:ExcelSource/de:CustomProperties/de:SqlCommand'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:ExcelSource/de:CustomProperties/de:CommandTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.CompressionType') as 'de:ExcelSource/de:DataCompression'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.StagingAreaTableName') as 'de:ExcelSource/de:StagingAreaTableName'
  for xml path('de:DataSource'),type)
--AdoNet source
    when (isnull((select top 1 AttributeValue from @attr where AttributeName = 'Source.Component' and AttributeValue = 'ADONET'),'') <> '')
      then
    (select
   (select top 1 AttributeValue from @attr where AttributeName = 'Source.Server') as 'de:AdoNetSource/de:DBConnection/de:Server'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Database') as 'de:AdoNetSource/de:DBConnection/de:Database'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ConnectionString') as 'de:AdoNetSource/de:DBConnection/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ConnectionQualifier') as 'de:AdoNetSource/de:DBConnection/de:Qualifier'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:AdoNetSource/de:DBConnection/de:QueryTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ADONET.AccessMode') as 'de:AdoNetSource/de:CustomProperties/de:AccessMode'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Query') as 'de:AdoNetSource/de:CustomProperties/de:SqlCommand'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:AdoNetSource/de:CustomProperties/de:CommandTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ADONET.AllowImplicitStringConversion') as 'de:AdoNetSource/de:CustomProperties/de:AllowImplicitStringConversion'
  for xml path('de:DataSource'),type)
--Odbc source
    when (isnull((select top 1 AttributeValue from @attr where AttributeName = 'Source.Component' and AttributeValue = 'ODBC'),'') <> '')
      then
    (select
   (select top 1 AttributeValue from @attr where AttributeName = 'Source.Server') as 'de:OdbcSource/de:DBConnection/de:Server'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Database') as 'de:OdbcSource/de:DBConnection/de:Database'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ConnectionString') as 'de:OdbcSource/de:DBConnection/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ConnectionQualifier') as 'de:OdbcSource/de:DBConnection/de:Qualifier'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:OdbcSource/de:DBConnection/de:QueryTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ODBC.AccessMode') as 'de:OdbcSource/de:CustomProperties/de:AccessMode'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.Query') as 'de:OdbcSource/de:CustomProperties/de:SqlCommand'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:OdbcSource/de:CustomProperties/de:StatementTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ODBC.BatchSize') as 'de:OdbcSource/de:CustomProperties/de:BatchSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ODBC.LobChunkSize') as 'de:OdbcSource/de:CustomProperties/de:LobChunkSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ODBC.ExposeCharColumnsAsUnicode') as 'de:OdbcSource/de:CustomProperties/de:ExposeCharColumnsAsUnicode'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ODBC.FetchMethod') as 'de:OdbcSource/de:CustomProperties/de:FetchMethod'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ODBC.DefaultCodePage') as 'de:OdbcSource/de:CustomProperties/de:DefaultCodePage'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ODBC.BindNumericAs') as 'de:OdbcSource/de:CustomProperties/de:BindNumericAs'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.ODBC.BindCharColumnsAs') as 'de:OdbcSource/de:CustomProperties/de:BindCharColumnsAs'
  for xml path('de:DataSource'),type)
--OData source  
      when (isnull((select top 1 AttributeValue from @attr where AttributeName = 'Source.Component' and AttributeValue = 'ODATA'),'') <> '')
      then
    (select
   (select top 1 AttributeValue from @attr where AttributeName = 'Source.ConnectionString') as 'de:ODataSource/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.OData.DefaultStringLength') as 'de:ODataSource/de:CustomProperties/de:DefaultStringLength'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.OData.CollectionName') as 'de:ODataSource/de:CustomProperties/de:CollectionName'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.OData.Query') as 'de:ODataSource/de:CustomProperties/de:Query'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.OData.ResourcePath') as 'de:ODataSource/de:CustomProperties/de:ResourcePath'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Source.OData.UseResourcePath') as 'de:ODataSource/de:CustomProperties/de:UseResourcePath'
  for xml path('de:DataSource'),type)
      end

--define destinations
  ,(select
-- OLEDB destination
    (select
   (select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Server') as 'de:DBConnection/de:Server'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Database') as 'de:DBConnection/de:Database'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ConnectionString') as 'de:DBConnection/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:DBConnection/de:QueryTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Staging') as 'de:StagingBlock/@Staging'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTableName') as 'de:StagingBlock/de:StagingTableName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTablePrepare') as 'de:StagingBlock/de:StagingTablePrepare'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTableUpload') as 'de:StagingBlock/de:StagingTableUpload'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.UserOptions') as 'de:StagingBlock/de:UserOptions'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MinPartitionID') as 'de:PartitionRange/@Min'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MaxPartitionID') as 'de:PartitionRange/@Max'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.OLEDB.AccessMode') as 'de:CustomProperties/de:AccessMode'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.TableName') as 'de:CustomProperties/de:OpenRowset'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.OLEDB.FastLoadOptions') as 'de:CustomProperties/de:FastLoadOptions'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.OLEDB.FastLoadKeepIdentity') as 'de:CustomProperties/de:FastLoadKeepIdentity'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.OLEDB.FastLoadKeepNulls') as 'de:CustomProperties/de:FastLoadKeepNulls'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.OLEDB.FastLoadMaxInsertCommitSize') as 'de:CustomProperties/de:FastLoadMaxInsertCommitSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:CustomProperties/de:CommandTimeout'
  from @dst dst where dst.DestinationType = 'OLEDB'
  for xml path('de:OleDbDestination'),type)
--FlatFile destination 
   ,(select 
   (select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MinPartitionID') as 'de:PartitionRange/@Min'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MaxPartitionID') as 'de:PartitionRange/@Max'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.CodePage') as 'de:CustomProperties/de:CodePage'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.ConnectionString') as 'de:CustomProperties/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.DataRowsToSkip') as 'de:CustomProperties/de:DataRowsToSkip'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.Format') as 'de:CustomProperties/de:Format'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.ColumnNamesInFirstDataRow') as 'de:CustomProperties/de:ColumnNamesInFirstDataRow'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.HeaderRowDelimiter') as 'de:CustomProperties/de:HeaderRowDelimiter'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.TextQualifier') as 'de:CustomProperties/de:TextQualifier'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.Unicode') as 'de:CustomProperties/de:Unicode'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.ColumnDelimiter') as 'de:CustomProperties/de:ColumnDelimiter'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.RecordDelimiter') as 'de:CustomProperties/de:RecordDelimiter'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.Header') as 'de:CustomProperties/de:Header'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.FlatFile.Override') as 'de:CustomProperties/de:Override'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.CompressionType') as 'de:CustomProperties/de:DataCompression'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingAreaTableName') as 'de:CustomProperties/de:StagingAreaTableName'
  from @dst dst where dst.DestinationType = 'FlatFile'
  for xml path('de:FlatFileDestination'),type)
--Sharepoint destination 
   ,(select 
   (select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ConnectionString') as 'de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.BatchSize') as 'de:CustomProperties/de:BatchSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.CamlQuery') as 'de:CustomProperties/de:CamlQuery'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.IncludeFolders') as 'de:CustomProperties/de:IncludeFolders'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.IsRecursive') as 'de:CustomProperties/de:IsRecursive'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.SharePointCulture') as 'de:CustomProperties/de:SharePointCulture'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.SiteListName') as 'de:CustomProperties/de:SiteListName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.SiteListViewName') as 'de:CustomProperties/de:SiteListViewName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.SiteUrl') as 'de:CustomProperties/de:SiteUrl'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SPList.UseConnectionManager') as 'de:CustomProperties/de:UseConnectionManager'
  from @dst dst where dst.DestinationType = 'SPList'
  for xml path('de:SharePointDestination'),type)
-- Excel destination
   ,(select
   (select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Excel.FilePath') as 'de:FilePath'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Excel.Header') as 'de:Header'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Excel.ExcelVersion') as 'de:ExcelVersion'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MinPartitionID') as 'de:PartitionRange/@Min'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MaxPartitionID') as 'de:PartitionRange/@Max'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Excel.AccessMode') as 'de:CustomProperties/de:AccessMode'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Excel.OpenRowset') as 'de:CustomProperties/de:OpenRowset'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:CustomProperties/de:CommandTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.CompressionType') as 'de:CustomProperties/de:DataCompression'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingAreaTableName') as 'de:CustomProperties/de:StagingAreaTableName'
  from @dst dst where dst.DestinationType = 'Excel'
  for xml path('de:ExcelDestination'),type)
-- ADONET destination
   ,(select
   (select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Server') as 'de:DBConnection/de:Server'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Database') as 'de:DBConnection/de:Database'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ConnectionString') as 'de:DBConnection/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ConnectionQualifier') as 'de:DBConnection/de:Qualifier'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:DBConnection/de:QueryTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Staging') as 'de:StagingBlock/@Staging'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTableName') as 'de:StagingBlock/de:StagingTableName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTablePrepare') as 'de:StagingBlock/de:StagingTablePrepare'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTableUpload') as 'de:StagingBlock/de:StagingTableUpload'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.UserOptions') as 'de:StagingBlock/de:UserOptions'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MinPartitionID') as 'de:PartitionRange/@Min'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MaxPartitionID') as 'de:PartitionRange/@Max'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ADONET.AccessMode') as 'de:CustomProperties/de:AccessMode'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.TableName') as 'de:CustomProperties/de:TableOrViewName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ADONET.BatchSize') as 'de:CustomProperties/de:BatchSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ADONET.UseBulkInsertWhenPossible') as 'de:CustomProperties/de:UseBulkInsertWhenPossible'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:CustomProperties/de:CommandTimeout'
  from @dst dst where dst.DestinationType = 'ADONET'
  for xml path('de:AdoNetDestination'),type)
-- ODBC destination
   ,(select
   (select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Server') as 'de:DBConnection/de:Server'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Database') as 'de:DBConnection/de:Database'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ConnectionString') as 'de:DBConnection/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ConnectionQualifier') as 'de:DBConnection/de:Qualifier'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:DBConnection/de:QueryTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Staging') as 'de:StagingBlock/@Staging'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTableName') as 'de:StagingBlock/de:StagingTableName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTablePrepare') as 'de:StagingBlock/de:StagingTablePrepare'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTableUpload') as 'de:StagingBlock/de:StagingTableUpload'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.UserOptions') as 'de:StagingBlock/de:UserOptions'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MinPartitionID') as 'de:PartitionRange/@Min'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MaxPartitionID') as 'de:PartitionRange/@Max'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ODBC.InsertMethod') as 'de:CustomProperties/de:InsertMethod'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ODBC.BindCharColumnsAs') as 'de:CustomProperties/de:BindCharColumnsAs'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ODBC.BindNumericAs') as 'de:CustomProperties/de:BindNumericAs'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.TableName') as 'de:CustomProperties/de:TableName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ODBC.BatchSize') as 'de:CustomProperties/de:BatchSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ODBC.TransactionSize') as 'de:CustomProperties/de:TransactionSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ODBC.LobChunkSize') as 'de:CustomProperties/de:LobChunkSize'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:CustomProperties/de:StatementTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ODBC.DefaultCodePage') as 'de:CustomProperties/de:DefaultCodePage'
  from @dst dst where dst.DestinationType = 'ODBC'
  for xml path('de:OdbcDestination'),type)
-- SqlBulk destination
   ,(select
   (select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Server') as 'de:DBConnection/de:Server'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Database') as 'de:DBConnection/de:Database'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.ConnectionString') as 'de:DBConnection/de:ConnectionString'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:DBConnection/de:QueryTimeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.Staging') as 'de:StagingBlock/@Staging'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTableName') as 'de:StagingBlock/de:StagingTableName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTablePrepare') as 'de:StagingBlock/de:StagingTablePrepare'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.StagingTableUpload') as 'de:StagingBlock/de:StagingTableUpload'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.UserOptions') as 'de:StagingBlock/de:UserOptions'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MinPartitionID') as 'de:PartitionRange/@Min'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.MaxPartitionID') as 'de:PartitionRange/@Max'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.DefaultCodePage') as 'de:CustomProperties/de:DefaultCodePage'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.AlwaysUseDefaultCodePage') as 'de:CustomProperties/de:AlwaysUseDefaultCodePage'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.TableName') as 'de:CustomProperties/de:BulkInsertTableName'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertCheckConstraints') as 'de:CustomProperties/de:BulkInsertCheckConstraints'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertFirstRow') as 'de:CustomProperties/de:BulkInsertFirstRow'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertFireTriggers') as 'de:CustomProperties/de:BulkInsertFireTriggers'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertKeepIdentity') as 'de:CustomProperties/de:BulkInsertKeepIdentity'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertKeepNulls') as 'de:CustomProperties/de:BulkInsertKeepNulls'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertLastRow') as 'de:CustomProperties/de:BulkInsertLastRow'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertMaxErrors') as 'de:CustomProperties/de:BulkInsertMaxErrors'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertOrder') as 'de:CustomProperties/de:BulkInsertOrder'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.BulkInsertTablock') as 'de:CustomProperties/de:BulkInsertTablock'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'QueryTimeout') as 'de:CustomProperties/de:Timeout'
  ,(select top 1 AttributeValue from @attr where AttributeName = dst.DestinationName + '.SQLBULK.MaxInsertCommitSize') as 'de:CustomProperties/de:MaxInsertCommitSize'
  from @dst dst where dst.DestinationType = 'SQLBULK'
  for xml path('de:SqlBulkDestination'),type)
  for xml path('de:DataDestination'),type)
  
  ,(select top 1 AttributeValue from @attr where AttributeName = 'StagingAreaRoot') as 'de:StagingAreaRoot'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Destination.PartitionFunction') as 'de:Partition/@Function'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Destination.PartitionFunctionInput') as 'de:Partition/de:Input'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'Destination.PartitionFunctionOutput') as 'de:Partition/de:Output'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'SavePackage') as 'de:SavePackage/@Save'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'LoadPackage') as 'de:SavePackage/@Load'
  ,(select top 1 AttributeValue from @attr where AttributeName = 'PackageFileName') as 'de:SavePackage'
  for xml path('de:MoveData'),type)
 when 'RunPackage'
 then (select
  (select top 1 AttributeValue from @attr where AttributeName = 'Package.File') as 'de:File'
  for xml path('de:RunPackage'),type)
end
 for xml path(''),type, root('de:Parameters'))


end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pParameters = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@pProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_DE_MapAttributes]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@pParameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@dst].[DestinationName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters].[@dst].[DestinationType]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_de_CreateParameters].[@attr]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_de_CreateParameters].[@attr].[AttributeValue]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_de_CreateParameters].[@dst]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_de_CreateParameters].[@dst].[DestinationName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_de_CreateParameters].[@dst].[DestinationType]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_de_CreateParameters].[@pParameters]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLClient_DE]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_de_CreateParameters].[@pProcessRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="619" />
				<Property Name="Length" Value="36303" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;--select * from ETLStepattribute where batchid = -1&#xD;&#xA;--select * from ETLBatch where batchid = -15&#xD;&#xA;declare @uid uniqueidentifier&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pParameters xml--(ETLClient_DE)&#xD;&#xA;--set @uid = newid()&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-10,12,null,4,10&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext,@uid&#xD;&#xA;exec dbo.prc_de_CreateParameters @pParameters out, @pProcessRequest&#xD;&#xA;--select @pHeader&#xD;&#xA;select @pContext&#xD;&#xA;--select @pProcessRequest&#xD;&#xA;select @pParameters&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_de_CreateParameters]&#xD;&#xA;    @pParameters xml([ETLClient_DE]) output&#xD;&#xA;   --@pParameters xml output&#xD;&#xA;   ,@pProcessRequest xml([ETLController])&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_DE_MapAttributes]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         ETLController.SQL
**
**D Desc:         map ETL attributes to de expected 
**
**D Auth:         andreys
**D Date:         12/11/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
2010-05-16           andrey@biasintelligence.com           change the mapping logic to allow for pattern mapping
                                        to support multiple destinations
2017-05-02			 andrey								   add OData source support

******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)
DECLARE @pr nvarchar(max)


SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try

declare @attr table (AttributeName nvarchar(100),AttributeValue nvarchar(max))
declare @map table (AttributeName sysname,inOverride sysname null,outOverride sysname null)


-------------------------------------------------------------------------
-- de required mapping
-------------------------------------------------------------------------
insert @map
--header
          select 'BatchID',null,'Control.BatchID'
union all select 'StepID',null,'Control.StepID'
union all select 'RunID',null,'Control.RunID'
union all select 'Conversation',null,'Control.Conversation'
union all select 'ConversationGrp',null,'Control.ConversationGrp'
union all select 'Options',null,'Control.Options'
union all select 'Control.Database',null,null
union all select 'Control.Server',null,null

--action MoveData,RunPackage
union all select 'Action',null,'Action'
--RunPackage
union all select 'Package.File',null,null

--MoveData
union all select 'Source.Server',null,null
union all select 'Source.Database',null,null
union all select 'Source.ConnectionString',null,null
union all select 'Source.ConnectionQualifier',null,null

--action MoveData
union all select 'Destination%.Server',null,null
union all select 'Destination%.Database',null,null
union all select 'Destination%.TableName',null,null
union all select 'Destination%.ConnectionString',null,null
union all select 'Destination%.ConnectionQualifier',null,null

--Partition Control
union all select 'Destination.PartitionFunction',null,null
union all select 'Destination.PartitionFunctionInput',null,null
union all select 'Destination.PartitionFunctionOutput',null,null
union all select 'Destination%.MinPartitionID',null,null
union all select 'Destination%.MaxPartitionID',null,null


--action MoveData
union all select 'Source.Component',null,null
union all select 'StagingAreaRoot',null,null
union all select 'Source.StagingAreaTable','StagingAreaTable','StagingAreaTableName'
union all select 'Source.Query',null,null
union all select 'Source.QueryType',null,null
union all select 'Source.CompessionType',null,null
--OLEDBSource
union all select 'Source.OLEDB.AccessMode',null,null
union all select 'Source.OLEDB.SqlCommand','OLEDB.SqlCommand','Query'
union all select 'Source.OLEDB.CommandTimeout',null,'QueryTimeout'
--FlatFileSource
union all select 'Source.FlatFile.ColumnDelimiter',null,null
union all select 'Source.FlatFile.RecordDelimiter',null,null
union all select 'Source.FlatFile.ConnectionString',null,null
union all select 'Source.FlatFile.TextQualifier',null,null
union all select 'Source.FlatFile.Format',null,null
union all select 'Source.FlatFile.Unicode',null,null
union all select 'Source.FlatFile.ColumnNamesInFirstDataRow',null,null
--SharePointSource
union all select 'Source.SPList.BatchSize',null,null
union all select 'Source.SPList.CamlQuery',null,null
union all select 'Source.SPList.IncludeFolders',null,null
union all select 'Source.SPList.IsRecursive',null,null
union all select 'Source.SPList.SharePointCulture',null,null
union all select 'Source.SPList.SiteListName',null,null
union all select 'Source.SPList.SiteListViewName',null,null
union all select 'Source.SPList.SiteUrl',null,null
union all select 'Source.SPList.DecodeLookupColumns',null,null
union all select 'Source.SPList.IncludeHiddenColumns',null,null
union all select 'Source.SPList.UseConnectionManager',null,null
--ExcelSource
union all select 'Source.Excel.FilePath',null,null
union all select 'Source.Excel.Header',null,null
union all select 'Source.Excel.ExcelVersion',null,null
union all select 'Source.Excel.AccessMode',null,null
union all select 'Source.Excel.OpenRowset',null,null
union all select 'Source.Excel.SqlCommand',null,null
union all select 'Source.Excel.CommandTimeout',null,'QueryTimeout'
--AdoNetSource
union all select 'Source.ADONET.AccessMode',null,null
union all select 'Source.ADONET.SqlCommand','ADONET.SqlCommand','Query'
union all select 'Source.ADONET.CommandTimeout',null,'QueryTimeout'
union all select 'Source.ADONET.AllowImplicitStringConversion',null,null
--OdbcSource
union all select 'Source.ODBC.AccessMode',null,null
union all select 'Source.ODBC.SqlCommand','ODBC.SqlCommand','Query'
union all select 'Source.ODBC.CommandTimeout',null,'QueryTimeout'
union all select 'Source.ODBC.StatementTimeout',null,'QueryTimeout'
union all select 'Source.ODBC.BatchSize',null,null
union all select 'Source.ODBC.LobChunkSize',null,null
union all select 'Source.ODBC.ExposeCharColumnsAsUnicode',null,null
union all select 'Source.ODBC.FetchMethod',null,null
union all select 'Source.ODBC.DefaultCodePage',null,null
union all select 'Source.ODBC.BindNumericAs',null,null
union all select 'Source.ODBC.BindCharColumnsAs',null,null
--ODataSource
union all select 'Source.OData.DefaultStringLength',null,null
union all select 'Source.OData.CollectionName',null,null
union all select 'Source.OData.Query',null,null
union all select 'Source.OData.ResourcePath',null,null
union all select 'Source.OData.UseResourcePath',null,null

union all select 'Destination%.StagingAreaTable','StagingAreaTable','StagingAreaTableName'
union all select 'Destination%.Component',null,null
union all select 'Destination%.CompessionType',null,null
--FlatFileDestination
union all select 'Destination%.FlatFile.ColumnDelimiter',null,null
union all select 'Destination%.FlatFile.RecordDelimiter',null,null
union all select 'Destination%.FlatFile.ConnectionString',null,null
union all select 'Destination%.FlatFile.TextQualifier',null,null
union all select 'Destination%.FlatFile.Format',null,null
union all select 'Destination%.FlatFile.Unicode',null,null
union all select 'Destination%.FlatFile.Override',null,null
--OLEDBDestination
union all select 'Destination%.OLEDB.AccessMode',null,null
union all select 'Destination%.OLEDB.OpenRowset','OLEDB.OpenRowset','TableName'
union all select 'Destination%.OLEDB.TableName','OLEDB.TableName','TableName'
union all select 'Destination%.OLEDB.OpenRowsetVariable',null,null
union all select 'Destination%.OLEDB.FastLoadOptions',null,null
union all select 'Destination%.OLEDB.FastLoadKeepIdentity',null,null
union all select 'Destination%.OLEDB.FastLoadKeepNulls',null,null
union all select 'Destination%.OLEDB.FastLoadMaxInsertCommitSize',null,null
union all select 'Destination%.OLEDB.CommandTimeout',null,'QueryTimeout'
--SharepointDestination
union all select 'Destination%.SPList.BatchSize',null,null
union all select 'Destination%.SPList.CamlQuery',null,null
union all select 'Destination%.SPList.IncludeFolders',null,null
union all select 'Destination%.SPList.IsRecursive',null,null
union all select 'Destination%.SPList.SharePointCulture',null,null
union all select 'Destination%.SPList.SiteListName',null,null
union all select 'Destination%.SPList.SiteListViewName',null,null
union all select 'Destination%.SPList.SiteUrl',null,null
union all select 'Destination%.SPList.UseConnectionManager',null,null
--ExcelDestination
union all select 'Destination%.Excel.AccessMode',null,null
union all select 'Destination%.Excel.OpenRowset',null,null
union all select 'Destination%.Excel.CommandTimeout',null,'QueryTimeout'
union all select 'Destination%.Excel.FilePath',null,null
union all select 'Destination%.Excel.Header',null,null
union all select 'Destination%.Excel.ExcelVersion',null,null
--AdoNetDestination
union all select 'Destination%.ADONET.AccessMode',null,null
union all select 'Destination%.ADONET.TableOrViewName','ADONET.TableOrViewName','TableName'
union all select 'Destination%.ADONET.BatchSize',null,null
union all select 'Destination%.ADONET.UseBulkInsertWhenPossible',null,null
union all select 'Destination%.ADONET.CommandTimeout',null,'QueryTimeout'
--OdbcDestination
union all select 'Destination%.ODBC.InsertMethod',null,null
union all select 'Destination%.ODBC.BindCharColumnsAs',null,null
union all select 'Destination%.ODBC.BindNumericAs',null,null
union all select 'Destination%.ODBC.TableName','ODBC.TableName','TableName'
union all select 'Destination%.ODBC.BatchSize',null,null
union all select 'Destination%.ODBC.TransactionSize',null,null
union all select 'Destination%.ODBC.LobChunkSize',null,null
union all select 'Destination%.ODBC.CommandTimeout',null,'QueryTimeout'
union all select 'Destination%.ODBC.StatementTimeout',null,'QueryTimeout'
union all select 'Destination%.ODBC.DefaultCodePage',null,null
--SqlBulkDestination
union all select 'Destination%.SQLBULK.DefaultCodePage',null,null
union all select 'Destination%.SQLBULK.AlwaysUseDefaultCodePage',null,null
union all select 'Destination%.SQLBULK.BulkInsertTableName','SQLBULK.BulkInsertTableName','TableName'
union all select 'Destination%.SQLBULK.TableName','SQLBULK.TableName','TableName'
union all select 'Destination%.SQLBULK.BulkInsertCheckConstraints',null,null
union all select 'Destination%.SQLBULK.BulkInsertFirstRow',null,null
union all select 'Destination%.SQLBULK.BulkInsertFireTriggers',null,null
union all select 'Destination%.SQLBULK.BulkInsertKeepIdentity',null,null
union all select 'Destination%.SQLBULK.BulkInsertKeepNulls',null,null
union all select 'Destination%.SQLBULK.BulkInsertLastRow',null,null
union all select 'Destination%.SQLBULK.BulkInsertMaxErrors',null,null
union all select 'Destination%.SQLBULK.BulkInsertOrder',null,null
union all select 'Destination%.SQLBULK.BulkInsertTablock',null,null
union all select 'Destination%.SQLBULK.CommandTimeout',null,'QueryTimeout'
union all select 'Destination%.SQLBULK.Timeout',null,'QueryTimeout'
union all select 'Destination%.SQLBULK.MaxInsertCommitSize',null,null

--Packadge control
union all select 'SavePackage',null,null
union all select 'PackageFileName',null,null
union all select 'LoadPackage',null,null
--Staging control
union all select 'Destination%.Staging',null,null
union all select 'Destination%.StagingTableName',null,null
union all select 'Destination%.StagingTablePrepare',null,null
union all select 'Destination%.StagingTableUpload',null,null
union all select 'Destination%.UserOptions',null,null
--All
union all select 'QueryTimeout',null,null
union all select 'etl:Timeout',null,'QueryTimeout'
union all select 'UserOptions',null,null
union all select 'ForceStart',null,null
union all select 'Debug',null,null


;with xmlnamespaces('ETLController.XSD' as etl)
insert @attr
select b.b.value('./@Name[1]','nvarchar(100)'),b.b.value('(.)[1]','nvarchar(max)')
  from @pAttributes.nodes('/etl:Attributes') a(a)
  cross apply a.a.nodes('./etl:Attribute') b(b)

;with xmlnamespaces ('DeltaExtractor.XSD' as de, 'ETLController.XSD' as etl)
select @pAttributes = 
 (select case when m.outOverride is null then a.AttributeName
              else replace(a.AttributeName,isnull(m.inOverride,a.AttributeName),m.outOverride)
          end as '@Name',a.AttributeValue as '*'
    from @attr a
   left join @map m on a.AttributeName like m.AttributeName
     for xml path('etl:Attribute'),type, root('etl:Attributes'))

end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pAttributes = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_DE_MapAttributes].[@pAttributes]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_DE_MapAttributes].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_DE_MapAttributes].[@map].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_DE_MapAttributes].[@map].[outOverride]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_DE_MapAttributes].[@map].[inOverride]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_DE_MapAttributes].[@attr].[AttributeValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_DE_MapAttributes].[@attr]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_DE_MapAttributes].[@attr].[AttributeName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_DE_MapAttributes].[@attr].[AttributeValue]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_DE_MapAttributes].[@map]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_DE_MapAttributes].[@map].[AttributeName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_DE_MapAttributes].[@map].[inOverride]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_DE_MapAttributes].[@map].[outOverride]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_DE_MapAttributes].[@pAttributes]">
						<Property Name="IsOutput" Value="True" />
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="563" />
				<Property Name="Length" Value="12921" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;--select * from ETLStepattribute where batchid = -15&#xD;&#xA;declare @uid uniqueidentifier&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pAttributes xml&#xD;&#xA;--set @uid = newid()&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-10,3,null,4,15&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext,@uid&#xD;&#xA;exec dbo.prc_ReadContextAttributes @pProcessRequest,@pAttributes out&#xD;&#xA;select @pAttributes&#xD;&#xA;exec dbo.prc_DE_MapAttributes @pAttributes out&#xD;&#xA;select @pAttributes&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE dbo.prc_DE_MapAttributes&#xD;&#xA;    @pAttributes xml([ETLController]) output&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ETLAttributeSet]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[prc_ETLAttributeSet].sql
** Name:	[dbo].[prc_ETLAttributeSet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema40/Procedure/[prc_ETLAttributeSet].sql:

** Desc:	set  user defined attribute value for batch/step/const combination
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	08/01/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------
** 2012-01-09       andreys                             validate inpits
*/
set nocount on
declare @msg nvarchar(max)
declare @Err int
declare @proc sysname

set @Err = 0
set @proc = OBJECT_NAME(@@procid)

begin try

   if (not exists(select 1 from dbo.ETLBatch where BatchID = @BatchID))
      raiserror('Invalid Parameter b=%d',11,11,@BatchID);


   if (@ConstId is not null and @StepID is null)
   begin
      if (not exists(select 1 from dbo.ETLBatchConstraint where BatchID = @BatchID and ConstId = @ConstId))
         raiserror('Invalid Parameter bc=%d.%d',11,11,@BatchID,@ConstID);
  --columns
      if (@AttributeName = 'ConstOrder')
         update dbo.[ETLBatchConstraint]
            set ConstOrder = @AttributeValue
          where BatchID = @BatchID and ConstId = @ConstID
      else if (@AttributeName = 'WaitPeriod')
         update dbo.[ETLBatchConstraint]
            set ConstOrder = @AttributeValue
          where BatchID = @BatchID and ConstId = @ConstID
   --attributes 
      else if exists(select 1 from dbo.[ETLBatchConstraintAttribute]
                 where BatchID = @BatchID and ConstId = @ConstID and AttributeName = @AttributeName)
         if (@AttributeValue is null)
            delete dbo.[ETLBatchConstraintAttribute]
             where BatchID = @BatchID and ConstId = @ConstID and AttributeName = @AttributeName
         else
            update dbo.[ETLBatchConstraintAttribute]
               set AttributeValue = @AttributeValue
             where BatchID = @BatchID and ConstId = @ConstID and AttributeName = @AttributeName
      else if (@AttributeValue is not null)
         insert dbo.[ETLBatchConstraintAttribute] (BatchID,ConstID,AttributeName,AttributeValue)
         values (@BatchID,@ConstID,@AttributeName,@AttributeValue)
   end
   else if (@ConstId is not null and @StepID is not null)
   begin
      if (not exists(select 1 from dbo.ETLStepConstraint where BatchID = @BatchID and StepID = @StepID and ConstID = @ConstID))
         raiserror('Invalid Parameter  for the bsc= %d.%d.%d',11,11,@BatchID,@StepID,@ConstID);
   --columns
      if (@AttributeName = 'ConstOrder')
         update dbo.[ETLStepConstraint]
            set ConstOrder = @AttributeValue
          where BatchID = @BatchID and StepID = @StepID and ConstId = @ConstID
      else if (@AttributeName = 'WaitPeriod')
         update dbo.[ETLStepConstraint]
            set ConstOrder = @AttributeValue
          where BatchID = @BatchID and StepID = @StepID and ConstId = @ConstID
   --attributes 
     else if exists(select 1 from dbo.[ETLStepConstraintAttribute]
                 where BatchID = @BatchID and StepID = @StepID and ConstId = @ConstID and AttributeName = @AttributeName)
         if (@AttributeValue is null)
            delete dbo.[ETLStepConstraintAttribute]
             where BatchID = @BatchID and StepID = @StepID  and ConstId = @ConstID and AttributeName = @AttributeName
         else
            update dbo.[ETLStepConstraintAttribute]
               set AttributeValue = @AttributeValue
             where BatchID = @BatchID and StepID = @StepID  and ConstId = @ConstID and AttributeName = @AttributeName
      else if (@AttributeValue is not null)
         insert dbo.[ETLStepConstraintAttribute] (BatchID,StepID,ConstID,AttributeName,AttributeValue)
         values (@BatchID,@StepID,@ConstID,@AttributeName,@AttributeValue)
   end
   else if (@StepID is not null)
   begin
      if (not exists(select 1 from dbo.ETLStep where BatchID = @BatchID and StepID = @StepID))
         raiserror('Invalid Parameter  for the bs= %d.%d',11,11,@BatchID,@StepID);
    --columns
      if (@AttributeName = 'StepName')
         update dbo.[ETLStep]
            set StepName = @AttributeValue
          where BatchID = @BatchID and StepID = @StepID
      else if (@AttributeName = 'StepDesc')
         update dbo.[ETLStep]
            set StepDesc = @AttributeValue
          where BatchID = @BatchID and StepID = @StepID
      else if (@AttributeName = 'IgnoreErr')
         update dbo.[ETLStep]
            set IgnoreErr = @AttributeValue
          where BatchID = @BatchID and StepID = @StepID
      else if (@AttributeName = 'StepOrder')
         update dbo.[ETLStep]
            set StepOrder = @AttributeValue
          where BatchID = @BatchID and StepID = @StepID
   --attributes 
      else if exists(select 1 from dbo.[ETLStepAttribute]
                 where BatchID = @BatchID and StepId = @StepID and AttributeName = @AttributeName)
         if (@AttributeValue is null)
            delete dbo.[ETLStepAttribute]
             where BatchID = @BatchID and StepID = @StepID and AttributeName = @AttributeName
         else
            update dbo.[ETLStepAttribute]
               set AttributeValue = @AttributeValue
             where BatchID = @BatchID and StepId = @StepID and AttributeName = @AttributeName
      else if (@AttributeValue is not null)
         insert dbo.[ETLStepAttribute] (BatchID,StepID,AttributeName,AttributeValue)
         values (@BatchID,@StepID,@AttributeName,@AttributeValue)
   end
   else
   begin
    --columns
      if (@AttributeName = 'BatchName')
         update dbo.[ETLBatch]
            set BatchName = @AttributeValue
          where BatchID = @BatchID
      else if (@AttributeName = 'BatchDesc')
         update dbo.[ETLBatch]
            set BatchDesc = @AttributeValue
          where BatchID = @BatchID
      else if (@AttributeName = 'IgnoreErr')
         update dbo.[ETLBatch]
            set IgnoreErr = @AttributeValue
          where BatchID = @BatchID
      else if (@AttributeName = 'RestartOnErr')
         update dbo.[ETLBatch]
            set RestartOnErr = @AttributeValue
          where BatchID = @BatchID
   --attributes 
      else if exists(select 1 from dbo.[ETLBatchAttribute]
                 where BatchID = @BatchID and AttributeName = @AttributeName)
         if (@AttributeValue is null)
            delete dbo.[ETLBatchAttribute]
             where BatchID = @BatchID and AttributeName = @AttributeName
         else
            update dbo.[ETLBatchAttribute]
               set AttributeValue = @AttributeValue
             where BatchID = @BatchID and AttributeName = @AttributeName
      else if (@AttributeValue is not null)
         insert dbo.[ETLBatchAttribute] (BatchID,AttributeName,AttributeValue)
         values (@BatchID,@AttributeName,@AttributeValue)
   end

end try
begin catch	
	if @@trancount > 0 rollback tran
	
   set @Proc = ERROR_PROCEDURE()
   set @Msg = ERROR_MESSAGE()
   raiserror ('ERROR: PROC %s, MSG: %s',11,17,@Proc,@Msg) 
   set @Err = ERROR_NUMBER()
end catch
   return 0
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLAttributeSet].[@BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLAttributeSet].[@ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLAttributeSet].[@StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLAttributeSet].[@AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLAttributeSet].[@AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[RestartOnErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLAttributeSet].[@BatchID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLAttributeSet].[@StepID]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLAttributeSet].[@ConstID]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLAttributeSet].[@AttributeName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLAttributeSet].[@AttributeValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="4000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="99" />
				<Property Name="Length" Value="7834" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;/*&#xD;&#xA;exec [dbo].[prc_ETLAttributeSet] -10,-5,null,'RestartOnErr','1'&#xD;&#xA;select * from ETLBatch&#xD;&#xA;*/&#xD;&#xA;CREATE procedure [dbo].[prc_ETLAttributeSet] (&#xD;&#xA;    @BatchID int&#xD;&#xA;   ,@StepID int = null&#xD;&#xA;   ,@ConstID int = null&#xD;&#xA;   ,@AttributeName nvarchar(100)&#xD;&#xA;   ,@AttributeValue nvarchar(4000)&#xD;&#xA;)&#xD;&#xA; as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ETLCounterSet]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[prc_ETLCounterSet].sql
** Name:	[dbo].[prc_ETLCounterSet]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Procedure/[prc_ETLCounterSet].sql:

** Desc:	set client Counter value
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	10/30/2007
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------
** 2012-01-09       andreys                             validate inpits

*/

set nocount on
declare @err                int
declare @proc               sysname
declare @msg                nvarchar(1000)
declare @debug              tinyint
declare @Options            int
declare @query              nvarchar(max)

declare @BatchID int
declare @StepID int
declare @RunID int
declare @LGRunID int
declare @ProcErr int
declare @ProcName sysname
declare @Counters xml(ETLController)

set @err = 0
begin try

set @BatchID = @pBatchID
set @StepID = isnull(@pStepID,0)
set @RunID = isnull(@pRunID,0)

   if (not exists(select 1 from dbo.ETLBatch where BatchID = @BatchID))
      raiserror('Invalid Parameter b=%d',11,11,@BatchID);
   if (@RunID <> 0 and not exists(select 1 from dbo.ETLBatchRun where BatchID = @BatchID and RunID = @RunID))
      raiserror('Invalid Parameter br=%d',11,11,@BatchID,@RunID);
   if (@StepID <> 0 and not exists(select 1 from dbo.ETLStep where BatchID = @BatchID and StepID = @StepID))
      raiserror('Invalid Parameter bs=%d',11,11,@BatchID,@StepID);


   if exists(select 1 from dbo.[ETLStepRunCounter]
                      where RunID = @RunID and StepID = @StepID
                        and BatchID = @BatchID and CounterName = @pName)
   begin
      if @pValue is null
      begin
         delete dbo.[ETLStepRunCounter]
          where RunID = @RunID and StepID = @StepID
            and BatchID = @BatchID and CounterName = @pName
         --raiserror('record was deleted from dbo.ETLStepRunCounter',0,1)
      end
      else
      begin
         update dbo.[ETLStepRunCounter]
         set CounterValue = @pValue
          where RunID = @RunID and StepID = @StepID
            and BatchID = @BatchID and CounterName = @pName
         --raiserror('record was updated in dbo.ETLStepRunCounter',0,1)
      end
   end
   else
   begin
      insert dbo.[ETLStepRunCounter]
      (RunID,StepID,CounterName,BatchID,CounterValue)
      values(@RunID,@StepID,@pName,@BatchID,@pValue)
      --raiserror('record was inserted into dbo.ETLStepRunCounter',0,1)
   end


end try
begin catch
   set @Proc = ERROR_PROCEDURE()
   set @pValue = null
   set @Msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   raiserror ('ERROR: PROC %s, MSG: %s',11,11,@Proc,@Msg) 
end catch

return @err
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLCounterSet].[@pBatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLCounterSet].[@pStepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLCounterSet].[@pRunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLCounterSet].[@pName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ETLCounterSet].[@pValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLCounterSet].[@pBatchID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLCounterSet].[@pStepID]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLCounterSet].[@pRunID]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLCounterSet].[@pName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ETLCounterSet].[@pValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="107" />
				<Property Name="Length" Value="3396" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;exec dbo.prc_ETLCounterSet -20,1,0,'test2','bbb'&#xD;&#xA;select dbo.fn_ETLCounterGet (-20,1,0,'test2')&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;create procedure [dbo].[prc_ETLCounterSet] (&#xD;&#xA;    @pBatchID int&#xD;&#xA;   ,@pStepID int = null&#xD;&#xA;   ,@pRunID int = null&#xD;&#xA;   ,@pName varchar(100) = null&#xD;&#xA;   ,@pValue nvarchar(max)&#xD;&#xA;&#xD;&#xA;) as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_EventCheck]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_EventCheck.SQL
**
**D Desc:         Check for condition Event condition 
**
**D Auth:         andreys
**D Date:         10/28/2007
**
** Param: @pRequest  - BatchID info
                  @pReceipt results (StatusID - 2 - SUCCESS, 3 - FAILURE, 4 - ERROR, 6 - FAILURE_IMMEDIATE) (OUTPUT only)
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @ProcName sysname
DECLARE @StatusID tinyint
DECLARE @msg nvarchar(max)
DECLARE @ErrMsg nvarchar(max)
DECLARE @BatchID int
DECLARE @StepID int
DECLARE @ConstID int
DECLARE @debug tinyint
DECLARE @handle uniqueidentifier
DECLARE @Value varchar(1000)
DECLARE @nValue nvarchar(max)
DECLARE @RunID int
DECLARE @Options int

DECLARE @WatermarkEventType nvarchar(1000)
DECLARE @WatermarkEventID uniqueidentifier
DECLARE @WatermarkEventReceived datetime
DECLARE @WatermarkEventPosted datetime
DECLARE @WatermarkEventArgs xml

DECLARE @EventType nvarchar(1000)
DECLARE @EventID uniqueidentifier
DECLARE @EventReceived datetime
DECLARE @EventPosted datetime
DECLARE @EventArgs xml

DECLARE @EventServer sysname
DECLARE @EventDatabase sysname

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

DECLARE @STAT_SUCCESS TINYINT
DECLARE @STAT_FAILURE TINYINT
DECLARE @STAT_ERROR TINYINT
DECLARE @STAT_FAILURE_IMMEDIATE TINYINT

SET @STAT_SUCCESS = 2
SET @STAT_FAILURE = 3
SET @STAT_ERROR = 4
SET @STAT_FAILURE_IMMEDIATE = 6
-------------------------------------------------------------------
--Return Statuses
--2 - Success
--3 - Failure
--4 - Error
--6 - failure and exit
-------------------------------------------------------------------
DECLARE @Request AS xml (ETLController)
DECLARE @Receipt AS xml (ETLController)
DECLARE @Header AS xml (ETLController)
DECLARE @Context AS xml (ETLController)
DECLARE @ProcessInfo AS xml (ETLController)
DECLARE @Attributes AS xml (ETLController)

begin try
exec @ProcErr = dbo.[prc_ReadProcessRequest] @pRequest,@Header out,@Context out,@handle out
exec @ProcErr = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out

set @debug = nullif(@Options & 1,0)
IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'BEGIN Procedure ' + @ProcName
                           + ' with @BatchID=' + CAST(@BatchID AS nvarchar(30))
                           + ISNULL( ', @StepID=' +CAST(@StepID AS nvarchar(30)),'')
                           + ISNULL( ', @RunID=' +CAST(@RunID AS nvarchar(30)),'')

   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END


-------------------------------------------------------------------
--Retrieve Attributes
-------------------------------------------------------------------
exec @ProcErr = dbo.[prc_ReadContextAttributes] @pRequest,@Attributes out

exec @ProcErr = dbo.[prc_ReadAttribute] @Attributes,'WatermarkEventType',@WatermarkEventType out
exec @ProcErr = dbo.[prc_ReadAttribute] @Attributes,'EventType',@EventType out
exec @ProcErr = dbo.[prc_ReadAttribute] @Attributes,'EventServer',@EventServer out
exec @ProcErr = dbo.[prc_ReadAttribute] @Attributes,'EventDatabase',@EventDatabase out
if (@EventType is null)
BEGIN
   SET @ErrMsg = '   ERROR 50110: EvenType is required'
   SET @StatusID = @STAT_ERROR
   SET @Err = 50110
   raiserror (@ErrMsg,11,11)
END

if (@WatermarkEventType is null)
BEGIN
   SET @ErrMsg = '   ERROR 50110: WatermarkEventType is required'
   SET @StatusID = @STAT_ERROR
   SET @Err = 50110
   raiserror (@ErrMsg,11,11)
END

set @EventServer = ISNULL(@EventServer,@@SERVERNAME)
set @EventDatabase = ISNULL(@EventDatabase,DB_NAME())

----------------------------------------------------------------------------------
--Checking...
----------------------------------------------------------------------------------
exec dbo.[prc_CLREventReceive] @EventServer,@EventDatabase
   ,@WatermarkEventID out,@WatermarkEventPosted out,@WatermarkEventReceived out,@WatermarkEventArgs out
   ,@WatermarkEventType,@Options

exec dbo.[prc_CLREventReceive] @EventServer,@EventDatabase
   ,@EventID out,@EventPosted out,@EventReceived out,@EventArgs out
   ,@EventType,@Options

--IF (@debug IS NOT NULL)
--BEGIN
   SET @msg = '   Waiting for Event condition: ' + @EventType + ' > ' + @WatermarkEventType
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
--END

set @StatusID = 
case when @EventReceived is null then @STAT_FAILURE
     when @WatermarkEventReceived is null then @STAT_SUCCESS
     when @WatermarkEventReceived < @EventReceived then @STAT_SUCCESS
     else @STAT_FAILURE
 end

end try
begin catch
set @err = error_number()
set @ErrMsg = isnull(@ErrMsg,error_message())
IF (@ErrMsg IS NOT NULL)
BEGIN
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@ErrMsg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
set @StatusID = @STAT_FAILURE_IMMEDIATE
end catch

if (@pReceipt is null)
   exec @ProcErr = dbo.prc_CreateProcessReceipt @pReceipt out,@Header,@StatusID,@Err,@ErrMsg

IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_EventCheck].[@pRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CLREventReceive]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_EventCheck].[@pReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_EventCheck].[@pRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_EventCheck].[@pReceipt]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="679" />
				<Property Name="Length" Value="6617" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;select * from ETLSteprunhistory where batchid = -15&#xD;&#xA;&#xD;&#xA;declare @pHeader xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-15,null,null,6,1&#xD;&#xA;exec dbo.prc_AttributeSet @pHeader,'CheckFile','c:\20080707_DailyMapsReady.txt'&#xD;&#xA;--xp_cmdshell 'dir c:\20080707_DailyMapsReady.txt'&#xD;&#xA;&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-15,1,null,5,1&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;--select @pProcessRequest&#xD;&#xA;exec dbo.prc_EventCheck @pProcessRequest,@pProcessReceipt out&#xD;&#xA;select @pProcessReceipt&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE dbo.prc_EventCheck&#xD;&#xA;    @pRequest xml([ETLController])&#xD;&#xA;   ,@pReceipt  xml([ETLController]) = NULL OUTPUT&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ExecCmd]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ExecCmd.SQL
**
**D Desc:         Execute Cmd Statement
**
**D Auth:         andreys
**D Date:         10/28/2007
**
** Param: @pRequest  - BatchID info
                  @pReceipt results (StatusID - 2 - SUCCESS, 3 - FAILURE, 4 - ERROR) (OUTPUT only)
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @ProcName sysname
DECLARE @StatusID tinyint
DECLARE @msg nvarchar(max)
DECLARE @ErrMsg nvarchar(max)
DECLARE @BatchID int
DECLARE @StepID int
DECLARE @ConstID int
DECLARE @debug tinyint
DECLARE @handle uniqueidentifier
DECLARE @RunID int
DECLARE @Options int
DECLARE @Name nvarchar(100)

DECLARE @nSql nvarchar(max)
DECLARE @nCmd nvarchar(max)
DECLARE @nCmdCheck nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0
SET @pCMDAttribute = ISNULL(@pCMDAttribute,'CMD')

DECLARE @STAT_SUCCESS TINYINT
DECLARE @STAT_FAILURE TINYINT
DECLARE @STAT_ERROR TINYINT

SET @STAT_SUCCESS = 2
SET @STAT_FAILURE = 3
SET @STAT_ERROR = 4
-------------------------------------------------------------------
--Return Statuses
--2 - Success
--3 - Failure
--4 - Error
-------------------------------------------------------------------
DECLARE @Request AS xml (ETLController)
DECLARE @Receipt AS xml (ETLController)
DECLARE @Header AS xml (ETLController)
DECLARE @Context AS xml (ETLController)
DECLARE @ProcessInfo AS xml (ETLController)
DECLARE @Attributes AS xml (ETLController)

begin try
exec @ProcErr = dbo.[prc_ReadProcessRequest] @pRequest,@Header out,@Context out,@handle out
exec @ProcErr = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out

set @debug = nullif(@Options & 1,0)
IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'BEGIN Procedure ' + @ProcName
                           + ' with @BatchID=' + CAST(@BatchID AS nvarchar(30))
                           + ISNULL( ', @StepID=' +CAST(@StepID AS nvarchar(30)),'')

   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END


-------------------------------------------------------------------
--Retrieve SQL Attribute
-------------------------------------------------------------------

exec @ProcErr = dbo.[prc_ReadContextAttributes] @pRequest,@Attributes out
exec @ProcErr = dbo.[prc_ReadAttribute] @Attributes,@pCMDAttribute,@nCmd out

set @Name = @pCMDAttribute + 'CHECK'
exec @ProcErr = dbo.[prc_ReadAttribute] @Attributes,@Name,@nCmdCheck out


IF (@nCmd IS NULL)
BEGIN
  SET @ErrMsg = '   ERROR 50110: failed to retrieve Attribute ' + @pCMDAttribute + '('
                       + CAST(@BatchID AS nvarchar(30))
                       + ISNULL( ',' +CAST(@StepID AS nvarchar(30)),'') + ')'
  SET @StatusID = @STAT_ERROR
  SET @Err = 50110
  raiserror (@ErrMsg,11,11)
END
-------------------------------------------------------------------
--Execute
-------------------------------------------------------------------
IF (@debug IS NOT NULL)
BEGIN
   SET @msg = '   Executing: ' + @nCmd + case when @nCmdCheck is not null then ' with Check (' + @nCmdCheck + ')' else '' end
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END

set @nSql = '
declare @msg nvarchar(max)
declare @Err int
declare @ProcErr int
declare @rows int

declare @loop int
declare @ProcessInfo xml(ETLController)
declare @Header xml(ETLController)
declare @handle uniqueidentifier

begin try

create table #msg (id int not null identity(1,1),msg nvarchar(max) null)
insert #msg (msg)
exec @err = xp_cmdshell ''' +  @nCmd + '''
set @rows = @@IDENTITY
'
if (@debug IS NOT NULL)
begin
   set @nSql = @nSql
+ '
exec @ProcErr = dbo.prc_ReadProcessRequest @request,@Header out,null,@handle out
set @loop = 1
while (@loop <= @rows)
begin
   select @msg = msg from #msg where id = @loop
   set @msg = isnull(rtrim(@msg),'''')
   if (len(@msg) > 0)
   begin
      exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
      exec @ProcErr = dbo.prc_Print @ProcessInfo,@handle
   end
   set @loop = @loop + 1
end
'
end
set @nSql = @nSql
+ '
if (@err <> 0) raiserror (''ERROR  xp_cmdshell exits with status %d'',11,11,@Err)
set @msg=NULL
select top 1 @msg = msg from #msg where
(charindex(''error'',msg) > 0
or charindex(''exception'',msg) > 0)
if (@msg is not null) raiserror (''%s'',11,11,@msg)
drop table #msg
'
+ case when @nCmdCheck is not null then 'if not(' + @nCmdCheck + ') raiserror(''Error CmdCheck has failed'',11,11)' else '' end
+
'
end try
begin catch
   set @Err = error_number()
   exec @ProcErr = dbo.prc_ReadProcessRequest @request,@Header out,null,@handle out
   set @loop = 1
   while (@loop <= @rows)
   begin
      select @msg = msg from #msg where id = @loop
      set @msg = isnull(rtrim(@msg),'''')
      if (len(@msg) > 0)
      begin
         exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
         exec @ProcErr = dbo.prc_Print @ProcessInfo,@handle
      end
      set @loop = @loop + 1
   end
   set @msg = error_message()
   raiserror(''ERROR %d: %s'',11,11,@Err,@msg)
end catch
'

begin try
EXEC sp_executesql
            @nSql
           ,N'@receipt xml(ETLController) output,@request xml(ETLController)'
           ,@request = @pRequest
           ,@receipt = @pReceipt out
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
   set @ErrMsg = '   ERROR failed to execute: '  + isnull(@nCmd,'null')
   raiserror (@ErrMsg,11,11)
end catch

SET @StatusID = @STAT_SUCCESS
end try
begin catch
set @ErrMsg = isnull(@ErrMsg,error_message())
set @err = error_number()
IF (@ErrMsg IS NOT NULL)
BEGIN
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@ErrMsg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
set @StatusID = @STAT_ERROR
--set @StatusID = @STAT_FAILURE
end catch

if (@pReceipt is null)
   exec @ProcErr = dbo.prc_CreateProcessReceipt @pReceipt out,@Header,@StatusID,@Err,@ErrMsg

IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExecCmd].[@pCMDAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExecCmd].[@pRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadAttribute]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ExecCmd].[@pReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecCmd].[@pRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecCmd].[@pReceipt]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecCmd].[@pCMDAttribute]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="404" />
				<Property Name="Length" Value="7502" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-10,1,null,4,1&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;select @pProcessRequest&#xD;&#xA;exec dbo.prc_ExecCmd @pProcessRequest,@pProcessReceipt out&#xD;&#xA;select @pProcessReceipt&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ExecCmd]&#xD;&#xA;    @pRequest xml([ETLController])&#xD;&#xA;   ,@pReceipt  xml([ETLController]) = NULL OUTPUT&#xD;&#xA;   ,@pCMDAttribute nvarchar(100) = NULL&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ExecDE]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ExecCmd.SQL
**
**D Desc:         Run Delta Extractor
**
**D Auth:         andreys
**D Date:         12/15/2007
**
** Param: @pRequest  - BatchID info
                  @pReceipt results (StatusID - 2 - SUCCESS, 3 - FAILURE, 4 - ERROR) (OUTPUT only)
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:


******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @ProcName sysname
DECLARE @StatusID tinyint
DECLARE @msg nvarchar(max)
DECLARE @ErrMsg nvarchar(max)
DECLARE @BatchID int
DECLARE @StepID int
DECLARE @ConstID int
DECLARE @debug tinyint
DECLARE @handle uniqueidentifier
DECLARE @RunID int
DECLARE @Options int
DECLARE @Name nvarchar(100)

DECLARE @nSql nvarchar(max)
DECLARE @nCmd nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0
SET @pDELocation = ISNULL(@pDELocation,'DEPath')

DECLARE @STAT_SUCCESS TINYINT
DECLARE @STAT_FAILURE TINYINT
DECLARE @STAT_ERROR TINYINT

SET @STAT_SUCCESS = 2
SET @STAT_FAILURE = 3
SET @STAT_ERROR = 4
-------------------------------------------------------------------
--Return Statuses
--2 - Success
--3 - Failure
--4 - Error
-------------------------------------------------------------------
DECLARE @Request AS xml (ETLController)
DECLARE @Receipt AS xml (ETLController)
DECLARE @Header AS xml (ETLController)
DECLARE @Context AS xml (ETLController)
DECLARE @ProcessInfo AS xml (ETLController)
DECLARE @Attributes AS xml (ETLController)
DECLARE @Parameters as xml (ETLClient_DE)

begin try
exec @ProcErr = dbo.[prc_ReadProcessRequest] @pRequest,@Header out,@Context out,@handle out
exec @ProcErr = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out

set @debug = nullif(@Options & 1,0)
IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'BEGIN Procedure ' + @ProcName
                           + ' with @BatchID=' + CAST(@BatchID AS nvarchar(30))
                           + ISNULL( ', @StepID=' +CAST(@StepID AS nvarchar(30)),'')

   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END


-------------------------------------------------------------------
--Retrieve DEPath Attribute
-------------------------------------------------------------------

exec @ProcErr = dbo.[prc_ReadContextAttributes] @pRequest,@Attributes out
exec @ProcErr = dbo.[prc_ReadAttribute] @Attributes,@pDELocation,@nCmd out

IF (@nCmd IS NULL)
BEGIN
  SET @ErrMsg = '   ERROR 50110: failed to retrieve Attribute ' + @pDELocation + '('
                       + CAST(@BatchID AS nvarchar(30))
                       + ISNULL( ',' +CAST(@StepID AS nvarchar(30)),'') + ')'
  SET @StatusID = @STAT_ERROR
  SET @Err = 50110
  raiserror (@ErrMsg,11,11)
END
-------------------------------------------------------------------
--Execute
-------------------------------------------------------------------
exec @ProcErr = dbo.prc_de_CreateParameters @Parameters out,@pRequest


IF (@debug IS NOT NULL)
BEGIN
   SET @msg = '   Executing: ' + @nCmd + ' with:' + cast(@Parameters as nvarchar(max))
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END

set @nCmd = @nCmd + ' "' + dbo.fn_GetBase64String('<?xml version="1.0"?>' + cast(@Parameters as nvarchar(max))) + '"'

set @nSql = '
declare @msg nvarchar(max)
declare @Err int
declare @ProcErr int
declare @rows int

declare @loop int
declare @ProcessInfo xml(ETLController)
declare @Header xml(ETLController)
declare @handle uniqueidentifier

begin try

create table #msg (id int not null identity(1,1),msg nvarchar(max) null)
insert #msg (msg)
exec @err = xp_cmdshell ''' +  @nCmd + '''
set @rows = @@IDENTITY
'
if (@debug IS NOT NULL)


begin
   set @nSql = @nSql
+ '
exec @ProcErr = dbo.prc_ReadProcessRequest @request,@Header out,null,@handle out
set @loop = 1
while (@loop <= @rows)
begin
   select @msg = msg from #msg where id = @loop
   set @msg = isnull(rtrim(@msg),'''')
   if (len(@msg) > 0)
   begin
      exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
      exec @ProcErr = dbo.prc_Print @ProcessInfo,@handle
   end
   set @loop = @loop + 1
end
'
end
set @nSql = @nSql
+ '
if (@err <> 0) raiserror (''ERROR  xp_cmdshell exits with status %d'',11,11,@Err)
Set @msg=NULL
select top 1 @msg = msg from #msg where
(charindex(''error'',msg) > 0
or charindex(''exception'',msg) > 0)
if (@msg is not null) raiserror (''%s'',11,11,@msg)
drop table #msg
end try
begin catch
   set @Err = error_number()
   exec @ProcErr = dbo.prc_ReadProcessRequest @request,@Header out,null,@handle out
   set @loop = 1
   while (@loop <= @rows)
   begin
      select @msg = msg from #msg where id = @loop
      set @msg = isnull(rtrim(@msg),'''')
      if (len(@msg) > 0)
      begin
         exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
         exec @ProcErr = dbo.prc_Print @ProcessInfo,@handle
      end
      set @loop = @loop + 1
   end
   set @msg = error_message()
   raiserror(''ERROR %d: %s'',11,11,@Err,@msg)
end catch
'

begin try
EXEC sp_executesql
            @nSql
           ,N'@receipt xml(ETLController) output,@request xml(ETLController)'
           ,@request = @pRequest
           ,@receipt = @pReceipt out
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
   set @ErrMsg = '   ERROR failed to execute: '  + isnull(@nCmd,'null')
   raiserror (@ErrMsg,11,11)
end catch

SET @StatusID = @STAT_SUCCESS
end try
begin catch
set @ErrMsg = isnull(@ErrMsg,error_message())
set @err = error_number()
IF (@ErrMsg IS NOT NULL)
BEGIN
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@ErrMsg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
set @StatusID = @STAT_ERROR
--set @StatusID = @STAT_FAILURE
end catch

if (@pReceipt is null)
   exec @ProcErr = dbo.prc_CreateProcessReceipt @pReceipt out,@Header,@StatusID,@Err,@ErrMsg

IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLClient_DE]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExecDE].[@pDELocation]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExecDE].[@pRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadAttribute]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_de_CreateParameters]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_GetBase64String]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ExecDE].[@pReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecDE].[@pRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecDE].[@pReceipt]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecDE].[@pDELocation]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="424" />
				<Property Name="Length" Value="7435" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="-- Stored procedure&#xD;&#xA;/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-10,1,null,4,1&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;select @pProcessRequest&#xD;&#xA;exec dbo.prc_ExecDE @pProcessRequest,@pProcessReceipt out&#xD;&#xA;select @pProcessReceipt&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ExecDE]&#xD;&#xA;    @pRequest xml([ETLController])&#xD;&#xA;   ,@pReceipt  xml([ETLController]) = NULL OUTPUT&#xD;&#xA;   ,@pDELocation nvarchar(100) = NULL&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ExecSql]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ExecSql.SQL
**
**D Desc:         Execute Sql Statement
**
**D Auth:         andreys
**D Date:         10/28/2007
**
** Param: @pRequest  - BatchID info
                  @pReceipt results (StatusID - 2 - SUCCESS, 3 - FAILURE, 4 - ERROR) (OUTPUT only)
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @ProcName sysname
DECLARE @StatusID tinyint
DECLARE @msg nvarchar(max)
DECLARE @ErrMsg nvarchar(max)
DECLARE @BatchID int
DECLARE @StepID int
DECLARE @ConstID int
DECLARE @debug tinyint
DECLARE @handle uniqueidentifier
DECLARE @Value varchar(1000)
DECLARE @nValue nvarchar(max)
DECLARE @RunID int
DECLARE @Options int

DECLARE @nSql nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0
SET @pSQLAttribute = ISNULL(@pSQLAttribute,'SQL')

DECLARE @STAT_SUCCESS TINYINT
DECLARE @STAT_FAILURE TINYINT
DECLARE @STAT_ERROR TINYINT

SET @STAT_SUCCESS = 2
SET @STAT_FAILURE = 3
SET @STAT_ERROR = 4
-------------------------------------------------------------------
--Return Statuses
--2 - Success
--3 - Failure
--4 - Error
-------------------------------------------------------------------
DECLARE @Request AS xml (ETLController)
DECLARE @Receipt AS xml (ETLController)
DECLARE @Header AS xml (ETLController)
DECLARE @Context AS xml (ETLController)
DECLARE @ProcessInfo AS xml (ETLController)
DECLARE @Attributes AS xml (ETLController)

begin try
exec @ProcErr = dbo.[prc_ReadProcessRequest] @pRequest,@Header out,@Context out,@handle out
exec @ProcErr = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out

set @debug = nullif(@Options & 1,0)
IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'BEGIN Procedure ' + @ProcName
                           + ' with @BatchID=' + CAST(@BatchID AS nvarchar(30))
                           + ISNULL( ', @StepID=' +CAST(@StepID AS nvarchar(30)),'')

   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END


-------------------------------------------------------------------
--Retrieve SQL Attribute
-------------------------------------------------------------------

exec @ProcErr = dbo.[prc_ReadContextAttributes] @pRequest,@Attributes out
exec @ProcErr = dbo.[prc_ReadAttribute] @Attributes,@pSQLAttribute,@nSql out

IF (@nSql IS NULL)
BEGIN
  SET @ErrMsg = '   ERROR 50110: failed to retrieve Attribute ' + @pSQLAttribute + '('
                       + CAST(@BatchID AS nvarchar(30))
                       + ISNULL( ',' +CAST(@StepID AS nvarchar(30)),'') + ')'
  SET @StatusID = @STAT_ERROR
  SET @Err = 50110
  raiserror (@ErrMsg,11,11)
END
-------------------------------------------------------------------
--Execute
-------------------------------------------------------------------
IF (@debug IS NOT NULL)
BEGIN
   SET @msg = '   Executing: ' + @nSql
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END

SET @nSql = ' begin try ' + @nSql + ' end try'
          + ' begin catch' 
          + ' declare @msg nvarchar(max),@err int'
          + ' set @msg = error_message()'
          + ' set @Err = error_number()'
          + ' raiserror(''ERROR %d: %s'',11,11,@Err,@msg)'
          + ' end catch'

begin try
EXEC sp_executesql
            @nSql
           ,N'@receipt xml(ETLController) output,@request xml(ETLController)'
           ,@request = @pRequest
           ,@receipt = @pReceipt out
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
   set @ErrMsg = '   ERROR failed to execute: '  + isnull(@nSql,'null')
   raiserror (@ErrMsg,11,11)
end catch

SET @StatusID = @STAT_SUCCESS
end try
begin catch
set @err = error_number()
set @ErrMsg = isnull(@ErrMsg,error_message())
IF (@ErrMsg IS NOT NULL)
BEGIN
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@ErrMsg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
set @StatusID = @STAT_ERROR
--set @StatusID = @STAT_FAILURE
end catch

if (@pReceipt is null)
   exec @ProcErr = dbo.prc_CreateProcessReceipt @pReceipt out,@Header,@StatusID,@Err,@ErrMsg

IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExecSql].[@pSQLAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExecSql].[@pRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadAttribute]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ExecSql].[@pReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecSql].[@pRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecSql].[@pReceipt]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExecSql].[@pSQLAttribute]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="404" />
				<Property Name="Length" Value="5601" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-11,2,null,4,1&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;select @pProcessRequest&#xD;&#xA;exec dbo.prc_ExecSql @pProcessRequest,@pProcessReceipt out&#xD;&#xA;select @pProcessReceipt&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ExecSql]&#xD;&#xA;    @pRequest xml([ETLController])&#xD;&#xA;   ,@pReceipt  xml([ETLController]) = NULL OUTPUT&#xD;&#xA;   ,@pSQLAttribute varchar(100) = NULL&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_Execute]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:             prc_Execute.SQL
**
**D Desc:         execute ETL process
**
**D Auth:         andreys
**D Date:         10/30/2007
**
** Param: 
          @pBatchName - BatchName from the ETLBatch Table. NULL if pContext is specified
         ,@Options    - debug(produce debug output)
                       ,forcestart(force the batch to start even when the other instance is running)
                       ,wait(wait <TIMEOUT> for the other instance to finish)
                       ,slaveoff(execute all steps on local service only. Communications to remote services will not start)
         ,@pHandle    - conversation handle to communicate back to parent process
         ,@pContext   - ad-hoc batch in xml format. see context element definition in ETLController schema

** Batch level system Attributes:
**  MAXTHREAD -- max number parallel threads
**  TIMEOUT   -- receive timeout in sec
**  LIFETIME  -- dialog timeout in sec
**  PING      -- receive wait break for external error checks in sec
**  HISTRET   -- time to retain processing history in days
** Step level system Attributes
**  DISABLED  -- YES/NO
**  SEQGROUP  -- sequence group. All steps in a group executed sequentially in StepOrder order
**  PRIGROUP  -- priority group. Groupes executed sequentially in PRIGROP order.
**               But steps in a group in parallel in StepOrder order
**  LOOPGROUP -- loop support. Steps in loop group are executed recursivly until BreakEvent is posted to any of LoogGroup steps
**  RESTART   -- 1/0 restart step on batch error
**  SVCNAME   -- SSB Service name to send a step for execution to (ANY = least busy, LOCAL = ETLController_Process (master node)
**               DEFAULT = LOCAL or configurable through systemparameters)
** Constraint level
**  PING      -- interval to call constraint process in sec (default to 10)
**  DISABLED  -- YES/NO

*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
**  7/29/2008        andreys            wait option
**  2009/12/04       andrey@biasintelligence.com           handle Exit Event
**  2009/12/27       andrey@biasintelligence.com           loop support
**  2010/03/30       andrey@biasintelligence.com           add Send Cancel request
**  2010/04/01       andrey@biasintelligence.com           loop bug. if BreakEvent is posted from the last step the workflow will hang 
**  2010/05/16       andrey@biasintelligence.com           the workflow is left in running state after contraints were not met.
**  2010/07/17       andrey@biasintelligence.com           Master/Slave services. See SVCNAME attribute. By default run all steps on LOCAL Service (Master)
**                                      can be disabled by passing <slaveoff> keyword in options
**  2010/08/13       andrey@biasintelligence.com           fix force start recovery code. ETLBatch and ETLStep tables were not updated properly
**  2012/01/06       andrey@biasintelligence.com           fix step execution order
**  2014/01/20       andrey             fix IgnoreErr logic
******************************************************************/
SET NOCOUNT ON;

DECLARE @Err INT;
DECLARE @ExitCode INT;
DECLARE @Cnt INT;
--DECLARE @StepTable sysname
--DECLARE @nStepTable nvarchar(100)
DECLARE @ProcName sysname;
DECLARE @Trancount int;
DECLARE @Timeout int;
DECLARE @Loop int;
DECLARE @StepID int;
DECLARE @BatchID int;
DECLARE @nSQL1 nvarchar(max);
DECLARE @StatusID tinyint;
DECLARE @StatusOrder tinyint;
DECLARE @BatchStatusID tinyint;
DECLARE @BatchErr INT;
DECLARE @Now varchar(30);
DECLARE @msg nvarchar(max);

DECLARE @OnBatchSuccess sysname;
DECLARE @OnBatchFailure sysname;
DECLARE @BatchIgnore tinyint;
DECLARE @Restart tinyint;
DECLARE @RunID int;
DECLARE @LastStatusID tinyint;
DECLARE @LastRunID int;
DECLARE @CleanupRunID int;
DECLARE @checktimeout int;
DECLARE @SeqGroup nvarchar(10);
DECLARE @pDebug tinyint;
DECLARE @pForceStart tinyint;
DECLARE @pWait tinyint;
declare @pSlaveOff tinyint;
DECLARE @bOptions int;
DECLARE @RaiserrMsg nvarchar(max);
DECLARE @Wait varchar(20);
declare @StartDate datetime;
declare @StatusDate datetime;
declare @LocalService sysname;
declare @SvcName sysname;

--@pDebug is bitmap placeholder for options
-- 1 - debug
-- 2 - forcestart

SET @Trancount = @@TRANCOUNT;
--SET @StepTable = 'tempdb.dbo.' + @pBatchName
--SET @nStepTable = CAST(@StepTable AS nvarchar(100))
SET @ProcName = OBJECT_NAME(@@PROCID);
SET @Err = 0;
SET @ExitCode = 0;
SET @BatchErr = 0;
SET @LocalService = 'ETLController_Process'

SET @pDebug = CASE WHEN CHARINDEX('debug',@Options) > 0 THEN 1 ELSE 0 END;
SET @pForceStart = CASE WHEN CHARINDEX('forcestart',@Options) > 0 THEN 1 ELSE 0 END;
SET @pWait = CASE WHEN CHARINDEX('wait',@Options) > 0 THEN 1 ELSE 0 END;
SET @pSlaveOff = CASE WHEN CHARINDEX('slaveoff',@Options) > 0 THEN 1 ELSE 0 END;
SET @bOptions = isnull(@pDebug,0) + isnull(@pForceStart,0) * 2;

SET @checktimeout = 0;
SET @StartDate = GETDATE();

DECLARE @STAT_AVAILABLE TINYINT;
DECLARE @STAT_STARTED TINYINT;
DECLARE @STAT_SUCCESS TINYINT;
DECLARE @STAT_FAILURE TINYINT;
DECLARE @STAT_ERROR TINYINT;
DECLARE @STAT_WARNING TINYINT;
DECLARE @STAT_FAILURE_IMMEDIATE TINYINT;

SET @STAT_AVAILABLE = 0;
SET @STAT_STARTED = 1;
SET @STAT_SUCCESS = 2;
SET @STAT_FAILURE = 3;
SET @STAT_ERROR = 4;
SET @STAT_WARNING = 5;
SET @STAT_FAILURE_IMMEDIATE = 6;
-------------------------------------------------------------------
--Step Statuses
--0 - Available
--1 - Started
--2 - Success
--3 - Failure
--4 - Error
--5 - Warning
--6 - Failure with abort.Used only in constraint procs to abort constraint check
-------------------------------------------------------------------
DECLARE @ATT_MAXTHREAD TINYINT   -- max number parallel threads
DECLARE @ATT_TIMEOUT INT         -- receive timeout in sec
DECLARE @ATT_LIFETIME INT        -- dialog timeout in sec
DECLARE @ATT_PING_MAX INT        -- max PING value
DECLARE @ATT_PING INT            -- receive wait break for external error checks in sec
                                 -- defaults to @ATT_PING_MAX
DECLARE @ATT_HISTRET INT         -- time to retain processing history in days

--to test without broker
--create table #tmp(StepID int not null,StatusID tinyint not null)


DECLARE @handle AS UNIQUEIDENTIFIER
DECLARE @message_type NVARCHAR(256)
DECLARE @message NVARCHAR(MAX)
DECLARE @ProcessRequest AS XML (ETLController)
DECLARE @ProcessReceipt AS XML (ETLController)
DECLARE @ProcessInfo AS XML (ETLController)
DECLARE @Context AS XML (ETLController)
DECLARE @Header AS XML (ETLController)
DECLARE @BatchHeader AS XML (ETLController)
DECLARE @StepHeader AS XML (ETLController)
DECLARE @ReceiptHeader AS XML (ETLController)
DECLARE @ThreadCount TINYINT
declare @ServiceStatusID tinyint

raiserror ('
 Use ETLMonitor.exe to monitor workflow progress. All informational messages are directed to Log only.
 Error output is still multi-casted to both log and console.
 ',0,1) with nowait;  


BEGIN TRY --Main block
BEGIN TRY --validations

--dummy header
EXEC @ExitCode = dbo.prc_CreateHeader @Header out,0,0,0,0,@bOptions

SET @StatusID = NULL
IF (@pDebug = 1)
BEGIN
   SET @msg =  'BEGIN Procedure ' + @ProcName + ' with @pBatchName=' + isnull(@pBatchName,'@pContext')
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
END


-----------------------------------------------------------------------------------
-- validate input parameters
-----------------------------------------------------------------------------------
if (@pBatchName is null)
begin
   if (@pContext is null)
   BEGIN
      SET @Err = 50101
      SET @StatusID = @STAT_ERROR
      SET @RaiserrMsg = '   ERROR @pContext is expected'
      RAISERROR(@RaiserrMsg,11,11) 
   END

  ;with xmlnamespaces('ETLController.XSD' as ETL)
  select @BatchID = @pContext.value('(/ETL:Context/@BatchID)[1]','int')
        ,@pBatchName = @pContext.value('(/ETL:Context/@BatchName)[1]','nvarchar(30)')

   if (@BatchID is null or @pBatchName is null)
   BEGIN
      SET @Err = 50101
      SET @StatusID = @STAT_ERROR
      SET @RaiserrMsg = '   ERROR @pContext: attribute BatchID and BatchName are required'
      RAISERROR(@RaiserrMsg,11,11) 
   END

   IF (@pDebug = 1)
   BEGIN
      SET @msg =  ' Context @pBatchName=' + @pBatchName
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
      exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
   END


   if exists (select 1 from dbo.ETLBatch where BatchName = @pBatchName and BatchID <> @BatchID)
   BEGIN
      SET @Err = 50101
      SET @StatusID = @STAT_ERROR
      SET @RaiserrMsg = '   ERROR pContext: BatchName=' + @pBatchName + ' already exists with different BatchID'
      RAISERROR(@RaiserrMsg,11,11) 
   END

   set @Options = @Options + ',replace'
   EXEC @ExitCode = dbo.prc_PersistContext @pContext,@pHandle,@Options
end
else
begin 

   SELECT @BatchID = BatchID
     FROM dbo.ETLBatch  WHERE BatchName = @pBatchName

   IF (@BatchID IS NULL)
   BEGIN
      SET @Err = 50101
      SET @StatusID = @STAT_ERROR
      SET @RaiserrMsg = '   ERROR invalid input parameter @pBatchName=' + @pBatchName
      RAISERROR(@RaiserrMsg,11,11)
   END
end

--dont have runid yet
EXEC @ExitCode = dbo.prc_CreateHeader @BatchHeader out,@BatchID,null,null,0,@bOptions,1--batch

IF (@pDebug = 1)
BEGIN
   SET @msg = '   Batch found @BatchID=' + CAST(@BatchID as nvarchar(30))
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
   exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
END

EXEC @ExitCode = dbo.prc_CreateContext @Context out,@BatchHeader

IF (@pDebug = 1)
BEGIN
   SET @msg = '   Batch Context=' + CAST(@Context as nvarchar(max))
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
   exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
END

;with xmlnamespaces('ETLController.XSD' as ETL)
select
       @OnBatchSuccess = 'exec @ExitCode = ' + cb.b.value('(./ETL:OnSuccess/ETL:Process)[1]','nvarchar(max)') + ' @pRequest=@Request,@pReceipt=@Receipt out' 
                       + isnull(',' + cb.b.value('(./ETL:OnSuccess/ETL:Param)[1]','nvarchar(max)'),'')
      ,@OnBatchFailure = 'exec @ExitCode = ' + cb.b.value('(./ETL:OnFailure/ETL:Process)[1]','nvarchar(max)') + ' @pRequest=@Request,@pReceipt=@Receipt out' 
                       + isnull(',' + cb.b.value('(./ETL:OnFailure/ETL:Param)[1]','nvarchar(max)'),'')
      ,@BatchIgnore = NULLIF(cb.b.value('(./@IgnoreErr)[1]','tinyint'),0)
      ,@Restart = NULLIF(cb.b.value('(./@Restart)[1]','tinyint'),0)
      ,@ATT_MAXTHREAD = NULLIF(cb.b.value('(./@MaxThread)[1]','tinyint'),0)
      ,@ATT_TIMEOUT = NULLIF(cb.b.value('(./@Timeout)[1]','int'),0)
      ,@ATT_LIFETIME = NULLIF(cb.b.value('(./@Lifetime)[1]','int'),0)
      ,@ATT_PING = NULLIF(cb.b.value('(./@Ping)[1]','int'),0)
      ,@ATT_HISTRET = NULLIF(cb.b.value('(./@HistRet)[1]','int'),0)
  from @Context.nodes('/ETL:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)

-------------------------------------------------------------------
--Set defaults
-------------------------------------------------------------------
SET @ATT_PING_MAX = 120 --sec
SET @ATT_MAXTHREAD = CASE WHEN ISNULL(@ATT_MAXTHREAD,0) <= 0 THEN 1 ELSE @ATT_MAXTHREAD END; --num
SET @ATT_LIFETIME = CASE WHEN ISNULL(@ATT_LIFETIME,0) <= 0 THEN 7200 ELSE @ATT_LIFETIME END; --sec
SET @ATT_TIMEOUT = CASE WHEN ISNULL(@ATT_TIMEOUT,0) <= 0 THEN @ATT_LIFETIME ELSE @ATT_TIMEOUT END; --sec
--Ping must be less then 1 min
--it is used to reset the broker thread Cancel job timer
--which is hardcoded to 60 sec. if ping is not received within 1 min
--all worker threads will be terminated for that conversation
-- this is done to allow to kill the prc_execute process
SET @ATT_PING = case when ISNULL(@ATT_PING,0) < 1 then @ATT_PING_MAX
                     when @ATT_PING > @ATT_PING_MAX then @ATT_PING_MAX
                     else @ATT_PING
                 end
SET @ATT_HISTRET = CASE WHEN ISNULL(@ATT_HISTRET,0) <= 0 THEN 100 ELSE @ATT_HISTRET END; --days

-------------------------------------------------------------------
--Check if this batch is running
-------------------------------------------------------------------
SELECT @LastStatusID = StatusID
      ,@LastRunID    = RunID
  FROM dbo.ETLBatchRun
 WHERE RunID = (SELECT MAX(RunID) FROM dbo.ETLStepRun
                 WHERE BatchID = @BatchID)

IF (@LastRunID IS NOT NULL)
BEGIN
    IF (@pForceStart = 0)
    BEGIN
       -- wait <TIMEOUT> <PING>
       SET @Wait = right('00' + cast((@ATT_PING)/3600 as varchar(10)),3)
                + ':' + right('0' + cast(((@ATT_PING)/60)%60 as varchar(10)),2)
                + ':' + right('0' + cast((@ATT_PING)%60 as varchar(10)),2)

       SET @checktimeout = 0
       WHILE (@pWait = 1 AND @checktimeout < @ATT_TIMEOUT)
       BEGIN
          IF (@pDebug = 1)
          BEGIN
             SET @msg = '   Waiting (' + @Wait + ')on previous run to finish RunID=' + cast(@LastRunID as varchar(10)) 
             exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
             exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
          END
          WAITFOR DELAY @wait
          SET @LastStatusID = NULL
          SELECT @LastStatusID = StatusID
                ,@LastRunID    = RunID
            FROM dbo.ETLBatchRun
           WHERE RunID = (SELECT MAX(RunID) FROM dbo.ETLStepRun
                          WHERE BatchID = @BatchID)

           IF (ISNULL(@LastStatusID,@STAT_AVAILABLE) <> @STAT_STARTED)
              BREAK

          SET @checktimeout = @checktimeout + @ATT_PING
       END
       IF (ISNULL(@LastStatusID,@STAT_AVAILABLE) = @STAT_STARTED)
       BEGIN
          SET @Err = 50103
          SET @StatusID = @STAT_FAILURE_IMMEDIATE
          SET @RaiserrMsg = '   ERROR Batch=' + @pBatchName
                + ' is already running with RunID=' + cast(@LastRunID as varchar(10))
                + ', process can not continue '
          exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@RaiserrMsg,@Err
          exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
          RAISERROR(@RaiserrMsg,11,11)
       END
     END
     ELSE
     BEGIN
       SET @msg = '   WARNING Batch=' + @pBatchName
             + ' is force started from RunID=' + cast(@LastRunID as varchar(10))
       exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
       exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
       exec @ExitCode = dbo.prc_Finalize @BatchHeader,@pHandle,@STAT_FAILURE;
    END
END

SELECT @LastStatusID = StatusID
      ,@LastRunID    = RunID
 FROM dbo.ETLBatchRun
WHERE RunID = (SELECT MAX(RunID) FROM dbo.ETLBatchRun
                WHERE BatchID = @BatchID)

end try --validations
begin catch
  set @msg = error_message();
  raiserror('Validation Block error=%d,status=%d: %s',11,11,@Err,@StatusID,@msg)
end catch

begin try -- workflow body block
begin try -- workflow constraints check block

SET @checktimeout = 0
-------------------------------------------------------------------
--Generate new runid
--Prepare Processing Step records
-------------------------------------------------------------------
INSERT dbo.ETLBatchRun
(BatchID,StatusDT,StatusID,Err,StartTime,EndTime)
SELECT @BatchID,getdate(),1,0,getdate(),cast(null as datetime)
SELECT @RunID = SCOPE_IDENTITY()


-------------------------------------------------------------------
--Process the Batch Constraints
-------------------------------------------------------------------
EXEC @ExitCode = dbo.prc_CreateHeader @Header out,@BatchID,null,null,@RunID,@bOptions,5 --b and bc
exec @ExitCode = dbo.prc_CreateContext @Context out,@Header
exec @ExitCode = dbo.prc_CreateProcessRequest @ProcessRequest out,@Header,@Context,@pHandle

--IF (@pDebug = 1)
--BEGIN
--   SET @msg = '   Batch Constraint Context=' + CAST(@Context as nvarchar(max))
--   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
--   exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
--END

SET @ProcessReceipt = NULL
EXEC @ExitCode = dbo.prc_ConstraintCheck
                  @pRequest = @ProcessRequest
                 ,@pReceipt = @ProcessReceipt output

EXEC @ExitCode = dbo.prc_ReadProcessReceipt @ProcessReceipt,null,@StatusID out,@Err out,@msg out
SET @StatusID = ISNULL(@StatusID,@STAT_ERROR)

IF (@StatusID = @STAT_FAILURE)
BEGIN
   SET @RaiserrMsg = '   ERROR Batch Constraints were not met'
END
ELSE IF (@StatusID = @STAT_ERROR or @Err <> 0)
BEGIN
   SET @RaiserrMsg = '   ERROR Batch Constraints check failed'
END

IF (@pDebug = 1)
BEGIN
   SET @msg = '   Batch Constraint Check returns StatusID=' + CAST(@StatusID as nvarchar(30))
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
   exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
END

IF (@RaiserrMsg is not null)
BEGIN
   RAISERROR(@RaiserrMsg,11,11)
END

end try --workflow constraints check block
begin catch
  set @msg = ERROR_MESSAGE()
  raiserror('Workflow Constraints Check Block error=%d,status=%d: %s',11,11,@Err,@StatusID,@msg)
end catch

begin try --workflow steps block

set @BatchStatusID = @STAT_SUCCESS;
-------------------------------------------------------------------
--Retrieve destination service list
--and start conversation to all available services
-------------------------------------------------------------------
declare @service table (SvcID int identity(1,1),[SvcName] sysname,StatusID smallint null
                       ,Handle uniqueidentifier null,grpHandle uniqueidentifier null,StatusDate datetime null)
declare @svcid int
declare @svcStatusID smallint
declare @grpHandle uniqueidentifier

insert @service (SvcName,StatusID)
select [name],@STAT_STARTED
  from sys.services where [name] = @LocalService;

if (@pSlaveOff = 0)
   insert @service (SvcName,StatusID)
   select [remote_service_name],@STAT_STARTED
     from sys.routes where [remote_service_name] like @LocalService + '%'
     and [remote_service_name] <> @LocalService;

set @svcid = 0
SET @grpHandle = newid()
while (1=1)
begin
   set @svcName = null
   select @svcname = SvcName
         ,@svcid = SvcID
     from @service where SvcId = (select min(SvcID) from  @service where SvcID > @SvcID)
   if @svcName is null
      break


--Start conversation
   SET @Handle = null
   BEGIN DIALOG CONVERSATION @handle
   FROM SERVICE  [ETLController_Request]
   TO SERVICE @svcName
--select family_id from master.sys.databases where database_id = db_id()
--                           ,'E995CF15-A383-4FBB-8FE3-1D6C129F190C'
   ON CONTRACT  [ETLController]
   WITH LIFETIME = @ATT_LIFETIME
   ,RELATED_CONVERSATION_GROUP = @grpHandle
   ,ENCRYPTION = OFF

   if (@handle is null)
      continue

   IF (@pDebug = 1)
   BEGIN
      SET @msg = '   Start Conversation to service:' + @svcName
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
      exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
   END

   update @service
      set Handle = @handle
         ,grpHandle = @GrpHandle
         ,StatusID = @STAT_STARTED
         ,StatusDate = GETDATE()
    where SvcID = @SvcID

   --overload StepID with SvcID in test msg
   exec @ExitCode = dbo.prc_CreateHeader @Header out,@BatchID,@SvcID,null,@RunID,@bOptions,0
   exec @ExitCode = dbo.prc_CreateProcessRequest @ProcessRequest out,@Header,null,null;
   
   SEND ON CONVERSATION @handle 
   MESSAGE TYPE [ETLController_Test]
   (CAST(@ProcessRequest AS VARBINARY(MAX)));

   BEGIN CONVERSATION TIMER (@handle) TIMEOUT = @ATT_PING ;

end

if not exists(select 1 from @service where handle is not null)
begin
  SET @RaiserrMsg = '   ERROR no available services found'
  RAISERROR(@RaiserrMsg,11,11)
end

-------------------------------------------------------------------
--Prepare the step Queue table
-------------------------------------------------------------------

EXEC @ExitCode = dbo.prc_CreateHeader @BatchHeader out,@BatchID,null,null,@RunID,@bOptions,1--batch

INSERT dbo.ETLStepRun
(RunID,BatchID,StepID
,StatusDT,StatusID
,SPID,StepOrder,IgnoreErr
,Err,StartTime,EndTime,SeqGroup,PriGroup,SvcName)

SELECT @RunID,s.BatchID,s.StepID
      ,getdate(),@STAT_AVAILABLE
      ,null,s.StepOrder,ISNULL(NULLIF(@BatchIgnore,0),NULLIF(s.IgnoreErr,0))
      ,null,null,null,sg.AttributeValue,isnull(pg.AttributeValue,'zzz')
      ,case when coalesce(sn.AttributeValue,bsn.AttributeValue,'LOCAL') IN ('LOCAL','DEFAULT') then @LocalService
            else isnull(sn.AttributeValue,bsn.AttributeValue)
       end
  FROM dbo.ETLStep s
  LEFT JOIN dbo.ETLStepAttribute a ON s.BatchID = a.BatchID AND s.StepID = a.StepID
   AND a.AttributeName = 'DISABLED' AND a.AttributeValue = '1'
  LEFT JOIN dbo.ETLStepAttribute sg ON s.BatchID = sg.BatchID AND s.StepID = sg.StepID
   AND sg.AttributeName = 'SEQGROUP'
  LEFT JOIN dbo.ETLStepAttribute pg ON s.BatchID = pg.BatchID AND s.StepID = pg.StepID
   AND pg.AttributeName = 'PRIGROUP'
  LEFT JOIN dbo.ETLStepAttribute rs ON s.BatchID = rs.BatchID AND s.StepID = rs.StepID
   AND rs.AttributeName = 'RESTART'
  LEFT JOIN dbo.ETLStepAttribute sn ON s.BatchID = sn.BatchID AND s.StepID = sn.StepID
   AND sn.AttributeName = 'SVCNAME'
  LEFT JOIN dbo.ETLBatchAttribute bsn ON s.BatchID = bsn.BatchID
   AND bsn.AttributeName = 'SVCNAME'  
 WHERE (s.BatchID = @BatchID and a.StepID IS NULL  --enebled steps only
   AND (ISNULL(@LastStatusID,@STAT_AVAILABLE) = @STAT_SUCCESS --succeeded batches 
    OR ((ISNULL(@Restart,0) <> 0) or (isnull(cast(rs.AttributeValue as tinyint),0) <> 0)) --always restartable steps
    OR (ISNULL(s.StatusID,@STAT_AVAILABLE) <> @STAT_SUCCESS) --never executed or failed steps
       ));

    SELECT @Cnt = @@ROWCOUNT
    IF (@Cnt = 0)
    BEGIN
       --this code also will work when last run failed on batch success process 
       --SET @StatusID = @STAT_SUCCESS
       SET @StatusID = @STAT_WARNING
       SET @msg = '   WARNING no steps found for the batch'
       exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
       exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
       --SET @RaiserrMsg = '   WARNING no steps found for the batch'
       --RAISERROR(@RaiserrMsg,11,11)
    END

    IF (@pDebug = 1)
    BEGIN
       SET @msg = '   Selected ' + CAST(@Cnt as nvarchar(30)) + ' steps into dbo.ETLStepRun with RunID=' + cast(@RunID as varchar(10)) 
       exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
       exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
    END
  

-------------------------------------------------------------------
--LOOP support
-------------------------------------------------------------------
declare @LoopGroup table (StepID int,GroupCode nvarchar(100),StatusID int, primary key (StepID,GroupCode))

insert @LoopGroup (StepID,GroupCode,StatusID)
select s.StepID, sa.AttributeValue,@STAT_STARTED
  from dbo.ETLStepRun s
  join dbo.ETLStepAttribute sa on sa.BatchID = s.BatchID and sa.StepID = s.StepID
   and sa.AttributeName = 'LOOPGROUP'
 where s.BatchID = @BatchID and s.RunId = @RunID


-------------------------------------------------------------------
--Loop through the Batch Steps
-------------------------------------------------------------------
SET @ThreadCount = 0
SET @Handle = null
Send_Message:
   IF(@ThreadCount >= @ATT_MAXTHREAD
   --wait for all services to responde
   --or exists (select 1 from @service where StatusID <> @STAT_SUCCESS)
   --wait for at least 1 service to respond
   or not exists (select 1 from @service where StatusID = @STAT_SUCCESS)
     )
      GOTO Receive_Message


-------------------------------------------------------------------
--Lock next available step for execution
-------------------------------------------------------------------
   SET @StepID = NULL
   SET @StatusID = NULL

    UPDATE  sr
    SET @StepID = sr1.StepID,sr.SPID = @@SPID,sr.StatusID = @STAT_STARTED,sr.StartTime = getdate()
	FROM dbo.ETLStepRun sr
	JOIN (SELECT TOP (1) sr.BatchID,sr.StepID
    FROM  dbo.ETLStepRun sr WHERE sr.RunID = @RunID AND sr.BatchID = @BatchID AND sr.StatusID = @STAT_AVAILABLE
	--requested step service should be running
    AND NOT EXISTS (SELECT 1 FROM @service svc WHERE (svc.SvcName = sr.SvcName AND svc.StatusID = @STAT_STARTED))
	--Seqgroup and PriGroup requirements should be met
    AND NOT EXISTS (SELECT 1 FROM dbo.ETLStepRun sr1 WHERE sr.BatchID = sr1.BatchID AND sr.RunID = sr1.RunID
    AND ((sr.SeqGroup = sr1.SeqGroup AND sr.StepOrder > sr1.StepOrder)
        OR sr.PriGroup > sr1.priGroup) AND sr1.StatusID IN (@STAT_STARTED,@STAT_AVAILABLE))
	--no errors unless IgnoreErr is specified
	AND NOT EXISTS (SELECT 1 FROM dbo.ETLStepRun sr2 WHERE sr.BatchID = sr2.BatchID AND sr.RunID = sr2.RunID
	AND (sr2.StatusID IN (@STAT_ERROR,@STAT_FAILURE) AND (@BatchIgnore IS NULL AND sr2.IgnoreErr IS NULL)))
		ORDER BY sr.PriGroup,sr.StepOrder,sr.SeqGroup
		) sr1
	ON sr.BatchID = sr1.BatchID AND sr.StepID = sr1.StepID;
 
-------------------------------------------------------------------
-------------------------------------------------------------------
   -- exit with no error indicates that all steps are taken 
   IF (@StepID IS NULL)
   BEGIN
      IF (@pDebug = 1)
      BEGIN
         SET @msg = '   No more available steps found'
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END
      SET @StatusID = @BatchStatusID
      IF (@ThreadCount > 0)
         GOTO Receive_Message
      ELSE
      BEGIN
         GOTO Exit_Loop
      END
   END

   exec @ExitCode = dbo.prc_CreateHeader @StepHeader out,@BatchID,@StepID,null,@RunID,@bOptions,11 --b,s and sc
 
   IF (@pDebug = 1)
   BEGIN
      SET @msg = '   Processing Step ' + CAST(@StepID as nvarchar(30))
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@StepHeader,@msg
      exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
   END
  
-------------------------------------------------------------------
--Skip step on Exit Event
-------------------------------------------------------------------
   set @StatusID = cast(dbo.fn_ETLCounterGet (@BatchID,@StepID,@RunID,'ExitEvent') as tinyint)
   IF (@StatusID is not null)
   BEGIN
      -- Update Step Status
      UPDATE s
         SET s.StatusID = @StatusID,s.EndTime = getdate(),s.Err = @Err
        FROM dbo.ETLStepRun s
       WHERE s.RunID = @RunID AND s.StepID = @StepID AND s.BatchID = @BatchID


      IF (@pDebug = 1)
      BEGIN
         SET @msg = '   Step ' + CAST(@StepID as nvarchar(30)) + ' skipped on ExitEvent with StatusID=' + CAST(@StatusID as nvarchar(30))
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@StepHeader,@msg
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END
     
      GOTO Send_Message
   END
 
   exec @ExitCode = dbo.prc_CreateContext @Context out,@StepHeader
   exec @ExitCode = dbo.prc_CreateProcessRequest @ProcessRequest out,@StepHeader,@Context

--   IF (@pDebug = 1)
--   BEGIN
--      SET @msg = '   Step Context=' + CAST(@Context as nvarchar(max))
--      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@StepHeader,@msg
--      exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
--   END

  set @Handle = null;
  select @SvcName = SvcName from dbo.ETLStepRun
   where BatchID = @BatchID and StepID = @StepID and RunID = @RunID;
   
  if (@SvcName = 'ANY')
  begin
-- less used
  select top(1) @Handle = h.Handle
               ,@SvcName = h.SvcName
    from @service h
    left join (
      select s.SvcName,count(*) as cnt
        from dbo.ETLStepRun s
       where s.BatchID = @BatchID and s.RunID = @RunID
         and s.SvcName is not null and s.StatusID = @STAT_STARTED
       group by s.SvcName) s on h.SvcName = s.SvcName
      where h.StatusID = @STAT_SUCCESS
      order by isnull(s.cnt,0);     
  end
  else if not exists (select 1 from @service where SvcName = @SvcName)
  begin
  --use local service for unknown Services
     set @SvcName = @LocalService;
     select top(1) @Handle = h.Handle
                  ,@SvcName = h.SvcName
       from @service h
      where h.SvcName = @SvcName
        and h.StatusID = @STAT_SUCCESS;
  end
  else
  begin
  --use service from metadata
     select top(1) @Handle = h.Handle
                  ,@SvcName = h.SvcName
       from @service h
      where h.SvcName = @SvcName
        and h.StatusID = @STAT_SUCCESS;
  end
   
   IF (@Handle IS NULL)
   BEGIN
      SET @Err = 50110;
      SET @StatusID = @STAT_ERROR;
      SET @RaiserrMsg = '   ERROR Service ' + @SvcName + ' is not available';
      RAISERROR(@RaiserrMsg,11,11);
   END

  update dbo.ETLSteprun
     set SvcName = @SvcName
   where BatchID = @BatchID and StepID = @StepID and RunID = @RunID
     and SvcName <> @SvcName;

   IF (@pDebug = 1)
   BEGIN
      SET @msg = '   Step ' + CAST(@StepID as nvarchar(30)) + ' was sent to service ' + @SvcName
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@StepHeader,@msg
      exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
   END
   
                      
   ;SEND ON CONVERSATION @handle 
   MESSAGE TYPE [ETLController_Request]
   (CAST(@ProcessRequest AS VARBINARY(MAX)))
   
--to test without broker
--insert #tmp(StepID,StatusID)
--values (@StepID,2)

   SET @ThreadCount = @ThreadCount + 1
   GOTO Send_Message

Receive_Message:
   WAITFOR(
   RECEIVE top(1)
       @handle = conversation_handle,
       @message_type=message_type_name, 
       @message = message_body 
    FROM [ETLController_Receipt_Queue]
    WHERE conversation_group_id = @grpHandle
       )--, TIMEOUT @ATT_PING * 1000

   SELECT @Cnt = @@ROWCOUNT
   IF (@Cnt = 0)
   BEGIN
      SET @StatusID = @STAT_ERROR
      SET @Err = 50111
      SET @RaiserrMsg = '   ERROR conversation ' + CAST(@handle as nvarchar(36)) + ' received no message'
      raiserror (@RaiserrMsg,11,11)
   END
   
-------------------------------------------------------------------
--Exit Batch on Exit Event
-------------------------------------------------------------------
   set @StatusID = cast(dbo.fn_ETLCounterGet (@BatchID,0,@RunID,'ExitEvent') as tinyint)
   IF (@StatusID is not null)
   BEGIN
      IF (@pDebug = 1)
      BEGIN
         SET @msg = '   Batch Exit on ExitEvent with StatusID=' + CAST(@StatusID as nvarchar(30))
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END
     
      GOTO Exit_Loop
   END

   
/*
--to test without broker
waitfor delay '000:00:05'
set @message_type = 'BATCHPROCESS_Receipt'
select top 1 @xml_Receipt = --NCHAR(0xFEFF) +
         N'<cait:ProcessReceipt xmlns:cait="BATCHPROCESS_Receipt.XSD">'
      + N'<cait:BatchID>' + CAST(@BatchID as nvarchar(30)) + N'</cait:BatchID>'
      + N'<cait:StepID>' + CAST(StepID as nvarchar(30)) + N'</cait:StepID>'
      + N'<cait:StatusID>' + CAST(StatusID as nvarchar(30)) + N'</cait:StatusID>'
      + N'<cait:Error>0</cait:Error>'
      + N'<cait:RunID>' + CAST(@RunID as nvarchar(30)) + N'</cait:RunID>'
      + N'</cait:ProcessReceipt>'
,@StepID = StepID
 from #tmp
set @cnt = 1
set @message = cast(@xml_Receipt as varbinary(max))
delete #tmp where StepId = @stepID
*/

   IF (@message_type = 'http://schemas.microsoft.com/SQL/ServiceBroker/DialogTimer')
   BEGIN

	  IF (@pDebug = 1)
	  BEGIN
	     SET @msg = '   DialogTimer message is received'
	     exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
	     exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
	  END
	  --StartDate = workflow instance start date
	  SET @checktimeout = DATEDIFF(SECOND,@StartDate,GETDATE())
	  IF (@checktimeout + @ATT_PING >= @ATT_LIFETIME) -- check dialog lifetime
      BEGIN
         SET @StatusID = @STAT_ERROR
         SET @Err = 50111
         SET @RaiserrMsg = '   ERROR Dialog Lifetime is exceeded'
         raiserror(@RaiserrMsg,11,11)
      END
	  ELSE IF (@checktimeout >= @ATT_TIMEOUT) -- check timeout
      BEGIN
         SET @StatusID = @STAT_ERROR
         SET @Err = 50112
         SET @RaiserrMsg = '   ERROR Workflow timeout is exceeded'
         raiserror(@RaiserrMsg,11,11)
      END
      ELSE
	  BEGIN
         
         select top(1) @svcid = h.SvcID
                      ,@SvcName = h.SvcName
                      ,@StatusDate = h.StatusDate
                      ,@ServiceStatusID = h.StatusID
           from @service h
          where h.Handle = @Handle
          
          --StatusDate = Last TEST message delivery
          --if test message didnt make thru until next Timer Ping print the warning
	      SET @checktimeout = DATEDIFF(SECOND,@StatusDate,GETDATE())	      
          if (@checktimeout > @ATT_PING)
          begin
            SET @msg = '   WARNING Workflow did not receive the Ping responce from service ' + @SvcName + ' in time'
	        exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
	        exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
	      end
            
          --overload StepID with SvcID in test msg
          exec @ExitCode = dbo.prc_CreateHeader @Header out,@BatchID,@SvcID,null,@RunID,@bOptions,0
          exec @ExitCode = dbo.prc_CreateProcessRequest @ProcessRequest out,@Header,null,null;
   
          --send another test message to check conversation status
          if (@ServiceStatusID = @STAT_SUCCESS)
          begin

             ;SEND ON CONVERSATION @handle 
             MESSAGE TYPE [ETLController_Test]
            (CAST(@ProcessRequest AS VARBINARY(MAX)));

             BEGIN CONVERSATION TIMER (@handle) TIMEOUT = @ATT_PING ;
          end
          else
          --never received the original response from Remote service: disable it
          begin
	         IF (@pDebug = 1)
	         BEGIN
	            SET @msg = '   WARNING: Service ' + @SvcName + ' will be disabled';
	            exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg;
	            exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle;
	         END
             ;END CONVERSATION @handle;
             
             delete @service where SvcID = @svcid;            
             if not exists(select 1 from @service)
             begin
                SET @StatusID = @STAT_ERROR
                SET @Err = 50113
                SET @RaiserrMsg = '   ERROR All Services failed to start'
                raiserror(@RaiserrMsg,11,11)
             end
             goto Send_Message                                  
          end
          GOTO Receive_Message
      END

   END
   --step processing message 
   ELSE IF (@message_type = 'ETLController_Receipt')
   BEGIN
      SET @ProcessReceipt = @message
      EXEC @ExitCode = dbo.prc_ReadProcessReceipt @ProcessReceipt,@ReceiptHeader out,@StatusID out,@Err out,@msg out
      EXEC @ExitCode = dbo.prc_ReadHeader @ReceiptHeader,null,@StepID out

-------------------------------------------------------------------
--Finish the step
-------------------------------------------------------------------
      -- Update Step Status
      UPDATE s
         SET s.StatusID = @StatusID,s.EndTime = getdate(),s.Err = @Err
        FROM dbo.ETLStepRun s
       WHERE s.RunID = @RunID AND s.StepID = @StepID AND s.BatchID = @BatchID


      IF (@pDebug = 1)
      BEGIN
         SET @msg = '   Step ' + CAST(@StepID as nvarchar(30)) + ' completed with StatusID=' + CAST(@StatusID as nvarchar(30))
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@ReceiptHeader,@msg
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END

-------------------------------------------------------------------
--LOOP support. Loop steps reset.
--Exit loop on receiving BreakEvent with the LoopGroup value
-------------------------------------------------------------------

      update lg
         set lg.StatusID = @STAT_SUCCESS
        from @LoopGroup lg
        join (select distinct rc.CounterValue as GroupCode
            from dbo.ETLStepRunCounter rc
           where rc.BatchID = @BatchID and rc.RunID = @RunID
             and rc.CounterName = 'BreakEvent') c
          on lg.GroupCode = c.GroupCode
        where lg.StatusID = @STAT_STARTED;
    
--update all the steps in a LoopGroup to available if loop is completed without BreakEvent
      update sr
         set StatusID = @STAT_AVAILABLE
            ,StatusDT = getdate()
            ,Err = 0
            ,EndTime = null
        from dbo.ETLStepRun sr
        join @LoopGroup r on sr.StepID = r.StepID and r.StatusID = @STAT_STARTED
         and r.GroupCode in (select r1.GroupCode
                           from @LoopGroup r1
                           join dbo.ETLStepRun sr1
                             on sr1.StepID = r1.StepID and sr1.BatchID = @BatchID and r1.StatusID = @STAT_STARTED
                        group by r1.GroupCode having COUNT(*) = SUM(case sr1.StatusID when 2 then 1 else 0 end))
       where sr.BatchID = @BatchID and sr.RunID = @RunID;

--update all not started steps in a LoopGroup to finished if loop receives a BreakEvent
      update sr
         set StatusID = @STAT_SUCCESS
            ,StatusDT = getdate()
            ,Err = 0
            ,EndTime = getdate()
        from dbo.ETLStepRun sr
        join @LoopGroup r on sr.StepID = r.StepID and r.StatusID = @STAT_SUCCESS
       where sr.BatchID = @BatchID and sr.StatusID = @STAT_AVAILABLE and sr.RunID = @RunID;

-------------------------------------------------------------------
--Check Batch Status
--keep batch running if IgnorErr in on but batch should still fail at the end
-------------------------------------------------------------------
      IF @BatchStatusID NOT IN (@STAT_ERROR,@STAT_FAILURE,@STAT_FAILURE_IMMEDIATE)
	  BEGIN
	     SET @BatchStatusID = @StatusID
      END
      SET @StatusID = NULL
      SET @StatusOrder = NULL

      -- Check Batch Status
      SELECT @StatusOrder = MIN(CASE
                WHEN StatusID IN (@STAT_FAILURE,@STAT_ERROR) AND IgnoreErr is not null THEN 10
                WHEN StatusID IN (@STAT_FAILURE,@STAT_ERROR) THEN 2
                ELSE 10 END)
        FROM dbo.ETLStepRun WHERE RunID = @RunID AND BatchID = @BatchID

      SELECT @StatusOrder = MIN(CASE
                WHEN sr.StatusID = @STAT_AVAILABLE THEN ISNULL(NULLIF(@StatusOrder,10),1)
                WHEN sr.StatusID = @STAT_SUCCESS and lg.StatusID = @STAT_STARTED THEN ISNULL(NULLIF(@StatusOrder,10),1)
                WHEN sr.StatusID = @STAT_STARTED THEN 1
                WHEN sr.StatusID = @STAT_SUCCESS THEN 4
                WHEN sr.StatusID IN (@STAT_FAILURE,@STAT_ERROR) AND IgnoreErr is not null THEN 4
                WHEN sr.StatusID = @STAT_FAILURE THEN 3
                WHEN sr.StatusID = @STAT_ERROR THEN 2
                WHEN sr.StatusID = @STAT_WARNING THEN 10
                WHEN sr.StatusID = @STAT_FAILURE_IMMEDIATE THEN 10
                ELSE 11 END)
        FROM dbo.ETLStepRun sr
        left join @LoopGroup lg on sr.StepID = lg.StepID 
       WHERE sr.RunID =  @RunID AND sr.BatchID = @BatchID

      SET @StatusID = CASE @StatusOrder
                WHEN 10 THEN @STAT_AVAILABLE
                WHEN 1 THEN @STAT_STARTED
                WHEN 4 THEN @STAT_SUCCESS
                WHEN 3 THEN @STAT_FAILURE
                WHEN 2 THEN @STAT_ERROR
                ELSE NULL END
-------------------------------------------------------------------
-------------------------------------------------------------------

      IF (@StatusID IS NULL)
      BEGIN
         SET @RaiserrMsg = '   ERROR failed to check the Status'
         SET @StatusID = @STAT_ERROR
         SET @Err = 50105
         raiserror(@RaiserrMsg,11,11)
      END

      IF (@pDebug = 1)
      BEGIN
         SET @msg = '   Batch Run StatusID=' + CAST(@StatusID as nvarchar(30))
         SET @msg = @msg + '; Overall Batch StatusID=' + CAST(@BatchStatusID as nvarchar(30))
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END


      IF (@StatusID <> @STAT_STARTED)
      BEGIN
         SET @StatusID = @BatchStatusID
         GOTO Exit_Loop
      END

      SET @ThreadCount = @ThreadCount - 1
       GOTO Send_Message
    END--Receipt
    ELSE IF (@message_type = 'ETLController_InfoMessage')
    BEGIN
      set @ProcessInfo = @message
      exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      GOTO Receive_Message
    END--InfoMessage
    ELSE IF (@message_type = 'ETLController_Test')
    BEGIN
      set @ProcessReceipt = @message
      EXEC @ExitCode = dbo.prc_ReadProcessReceipt @ProcessReceipt,@ReceiptHeader out,@ServiceStatusID out,@Err out,@msg out
      EXEC @ExitCode = dbo.prc_ReadHeader @ReceiptHeader,null,@SvcID out
      set @ServiceStatusID = isnull(@ServiceStatusID,@STAT_ERROR)
      

      if (@pDebug = 1 or @ServiceStatusID <> @STAT_SUCCESS)
      begin
         select @SvcName = SvcName from @service where SvcID = @SvcID
         SET @msg = '   Service test ' + @SvcName + ' returns StatusID=' + CAST(@ServiceStatusID as nvarchar(30))
                  + ' with message: ' + @msg;
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      end

      update @service
         set StatusID = @ServiceStatusID
            ,StatusDate = GETDATE()
       where SvcID = @SvcID
       
      GOTO Send_Message
    END--TESTMESSAGE
    ELSE 
    BEGIN 
      --GOTO Receive_Message
      SET @StatusID = @STAT_ERROR
      SET @Err = 50110
      RAISERROR ('   ERROR Message received:[%s] %s',11,11,@message_type,@message)
    END--UNKNOWN

-- Conversation Completed
Exit_Loop:

IF(@StatusID <> @STAT_SUCCESS)
BEGIN
   SET @RaiserrMsg = '   ERROR Step processing block return StatusID=' + cast(@StatusID as nvarchar(10))
   RAISERROR(@RaiserrMsg,11,11)
END
END TRY --workflow steps block
BEGIN CATCH

IF (@Trancount < @@TRANCOUNT)
  ROLLBACK TRAN

SET @Err = case @Err when 0 then ERROR_NUMBER() else @Err end;
IF (@RaiserrMsg IS NULL)
BEGIN
   set @StatusID = @STAT_ERROR
   set @RaiserrMsg = ERROR_MESSAGE()
END

exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@RaiserrMsg,@Err
exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
SET @RaiserrMsg = null

--if previous batch failed on success or failure with all steps succeeded
--we need to try finishing it again
IF (@StatusID = @STAT_WARNING and @LastStatusID <> @STAT_SUCCESS)
BEGIN
   SET @msg = '   WARNING Trying to finish last successfull run again'
   set @StatusID = @STAT_SUCCESS
END
ELSE IF @StatusID = @STAT_ERROR
BEGIN
   SET @msg = '   ERROR Process failed with Status 4(ERROR)'
   SET @RaiserrMsg = @msg
END
ELSE IF @StatusID = @STAT_FAILURE
BEGIN
   SET @msg = '   ERROR Process failed with Status 3(FAILURE)'
   SET @RaiserrMsg = @msg
END
ELSE IF @StatusID = @STAT_WARNING
BEGIN
   SET @msg = '   WARNING Process exited with Status 5(WARNING)'
END
ELSE IF @StatusID = @STAT_FAILURE_IMMEDIATE
BEGIN
   SET @msg = '   ERROR Process exited with Status 6(FAILURE WITH EXIT_IMMEDIATE)'
   SET @RaiserrMsg = @msg
END

IF (@msg IS NOT NULL)
BEGIN
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg,@Err
   exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
END

END CATCH

-- End All conversations
WHILE (1 = 1)
BEGIN
   set @handle = null;
   SELECT top(1) @handle = Handle
                ,@grpHandle = grpHandle
                ,@SvcID = SvcID
                ,@svcname = SvcName
                ,@ServiceStatusID = StatusID
     from @Service where Handle is not null

   if (@Handle is null)
      break

   --send Cancel request message to the other threads to Cancel any outstanding executions
   --overload StepID with SvcID in test msg
   exec @ExitCode = dbo.prc_CreateHeader @Header out,@BatchID,@SvcID,null,@RunID,@bOptions,0
   exec @ExitCode = dbo.prc_CreateProcessRequest @ProcessRequest out,@Header,null,null;
 
   if (@ServiceStatusID = @STAT_SUCCESS)
   begin  
       begin try
  --for some reason EndDialog or Error message is not getting picked up from the Queue
   --right away. Using Cancel request instead
      ;SEND ON CONVERSATION @handle 
       MESSAGE TYPE [ETLController_Cancel]
       (CAST(@ProcessRequest AS VARBINARY(MAX)));

         IF (@pDebug = 1)
         BEGIN
            SET @msg = '   Cancel request was sent to service = ' + @SvcName
            exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
            exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
         END
         
         --wait for EndDialog message
         while (1 = 1)
         begin 
           set @checktimeout = @ATT_PING * 1000;
           WAITFOR(
           RECEIVE top(1)
             @handle = conversation_handle,
             @message_type=message_type_name, 
             @message = message_body 
           FROM [ETLController_Receipt_Queue]
           WHERE conversation_handle = @Handle
           ), TIMEOUT @checktimeout;
          
           --do not wait longer that ping interval
           set @Cnt = @@ROWCOUNT
           if (@Cnt = 0)
             break;
          
           if (@message_type in ('http://schemas.microsoft.com/SQL/ServiceBroker/EndDialog'
                               ,'http://schemas.microsoft.com/SQL/ServiceBroker/Error'))
              break;     
         end
         end try
         begin catch
             SET @msg = '   ERROR failed to SEND Cancel request to service = ' + @SvcName
             exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
             exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
         end catch
    end
    --try to end conversation     
    begin try
       END CONVERSATION @handle;
    end try
    begin catch
       IF (@pDebug = 1)
       BEGIN
          SET @msg = ERROR_MESSAGE();
          exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
          exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
       END    
    end catch
    delete @Service where SvcID = @SvcID
    SET @handle = null
END

end try --workflow body block
begin catch
   set @StatusId = case isnull(@StatusID,@STAT_ERROR) when @STAT_SUCCESS then @STAT_ERROR else isnull(@StatusID,@STAT_ERROR) end;
   set @Err = case @Err when 0 then ERROR_NUMBER() else @Err end;
end catch

-------------------------------------------------------------------
--Finish the batch
-------------------------------------------------------------------
SET @StepID = 0
IF (@RunID IS NOT NULL AND @StatusID <> @STAT_FAILURE_IMMEDIATE)
BEGIN
   --OnBatchSuccess\OnBatchFailure
   SET @BatchStatusID = @StatusID
   SET @BatchErr = @Err
   SET @nSQL1 = NULL
   IF (@StatusID = @STAT_SUCCESS)
   BEGIN
      SET @nSQL1 = @OnBatchSuccess
      IF (@pDebug = 1)
      BEGIN
         SET @msg = '   OnBatchSuccess: ' + ISNULL(@OnBatchSuccess,'NULL')
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END
   END
   ELSE IF (@StatusID IN (@STAT_FAILURE,@STAT_ERROR))
   BEGIN
      SET @nSQL1 = @OnBatchFailure
      IF (@pDebug = 1)
      BEGIN
         SET @msg = '   OnBatchFailure: ' + ISNULL(@OnBatchFailure,'NULL')
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END
   END

   IF (@nSQL1 IS NOT NULL)
   BEGIN
      BEGIN TRY
      exec @ExitCode = dbo.prc_CreateHeader @Header out,@BatchID,null,null,@RunID,@bOptions,1 --b
      exec @ExitCode = dbo.prc_CreateContext @Context out,@Header
      exec @ExitCode = dbo.prc_CreateProcessRequest @ProcessRequest out,@Header,@Context,@phandle
      SET @ProcessReceipt = NULL
      EXEC sp_ExecuteSQL @nSql1
                  ,N'@ExitCode int output,@Request xml,@Receipt xml output'
                  ,@ExitCode = @ExitCode output
                  ,@Request = @ProcessRequest
                  ,@Receipt = @ProcessReceipt output
      
      EXEC @ExitCode = dbo.prc_ReadProcessReceipt @ProcessReceipt,null,@StatusID out,@Err out,@msg out

      SET @StatusID = isnull(@StatusID,@STAT_ERROR)
      IF (@Err <> 0 OR @StatusID <> @STAT_SUCCESS)
      BEGIN
         SET @RaiserrMsg = '   ERROR failed to execute OnSuccess/OnFailure code: return StatusID=' + cast(@StatusID as nvarchar(10))
                         + ' with msg: ' +  isnull(@msg,'null')
         RAISERROR(@RaiserrMsg,11,11)
      END
      
      END TRY
      BEGIN CATCH
         SET @Err = isnull(nullif(@Err,0),ERROR_NUMBER())
         SET @RaiserrMsg = '   ERROR OnSuccess/OnFailure:' + ERROR_MESSAGE()
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@RaiserrMsg,@Err
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END CATCH

      IF (@pDebug = 1)
      BEGIN
         SET @msg = '   Completed with StatusID=' + CAST(@StatusID as nvarchar(30))
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg,@Err
         exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
      END

   END
   IF(@StatusID = @STAT_SUCCESS)
   BEGIN
      SET @StatusID = @BatchStatusID
      SET @Err = @BatchErr
   END
END

IF (@RunID IS NOT NULL)
BEGIN
   exec @ExitCode = dbo.prc_Finalize @BatchHeader,@pHandle,@StatusID;

   --processing history clean up
   SELECT @CleanupRunID = max(RunID)
     FROM dbo.ETLBatchRun
    WHERE BatchID = @BatchID and StatusDT <= dateadd(dd,-@ATT_HISTRET,getdate())

   IF (@pDebug = 1)
   BEGIN
      SET @msg = '   Retention for BatchID=' + CAST(@BatchID as nvarchar(30)) + ' is set to ' + CAST(@ATT_HISTRET as nvarchar(30)) + ' days.'
               + ' All history prior to RunID=' + ISNULL(CAST(@CleanupRunID as nvarchar(30)),'null') + ' will be deleted'
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
      exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
   END

   IF (@CleanupRunID IS NOT NULL)
   BEGIN
      DELETE dbo.ETLStepRunHistoryLog
        FROM dbo.ETLStepRunHistoryLog h
        JOIN dbo.ETLBatchRun b on h.RunID = b.RunID AND b.BatchID = @BatchID
       WHERE  h.RunID <= @CleanupRunID

      DELETE dbo.ETLStepRunHistory WHERE RunID <= @CleanupRunID and BatchID = @BatchID
      DELETE dbo.ETLStepRunCounter WHERE RunID <= @CleanupRunID and BatchID = @BatchID
      --DELETE dbo.ETLStepRun WHERE RunID <= @CleanupRunID and BatchID = @BatchID
      DELETE dbo.ETLBatchRun WHERE RunID <= @CleanupRunID and BatchID = @BatchID
   END

   IF (@pDebug = 1)
   BEGIN
      SET @msg = '   Completed BatchID=' + CAST(@BatchID as nvarchar(30)) + ' with StatusID=' + CAST(@StatusID as nvarchar(30))
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg,@Err
      exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
   END

   if (@RaiserrMsg is not null)
      RAISERROR(@RaiserrMsg,11,11)

END

END TRY --Main block
BEGIN CATCH
   SET @Err = case @Err when 0 then ERROR_NUMBER() else @Err end
   SET @RaiserrMsg = ERROR_MESSAGE()
END CATCH

IF (@StatusID IN (@STAT_SUCCESS,@STAT_WARNING)) SET @Err = 0
IF (@pDebug = 1)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
   exec @ExitCode = dbo.prc_Print @ProcessInfo,@pHandle
END

IF (@RaiserrMsg is not null)
   RAISERROR(@RaiserrMsg,11,11)

RETURN @Err;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@Options]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@pBatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@pHandle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@pContext]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateContext]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[dbo].[ETLBatchRun]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Finalize]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StartTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[EndTime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@pRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck].[@pReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessReceipt]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[SvcName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[StatusID]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[services]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[services].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[routes]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[routes].[remote_service_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[SvcID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[SvcID]" />
				</Entry>
				<Entry>
					<References Name="[ETLController_Request]" />
				</Entry>
				<Entry>
					<References Name="[ETLController]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[Handle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[grpHandle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[StatusDate]" />
				</Entry>
				<Entry>
					<References Name="[ETLController_Test]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[Handle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[spid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StartTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[EndTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SeqGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[PriGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SvcName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StatusID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[GroupCode]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[SvcName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SvcName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SeqGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SeqGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[PriGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[PriGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[PriGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SeqGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[spid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StartTime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[fn_ETLCounterGet]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[EndTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SvcName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[SvcName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SvcName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[Handle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[SvcName]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[ETLController_Request]" Disambiguator="4" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController_Receipt_Queue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[SvcID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@service].[StatusDate]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[GroupCode]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[CounterValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[GroupCode]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[GroupCode]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Execute].[@LoopGroup].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[ETLController_Cancel]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunCounter].[BatchID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_Execute].[@service]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@service].[SvcID]">
									<Property Name="IsNullable" Value="False" />
									<Property Name="IsIdentity" Value="True" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@service].[SvcName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@service].[StatusID]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@service].[Handle]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@service].[grpHandle]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@service].[StatusDate]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[datetime]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_Execute].[@LoopGroup]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@LoopGroup].[StepID]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@LoopGroup].[GroupCode]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Execute].[@LoopGroup].[StatusID]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Execute].[@pBatchName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="30" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Execute].[@Options]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Execute].[@pHandle]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Execute].[@pContext]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="123" />
				<Property Name="Length" Value="53529" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="--select * from ETLbatch&#xD;&#xA;--select * from ETLstep where batchid = -20&#xD;&#xA;--prc_execute 'NTBC01','debug,forcestart,slaveoff'&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_Execute]&#xD;&#xA;    @pBatchName nvarchar(30)= NULL&#xD;&#xA;   ,@Options nvarchar(100) = NULL&#xD;&#xA;   ,@pHandle uniqueidentifier = NULL&#xD;&#xA;   ,@pContext xml(ETLController) = NULL&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ExportMetadataScript]">
			<Property Name="BodyScript">
				<Value><![CDATA[
/******************************************************************************
** File:	[prc_ExportMetadataScript].sql
** Name:	[dbo].[prc_ExportMetadataScript]

** Desc:	export workflow metadata to sql script
**          
**
** Params:
** Returns:
**
** Author:	andrey
** Date:	11/27/2016
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------
declare @script nvarchar(max);
exec prc_ExportMetadataScript @batchId = 100,@script = @script out
print substring (@Script,1,4000)
print substring (@Script,4001,8000)
print substring (@Script,8001,12000)
print substring (@Script,12001,16000)

*/
set nocount on;

set @script = '';
declare @sql nvarchar(max);

begin try

declare @msg nvarchar(2000);
if (@BatchName is null and @BatchId is null)
begin
	set @msg = 'Invalid input parameters. BatchId or BatchName are required';
	throw 50001,@msg,1; 
end


declare @bid int, @batchDesc nvarchar(1000);
select top 1
	 @bid = batchId
 from dbo.ETLBatch
where batchId = isnull(@batchId,batchId)
  and batchName = isnull(@batchName,batchName);

if (@bid is null)
begin
	set @msg = 'Invalid input parameters. BatchId: ' + isnull(cast(@batchId as nvarchar(30)),'null')
			 + ' or BatchName:' + isnull(@BatchName,'null');
	throw 50002,@msg,1; 
end

select top 1
	 @batchId = batchId
	,@BatchName = batchName
	,@BatchDesc = batchDesc
from dbo.ETLBatch
where batchId = @bid;


set @Script = '
---------------------------------------------------------
--' + @batchDesc + '
---------------------------------------------------------
set quoted_identIfier on;
set nocount on;
Declare @Batchid int,@BatchName nvarchar(100) ;
set @BatchID = ' + cast(@batchId as nvarchar(30)) + ';
set @BatchName = ''' + @batchName + ''';

print '' Compiling '' + @BatchName;

begin try
-------------------------------------------------------
--remove Workflow metadata
-------------------------------------------------------
exec dbo.prc_RemoveContext @BatchName;
'

set @sql = (select
	     + '''' + isnull(batchDesc,@batchName) + ''','
		 + isnull(cast(OnSuccessID as nvarchar(10)),'null') + ','
		 + isnull(cast(OnFailureID as nvarchar(10)),'null') + ','
		 + isnull(cast(IgnoreErr as nvarchar(10)),'0') + ','
		 + isnull(cast(RestartOnErr as nvarchar(10)),'0')
from dbo.ETLBatch where batchId = @batchId);

set @Script += '

-------------------------------------------------------
--create workflow record 
-------------------------------------------------------
set identity_insert dbo.ETLBatch on;
insert dbo.ETLBatch
(BatchID,BatchName,BatchDesc,OnSuccessID,OnFailureID,IgnoreErr,RestartOnErr)
values (@BatchID,@BatchName,' + @sql + ');
set identity_insert dbo.ETLBatch off;
'
--system attributes
set @sql = '';
select @sql += ',(@batchId,''' + ba.attributeName + ''',''' + replace(ba.attributeValue,'''','''''') + ''')
'
from dbo.ETLBatchAttribute ba
where ba.batchId = @batchId
and  ba.AttributeName in ('HISTRET','MAXTHREAD','PING','TIMEOUT','LIFETIME','RETRY','DELAY');

if (len(@sql) > 0)
set @Script += '
-------------------------------------------------------
--Define workflow level system attributes
--those attributes can be referenced in wf body like <etl:MaxThread> etc.
-------------------------------------------------------
insert dbo.ETLBatchAttribute
(BatchID,AttributeName,AttributeValue)
values
 ' + right(@sql,len(@sql) - 1) + ';';


--user attributes
set @sql = '';
select @sql += ',(@batchId,''' + ba.attributeName + ''',''' + replace(ba.attributeValue,'''','''''') + ''')
'
from dbo.ETLBatchAttribute ba
where ba.batchId = @batchId
and  ba.AttributeName not in ('HISTRET','MAXTHREAD','PING','TIMEOUT','LIFETIME','RETRY','DELAY');

if (len(@sql) > 0)
set @Script += '
-------------------------------------------------------
--Define workflow level user attributes
-- use systemparameters to store global configuration parameters
-- select * from systemparameters
-------------------------------------------------------
insert dbo.ETLBatchAttribute
(BatchID,AttributeName,AttributeValue)
values
 ' + right(@sql,len(@sql) - 1) + ';';


if exists (select 1 from dbo.ETLBatchConstraint where batchId = @batchId)
begin

set @Script += '
-------------------------------------------------------
--create batch level constraints
-------------------------------------------------------

'
set @sql = '';
select @sql += ',(@batchId,'
		 + cast(constId as nvarchar(10)) + ','
		 + isnull(cast(ProcessId as nvarchar(10)),'null') + ','
		 + isnull('''' + ConstOrder + '''','null') + ','
		 + isnull(cast(WaitPeriod as nvarchar(10)),'0') + ')'
from dbo.ETLBatchConstraint where batchId = @batchId
order by constId;


if (len(@sql) > 0)
set @Script += '
set identity_insert dbo.ETLBatchConstraint on
insert dbo.ETLBatchConstraint
(BatchID,ConstID,ProcessID,ConstOrder,WaitPeriod)
values
' + right(@sql,len(@sql) - 1) + ';
set identity_insert dbo.ETLBatchConstraint off;
';

--system attributes
set @sql = '';
select @sql += ',(@batchId,' + cast(bca.ConstId as nvarchar(10)) + ',''' + bca.attributeName + ''',''' + replace(bca.attributeValue,'''','''''') + ''')
'
from dbo.ETLBatchConstraintAttribute bca
where bca.batchId = @batchId
and  bca.AttributeName in ('DISABLED','PING')
order by bca.constId;

if (len(@sql) > 0)
begin
set @Script += '
-------------------------------------------------------
--Define workflow constraint level system attributes
-------------------------------------------------------
insert dbo.ETLBatchConstraintAttribute
(BatchID,ConstId,AttributeName,AttributeValue)
values
 ' + right(@sql,len(@sql) - 1) + ';';

--user attributes
set @sql = '';
select @sql += ',(@batchId,' + cast(bca.ConstId as nvarchar(10)) + ',''' + bca.attributeName + ''',''' + replace(bca.attributeValue,'''','''''') + ''')
'
from dbo.ETLBatchConstraintAttribute bca
where bca.batchId = @batchId
and  bca.AttributeName not in ('DISABLED','PING')
order by bca.constId;


set @Script += '

-------------------------------------------------------
--Define workflow constraint level user attributes
-------------------------------------------------------
insert dbo.ETLBatchConstraintAttribute
(BatchID,ConstId,AttributeName,AttributeValue)
values
 ' + right(@sql,len(@sql) - 1) + ';';

end
end

--steps
set @Script += '

-------------------------------------------------------
--create workflow steps
-------------------------------------------------------
declare @stepId int;
';

declare step_cur cursor local fast_forward
for select StepId from dbo.ETLStep
where BatchId = @BatchId;

declare @stepId int = 0;
open step_cur
while (1=1)
begin

fetch next from step_cur into @stepId;
if (@@FETCH_STATUS <> 0) break;

select @sql = '(@batchId,@stepId,'
		 + '''' + StepName + '''' + ','
		 + isnull('''' + StepDesc + '''','null') + ','
		 + cast(StepProcId as nvarchar(10)) + ','
		 + isnull(cast(OnSuccessID as nvarchar(10)),'null') + ','
		 + isnull(cast(OnFailureID as nvarchar(10)),'null') + ','
		 + isnull(cast(IgnoreErr as nvarchar(10)),'0') + ','
		 + isnull('''' + StepOrder + '''','null') + ')
'
from dbo.ETLStep where batchId = @batchId and stepId = @stepId;

set @Script += '

-------------------------------------------------------
--step: ' + cast(@stepId as nvarchar(10)) + '
-------------------------------------------------------
set @stepId = ' + cast(@stepId as nvarchar(10)) + ';
set identity_insert dbo.ETLStep on;
insert dbo.ETLStep
(BatchID,StepID,StepName,StepDesc,StepProcID,OnSuccessID,OnFailureID,IgnoreErr,StepOrder)
values
 ' + @sql + ';
set identity_insert dbo.ETLStep off;
';

--step attributes
--system attributes
set @sql = '';
select @sql += ',(@batchId,@stepId,''' + sa.attributeName + ''',''' + replace(sa.attributeValue,'''','''''') + ''')
'
from dbo.ETLStepAttribute sa
where sa.batchId = @batchId and sa.stepId = @stepId
and  sa.AttributeName in ('DISABLED','SEQGROUP','PRIGROUP','RETRY','DELAY','RESTART','LOOPGROUP');

if (len(@sql) > 0)
set @Script += '
-------------------------------------------------------
--Define workflow step level system attributes
--those attributes can be referenced in wf body like <etl:Disabled> etc.
-------------------------------------------------------
insert dbo.ETLStepAttribute
(BatchID,StepId,AttributeName,AttributeValue)
values
 ' + right(@sql,len(@sql) - 1) + ';';


--user attributes
set @sql = '';
select @sql += ',(@batchId,@stepId,''' + sa.attributeName + ''',''' + replace(sa.attributeValue,'''','''''') + ''')
'
from dbo.ETLStepAttribute sa
where sa.batchId = @batchId and sa.stepId = @stepId
and  sa.AttributeName not in ('DISABLED','SEQGROUP','PRIGROUP','RETRY','DELAY','RESTART','LOOPGROUP');

if (len(@sql) > 0)
set @Script += '
-------------------------------------------------------
--Define workflow step level user attributes
-------------------------------------------------------
insert dbo.ETLStepAttribute
(BatchID,StepId,AttributeName,AttributeValue)
values
 ' + right(@sql,len(@sql) - 1) + ';';


if exists (select 1 from dbo.ETLStepConstraint where batchId = @batchId and stepId = @stepId)
begin

set @Script += '
-------------------------------------------------------
--create step level constraints
-------------------------------------------------------

'
set @sql = '';
select @sql += ',(@batchId,@stepId,'
		 + cast(constId as nvarchar(10)) + ','
		 + isnull(cast(ProcessId as nvarchar(10)),'null') + ','
		 + isnull('''' + ConstOrder + '''','null') + ','
		 + isnull(cast(WaitPeriod as nvarchar(10)),'0') + ')'
from dbo.ETLStepConstraint where batchId = @batchId and stepId = @stepId
order by ConstId;


if (len(@sql) > 0)
set @Script += '
set identity_insert dbo.ETLStepConstraint on
insert dbo.ETLStepConstraint
(BatchID,StepID,ConstID,,ProcessID,ConstOrder,WaitPeriod)
values
' + right(@sql,len(@sql) - 1) + ';
set identity_insert dbo.ETLStepConstraint off;
';

--system attributes
set @sql = '';
select @sql += ',(@batchId,@stepId,' + cast(sca.ConstId as nvarchar(10)) + ',''' + sca.attributeName + ''',''' + replace(sca.attributeValue,'''','''''') + ''')
'
from dbo.ETLStepConstraintAttribute sca
where sca.batchId = @batchId and sca.stepId = @stepId
and  sca.AttributeName in ('DISABLED','PING')
order by sca.constId;

if (len(@sql) > 0)
begin
set @Script += '
-------------------------------------------------------
--Define workflow step constraint level system attributes
-------------------------------------------------------
insert dbo.ETLStepConstraintAttribute
(BatchID,StepID,ConstId,AttributeName,AttributeValue)
values
 ' + right(@sql,len(@sql) - 1) + ';';

--user attributes
set @sql = '';
select @sql += ',(@batchId,@stepId,' + cast(sca.ConstId as nvarchar(10)) + ',''' + sca.attributeName + ''',''' + replace(sca.attributeValue,'''','''''') + ''')
'
from dbo.ETLStepConstraintAttribute sca
where sca.batchId = @batchId
and  sca.AttributeName not in ('DISABLED','PING')
order by sca.constId;

set @Script += '

-------------------------------------------------------
--Define workflow step constraint level user attributes
-------------------------------------------------------
insert dbo.ETLStepConstraintAttribute
(BatchID,StepID,ConstId,AttributeName,AttributeValue)
values
 ' + right(@sql,len(@sql) - 1) + ';';

end
end

end
deallocate step_cur;

set @Script += '

end try
begin catch
   declare @msg nvarchar(1000)
   set @msg = ''ERRROR: set metadata failed with message: '' + error_message();
   throw 50001, @msg, 1;
end catch
'
;

--print substring (@Script,1,4000)
--print substring (@Script,4001,8000)
--print substring (@Script,8001,12000)
--print substring (@Script,12001,16000)

end try
begin catch
   set @msg = 'Failed to script etadata: ' + error_message();
   throw 50001, @msg, 1;
end catch]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExportMetadataScript].[@Script]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExportMetadataScript].[@BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ExportMetadataScript].[@BatchId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchDesc]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchDesc]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[OnFailureID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[RestartOnErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepDesc]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepProcID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[OnFailureID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepOrder]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExportMetadataScript].[@BatchName]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExportMetadataScript].[@BatchId]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ExportMetadataScript].[@Script]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="12433" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="create procedure [dbo].[prc_ExportMetadataScript]&#xD;&#xA; @BatchName nvarchar(100) = null&#xD;&#xA;,@BatchId int = null&#xD;&#xA;,@Script nvarchar(max) = null out&#xD;&#xA;as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_Finalize]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
begin
/******************************************************************************
** File:	[prc_Finalize].sql
** Name:	[dbo].[prc_Finalize]

** SD Location: VSS/Development/SubjectAreas/BI/Database/Schema/Procedure/[prc_Finalize].sql:

** Desc:	clean up the execution tables
**          
**
** Params:
** Returns:
**
** Author:	andreys
** Date:	10/15/2011
** ****************************************************************************
** CHANGE HISTORY
** ****************************************************************************
** Date				Author	version	4	#bug			Description
** ----------------------------------------------------------------------------------------------------------

*/

set nocount on
declare @err                int
declare @proc               sysname
declare @msg                nvarchar(1000)
declare @debug              tinyint
declare @Rows               int

declare @ProcErr int
declare @ProcName sysname
declare @BatchID int
declare @RunID int
declare @Options int
declare @ProcessInfo xml (ETLController)

set @ProcName = object_name(@@PROCID);

set @err = 0;
begin try

exec dbo.prc_ReadHeader @pHeader,@BatchID out,null,null,@RunID out,@Options out;
set @debug = @Options & 1;

--Finalize All stuck RunIDs
--set @RunID = null;

declare @run table (RunID int primary key);
insert @run
select distinct RunID from dbo.ETLStepRun
 where BatchID = @BatchID AND (RunID = @RunID OR isnull(@RunID,0) = 0)
 union select RunID from dbo.ETLBatchRun
 where BatchID = @BatchID AND (RunID = @RunID OR (isnull(@RunID,0) = 0 and StatusID = 1));

select @RunID = MAX(RunID) from @run;

UPDATE s
  SET s.StatusID = CASE WHEN t.StatusID = 1 THEN @pStatusID ELSE t.StatusID END,s.StatusDT = t.StatusDT,s.Err = t.Err
 FROM dbo.ETLStep s
 JOIN  dbo.ETLStepRun t ON s.StepID = t.StepID AND s.BatchID = t.BatchID
 JOIN @run r on t.RunID = r.RunID
WHERE s.BatchID = @BatchID;

UPDATE b
 SET b.EndTime = getdate()
    ,b.StatusID = @pStatusID
    ,b.StatusDT = getdate()
    ,b.Err = case when @pStatusID = 2 then 0 else 50103 end
FROM dbo.ETLBatchRun b
JOIN @run r ON b.RunID = r.RunID
WHERE b.BatchID = @BatchID;

DELETE dbo.ETLStepRun
OUTPUT deleted.RunID,deleted.BatchID,deleted.StepID,deleted.StatusDT
 ,CASE WHEN deleted.StatusID = 1 THEN @pStatusID ELSE deleted.StatusID END
 ,deleted.SPID,deleted.StepOrder,deleted.IgnoreErr
 ,deleted.Err,deleted.StartTime,deleted.EndTime,deleted.SeqGroup,deleted.PriGroup,deleted.SvcName
 INTO dbo.ETLStepRunHistory
(RunID,BatchID,StepID,StatusDT,StatusID,SPID,StepOrder,IgnoreErr
,Err,StartTime,EndTime,SeqGroup,PriGroup,SvcName)
FROM dbo.ETLStepRun s
JOIN @run r ON s.RunID = r.RunID
WHERE s.BatchID = @BatchID;

set @Rows = @@ROWCOUNT;
IF (@Debug = 1)
BEGIN
  SET @msg = '   Moved ' + CAST(@Rows as nvarchar(30)) + ' rows in ETLStepRunHistory for BatchID=' + CAST(@BatchID as nvarchar(30));
  exec dbo.prc_CreateProcessInfo @ProcessInfo out,@pHeader,@msg;
  exec dbo.prc_Print @ProcessInfo,@pHandle;
END

UPDATE b
 SET b.EndTime = r.EndTime
    ,b.StatusDT = r.StatusDT
    ,b.StatusID = r.StatusID
   ,b.Err = r.Err
FROM dbo.ETLBatch b
JOIN dbo.ETLBatchRun r ON b.BatchID = r.BatchID AND r.RunID = @RunID 
WHERE b.BatchID = @BatchID;


end try
begin catch
   set @Proc = ERROR_PROCEDURE()
   set @Msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   raiserror ('ERROR: PROC %s, MSG: %s',11,11,@Proc,@Msg) 
end catch

return @err
end;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Finalize].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Finalize].[@run].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Finalize].[@run].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Finalize].[@pStatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Finalize].[@run].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[EndTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Finalize].[@run].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[spid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StartTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[EndTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SeqGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[PriGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[SvcName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[spid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[StartTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[EndTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[SeqGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[PriGroup]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[SvcName]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Finalize].[@pHandle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[EndTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[EndTime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StatusDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[Err]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_Finalize].[@run]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_Finalize].[@run].[RunID]">
									<Property Name="IsNullable" Value="False" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Finalize].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Finalize].[@pHandle]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Finalize].[@pStatusID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3656" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE procedure [dbo].[prc_Finalize] (&#xD;&#xA;    @pHeader xml(ETLController)&#xD;&#xA;   ,@pHandle uniqueidentifier = null&#xD;&#xA;   ,@pStatusID smallint&#xD;&#xA;   &#xD;&#xA;) as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_PersistContext]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_PersistContext.SQL
**
**D Desc:         create persist context into ETLBatch tables
**
** @Options       debug,replace
** @pHandle       conversation handle to communicate messages back to main thread

**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
01/12/2008           Praveen			Added Retry and Delay 83349
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)
DECLARE @trancount int

DECLARE @BatchID int
DECLARE @StepID int
DECLARE @ConstID int
DECLARE @RunID int
DECLARE @Options int
DECLARE @debug tinyint
DECLARE @replace tinyint
DECLARE @Handle uniqueidentifier
DECLARE @BatchName nvarchar(30)

declare @Name nvarchar(100)
declare @Value1 nvarchar(max)
declare @Value2 nvarchar(max)
declare @nValue nvarchar(max)

DECLARE @Header xml(ETLController)
DECLARE @Context xml(ETLController)
DECLARE @ProcessInfo xml(ETLController)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0
SET @trancount = @@trancount


begin try
set @debug = case when charindex('debug',@pOptions) > 0 then 1 else 0 end
set @replace = case when charindex('replace',@pOptions) > 0 then 1 else 0 end

;with xmlnamespaces('ETLController.XSD' as etl)
select @BatchID = @pContext.value('(/etl:Context/@BatchID)[1]','int')
      ,@BatchName = @pContext.value('(/etl:Context/@BatchName)[1]','nvarchar(30)')

exec [prc_CreateHeader] @Header out,@BatchID,null,null,0,@debug,15
if (@debug = 1)
begin
   SET @msg =  'BEGIN Procedure ' + @ProcName + ' for BatchName=' + isnull(@BatchName,'NULL')
            + ' (' + isnull(cast(@BatchID as nvarchar(10)),'NULL') + ')'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end


if exists (select 1 from dbo.[ETLBatch] where BatchName = @BatchName and BatchID <> @BatchID)
BEGIN
   SET @Err = 50101
   SET @msg = '   ERROR pContext: BatchName=' + @BatchName + ' already exists with different BatchID'
   RAISERROR(@msg,11,11) 
END

--b shred
;with xmlnamespaces('ETLController.XSD' as etl)
select
       cb.b.value('(./@BatchID)[1]','int') as BatchID
      ,cb.b.value('(./@BatchName)[1]','nvarchar(30)') as BatchName
      ,cb.b.value('(./@BatchDesc)[1]','nvarchar(500)') as BatchDesc
      ,cb.b.value('(./etl:OnSuccess/@ProcessID)[1]','int') as OnSuccessID
      ,cb.b.value('(./etl:OnFailure/@ProcessID)[1]','int') as OnFailureID
      ,cb.b.value('(./@IgnoreErr)[1]','tinyint') as IgnoreErr
      ,cb.b.value('(./@Restart)[1]','tinyint') as RestartOnErr
      ,cb.b.value('(./@MaxThread)[1]','tinyint') as MaxThread
      ,cb.b.value('(./@Timeout)[1]','int') as [Timeout]
      ,cb.b.value('(./@Lifetime)[1]','int') as Lifetime
      ,cb.b.value('(./@Ping)[1]','tinyint') as Ping
      ,cb.b.value('(./@HistRet)[1]','int') as HistRet
      ,cb.b.value('(./@Retry)[1]','int') as Retry
      ,cb.b.value('(./@Delay)[1]','int') as [Delay]
  into #b
  from @pContext.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Shredding B:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--ba shred
;with xmlnamespaces('ETLController.XSD' as etl)
select
       cb.b.value('(./@BatchID)[1]','int') as BatchID
      ,cba.ba.value('(./@Name)[1]','nvarchar(100)') as AttributeName
      ,cba.ba.value('(.)[1]','nvarchar(4000)') as AttributeValue
  into #ba
  from @pContext.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
  cross apply cb.b.nodes('./etl:Attributes/etl:Attribute') cba(ba)
  union select BatchID,'MAXTHREAD',cast(MaxThread as nvarchar(1000)) from #b where MaxThread is not null
  union select BatchID,'TIMEOUT',cast([Timeout] as nvarchar(1000)) from #b where [Timeout] is not null
  union select BatchID,'LIFETIME',cast(Lifetime as nvarchar(1000)) from #b where Lifetime is not null
  union select BatchID,'PING',cast(Ping as nvarchar(1000)) from #b where Ping is not null
  union select BatchID,'HISTRET',cast(HistRet as nvarchar(1000)) from #b where HistRet is not null
  union select BatchID,'RETRY',cast(Retry as nvarchar(1000)) from #b where Retry is not null
  union select BatchID,'DELAY',cast([Delay] as nvarchar(1000)) from #b where [Delay] is not null

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Shredding BA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end


;with xmlnamespaces('ETLController.XSD' as etl)
select
       cb.b.value('(./@BatchID)[1]','int') as BatchID
      ,cbc.bc.value('(./@ConstID)[1]','int') as ConstID
      ,cbc.bc.value('(./etl:Process/@ProcessID)[1]','int') as ProcessID
      ,cbc.bc.value('(./@ConstOrder)[1]','nvarchar(10)') as ConstOrder
      ,cbc.bc.value('(./@WaitPeriod)[1]','int') as WaitPeriod
      ,cbc.bc.value('(./@Disabled)[1]','tinyint') as [Disabled]
      ,cbc.bc.value('(./@Ping)[1]','int') as Ping
  into #bc
  from @pContext.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
  cross apply cb.b.nodes('./etl:Constraints/etl:Constraint') cbc(bc)
set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Shredding BC:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

;with xmlnamespaces('ETLController.XSD' as etl)
select
       cb.b.value('(./@BatchID)[1]','int') as BatchID
      ,cbc.bc.value('(./@ConstID)[1]','int') as ConstID
      ,cbca.bca.value('(./@Name)[1]','nvarchar(100)') as AttributeName
      ,cbca.bca.value('(.)[1]','nvarchar(4000)') as AttributeValue
  into #bca
  from @pContext.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
  cross apply cb.b.nodes('./etl:Constraints/etl:Constraint') cbc(bc)
  cross apply cbc.bc.nodes('./etl:Attributes/etl:Attribute') cbca(bca)
  union select BatchID,ConstID,'DISABLED',cast([Disabled] as nvarchar(1000)) from #bc where [Disabled] is not null
  union select BatchID,ConstID,'PING',cast(Ping as nvarchar(1000)) from #bc where Ping is not null

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Shredding BCA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--s shred
;with xmlnamespaces('ETLController.XSD' as etl)
select
       cb.b.value('(./@BatchID)[1]','int') as BatchID
      ,cs.s.value('(./@StepID)[1]','int') as StepID
      ,cs.s.value('(./@StepName)[1]','nvarchar(100)') as StepName
      ,cs.s.value('(./@StepDesc)[1]','nvarchar(500)') as StepDesc
      ,cs.s.value('(./etl:Process/@ProcessID)[1]','int') as StepProcID
      ,cs.s.value('(./etl:OnSuccess/@ProcessID)[1]','int') as OnSuccessID
      ,cs.s.value('(./etl:OnFailure/@ProcessID)[1]','int') as OnFailureID
      ,cs.s.value('(./@IgnoreErr)[1]','tinyint') as IgnoreErr
      ,cs.s.value('(./@Restart)[1]','tinyint') as RestartOnErr
      ,cs.s.value('(./@StepOrder)[1]','nvarchar(10)') as StepOrder
      ,cs.s.value('(./@Disabled)[1]','tinyint') as [Disabled]
      ,cs.s.value('(./@SeqGroup)[1]','int') as SeqGroup
      ,cs.s.value('(./@PriGroup)[1]','int') as PriGroup
      ,cs.s.value('(./@Retry)[1]','int') as Retry
      ,cs.s.value('(./@Delay)[1]','int') as [Delay]
  into #s
  from @pContext.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
  cross apply cb.b.nodes('./etl:Steps/etl:Step') cs(s)

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Shredding S:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--sa shred
;with xmlnamespaces('ETLController.XSD' as etl)
select
       cb.b.value('(./@BatchID)[1]','int') as BatchID
      ,cs.s.value('(./@StepID)[1]','int') as StepID
      ,csa.sa.value('(./@Name)[1]','nvarchar(100)') as AttributeName
      ,csa.sa.value('(.)[1]','nvarchar(4000)') as AttributeValue
  into #sa
  from @pContext.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
  cross apply cb.b.nodes('./etl:Steps/etl:Step') cs(s)
  cross apply cs.s.nodes('./etl:Attributes/etl:Attribute') csa(sa)
  union select BatchID,StepID,'DISABLED',cast([Disabled] as nvarchar(1000)) from #s where [Disabled] is not null
  union select BatchID,StepID,'SEQGROUP',cast(SeqGroup as nvarchar(1000)) from #s where SeqGroup is not null
  union select BatchID,StepID,'PRIGROUP',cast(PriGroup as nvarchar(1000)) from #s where PriGroup is not null
  union select BatchID,StepID,'RETRY',cast(Retry as nvarchar(1000)) from #s where Retry is not null
  union select BatchID,StepID,'DELAY',cast([Delay] as nvarchar(1000)) from #s where [Delay] is not null
  union select BatchID,StepID,'RESTART',cast(RestartOnErr as nvarchar(1000)) from #s where RestartOnErr is not null

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Shredding SA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--sc shred
;with xmlnamespaces('ETLController.XSD' as etl)
select
       cb.b.value('(./@BatchID)[1]','int') as BatchID
      ,cs.s.value('(./@StepID)[1]','int') as StepID
      ,csc.sc.value('(./@ConstID)[1]','int') as ConstID
      ,csc.sc.value('(./etl:Process/@ProcessID)[1]','int') as ProcessID
      ,csc.sc.value('(./@ConstOrder)[1]','nvarchar(10)') as ConstOrder
      ,csc.sc.value('(./@WaitPeriod)[1]','int') as WaitPeriod
      ,csc.sc.value('(./@Disabled)[1]','tinyint') as [Disabled]
      ,csc.sc.value('(./@Ping)[1]','int') as Ping
  into #sc
  from @pContext.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
  cross apply cb.b.nodes('./etl:Steps/etl:Step') cs(s)
  cross apply cs.s.nodes('./etl:Constraints/etl:Constraint') csc(sc)

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Shredding SC:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--sca shred
;with xmlnamespaces('ETLController.XSD' as etl)
select
       cb.b.value('(./@BatchID)[1]','int') as BatchID
      ,cs.s.value('(./@StepID)[1]','int') as StepID
      ,csc.sc.value('(./@ConstID)[1]','int') as ConstID
      ,csca.sca.value('(./@Name)[1]','nvarchar(100)') as AttributeName
      ,csca.sca.value('(.)[1]','nvarchar(4000)') as AttributeValue
  into #sca
  from @pContext.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
  cross apply cb.b.nodes('./etl:Steps/etl:Step') cs(s)
  cross apply cs.s.nodes('./etl:Constraints/etl:Constraint') csc(sc)
  cross apply csc.sc.nodes('./etl:Attributes/etl:Attribute') csca(sca)
  union select BatchID,ConstID,ConstID,'DISABLED',cast([Disabled] as nvarchar(1000)) from #sc where [Disabled] is not null
  union select BatchID,ConstID,ConstID,'PING',cast(Ping as nvarchar(1000)) from #sc where Ping is not null

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Shredding SCA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

BEGIN TRAN

if (@Replace = 1)
begin

   exec @ProcErr = dbo.[prc_RemoveContext] @BatchName,@pHandle,@pOptions

   if (@debug = 1)
   begin
      SET @msg =  'Deleted all old records (Replace=1)...'
      exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
      exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
   end

end

--b persist
update d
   set
       d.BatchName = t.BatchName
      ,d.BatchDesc = t.BatchDesc
      ,d.OnSuccessID = t.OnSuccessID
      ,d.OnFailureID = t.OnFailureID
      ,d.IgnoreErr = t.IgnoreErr
      ,d.RestartOnErr = t.RestartOnErr
  from dbo.[ETLBatch] d
  join #b t on d.BatchID = t.BatchID

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Updated B:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

set identity_insert dbo.[ETLBatch] on
insert dbo.[ETLBatch]
    (BatchID,BatchName,BatchDesc,OnSuccessID,OnFailureID,IgnoreErr,RestartOnErr)
select
       t.BatchID
      ,t.BatchName
      ,t.BatchDesc
      ,t.OnSuccessID
      ,t.OnFailureID
      ,t.IgnoreErr
      ,t.RestartOnErr
  from #b t
  left join dbo.[ETLBatch] d on t.BatchID = d.BatchID
 where d.BatchID is null
set @cnt = @@ROWCOUNT
set identity_insert dbo.[ETLBatch] off

if (@debug = 1)
begin
   SET @msg =  'Inserted B:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--ba persist
update d
   set
       d.AttributeValue = t.AttributeValue
  from dbo.[ETLBatchAttribute] d
  join #ba t on d.BatchID = t.BatchID and d.AttributeName = t.AttributeName

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Updated BA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

insert dbo.[ETLBatchAttribute]
    (BatchID,AttributeName,AttributeValue)
select
       t.BatchID
      ,t.AttributeName
      ,t.AttributeValue
  from #ba t
  left join dbo.[ETLBatchAttribute] d on t.BatchID = d.BatchID and t.AttributeName = d.AttributeName
 where d.BatchID is null

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Inserted B:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--bc persist
update d
   set
       d.ProcessID = t.ProcessID
      ,d.ConstOrder = t.ConstOrder
      ,d.WaitPeriod = t.WaitPeriod
  from dbo.[ETLBatchConstraint] d
  join #bc t on d.BatchID = t.BatchID and d.ConstID = t.ConstID

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Updated BC:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

set identity_insert dbo.[ETLBatchConstraint] on
insert dbo.[ETLBatchConstraint]
    (BatchID,ConstID,ProcessID,ConstOrder,WaitPeriod)
select
       t.BatchID
      ,t.ConstID
      ,t.ProcessID
      ,t.ConstOrder
      ,t.WaitPeriod
  from #bc t
  left join dbo.[ETLBatchConstraint] d on t.BatchID = d.BatchID and d.ConstID = t.ConstID
 where d.BatchID is null
set @cnt = @@ROWCOUNT
set identity_insert dbo.[ETLBatchConstraint] off

if (@debug = 1)
begin
   SET @msg =  'Inserted BC:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--bca persist
update d
   set
       d.AttributeValue = t.AttributeValue
  from dbo.[ETLBatchConstraintAttribute] d
  join #bca t on t.BatchID = d.BatchID and t.ConstID = d.ConstID and t.AttributeName = d.AttributeName

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Updated BCA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

insert dbo.[ETLBatchConstraintAttribute]
    (BatchID,ConstID,AttributeName,AttributeValue)
select
       t.BatchID
      ,t.ConstID
      ,t.AttributeName
      ,t.AttributeValue
  from #bca t
  left join dbo.[ETLBatchConstraintAttribute] d on t.BatchID = d.BatchID and t.ConstID = d.ConstID and t.AttributeName = d.AttributeName
 where d.BatchID is null

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Inserted BCA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--s persist
update d
   set
       d.StepName = t.StepName
      ,d.StepDesc = t.StepDesc
      ,d.StepProcID = t.StepProcID
      ,d.OnSuccessID = t.OnSuccessID
      ,d.OnFailureID = t.OnFailureID
      ,d.IgnoreErr = t.IgnoreErr
      ,d.StepOrder = t.StepOrder
  from dbo.[ETLStep] d
  join #s t on d.BatchID = t.BatchID and t.StepID = d.StepID

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Updated S:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

set identity_insert dbo.[ETLStep] on
insert dbo.[ETLStep]
    (BatchID,StepID,StepName,StepDesc,StepProcID,OnSuccessID,OnFailureID,IgnoreErr,StepOrder)
select
       t.BatchID
      ,t.StepID
      ,t.StepName
      ,t.StepDesc
      ,t.StepProcID
      ,t.OnSuccessID
      ,t.OnFailureID
      ,t.IgnoreErr
      ,t.StepOrder
  from #s t
  left join dbo.[ETLStep] d on t.BatchID = d.BatchID
 where d.BatchID is null

set @cnt = @@ROWCOUNT
set identity_insert dbo.[ETLStep] off

if (@debug = 1)
begin
   SET @msg =  'Inserted S:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--sa persist
update d
   set
       d.AttributeValue = t.AttributeValue
  from dbo.[ETLStepAttribute] d
  join #sa t on d.BatchID = t.BatchID and d.StepID = t.StepID and d.AttributeName = t.AttributeName

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Updated SA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

insert dbo.[ETLStepAttribute]
    (BatchID,StepID,AttributeName,AttributeValue)
select
       t.BatchID
      ,t.StepID
      ,t.AttributeName
      ,t.AttributeValue
  from #sa t
  left join dbo.[ETLStepAttribute] d on t.BatchID = d.BatchID and d.StepID = t.StepID and t.AttributeName = d.AttributeName
 where d.BatchID is null

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Inserted SA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--sc persist
update d
   set
       d.ProcessID = t.ProcessID
      ,d.ConstOrder = t.ConstOrder
      ,d.WaitPeriod = t.WaitPeriod
  from dbo.[ETLStepConstraint] d
  join #sc t on d.BatchID = t.BatchID and d.StepID = t.StepID and d.ConstID = t.ConstID

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Updated SC:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

set identity_insert dbo.[ETLStepConstraint] on
insert dbo.[ETLStepConstraint]
    (BatchID,StepID,ConstID,ProcessID,ConstOrder,WaitPeriod)
select
       t.BatchID
      ,t.StepID
      ,t.ConstID
      ,t.ProcessID
      ,t.ConstOrder
      ,t.WaitPeriod
  from #sc t
  left join dbo.[ETLStepConstraint] d on t.BatchID = d.BatchID and d.StepID = t.StepID and d.ConstID = t.ConstID
 where d.BatchID is null

set @cnt = @@ROWCOUNT
set identity_insert dbo.[ETLStepConstraint] off

if (@debug = 1)
begin
   SET @msg =  'Inserted SC:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--sca persist
update d
   set
       d.AttributeValue = t.AttributeValue
  from dbo.[ETLStepConstraintAttribute] d
  join #sca t on t.BatchID = d.BatchID and d.StepID = t.StepID and t.ConstID = d.ConstID and t.AttributeName = d.AttributeName

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Updated SCA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

insert dbo.[ETLStepConstraintAttribute]
    (BatchID,StepID,ConstID,AttributeName,AttributeValue)
select
       t.BatchID
      ,t.StepID
      ,t.ConstID
      ,t.AttributeName
      ,t.AttributeValue
  from #sca t
  left join dbo.[ETLStepConstraintAttribute] d on t.BatchID = d.BatchID and d.StepID = t.StepID and t.ConstID = d.ConstID and t.AttributeName = d.AttributeName
 where d.BatchID is null

set @cnt = @@ROWCOUNT
if (@debug = 1)
begin
   SET @msg =  'Inserted CSA:' + cast(@cnt as nvarchar(10)) + ' rows'
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

COMMIT TRAN

IF (@debug = 1)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
END

end try
begin catch
   if @Trancount < @@trancount
      ROLLBACK TRAN

   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[@pOptions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[@pContext]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[@pHandle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[BatchID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[MaxThread]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[Timeout]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[Lifetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[Ping]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[HistRet]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[Retry]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[Delay]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[ConstID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[Disabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[Ping]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[StepID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[Disabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[SeqGroup]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[PriGroup]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[Retry]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[Delay]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[RestartOnErr]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[ConstID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[Disabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[Ping]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_RemoveContext]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[BatchDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[OnFailureID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[OnFailureID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[RestartOnErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#b].[RestartOnErr]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[OnFailureID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[RestartOnErr]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#ba]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#ba].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#ba].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#ba].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bc].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bca]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bca].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bca].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bca].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#bca].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[StepName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[StepDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepProcID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[StepProcID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[OnFailureID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[OnFailureID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#s].[StepOrder]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepProcID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[OnSuccessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[OnFailureID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[IgnoreErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepOrder]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sa]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sa].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sa].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sa].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sa].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sc].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ProcessID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[ConstOrder]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[WaitPeriod]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sca]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sca].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sca].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sca].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sca].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_PersistContext].[#sca].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[ConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[AttributeValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_PersistContext].[#b]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[BatchID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[BatchName]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[BatchDesc]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[OnSuccessID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[OnFailureID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[IgnoreErr]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[RestartOnErr]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[MaxThread]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[Timeout]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[Lifetime]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[Ping]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[HistRet]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[Retry]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#b].[Delay]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_PersistContext].[#ba]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#ba].[BatchID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#ba].[AttributeName]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#ba].[AttributeValue]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_PersistContext].[#bc]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bc].[BatchID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bc].[ConstID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bc].[ProcessID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bc].[ConstOrder]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bc].[WaitPeriod]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bc].[Disabled]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bc].[Ping]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_PersistContext].[#bca]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bca].[BatchID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bca].[ConstID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bca].[AttributeName]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#bca].[AttributeValue]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_PersistContext].[#s]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[BatchID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[StepID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[StepName]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[StepDesc]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[StepProcID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[OnSuccessID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[OnFailureID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[IgnoreErr]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[RestartOnErr]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[StepOrder]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[Disabled]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[SeqGroup]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[PriGroup]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[Retry]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#s].[Delay]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_PersistContext].[#sa]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sa].[BatchID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sa].[StepID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sa].[AttributeName]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sa].[AttributeValue]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_PersistContext].[#sc]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sc].[BatchID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sc].[StepID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sc].[ConstID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sc].[ProcessID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sc].[ConstOrder]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sc].[WaitPeriod]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sc].[Disabled]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sc].[Ping]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_PersistContext].[#sca]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sca].[BatchID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sca].[StepID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sca].[ConstID]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sca].[AttributeName]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[prc_PersistContext].[#sca].[AttributeValue]">
									<Relationship Name="ExpressionDependencies">
										<Entry />
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_PersistContext].[@pContext]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_PersistContext].[@pHandle]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_PersistContext].[@pOptions]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="568" />
				<Property Name="Length" Value="23049" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;declare @Header xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pAttributes xml&#xD;&#xA;exec dbo.prc_CreateHeader @Header out,-20,null,null,4,15&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@Header&#xD;&#xA;--exec dbo.prc_CreateProcessRequest @pProcessRequest out,@Header,@pContext&#xD;&#xA;--select @pProcessRequest&#xD;&#xA;--exec dbo.prc_ReadContextAttributes @pProcessRequest,@pAttributes out&#xD;&#xA;--select @pAttributes&#xD;&#xA;select @pContext&#xD;&#xA;exec prc_PersistContext @pContext,'debug,replace'&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@Header&#xD;&#xA;select @pContext&#xD;&#xA;rollback tran&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE dbo.prc_PersistContext&#xD;&#xA;    @pContext xml([ETLController])&#xD;&#xA;   ,@pHandle uniqueidentifier = null &#xD;&#xA;   ,@pOptions nvarchar(100) = null&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_Print]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_Print.SQL
**
**D Desc:         Print or Send a processing Info message
**
**D Auth:         andreys
**D Date:         10/27/2007
**
** Param:
        @pProcessInfo       - message object
        @pConversation      - conversation handle to send the message
        @pConversationGrp   - conversation group handle
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @Now nvarchar(30)
DECLARE @msg nvarchar(max)
DECLARE @RunID int
DECLARE @BatchID int
DECLARE @StepID int
DECLARE @Options int
DECLARE @debug int
DECLARE @Header xml(ETLController)

SET @Err = 0
-------------------------------------------------------------------
--Return Statuses
--2 - Success
--3 - Failure
--4 - Error
-------------------------------------------------------------------
BEGIN TRY
-- DE should be provided with Master Srv and Dd which will not work with send
-- since conversation handle comes from Slave
-- disable send and rely on standard output for Master Print instead
-- and use send on Slave only. Slave node should not do table insert
set @pConversation = null;
IF (@pConversation IS NOT NULL)
BEGIN

   --RAISERROR ('not implemented',0,1) WITH NOWAIT
  ;SEND ON CONVERSATION @pConversation
   MESSAGE TYPE [ETLController_InfoMessage]
      (CAST(@pProcessInfo AS varbinary(max)));

END
ELSE
BEGIN
   exec dbo.[prc_ReadProcessInfo] @pProcessInfo,@Header out,@msg out,@Err out;
   exec dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out;

   SET @debug = ISNULL(@Options & 1,0);
   IF (isnull(@RunID,0) <> 0 OR @debug = 1)
   BEGIN
     --PRINT @msg;

     INSERT dbo.[ETLStepRunHistoryLog]
      (RunID,BatchID,StepID,LogDT,Err,LogMessage)
     VALUES(@RunID,isnull(@BatchID,0),isnull(@StepID,0),getdate(),isnull(@Err,0),@msg);
   END
     
   SET @Err = 0;
END

END TRY
BEGIN CATCH
    SET @Err = ERROR_NUMBER();
    SET @msg = ERROR_MESSAGE();
    RAISERROR('Error %d %s',11,11,@Err,@msg);
END CATCH

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print].[@pConversation]" />
				</Entry>
				<Entry>
					<References Name="[ETLController_InfoMessage]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print].[@pProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[LogDT]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[Err]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistoryLog].[LogMessage]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Print].[@pProcessInfo]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Print].[@pConversation]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_Print].[@pConversationGrp]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="279" />
				<Property Name="Length" Value="2825" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @m nvarchar(max)&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pProcessInfo xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,1,null,null,4,1&#xD;&#xA;select @pHeader&#xD;&#xA;exec dbo.prc_CreateProcessInfo @pProcessInfo out,@pHeader,'xxx'&#xD;&#xA;select @pProcessInfo&#xD;&#xA;exec dbo.prc_Print @pProcessInfo&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_Print]&#xD;&#xA;      @pProcessInfo xml([ETLController])&#xD;&#xA;     ,@pConversation uniqueidentifier = NULL&#xD;&#xA;     ,@pConversationGrp uniqueidentifier = NULL&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ProcessQueue]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ProcessQueue.SQL
**
**D Desc:         Process Queue record
**
**D Auth:         andreys
**D Date:         10/27/2007
**
** Param:
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
**  2010-03-28       andrey@biasintelligence.com           kill all threads on the same conversation on Cancel
**  2010-04-06       andrey@biasintelligence.com           try/catch to improve OnSuccess/OnFailure 
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ExitCode INT
DECLARE @StepErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @StatusID tinyint
DECLARE @StepStatusID tinyint
DECLARE @msg nvarchar(max)
DECLARE @RaiserrMsg nvarchar(max)
DECLARE @RetryCnt smallint

DECLARE @nSql nvarchar(max)

DECLARE @BatchID INT
DECLARE @StepID INT
DECLARE @RunID int
DECLARE @Options INT
DECLARE @debug TINYINT

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @ExitCode = 0
SET @Err = 0

DECLARE @OnStepSuccess nvarchar(max)
DECLARE @OnStepFailure nvarchar(max)
DECLARE @StepProcess nvarchar(max)
DECLARE @StepIgnore tinyint

DECLARE @STAT_AVAILABLE TINYINT
DECLARE @STAT_STARTED TINYINT
DECLARE @STAT_SUCCESS TINYINT
DECLARE @STAT_FAILURE TINYINT
DECLARE @STAT_ERROR TINYINT
DECLARE @STAT_WARNING TINYINT
DECLARE @STAT_FAILURE_IMMEDIATE TINYINT

SET @STAT_AVAILABLE = 0
SET @STAT_STARTED = 1
SET @STAT_SUCCESS = 2
SET @STAT_FAILURE = 3
SET @STAT_ERROR = 4
SET @STAT_WARNING = 5
SET @STAT_FAILURE_IMMEDIATE = 6
-------------------------------------------------------------------
--Step Statuses
--0 - Available
--1 - Started
--2 - Success
--3 - Failure
--4 - Error
--5 - Warning
--6 - Failure with abort.Used only in constraint procs to abort constraint check
-------------------------------------------------------------------
DECLARE @srcHandle AS UNIQUEIDENTIFIER
DECLARE @srcGrpHandle AS UNIQUEIDENTIFIER
DECLARE @Handle AS UNIQUEIDENTIFIER
DECLARE @GrpHandle AS UNIQUEIDENTIFIER
DECLARE @message AS NVARCHAR(MAX)
DECLARE @message_type AS NVARCHAR(256)
DECLARE @ProcessRequest AS xml (ETLController)
DECLARE @ProcessReceipt AS xml (ETLController)
DECLARE @ProcessInfo AS xml (ETLController)
DECLARE @Header AS xml (ETLController)
DECLARE @BatchHeader AS xml (ETLController)
DECLARE @Context AS xml (ETLController)
DECLARE @RetryDelay smallint
DECLARE @Wait nvarchar(30)
DECLARE @ErrXML xml
DECLARE @dialogtable sysname
DECLARE @spid int
DECLARE @timeout int

--if timer is not restarted by main thread test message request executed on @PING <= 120 sec intervals
--the conversation will be terminated by target thread
--this is done to terminate the remote processes on the main thread abort
set @timeout = 300; --sec 

begin try --external main block

--dummy header
EXEC @ExitCode = dbo.[prc_CreateHeader] @Header out,0,0,0,0,0

TryAgain:

SET @handle = null
;RECEIVE TOP (1) 
 @Handle = conversation_handle
,@message = cast(message_body as nvarchar(max))
,@message_type = message_type_name
FROM [ETLController_Request_Queue]

IF (@handle IS NULL)
BEGIN
  RETURN @Err
END


--check the queue for TEST messages before cancelling on DialogTimer
--Broker may not spawn threads on user messages when sql server is too busy
IF (@message_type = 'http://schemas.microsoft.com/SQL/ServiceBroker/DialogTimer')
BEGIN
  select @message = cast(message_body as nvarchar(max))
    from [ETLController_Request_Queue]
   where conversation_handle = @Handle
     and message_type_name = 'ETLController_Test';
       
  if (@message is not null)
  begin
     IF (@debug = 1)
     BEGIN
         SET @msg = 'WARNING: Found ETLController_Test message in the queue on DialogTimer'
         --cant send this print to the log
         PRINT @msg
      END
      SET @message_type = 'ETLController_Test'
  end
END


set @dialogtable = 'dbo.' + quotename('dialog_' + cast(@Handle as nvarchar(36)));
IF (@message_type in ('http://schemas.microsoft.com/SQL/ServiceBroker/EndDialog' --end conversation request
                     ,'http://schemas.microsoft.com/SQL/ServiceBroker/Error' --error
                     ,'ETLController_Cancel' -- cancel request
                     ,'http://schemas.microsoft.com/SQL/ServiceBroker/DialogTimer')) --on timeout
BEGIN


   if (OBJECT_ID(@dialogtable,'u') is not null)
   begin
   --kill all active sessions on this conversation
   --except itself
      set @nSql = '
   declare @nsql nvarchar(4000);
      set @nsql = '''';
   select @nsql = @nsql + ''kill '' + cast(t.spid as nvarchar(30)) + '';''
     from ' + @dialogtable + ' t
     join sys.dm_broker_activated_tasks s
       on t.spid = s.spid
      and t.queue_id = s.queue_id 
    where t.spid <> @@spid;
   if (len(@nsql) > 0)               
      exec (@nsql);
   drop table ' + @dialogtable + ';
   '
      exec sp_executesql @nSql;
   end
    
   END CONVERSATION @Handle
   SET @Handle = null
   RETURN @Err
END


IF isnull(@message_type,'Unknown') not in ('ETLController_Request','ETLController_Test')
BEGIN
   SET @msg = '   WARNING: Message Type: [' + @message_type + '] is received. The message is discarded.'
   --cant send this print to the log
   PRINT @msg

   RETURN @Err
   --GOTO TryAgain
END

-- create dialogtable for a new conversation
-- this table will hold all active session_ids for this conversation
exec ('
if object_id(''' + @dialogtable + ''',''u'') is null
  create table ' + @dialogtable + '
  (spid int primary key,queue_id int,start_time datetime,runid int)
')

begin try --internal main

SET @ProcessRequest = @message
exec @ExitCode = dbo.[prc_ReadProcessRequest] @ProcessRequest,@Header out,@Context out,@srcHandle out,@srcGrpHandle out
exec @ExitCode = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out

SET @debug = isnull(@Options & 1,0)
SET @StatusID = @STAT_SUCCESS

EXEC @ExitCode = dbo.[prc_CreateHeader] @BatchHeader out,@BatchID,null,null,@RunID,@Options,1--batch

IF @message_type = 'ETLController_Request'
BEGIN

   SET @msg =  'BEGIN Procedure ' + @ProcName + ' with message type ' + @message_type
                     + ' BatchID=' + CAST(@BatchID as nvarchar(30))
                     + ' StepID=' + isnull(CAST(@StepID as nvarchar(30)),0)
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle

-------------------------------------------------------------------
--register with @dialogtable
-------------------------------------------------------------------
   set @nSql = '
insert ' + @dialogtable + '
  (spid,queue_id,start_time,runid)
select spid,queue_id,getdate(),@RunID
  from sys.dm_broker_activated_tasks
 where spid = @@spid;
'
   exec sp_executesql @nsql,N'@RunID int',@RunID = @RunID;

   IF (@debug = 1)
   BEGIN
      SET @msg = '   session_id=' + CAST(@@spid AS nvarchar(30))
               + ' added to ' + @dialogtable + ' table'
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
   END

   exec @ExitCode = dbo.[prc_CreateProcessRequest] @ProcessRequest out,@Header,@Context,@handle
-------------------------------------------------------------------
--Check Step Constraints
-------------------------------------------------------------------
begin try --constraints
   SET @ProcessReceipt = NULL
   EXEC @ExitCode = dbo.[prc_ConstraintCheck] @ProcessRequest,@ProcessReceipt out
   EXEC @ExitCode = dbo.[prc_ReadProcessReceipt] @ProcessReceipt,null,@StatusID out,@Err out,@msg out

   SET @StatusID = ISNULL(@StatusID,@STAT_ERROR)
   IF (@debug = 1)
   BEGIN
      SET @msg = '   prc_ConstraintCheck returns StatusID=' + CAST(@StatusID AS nvarchar(30))
               + ' with msg:' + isnull(@msg,'null')
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
   END


   SET @msg = null
   IF (@StatusID = @STAT_FAILURE_IMMEDIATE)
   BEGIN
      SET @RaiserrMsg = '   ERROR receive abort from Step Constraints check'
      RAISERROR(@RaiserrMsg,11,11)
   END
   ELSE IF (@StatusID = @STAT_FAILURE)
   BEGIN
      SET @msg = '   ERROR Step Constraints were not met'
   END
   ELSE IF (@Err <> 0 OR @StatusID = @STAT_ERROR)
   BEGIN
      SET @msg = '   ERROR checking Step Constraints'
   END

   IF (@msg IS NOT NULL)
   BEGIN
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
   END

end try --constraints
begin catch
   set @RaiserrMsg = ERROR_MESSAGE()
   raiserror (@RaiserrMsg,11,11)
end catch

   --ELSE --IF (@StatusID = @STAT_SUCCESS)
   --BEGIN
-------------------------------------------------------------------
--Process Step
-------------------------------------------------------------------
      ;with xmlnamespaces('ETLController.XSD' as etl)
      select
             @OnStepSuccess = 'exec @ExitCode = ' + cs.s.value('(./etl:OnSuccess/etl:Process)[1]','nvarchar(max)') + ' @pRequest=@Request,@pReceipt=@Receipt out' 
                            + isnull(',' + cs.s.value('(./etl:OnSuccess/etl:Param)[1]','nvarchar(max)'),'')
            ,@OnStepFailure = 'exec @ExitCode = ' + cs.s.value('(./etl:OnFailure/etl:Process)[1]','nvarchar(max)') + ' @pRequest=@Request,@pReceipt=@Receipt out' 
                            + isnull(',' + cs.s.value('(./etl:OnFailure/etl:Param)[1]','nvarchar(max)'),'')
            ,@StepProcess = 'exec @ExitCode = ' + cs.s.value('(./etl:Process/etl:Process)[1]','nvarchar(max)') + ' @pRequest=@Request,@pReceipt=@Receipt out' 
                            + isnull(',' + cs.s.value('(./etl:Process/etl:Param)[1]','nvarchar(max)'),'')
            ,@StepIgnore  = coalesce(cs.s.value('(./@IgnoreErr)[1]','tinyint'),cb.b.value('(./@IgnoreErr)[1]','tinyint'),0)
            ,@RetryCnt = coalesce(cs.s.value('(./@Retry)[1]','smallint'),cb.b.value('(./@Retry)[1]','smallint'),0)
            ,@RetryDelay = coalesce(cs.s.value('(./@Delay)[1]','smallint'),cb.b.value('(./@Delay)[1]','smallint'),60) --sec
        from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
        cross apply cb.b.nodes('./etl:Steps/etl:Step[@StepID=(sql:variable("@StepID"))]') cs(s)


      IF (@debug = 1)
      BEGIN
         SET @msg = '   Retrieve Step Parameters'
         exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
         exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
      END


      SET @Wait = right('00' + cast(@RetryDelay/3600 as varchar(10)),3)
                + ':' + right('0' + cast((@RetryDelay/60)%60 as varchar(10)),2)
                + ':' + right('0' + cast(@RetryDelay%60 as varchar(10)),2)


      IF (@StepProcess IS NULL)
      BEGIN
         SET @StatusID = @STAT_ERROR
         SET @Err = 50120
         SET @RaiserrMsg = '   ERROR Step Process is not found'
         RAISERROR (@RaiserrMsg,11,11)
      END
      ELSE IF (@StatusID IN (@STAT_SUCCESS,@STAT_WARNING))
      BEGIN

begin try --process step

         IF (@debug = 1)
         BEGIN
            SET @msg = '   Step Process: ' + @StepProcess
            exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
            exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
         END

         WHILE (1 = 1)
         BEGIN
            SET @ProcessReceipt = NULL
            EXEC sp_ExecuteSQL @StepProcess
                  ,N'@ExitCode int output,@Request xml,@Receipt xml output'
                  ,@ExitCode = @ExitCode output
                  ,@Request = @ProcessRequest
                  ,@Receipt = @ProcessReceipt output
      
            EXEC @ExitCode = dbo.[prc_ReadProcessReceipt] @ProcessReceipt,null,@StatusID out,@Err out,@msg out
            SET @StatusID = ISNULL(@StatusID,@STAT_ERROR)

            --need to make sure the conversation is still active before executing onSuccess
            --just trying to send a message would do
            --IF (@debug = 1)
            --BEGIN 
               SET @msg = '   Retry(' + CAST(@RetryCnt AS nvarchar(30))
                        + ' with delay ' + CAST(@RetryDelay AS nvarchar(30)) +' sec)'
                        + ' Step process returns StatusID=' + CAST(@StatusID AS nvarchar(30))
                        + ' with msg: ' + isnull(@msg,'null')
               exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
               exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
            --END
            IF (@StatusID IN (@STAT_SUCCESS,@STAT_WARNING,@STAT_FAILURE_IMMEDIATE) OR @RetryCnt = 0 )
               BREAK

            WAITFOR DELAY @wait 
            IF (@RetryCnt <= -32000)
               SET @RetryCnt = 0

            SET @RetryCnt = @RetryCnt - 1
         END
      --END

end try
begin catch
   set @StatusID = @STAT_ERROR;
   set @Err = case @Err when 0 then ERROR_NUMBER() else @Err end;
end catch
-------------------------------------------------------------------
--OnSuccess or OnFailure
-------------------------------------------------------------------
      SET @StepStatusID = @StatusID
      SET @StepErr = @Err
      SET @nSql = NULL
      IF (@StatusID IN (@STAT_SUCCESS,@STAT_WARNING))
      BEGIN
         SET @nSql = @OnStepSuccess
         IF (@debug = 1)
         BEGIN
            SET @msg = '   OnStepSuccess: ' +ISNULL(@OnStepSuccess,'NULL')
            exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
            exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
         END
      END
      ELSE IF (@StatusID IN (@STAT_FAILURE,@STAT_ERROR))
      BEGIN
         SET @nSql = @OnStepFailure
         IF (@debug = 1)
         BEGIN
            SET @msg = '   OnStepFailure: ' +ISNULL(@OnStepFailure,'NULL')
            exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
            exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
         END
      END

      IF (@nSql IS NOT NULL)
      BEGIN
         SET @ProcessReceipt = NULL
         EXEC sp_ExecuteSQL @nSql
                  ,N'@ExitCode int output,@Request xml,@Receipt xml output'
                  ,@ExitCode = @ExitCode output
                  ,@Request = @ProcessRequest
                  ,@Receipt = @ProcessReceipt output
      
         EXEC @ExitCode = dbo.[prc_ReadProcessReceipt] @ProcessReceipt,null,@StatusID out,@Err out,@msg out

         SET @StatusID = ISNULL(@StatusID,@STAT_ERROR)

         IF (@debug = 1)
         BEGIN
            SET @msg = '  OnSuccess/OnFailure Completed with StatusID=' + CAST(@StatusID AS nvarchar(100))
                        + ' with msg: ' + isnull(@msg,'null')
            exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
            exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
         END
         IF (@Err <> 0 OR @StatusID = @STAT_ERROR)
         BEGIN
            SET @msg = '   ERROR failed to execute OnSuccess/OnFailure code'
            exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
            exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
        END


         IF(@StatusID IN (@STAT_SUCCESS,@STAT_WARNING))
         BEGIN
            SET @StatusID = @StepStatusID
            SET @Err = @StepErr
         END

      END
   END
-------------------------------------------------------------------
--Finish the step
-------------------------------------------------------------------

--remove current spid from @dialogtable
   set @nSql = 'delete ' + @dialogtable + ' where spid = @@spid;'
   exec sp_executesql @nSql,N'@RunID int',@RunID = @RunID

   IF (@debug = 1)
   BEGIN
      SET @msg = '   StepID=' + CAST(@StepID AS nvarchar(30)) + ' completed with StatusID=' + CAST(@StatusID AS nvarchar(30))
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
   END

END
ELSE IF @message_type = 'ETLController_Test'
BEGIN
   if (@debug = 1)
   begin
      SET @msg =  'BEGIN Procedure ' + @ProcName + ' with message type ' + @message_type
                     + ' BatchID=' + CAST(@BatchID as nvarchar(30))
                     + ' SvcID=' + isnull(CAST(@StepID as nvarchar(30)),0)
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
   end
   --restart the timer
   BEGIN CONVERSATION TIMER (@handle) TIMEOUT = @timeout ;
END
ELSE
BEGIN
   IF (@debug = 1)
   BEGIN
      SET @msg = '   Message Type: [' + @message_type + '] ' + @message
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
   END
END
end try --internal main
BEGIN CATCH
SET @Err = case @Err when 0 then ERROR_NUMBER() else @Err end;
SET @RaiserrMsg = isnull(@RaiserrMsg,ERROR_MESSAGE())
SET @StatusID = isnull(nullif(@StatusID,@STAT_SUCCESS),@STAT_ERROR)
IF (@RaiserrMsg IS NOT NULL)
BEGIN
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@RaiserrMsg,@Err
   exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle
END
END CATCH

exec @ExitCode = dbo.prc_CreateProcessReceipt @ProcessReceipt out,@Header,@StatusID,@Err,@RaiserrMsg


IF (@message_type = 'ETLController_Request')
begin
   SET @msg =  'END Procedure ' + @ProcName + ' for message type ' + @message_type
                     + ' BatchID=' + isnull(CAST(@BatchID as nvarchar(30)),'null')
                     + ' StepID=' + isnull(CAST(@StepID as nvarchar(30)),'null')
   exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg,@Err
   exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle;

    SEND ON CONVERSATION @handle
    MESSAGE TYPE [ETLController_Receipt]
   (CAST(@ProcessReceipt AS varbinary(MAX)));
end
ELSE IF (@message_type = 'ETLController_Test')
begin
   if (@debug = 1)
   begin
      SET @msg =  'END Procedure ' + @ProcName + ' for message type ' + @message_type
                     + ' BatchID=' + isnull(CAST(@BatchID as nvarchar(30)),'null')
                     + ' SvcID=' + isnull(CAST(@StepID as nvarchar(30)),'null')
      exec @ExitCode = dbo.prc_CreateProcessInfo @ProcessInfo out,@BatchHeader,@msg,@Err
      exec @ExitCode = dbo.[prc_Print] @ProcessInfo,@handle;
   end;
   
    SEND ON CONVERSATION @handle
    MESSAGE TYPE [ETLController_Test]
   (CAST(@ProcessReceipt AS varbinary(MAX)))

end
end try --main block
begin catch
   SET @Err = case @Err when 0 then ERROR_NUMBER() else @Err end;
   SET @RaiserrMsg = ERROR_MESSAGE()
   raiserror ('%d, %s',11,17,@Err,@RaiserrMsg);
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController_Request_Queue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController_Request_Queue].[message_body]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController_Request_Queue].[conversation_handle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController_Request_Queue].[message_type_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ConstraintCheck]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessReceipt]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[ETLController_Receipt]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[ETLController_Test]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varbinary]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="456" />
				<Property Name="Length" Value="19909" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @BatchID int&#xD;&#xA;set @BatchID = -20&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,@BatchID,1,2,4,1&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;select @pProcessRequest&#xD;&#xA;exec dbo.prc_ConstraintCheck @pProcessRequest,@pProcessReceipt out&#xD;&#xA;select @pProcessReceipt&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ProcessQueue]&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ReadAttribute]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ReadAttribute.SQL
**
**D Desc:         read Attribute
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try
  set @pValue = @pAttributes.value('declare namespace etl="ETLController.XSD";
   (/etl:Attributes/etl:Attribute[@Name=(sql:variable("@pName"))])[1]','nvarchar(max)')
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pValue = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadAttribute].[@pValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadAttribute].[@pAttributes]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadAttribute].[@pAttributes]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadAttribute].[@pName]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadAttribute].[@pValue]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="508" />
				<Property Name="Length" Value="1715" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @value nvarchar(max)&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pAttributes xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,101,1,1,4,1&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;--select @pProcessRequest&#xD;&#xA;exec dbo.prc_ReadContextAttributes @pProcessRequest,@pAttributes out&#xD;&#xA;select @pAttributes&#xD;&#xA;exec dbo.prc_ReadAttribute @pAttributes,'SQL',@value out&#xD;&#xA;select @value&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ReadAttribute]&#xD;&#xA;    @pAttributes xml([ETLController])&#xD;&#xA;   ,@pName nvarchar(100) = null output&#xD;&#xA;   ,@pValue nvarchar(max) = null output&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ReadContextAttributes]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ReadContextAttributes.SQL
**
**D Desc:         create Attributes object for a Context
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
**  05/21/2008       andreys            add etl namespace to system attributes
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

DECLARE @BatchID int
DECLARE @StepID int
DECLARE @ConstID int
DECLARE @RunID int
DECLARE @Options int
DECLARE @debug tinyint
DECLARE @Handle uniqueidentifier

declare @Name nvarchar(100)
declare @Value1 nvarchar(max)
declare @Value2 nvarchar(max)
declare @nValue nvarchar(max)
declare @id int

DECLARE @Header xml(ETLController)
DECLARE @Context xml(ETLController)
DECLARE @ProcessInfo xml(ETLController)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

declare @attr table(id int identity(1,1),AttributeName nvarchar(100),AttributeValue nvarchar(max) null,CompleteFlag tinyint null)
declare @ab table (aid int,bid int,isexec tinyint)

begin try
exec @ProcErr = dbo.[prc_ReadProcessRequest] @pProcessRequest,@Header out,@Context out,@Handle out
exec @ProcErr = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,@ConstID out,@RunID out,@Options out

set @debug = nullif(@Options & 1,0)
IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'BEGIN Procedure ' + @ProcName
                           + ' with @BatchID=' + CAST(@BatchID AS nvarchar(30))
                           + ISNULL( ', @StepID=' +CAST(@StepID AS nvarchar(30)),'')
                           + ISNULL( ', @ConstID=' +CAST(@ConstID AS nvarchar(30)),'')

   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END

if (@ConstID is not null and @StepID is null)
begin
   ;with xmlnamespaces('ETLController.XSD' as etl)
   insert @attr (AttributeName,AttributeValue)
   select cba.ba.value('@Name[1]','nvarchar(100)'),cba.ba.value('(.)[1]','nvarchar(max)')
     from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]
/etl:Constraints/etl:Constraint[@ConstID=(sql:variable("@ConstID"))]/etl:Attributes') cb(b)
   cross apply cb.b.nodes('./etl:Attribute') cba(ba)

--system batch constraint attributes
   ;with xmlnamespaces('ETLController.XSD' as etl)
   insert @attr (AttributeName,AttributeValue)
   select cba.ba.value('concat("etl:",local-name(.))','nvarchar(100)'),cba.ba.value('string(.)','nvarchar(max)')
     from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]
/etl:Constraints/etl:Constraint[@ConstID=(sql:variable("@ConstID"))]') cb(b)
   cross apply cb.b.nodes('./@*') cba(ba)
   left join @attr a on a.AttributeName = cba.ba.value('concat("etl:",local-name(.))','nvarchar(100)')
   where a.AttributeName is null

end
else if (@ConstID is not null)
begin
   ;with xmlnamespaces('ETLController.XSD' as etl)
   insert @attr (AttributeName,AttributeValue)
   select cba.ba.value('@Name[1]','nvarchar(100)'),cba.ba.value('(.)[1]','nvarchar(max)')
     from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]
/etl:Steps/etl:Step[@StepID=(sql:variable("@StepID"))]
/etl:Constraints/etl:Constraint[@ConstID=(sql:variable("@ConstID"))]/etl:Attributes') cb(b)
   cross apply cb.b.nodes('./etl:Attribute') cba(ba)

--system step constraint attributes
   ;with xmlnamespaces('ETLController.XSD' as etl)
   insert @attr (AttributeName,AttributeValue)
   select cba.ba.value('concat("etl:",local-name(.))','nvarchar(100)'),cba.ba.value('string(.)','nvarchar(max)')
     from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]
/etl:Steps/etl:Step[@StepID=(sql:variable("@StepID"))]
/etl:Constraints/etl:Constraint[@ConstID=(sql:variable("@ConstID"))]') cb(b)
   cross apply cb.b.nodes('./@*') cba(ba)
   left join @attr a on a.AttributeName = cba.ba.value('concat("etl:",local-name(.))','nvarchar(100)')
   where a.AttributeName is null
end

if(@StepID is not null)
begin
   ;with xmlnamespaces('ETLController.XSD' as etl)
   insert @attr (AttributeName,AttributeValue)
   select cba.ba.value('@Name[1]','nvarchar(100)'),cba.ba.value('(.)[1]','nvarchar(max)')
     from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]
/etl:Steps/etl:Step[@StepID=(sql:variable("@StepID"))]/etl:Attributes') cb(b)
   cross apply cb.b.nodes('./etl:Attribute') cba(ba)
   left join @attr a on a.AttributeName = cba.ba.value('@Name[1]','nvarchar(100)')
   where a.AttributeName is null

--system step attributes
   ;with xmlnamespaces('ETLController.XSD' as etl)
   insert @attr (AttributeName,AttributeValue)
   select cba.ba.value('concat("etl:",local-name(.))','nvarchar(100)'),cba.ba.value('string(.)','nvarchar(max)')
     from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]
/etl:Steps/etl:Step[@StepID=(sql:variable("@StepID"))]') cb(b)
   cross apply cb.b.nodes('./@*') cba(ba)
   left join @attr a on a.AttributeName = cba.ba.value('concat("etl:",local-name(.))','nvarchar(100)')
   where a.AttributeName is null

end

;with xmlnamespaces('ETLController.XSD' as etl)
insert @attr (AttributeName,AttributeValue)
select cba.ba.value('@Name[1]','nvarchar(100)'),cba.ba.value('(.)[1]','nvarchar(max)')
  from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]/etl:Attributes') cb(b)
cross apply cb.b.nodes('./etl:Attribute') cba(ba)
left join @attr a on a.AttributeName = cba.ba.value('@Name[1]','nvarchar(100)')
 where a.AttributeName is null

--system batch attributes
;with xmlnamespaces('ETLController.XSD' as etl)
insert @attr (AttributeName,AttributeValue)
select cba.ba.value('concat("etl:",local-name(.))','nvarchar(100)'),cba.ba.value('string(.)','nvarchar(max)')
  from @Context.nodes('/etl:Context[@BatchID=(sql:variable("@BatchID"))]') cb(b)
cross apply cb.b.nodes('./@*') cba(ba)
left join @attr a on a.AttributeName = cba.ba.value('concat("etl:",local-name(.))','nvarchar(100)')
where a.AttributeName is null

declare @inputoptions nvarchar(1000)
set @inputoptions = case when @options & 1 = 1 then 'debug' else '' end
+ case when @options & 2 = 2 then ',forcestart' else '' end

--legacy system attributes
insert @attr (AttributeName,AttributeValue)
select '@BatchID',cast(@BatchID as nvarchar(100))
union select '@StepID',cast(@StepID as nvarchar(100))
union select '@ConstID',cast(@ConstID as nvarchar(100))
union select '@RunID',cast(@RunID as nvarchar(100))
union select '@Options',cast(@inputoptions as nvarchar(100))
union select '@Handle',cast(@handle as nvarchar(100))
union select 'etl:RunID',cast(@RunID as nvarchar(100))


-------------------------------------------------------------------
--relationship table
-------------------------------------------------------------------
insert @ab
select a.id,b.id,0
  from @attr a
  join @attr b on charindex('<' + a.AttributeName + '>',b.AttributeValue) > 0
union all select a.id,b.id,1
  from @attr a
  join @attr b on charindex('<' + a.AttributeName + '*>',b.AttributeValue) > 0

-------------------------------------------------------------------
--replace dynamic parameters if any
-------------------------------------------------------------------
WHILE (1=1)
BEGIN
    SET @id = null
    SELECT top(1) @id = t.id
                 ,@Name = t.AttributeName
                 ,@Value1 = t.AttributeValue
      FROM @attr t
      WHERE t.CompleteFlag IS NULL
        AND NOT EXISTS(SELECT 1 FROM @ab t1
                         JOIN @attr t2 ON t1.aid = t2.id WHERE  t.id = t1.bid AND t2.CompleteFlag IS NULL) --no parents
        AND EXISTS(SELECT 1 FROM @ab t2 WHERE  t.id = t2.aid) --have children
      order by t.id

    IF (@id is null)
       BREAK


    update a set a.AttributeValue = REPLACE(a.AttributeValue,'<' + @Name + '>',isnull(@Value1,''))
      from @attr a
      join @ab ab on a.id = ab.bid and ab.aid = @id and ab.isexec = 0


   --execute value to get the value
   IF (@Value1 is not null
       AND EXISTS(SELECT 1 FROM @ab ab WHERE ab.aid = @id and ab.isexec = 1))
   BEGIN
      SET @nValue = 'select top 1 @value = (' + @Value1 + ')'

	  IF (@debug IS NOT NULL)
	  BEGIN
		  SET @msg = 'Evaluate attribute: ' + @Name + ' = ' + @Value1
		  exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
		  exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
	  END

      SET @Value2 = null
      EXEC sp_executesql @nValue,N'@value varchar(max) output',@value = @value2 out

      update a set a.AttributeValue = REPLACE(a.AttributeValue,'<' + @Name + '*>',isnull(@Value2,''))
        from @attr a
        join @ab ab on a.id = ab.bid and ab.aid = @id and ab.isexec = 1
   END


   update @attr set CompleteFlag = 1 where id = @id
END


;with xmlnamespaces('ETLController.XSD' as etl)
select @pAttributes = 
 (select a.AttributeName as '@Name',a.AttributeValue as '*' from @attr a
     for xml path('etl:Attribute'),root('etl:Attributes'),type)

if @pAttributes is null
   set @pAttributes = '<etl:Attributes xmlns:etl="ETLController.XSD" />'

IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END

end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pAttributes = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@pProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeValue]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeName]" />
				</Entry>
				<Entry />
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[CompleteFlag]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@ab].[aid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@ab].[bid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[CompleteFlag]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@ab].[aid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@ab].[bid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@ab].[aid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@ab].[isexec]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@ab].[aid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@ab].[isexec]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[sp_executesql]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[CompleteFlag]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@pAttributes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeValue]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_ReadContextAttributes].[@attr]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ReadContextAttributes].[@attr].[id]">
									<Property Name="IsNullable" Value="False" />
									<Property Name="IsIdentity" Value="True" />
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeName]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="100" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ReadContextAttributes].[@attr].[AttributeValue]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="IsMax" Value="True" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ReadContextAttributes].[@attr].[CompleteFlag]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[prc_ReadContextAttributes].[@ab]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ReadContextAttributes].[@ab].[aid]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ReadContextAttributes].[@ab].[bid]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[prc_ReadContextAttributes].[@ab].[isexec]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadContextAttributes].[@pProcessRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadContextAttributes].[@pAttributes]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="425" />
				<Property Name="Length" Value="10517" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pAttributes xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,301,2,null,4,15&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;select @pcontext&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;select @pProcessRequest&#xD;&#xA;exec dbo.prc_ReadContextAttributes @pProcessRequest,@pAttributes out&#xD;&#xA;select @pAttributes&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ReadContextAttributes]&#xD;&#xA;    @pProcessRequest xml([ETLController])&#xD;&#xA;   ,@pAttributes xml([ETLController]) = null output&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ReadCounter]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ReadCounter.SQL
**
**D Desc:         read Counter
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try
  ;with xmlnamespaces('ETLController.XSD' as etl)
  select @pValue = c.a.value('(.)[1]','nvarchar(max)')
        ,@pRunID = c.a.value('(./@RunID)[1]','int')
  from @pCounters.nodes('/etl:Counters/etl:Counter[@Name=(sql:variable("@pName"))]') c(a)
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pValue = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadCounter].[@pCounters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadCounter].[@pValue]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ReadCounter].[@pRunID]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadCounter].[@pCounters]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadCounter].[@pName]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadCounter].[@pValue]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadCounter].[@pRunID]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="314" />
				<Property Name="Length" Value="1626" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @value nvarchar(max)&#xD;&#xA;declare @RunID int&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pCounters xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,1,1,1,4,1&#xD;&#xA;exec dbo.prc_CreateCounters @pCounters out,@pHeader&#xD;&#xA;select @pCounters&#xD;&#xA;exec dbo.prc_ReadCounter @pCounters,'test',@value out,@RunID out&#xD;&#xA;select @value,@RunID&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ReadCounter]&#xD;&#xA;    @pCounters xml([ETLController])&#xD;&#xA;   ,@pName nvarchar(100) = null output&#xD;&#xA;   ,@pValue nvarchar(max) = null output&#xD;&#xA;   ,@pRunID int = null output&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ReadHeader]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ReadHeader.SQL
**
**D Desc:         read Header object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try

;with xmlnamespaces('ETLController.XSD' as etl)
select @pBatchID = h.d.value('(./@BatchID)[1]','int')
      ,@pStepID = h.d.value('(./@StepID)[1]','int')
      ,@pConstID = h.d.value('(./@ConstID)[1]','int')
      ,@pRunID = h.d.value('(./@RunID)[1]','int')
      ,@pOptions = h.d.value('(./@Options)[1]','int')
      ,@pScope = h.d.value('(./@Scope)[1]','int')
  from @pHeader.nodes('(/etl:Header)') h(d)

end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader].[@pBatchID]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ReadHeader].[@pStepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader].[@pConstID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader].[@pRunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader].[@pOptions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader].[@pScope]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadHeader].[@pHeader]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadHeader].[@pBatchID]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadHeader].[@pStepID]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadHeader].[@pConstID]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadHeader].[@pRunID]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadHeader].[@pOptions]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadHeader].[@pScope]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="259" />
				<Property Name="Length" Value="1822" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @b int,@s int,@c int,@o int,@r int,@sc int&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,1,2,null,4,10,5&#xD;&#xA;select @pHeader&#xD;&#xA;exec dbo.prc_ReadHeader @pHeader,@b out,@s out,@c out,@r out,@o out,@sc out&#xD;&#xA;select @b,@s,@c,@r,@o,@sc&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ReadHeader]&#xD;&#xA;    @pHeader xml([ETLController])&#xD;&#xA;   ,@pBatchID int = null output&#xD;&#xA;   ,@pStepID int = null output&#xD;&#xA;   ,@pConstID int = null output&#xD;&#xA;   ,@pRunID int = null output&#xD;&#xA;   ,@pOptions int = null output&#xD;&#xA;   ,@pScope int = null output&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ReadProcessInfo]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ReadProcessInfo.SQL
**
**D Desc:         read Info object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try
SELECT @pHeader = @pProcessInfo.query('declare namespace etl="ETLController.XSD";(/etl:ProcessInfo/etl:Header)[1]')
 ;WITH XMLNAMESPACES ('ETLController.XSD' as etl)
SELECT @pMsg = p.m.value('string(.)[1]','nvarchar(max)')
      ,@pErr = p.m.value('(./@Error)[1]','nvarchar(max)')
  FROM @pProcessInfo.nodes('/etl:ProcessInfo/etl:Message') as p(m)
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessInfo].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessInfo].[@pProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessInfo].[@pMsg]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[dbo].[prc_ReadProcessInfo].[@pErr]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessInfo].[@pProcessInfo]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessInfo].[@pHeader]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessInfo].[@pMsg]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessInfo].[@pErr]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="390" />
				<Property Name="Length" Value="1825" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @m nvarchar(max)&#xD;&#xA;declare @e int&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pHeader1 xml&#xD;&#xA;declare @pProcessInfo xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,1,null,null,4,10&#xD;&#xA;select @pHeader&#xD;&#xA;exec dbo.prc_CreateProcessInfo @pProcessInfo out,@pHeader,'xxx',10&#xD;&#xA;select @pProcessInfo&#xD;&#xA;exec dbo.prc_ReadProcessInfo @pProcessInfo,@pHeader1 out,@m out,@e out&#xD;&#xA;select @e,@m&#xD;&#xA;select @pHeader1&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ReadProcessInfo]&#xD;&#xA;    @pProcessInfo xml([ETLController])&#xD;&#xA;   ,@pHeader xml([ETLController]) = null output&#xD;&#xA;   ,@pMsg nvarchar(max) = null output&#xD;&#xA;   ,@pErr int = null output&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ReadProcessReceipt]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ReadProcessReceipt.SQL
**
**D Desc:         read Receipt object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try
SELECT @pHeader = @pProcessReceipt.query('declare namespace etl="ETLController.XSD";(/etl:ProcessReceipt/etl:Header)[1]')
SET @pStatusID = @pProcessReceipt.value('declare namespace etl="ETLController.XSD";(/etl:ProcessReceipt/etl:Status/@StatusID)[1]','int')
SET @pErr = @pProcessReceipt.value('declare namespace etl="ETLController.XSD";(/etl:ProcessReceipt/etl:Status/@Error)[1]','int')
SET @pErrMsg = @pProcessReceipt.value('declare namespace etl="ETLController.XSD";(/etl:ProcessReceipt/etl:Status/etl:msg)[1]','nvarchar(max)')
end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessReceipt].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessReceipt].[@pProcessReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessReceipt].[@pStatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessReceipt].[@pErr]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessReceipt].[@pErrMsg]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessReceipt].[@pProcessReceipt]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessReceipt].[@pHeader]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessReceipt].[@pStatusID]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessReceipt].[@pErr]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessReceipt].[@pErrMsg]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="420" />
				<Property Name="Length" Value="2086" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @s int,@e int,@m nvarchar(max)&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pHeader1 xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,1,null,null,4,10&#xD;&#xA;select @pHeader&#xD;&#xA;exec dbo.prc_CreateProcessReceipt @pProcessReceipt out,@pHeader,2,5000,'xxx'&#xD;&#xA;select @pProcessReceipt&#xD;&#xA;exec dbo.prc_ReadProcessReceipt @pProcessReceipt,@pHeader1 out,@s out,@e out,@m out&#xD;&#xA;select @s,@e,@m&#xD;&#xA;select @pHeader1&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ReadProcessReceipt]&#xD;&#xA;    @pProcessReceipt xml([ETLController])&#xD;&#xA;   ,@pHeader xml([ETLController]) = null output&#xD;&#xA;   ,@pStatusID int = null output&#xD;&#xA;   ,@pErr int = null output&#xD;&#xA;   ,@pErrMsg nvarchar(max) = null output&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_ReadProcessRequest]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_ReadProcessRequest.SQL
**
**D Desc:         read Request object
**
**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)
declare @nHandle nvarchar(36)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

begin try
SELECT @pHeader = @pProcessRequest.query('declare namespace etl="ETLController.XSD";(/etl:ProcessRequest/etl:Header)[1]')
SELECT @pContext = @pProcessRequest.query('declare namespace etl="ETLController.XSD";(/etl:ProcessRequest/etl:Context)[1]')
SET @nHandle = @pProcessRequest.value('declare namespace etl="ETLController.XSD";(/etl:ProcessRequest/etl:SrcConversation)[1]','nvarchar(36)')
if len(@nHandle) = 36
   set @pConversation = cast(@nHandle as uniqueidentifier)
SET @nHandle = @pProcessRequest.value('declare namespace etl="ETLController.XSD";(/etl:ProcessRequest/etl:SrcConversationGrp)[1]','nvarchar(36)')
if len(@nHandle) = 36
   set @pConversationGrp = cast(@nHandle as uniqueidentifier)

end try
begin catch
   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   set @pHeader = null
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest].[@pHeader]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest].[@pProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest].[@pContext]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest].[@pConversation]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest].[@pConversationGrp]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessRequest].[@pProcessRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessRequest].[@pHeader]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessRequest].[@pContext]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessRequest].[@pConversation]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_ReadProcessRequest].[@pConversationGrp]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="517" />
				<Property Name="Length" Value="2439" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;declare @uid uniqueidentifier&#xD;&#xA;declare @uid1 uniqueidentifier&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;set @uid = newid()&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-10,null,null,4,10&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext,@uid&#xD;&#xA;select @pProcessRequest&#xD;&#xA;exec dbo.prc_ReadProcessRequest @pProcessRequest,@pHeader out,@pContext out,@uid1 out&#xD;&#xA;select @pHeader&#xD;&#xA;select @pContext&#xD;&#xA;select @uid1&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_ReadProcessRequest]&#xD;&#xA;    @pProcessRequest xml([ETLController])&#xD;&#xA;   ,@pHeader xml([ETLController]) = null output&#xD;&#xA;   ,@pContext xml([ETLController]) = null output&#xD;&#xA;   ,@pConversation uniqueidentifier = null output&#xD;&#xA;   ,@pConversationGrp uniqueidentifier = null output&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_RemoveContext]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_PersistContext.SQL
**
**D Desc:         create persist context into ETLBatch tables
**
** @Options       debug

**D Auth:         andreys
**D Date:         10/27/2007
**
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @Cnt INT
DECLARE @ProcName sysname
DECLARE @msg nvarchar(max)
DECLARE @trancount int
DECLARE @debug tinyint

DECLARE @BatchID int

DECLARE @Header xml(ETLController)
DECLARE @ProcessInfo xml(ETLController)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0
SET @trancount = @@trancount


begin try
set @debug = case when charindex('debug',@pOptions) > 0 then 1 else 0 end

select @BatchID = BatchID
  from dbo.[ETLBatch] where BatchName = @pBatchName

if (@BatchID is null)
BEGIN
   --SET @Err = 50101
   --SET @msg = '   ERROR pContext: BatchName=' + @pBatchName + ' not found'
   --RAISERROR(@msg,11,11)
   --batch not found and nothing to remove
   SET @msg = '   WARNING pContext: BatchName=' + @pBatchName + ' not found'
   RAISERROR(@msg,0,1)
   RETURN @Err 
END

exec [prc_CreateHeader] @Header out,@BatchID,null,null,0,@debug,15
if (@debug = 1)
begin
   SET @msg =  'BEGIN Procedure ' + @ProcName + ' for BatchName=' + isnull(@pBatchName,'NULL')
            + ' (' + isnull(cast(@BatchID as nvarchar(10)),'NULL') + ')'

   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
end

--BEGIN TRAN

   delete dbo.[ETLStepConstraintAttribute] where BatchID = @BatchID
   delete dbo.[ETLStepConstraint] where BatchID = @BatchID
   delete dbo.[ETLStepAttribute] where BatchID = @BatchID
   delete dbo.[ETLStep] where BatchID = @BatchID
   delete dbo.[ETLBatchConstraintAttribute] where BatchID = @BatchID
   delete dbo.[ETLBatchConstraint] where BatchID = @BatchID
   delete dbo.[ETLBatchAttribute] where BatchID = @BatchID
   delete dbo.[ETLBatch] where BatchID = @BatchID

--COMMIT TRAN

IF (@debug = 1)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ProcErr = dbo.prc_CreateProcessInfo @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@pHandle
END

end try
begin catch
   if @Trancount < @@trancount
      ROLLBACK TRAN

   set @msg = ERROR_MESSAGE()
   set @Err = ERROR_NUMBER()
   raiserror (@msg,11,11)
end catch

RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_RemoveContext].[@pOptions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_RemoveContext].[@pBatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_RemoveContext].[@pHandle]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraintAttribute].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchConstraint].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchAttribute].[BatchID]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_RemoveContext].[@pBatchName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="30" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_RemoveContext].[@pHandle]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_RemoveContext].[@pOptions]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="140" />
				<Property Name="Length" Value="3052" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;declare @Header xml&#xD;&#xA;declare @pBatchName nvarchar(30)&#xD;&#xA;set @pBatchName = 'xxx' &#xD;&#xA;exec prc_RemoveContext @pBatchName,null,'debug'&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_RemoveContext]&#xD;&#xA;    @pBatchName nvarchar(30)&#xD;&#xA;   ,@pHandle uniqueidentifier = null &#xD;&#xA;   ,@pOptions nvarchar(100) = null&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_StatusCheck]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/******************************************************************
**D File:         prc_StatusCheck.SQL
**
**D Desc:         Check execution Status of the request
**
**D Auth:         andreys
**D Date:         10/28/2007
**
** Param: @pRequest  - BatchID info
                  @pReceipt results (StatusID - 2 - SUCCESS, 3 - FAILURE, 4 - ERROR, 6 - FAILURE_IMMEDIATE) (OUTPUT only)
*******************************************************************
**      Change History
*******************************************************************
**  Date:            Author:            Description:
******************************************************************/
SET NOCOUNT ON
DECLARE @Err INT
DECLARE @ProcErr INT
DECLARE @ProcName sysname
DECLARE @StatusID tinyint
DECLARE @msg nvarchar(max)
DECLARE @ErrMsg nvarchar(max)
DECLARE @BatchID int
DECLARE @StepID int
DECLARE @ConstID int
DECLARE @debug tinyint
DECLARE @handle uniqueidentifier
DECLARE @Value varchar(1000)
DECLARE @nValue nvarchar(max)
DECLARE @RunID int
DECLARE @Options int

DECLARE @CheckRunID int
DECLARE @CheckBatchID int
DECLARE @CheckStepID int
DECLARE @CheckBatchName nvarchar(100)
DECLARE @CheckStepName nvarchar(100)
DECLARE @CheckContext nvarchar(100)

SET @ProcName = OBJECT_NAME(@@PROCID)
SET @Err = 0
SET @ProcErr = 0

DECLARE @STAT_SUCCESS TINYINT
DECLARE @STAT_FAILURE TINYINT
DECLARE @STAT_ERROR TINYINT
DECLARE @STAT_FAILURE_IMMEDIATE TINYINT

SET @STAT_SUCCESS = 2
SET @STAT_FAILURE = 3
SET @STAT_ERROR = 4
SET @STAT_FAILURE_IMMEDIATE = 6
-------------------------------------------------------------------
--Return Statuses
--2 - Success
--3 - Failure
--4 - Error
--6 - failure and exit
-------------------------------------------------------------------
DECLARE @Request AS xml (ETLController)
DECLARE @Receipt AS xml (ETLController)
DECLARE @Header AS xml (ETLController)
DECLARE @Context AS xml (ETLController)
DECLARE @ProcessInfo AS xml (ETLController)
DECLARE @Attributes AS xml (ETLController)

begin try
exec @ProcErr = dbo.[prc_ReadProcessRequest] @pRequest,@Header out,@Context out,@handle out
exec @ProcErr = dbo.[prc_ReadHeader] @Header,@BatchID out,@StepID out,null,@RunID out,@Options out

set @debug = nullif(@Options & 1,0)
IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'BEGIN Procedure ' + @ProcName
                           + ' with @BatchID=' + CAST(@BatchID AS nvarchar(30))
                           + ISNULL( ', @StepID=' +CAST(@StepID AS nvarchar(30)),'')
                           + ISNULL( ', @RunID=' +CAST(@RunID AS nvarchar(30)),'')

   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END


-------------------------------------------------------------------
--Retrieve Attributes
-------------------------------------------------------------------
exec @ProcErr = dbo.[prc_ReadContextAttributes] @pRequest,@Attributes out

exec @ProcErr = dbo.prc_ReadAttribute @Attributes,'CheckContext',@CheckContext out
if (@CheckContext is null)
   set @CheckContext = 'Current'

exec @ProcErr = dbo.prc_ReadAttribute @Attributes,'CheckBatchID',@CheckBatchID out
if (@CheckBatchID is null)
begin
   exec @ProcErr = dbo.prc_ReadAttribute @Attributes,'CheckBatchName',@CheckBatchName out
   select @CheckBatchID = BatchID from dbo.[ETLBatch] where BatchName = @CheckBatchName
   IF (@CheckBatchID is null and @CheckBatchName is not null)
   BEGIN
     SET @ErrMsg = '   ERROR 50110: unknown CheckBatchName ' + @CheckBatchName
     SET @StatusID = @STAT_ERROR
     SET @Err = 50110
     raiserror (@ErrMsg,11,11)
   END
end

if (@CheckBatchID is null)
   set @CheckBatchID = @BatchID


exec @ProcErr = dbo.prc_ReadAttribute @Attributes,'CheckRunID',@CheckRunID out
if (@CheckRunID is null)
begin
   if (@CheckBatchID = @BatchID)
      set @CheckRunID = @RunID
   else
      select @CheckRunID = max(RunID) from dbo.[ETLBatchRun] where BatchID = @CheckBatchID
end


if (@CheckContext = 'Step' or (@CheckContext = 'Current' and @StepID is not null))
begin
   exec @ProcErr = dbo.prc_ReadAttribute @Attributes,'CheckStepID',@CheckStepID out
   if (@CheckStepID is null)
   begin
      exec @ProcErr = dbo.prc_ReadAttribute @Attributes,'CheckStepName',@CheckStepName out
      select @CheckStepID = StepID from dbo.[ETLStep] where BatchID = @CheckBatchID and StepName = @CheckStepName
      IF (@CheckStepID is null and @CheckStepName is not null)
      BEGIN
        SET @ErrMsg = '   ERROR 50110: unknown CheckStepName ' + @CheckStepName
        SET @StatusID = @STAT_ERROR
        SET @Err = 50110
        raiserror (@ErrMsg,11,11)
      END
   end

   if (@CheckStepID is null)
      set @CheckStepID = @StepID
end

if (@CheckBatchID = @BatchID and @CheckStepID = @StepID and @CheckRunID = @RunID)
begin
   SET @ErrMsg = '   ERROR 50110: check information is required: BATCHID/BATCHNAME;STEPID/STEPNAME;RUNID'
   SET @StatusID = @STAT_ERROR
   SET @Err = 50110
   raiserror (@ErrMsg,11,11)
end
----------------------------------------------------------------------------------
--Checking...
----------------------------------------------------------------------------------
--checking Batch
if (@CheckStepID is null)
begin
   SELECT @StatusID = StatusID
     FROM dbo.[ETLBatchRun] r
    WHERE r.RunID = @CheckRunID
      AND r.BatchID = @CheckBatchID

   IF (@debug IS NOT NULL)
   BEGIN
      SET @msg = '   Check: BatchID=' + cast(@CheckBatchID as nvarchar(30))
               + ',RunpID=' + cast(@CheckRunID as nvarchar(30))
               + ',Status=' + isnull(cast(@StatusID as varchar(10)),'null') 
      exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
      exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
   END

   SET @StatusID =
               CASE
                  WHEN @StatusID = 1 THEN @STAT_FAILURE --running
                  WHEN @StatusID in (0,2) THEN @STAT_SUCCESS      --finished with success or never been run
                  WHEN @StatusID in (3,4) THEN @STAT_FAILURE_IMMEDIATE --failed
                  ELSE @STAT_SUCCESS --not found therefore no reason to wait
                END
end
--checking Step
else
begin
   if (@CheckRunID = @RunID)
      SELECT @StatusID = StatusID
        FROM dbo.[ETLStepRun] r
       WHERE r.RunID = @CheckRunID
         AND r.BatchID = @CheckBatchID
         AND r.StepID = @CheckStepID
   else
      SELECT @StatusID = StatusID
        FROM dbo.[ETLStepRunHistory] r
       WHERE r.RunID = @CheckRunID
         AND r.BatchID = @CheckBatchID
         AND r.StepID = @CheckStepID


   IF (@debug IS NOT NULL)
   BEGIN
      SET @msg = '   Check: BatchID=' + cast(@CheckBatchID as nvarchar(30))
               + ',StepID=' + cast(@CheckStepID as nvarchar(30))
               + ',RunpID=' + cast(@CheckRunID as nvarchar(30))
               + ',Status=' + isnull(cast(@StatusID as varchar(10)),'null') 
      exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
      exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
   END

   SET @StatusID =
               CASE
                  WHEN @StatusID in (0,1) THEN @STAT_FAILURE --running or not started
                  WHEN @StatusID = 2 THEN @STAT_SUCCESS      --finished with success
                  WHEN @StatusID in (3,4) THEN @STAT_FAILURE_IMMEDIATE --failed
                  ELSE @STAT_SUCCESS --not found therefore no reason to wait
                END
end

end try
begin catch
set @err = error_number()
set @ErrMsg = isnull(@ErrMsg,error_message())
IF (@ErrMsg IS NOT NULL)
BEGIN
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@ErrMsg,@Err
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
set @StatusID = @STAT_FAILURE_IMMEDIATE
end catch

if (@pReceipt is null)
   exec @ProcErr = dbo.prc_CreateProcessReceipt @pReceipt out,@Header,@StatusID,@Err,@ErrMsg

IF (@debug IS NOT NULL)
BEGIN
   SET @msg = 'END Procedure ' + @ProcName
   exec @ProcErr = dbo.[prc_CreateProcessInfo] @ProcessInfo out,@Header,@msg
   exec @ProcErr = dbo.[prc_Print] @ProcessInfo,@handle
END
RETURN @Err]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[xml]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadProcessRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StatusCheck].[@pRequest]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadHeader]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessInfo]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_Print]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadContextAttributes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_ReadAttribute]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatch].[BatchName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStep].[StepName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLBatchRun].[BatchID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRun].[StepID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[StatusID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[RunID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[BatchID]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ETLStepRunHistory].[StepID]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_StatusCheck].[@pReceipt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_CreateProcessReceipt]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StatusCheck].[@pRequest]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_StatusCheck].[@pReceipt]">
						<Property Name="IsOutput" Value="True" />
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlXmlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[xml]" />
										</Entry>
									</Relationship>
									<Relationship Name="XmlSchemaCollection">
										<Entry>
											<References Name="[dbo].[ETLController]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="598" />
				<Property Name="Length" Value="9035" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;select * from ETLSteprunhistory where batchid = -20&#xD;&#xA;&#xD;&#xA;declare @pHeader xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-20,null,null,6,1&#xD;&#xA;exec dbo.prc_AttributeSet @pHeader,'CheckRunID',6&#xD;&#xA;&#xD;&#xA;declare @pHeader xml&#xD;&#xA;declare @pContext xml&#xD;&#xA;declare @pProcessRequest xml&#xD;&#xA;declare @pProcessReceipt xml&#xD;&#xA;exec dbo.prc_CreateHeader @pHeader out,-20,1,null,5,1&#xD;&#xA;exec dbo.prc_CreateContext @pContext out,@pHeader&#xD;&#xA;exec dbo.prc_CreateProcessRequest @pProcessRequest out,@pHeader,@pContext&#xD;&#xA;--select @pProcessRequest&#xD;&#xA;exec dbo.prc_StatusCheck @pProcessRequest,@pProcessReceipt out&#xD;&#xA;select @pProcessReceipt&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_StatusCheck]&#xD;&#xA;    @pRequest xml([ETLController])&#xD;&#xA;   ,@pReceipt  xml([ETLController]) = NULL OUTPUT&#xD;&#xA;As" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_SystemParameterLet]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[

/*
** Name:  [dbo].[prc_SystemParameterLet]
**
**
** Purpose:
**      Set systemParameters Values
**
*
** */

    SET NOCOUNT ON

    /*
    ** Declarations.
    */

    DECLARE @FAIL smallint                      -- Failure code for RETURN.
    DECLARE @SUCCEED smallint                   -- Success code for RETURN.

    DECLARE @ProcedureName sysname              -- This procedure.
    DECLARE @RetCode int                        -- Procedure return code.
	DECLARE @msg nvarchar(1000)
	DECLARE @err int;
    /*
    ** Initialize the @ProcedureName for error messages.
    */

    SET @ProcedureName = OBJECT_NAME(@@PROCID)

    /*
    ** Initialize some constants.
    */

    SET @FAIL = 1
    SET @SUCCEED = 0

    /*
    ** Parameter Check:  @ParameterName
    ** Make sure that the @Parameter name exists and is not NULL.
    */

    IF (@ParameterName IS NULL)
        BEGIN
            SET @msg = '@ParameterName can not be null'; 
			THROW 50008, @msg, 1;
            RETURN @FAIL
        END

    /*
    ** Parameter Check:  @ParameterType
    ** Make sure that the parameter category exists and is not NULL.
    */

    IF (@ParameterType IS NULL)
        BEGIN
            SET @msg = '@ParameterType can not be null'; 
			THROW 50008, @msg, 1;
            RETURN @FAIL
        END

    /*
    ** If this is a new parameter, let's create it in the table.
    */

    BEGIN TRY
	IF NOT EXISTS (SELECT *
                     FROM [dbo].[SystemParameters]
                    WHERE [ParameterType] = @ParameterType
                      AND [ParameterName] = @ParameterName
					  AND [EnvironmentName] = @EnvironmentName)
        BEGIN

            INSERT INTO [dbo].[SystemParameters] (
                [ParameterType]
              , [ParameterName]
              , [ParameterValue_Current]
              , [ParameterValue_New]
              , [ParameterValue_Default]
              , [ParameterDesc]
			  , [EnvironmentName]
              , [LastModifiedBy]
              , [LastModifiedDtim]
            ) VALUES (
                @ParameterType
              , @ParameterName
              , NULL
              , NULL
              , @ParameterDefault
              , @ParameterDesc
              , @EnvironmentName
			  , SUSER_SNAME()
              , CURRENT_TIMESTAMP
            )

        END

    /*
    ** Before we update, let's make sure someone else hasn't already updated!
    */

    IF (@LastModifiedDtim IS NOT NULL)
        BEGIN
            IF NOT EXISTS (
                SELECT *
                  FROM [dbo].[SystemParameters]
                 WHERE [ParameterName] = @ParameterName
                   AND [ParameterType] = @ParameterType
                   AND CONVERT(varchar, [LastModifiedDtim], 121) = CONVERT(varchar, @LastModifiedDtim, 121)
                )
                BEGIN
					SET @msg = '@ParameterName was modified outside of scope of this transaction';
					THROW 50030,@msg,1;
                    RETURN @FAIL
                END
        END

    /*
    ** Set the parameter value.
    */

    UPDATE [dbo].[SystemParameters]
      WITH (HOLDLOCK)
       SET [ParameterValue_New] = @ParameterValue
         , [LastModifiedBy] = SUSER_SNAME()
         , [LastModifiedDtim] = GETDATE()
     WHERE [ParameterName] = @ParameterName
       AND [ParameterType] = @ParameterType
	   AND [EnvironmentName] = @EnvironmentName

    /*
    ** Commit if necessary.
    */

    IF @EffectiveImmediately = 1
        BEGIN

            EXECUTE @RetCode = [dbo].[prc_SystemParameterSet]
                @ParameterType = @ParameterType
              , @ParameterName = @ParameterName
			  , @EnvironmentName = @EnvironmentName;

            IF (@RetCode <> 0) RETURN @FAIL;

        END

    RETURN @SUCCEED
	END TRY
	BEGIN CATCH
		SET @err = ERROR_NUMBER();
		SET @msg = CAST(@err AS NVARCHAR(100)) + ': ' + ERROR_MESSAGE();
		THROW 50000, @msg,1;
		RETURN @FAIL;
	END CATCH]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterLet].[@ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterLet].[@ParameterType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[EnvironmentName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterLet].[@EnvironmentName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_Current]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_New]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_Default]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[EnvironmentName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[LastModifiedBy]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[LastModifiedDtim]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterLet].[@ParameterDefault]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterLet].[@ParameterDesc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterLet].[@LastModifiedDtim]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[LastModifiedDtim]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterLet].[@ParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterLet].[@EffectiveImmediately]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterSet]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterSet].[@ParameterType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterSet].[@ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterSet].[@EnvironmentName]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterLet].[@ParameterType]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="32" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterLet].[@ParameterName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="57" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterLet].[@ParameterValue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1024" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterLet].[@ParameterDefault]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1024" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterLet].[@ParameterDesc]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1024" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterLet].[@LastModifiedDtim]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterLet].[@EffectiveImmediately]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterLet].[@EnvironmentName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA['All']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="2" />
				<Property Name="Length" Value="4740" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_SystemParameterLet] (&#xD;&#xA;        @ParameterType varchar(32)&#x9;&#x9;&#x9;&#x9; -- The system parameter category.&#xD;&#xA;      , @ParameterName varchar(57)&#x9;&#x9;&#x9;&#x9; -- The system parameter name.&#xD;&#xA;      , @ParameterValue varchar(1024)&#x9;&#x9;&#x9; -- The new setting.&#xD;&#xA;      , @ParameterDefault varchar(1024) = NULL   -- The default setting.&#xD;&#xA;      , @ParameterDesc varchar(1024) = NULL    -- Parameter description&#xD;&#xA;      , @LastModifiedDtim datetime = NULL -- Last updated date/time.&#xD;&#xA;      , @EffectiveImmediately bit = 0            -- 0= update later, 1= update now.&#xD;&#xA;&#x9;  , @EnvironmentName VARCHAR(100) = 'All'  --The environment Name for which this variable is defined&#xD;&#xA;    ) AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[prc_SystemParameterSet]">
			<Property Name="BodyScript">
				<Value QuotedIdentifiers="True"><![CDATA[
/*
** Name:  [dbo].[prc_SystemParameterSet]
**
** Purpose:
**      Set current systemParameters values 
**
**/




    SET NOCOUNT ON

    /*
    ** Declarations.
    */

    DECLARE @FAIL smallint                      -- Failure code for RETURN.
    DECLARE @SUCCEED smallint                   -- Success code for RETURN.

    DECLARE @ProcedureName sysname              -- This procedure.
	DECLARE @msg nvarchar(1000)
	DECLARE @err int;

    /*
    ** Initialize the @ProcedureName for error messages.
    */

    SET @ProcedureName = OBJECT_NAME(@@PROCID)

    /*
    ** Initialize some constants.
    */

    SET @FAIL = 1
    SET @SUCCEED = 0

    /*
    ** Parameter Check:  @ParameterName
    ** Make sure that the @Parameter name exists if it is not NULL.
    */

    IF (@ParameterName IS NOT NULL)
        IF NOT EXISTS (SELECT *
                         FROM [dbo].[SystemParameters]
                        WHERE [ParameterType] = COALESCE(@ParameterType, '')
                          AND [ParameterName] = @ParameterName
						  AND [EnvironmentName] = @EnvironmentName)
            BEGIN
				SET @msg = '@ParameterName: ' + @ParameterName + ' is not found'; 
				THROW 50008, @msg, 1;
				RETURN @FAIL
            END

    /*
    ** Set the parameter value.
    */
	BEGIN TRY
    IF (@ParameterType IS NOT NULL)
        IF (@ParameterName IS NULL)
            UPDATE [dbo].[SystemParameters]
               SET [ParameterValue_Current] = ParameterValue_New
             WHERE [ParameterType] = @ParameterType
			 AND [EnvironmentName] = @EnvironmentName
        ELSE
            UPDATE [dbo].[SystemParameters]
               SET [ParameterValue_Current] = ParameterValue_New
             WHERE [ParameterName] = @ParameterName
               AND [ParameterType] = @ParameterType
			   AND [EnvironmentName] = @EnvironmentName
    ELSE
        UPDATE [dbo].[SystemParameters]
           SET [ParameterValue_Current] = ParameterValue_New
		WHERE [EnvironmentName] = @EnvironmentName


    RETURN @SUCCEED;
	END TRY
	BEGIN CATCH
		SET @err = ERROR_NUMBER();
		SET @msg = CAST(@err AS NVARCHAR(100)) + ': ' + ERROR_MESSAGE();
		THROW 50000, @msg,1;
		THROW @Err, @msg,1;
		RETURN @FAIL;
	END CATCH]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterSet].[@ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterSet].[@ParameterType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[EnvironmentName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[prc_SystemParameterSet].[@EnvironmentName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_Current]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_New]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterType]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[EnvironmentName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterSet].[@ParameterType]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="32" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterSet].[@ParameterName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="57" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[prc_SystemParameterSet].[@EnvironmentName]">
						<Property Name="DefaultExpressionScript">
							<Value QuotedIdentifiers="True"><![CDATA['All']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="2" />
				<Property Name="Length" Value="2575" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;CREATE PROCEDURE [dbo].[prc_SystemParameterSet] (&#xD;&#xA;        @ParameterType VARCHAR(32) = NULL  -- The system parameter category.&#xD;&#xA;      , @ParameterName VARCHAR(57) = NULL  -- The system parameter name.&#xD;&#xA;&#x9;  , @EnvironmentName VARCHAR(100) = 'All' --The environment Name&#xD;&#xA;    ) AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[SystemParameters]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[ParameterType]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="32" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[ParameterName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="57" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[ParameterValue_Current]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1024" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[ParameterValue_New]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1024" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[ParameterValue_Default]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1024" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[ParameterDesc]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1024" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[EnvironmentName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[LastModifiedBy]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[SystemParameters].[LastModifiedDtim]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlCheckConstraint" Name="[dbo].[SystemParametersEnvironmentNameCK]">
			<Property Name="CheckExpressionScript">
				<Value><![CDATA[EnvironmentName IN ('ALL', 'DEV', 'TEST', 'UAT','PPE', 'PROD')]]></Value>
			</Property>
			<Relationship Name="CheckExpressionDependencies">
				<Entry>
					<References Name="[dbo].[SystemParameters].[EnvironmentName]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[SystemParameters]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlDmlTrigger" Name="[dbo].[trg_SystemParameters_Del]">
			<Property Name="IsDeleteTrigger" Value="True" />
			<Property Name="SqlTriggerType" Value="1" />
			<Property Name="BodyScript">
				<Value><![CDATA[

    /*
    ** Declarations.
    */

    DECLARE @ProcedureName sysname              -- This procedure.

    /*
    ** Initialize the @ProcedureName for error messages.
    */

    SELECT @ProcedureName = OBJECT_NAME(@@PROCID)

    IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;

    THROW 50026, 'SystemParameters delete operation is disabled', 1;]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parent">
				<Entry>
					<References Name="[dbo].[SystemParameters]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="201" />
				<Property Name="Length" Value="643" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;/*&#xD;&#xA;** Name:  [trg_SystemParameters_Del]&#xD;&#xA;**&#xD;&#xA;** Purpose:&#xD;&#xA;**      This script creates a trigger on table [dbo].[SystemParameters].&#xD;&#xA;**  Prevent users from removing system parameters.&#xD;&#xA;**&#xD;&#xA;**&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE TRIGGER [trg_SystemParameters_Del] ON [dbo].[SystemParameters] FOR DELETE AS" />
			</Annotation>
		</Element>
		<Element Type="SqlDmlTrigger" Name="[dbo].[trg_SystemParameters_Upd]">
			<Property Name="IsUpdateTrigger" Value="True" />
			<Property Name="SqlTriggerType" Value="1" />
			<Property Name="BodyScript">
				<Value><![CDATA[

    /*
    ** Declarations.
    */

    DECLARE @ProcedureName sysname              -- This procedure.
    DECLARE @ParameterName varchar(57)
    DECLARE @ParameterValue_Current varchar(1024)
    DECLARE @ParameterValue_New varchar(1024)
	DECLARE @msg nvarchar(1000)

    /*
    ** Initialize the @ProcedureName for error messages.
    */

    SELECT @ProcedureName = OBJECT_NAME(@@PROCID)

    /*
    ** Make sure that the current value is equal to the new value or
    ** else abort.
    */

    IF UPDATE([ParameterValue_Current]) AND
        EXISTS (SELECT *
                  FROM [inserted]
                 WHERE [ParameterValue_Current] <> [ParameterValue_New] )

        ROLLBACK TRANSACTION

    IF UPDATE([ParameterValue_Current]) AND UPDATE([ParameterValue_New])
        ROLLBACK TRANSACTION

    /*
    ** Post a warning message for each affected parameter.
    */

    DECLARE hC CURSOR FAST_FORWARD FOR
     SELECT i.[ParameterName]
          , i.[ParameterValue_Current]
          , i.[ParameterValue_New]
      FROM [inserted] AS i
      JOIN [deleted] AS d ON d.[ParameterName] = i.[ParameterName]
     WHERE d.[ParameterValue_Current] <> i.[ParameterValue_New]

    OPEN hC
    FETCH hC INTO @ParameterName, @ParameterValue_Current, @ParameterValue_New

    WHILE @@FETCH_STATUS <> -1
        BEGIN

            IF UPDATE(ParameterValue_Current)
			BEGIN
				SET @msg = 'Operation is not allowed: update @ParameterName: ' + @ParameterName + ' = ' + @ParameterValue_Current;
                THROW 50025, @msg, 1;
			END

            IF UPDATE(ParameterValue_New)
			BEGIN
				SET @msg = 'Operation is not allowed: update @ParameterName: ' + @ParameterName + ' = ' + @ParameterValue_New;
                THROW 50025, @msg, 1;
			END

            FETCH hC INTO @ParameterName, @ParameterValue_Current, @ParameterValue_New

        END

    CLOSE hC
    DEALLOCATE hC]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_Current]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_New]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_Current]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_New]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[SystemParameters].[ParameterValue_Current]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parent">
				<Entry>
					<References Name="[dbo].[SystemParameters]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="305" />
				<Property Name="Length" Value="2340" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;/*&#xD;&#xA;** Name:  [trg_SystemParameters_Upd]&#xD;&#xA;**&#xD;&#xA;** Purpose:&#xD;&#xA;**      This script creates a trigger on table [dbo].[SystemParameters].&#xD;&#xA;**  Issue warning messages about changes to the system parameters.  These&#xD;&#xA;**  errors should be trappable so that an operator can be notified of&#xD;&#xA;**  changes.&#xD;&#xA;**&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE TRIGGER [trg_SystemParameters_Upd] ON [dbo].[SystemParameters] FOR UPDATE AS" />
			</Annotation>
		</Element>
		<Element Type="SqlUniqueConstraint" Name="[dbo].[UQ_Dsv01]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Dsv].[DsvName]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Dsv].[DsvType]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Dsv]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlContract" Name="[ETLController]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Messages">
				<Entry>
					<Element Type="SqlContractMessageSpecifier">
						<Property Name="SentBy" Value="2" />
						<Relationship Name="MessageType">
							<Entry>
								<References Name="[ETLController_InfoMessage]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlContractMessageSpecifier">
						<Property Name="SentBy" Value="1" />
						<Relationship Name="MessageType">
							<Entry>
								<References Name="[ETLController_Request]" Disambiguator="4" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlContractMessageSpecifier">
						<Property Name="SentBy" Value="2" />
						<Relationship Name="MessageType">
							<Entry>
								<References Name="[ETLController_Receipt]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlContractMessageSpecifier">
						<Property Name="SentBy" Value="3" />
						<Relationship Name="MessageType">
							<Entry>
								<References Name="[ETLController_Test]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlContractMessageSpecifier">
						<Property Name="SentBy" Value="1" />
						<Relationship Name="MessageType">
							<Entry>
								<References Name="[ETLController_Cancel]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlMessageType" Name="[ETLController_Cancel]">
			<Property Name="ValidationMethod" Value="4" />
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="XmlSchemaCollection">
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlMessageType" Name="[ETLController_InfoMessage]">
			<Property Name="ValidationMethod" Value="4" />
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="XmlSchemaCollection">
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlRoute" Name="[ETLController_Local_Node00]">
			<Property Name="Service" Value="ETLController_Process" />
			<Property Name="Address" Value="LOCAL" />
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlService" Name="[ETLController_Process]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Contracts">
				<Entry>
					<References Name="[ETLController]" />
				</Entry>
			</Relationship>
			<Relationship Name="Queue">
				<Entry>
					<References Name="[dbo].[ETLController_Request_Queue]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlMessageType" Name="[ETLController_Receipt]">
			<Property Name="ValidationMethod" Value="4" />
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="XmlSchemaCollection">
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlMessageType" Name="[ETLController_Request]" Disambiguator="4">
			<Property Name="ValidationMethod" Value="4" />
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="XmlSchemaCollection">
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlService" Name="[ETLController_Request]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Contracts">
				<Entry>
					<References Name="[ETLController]" />
				</Entry>
			</Relationship>
			<Relationship Name="Queue">
				<Entry>
					<References Name="[dbo].[ETLController_Receipt_Queue]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlMessageType" Name="[ETLController_Test]">
			<Property Name="ValidationMethod" Value="4" />
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="XmlSchemaCollection">
				<Entry>
					<References Name="[dbo].[ETLController]" />
				</Entry>
			</Relationship>
		</Element>
	</Model>
</DataSchemaModel>